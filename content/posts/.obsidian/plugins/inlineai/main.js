/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var Lb=Object.create;var Rs=Object.defineProperty;var Db=Object.getOwnPropertyDescriptor;var Mb=Object.getOwnPropertyNames;var Fb=Object.getPrototypeOf,Ub=Object.prototype.hasOwnProperty;var zb=(n,e,t)=>e in n?Rs(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var N=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),Jd=(n,e)=>{for(var t in e)Rs(n,t,{get:e[t],enumerable:!0})},Wd=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Mb(e))!Ub.call(n,a)&&a!==t&&Rs(n,a,{get:()=>e[a],enumerable:!(r=Db(e,a))||r.enumerable});return n};var wt=(n,e,t)=>(t=n!=null?Lb(Fb(n)):{},Wd(e||!n||!n.__esModule?Rs(t,"default",{value:n,enumerable:!0}):t,n)),Bb=n=>Wd(Rs({},"__esModule",{value:!0}),n);var V=(n,e,t)=>zb(n,typeof e!="symbol"?e+"":e,t);var Zh=N((rk,Kh)=>{"use strict";Kh.exports=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e=="undefined"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}});var tf=N((nk,Uc)=>{"use strict";var X_=/[\p{Lu}]/u,Q_=/[\p{Ll}]/u,Jh=/^[\p{Lu}](?![\p{Lu}])/gu,Xh=/([\p{Alpha}\p{N}_]|$)/u,Qh=/[_.\- ]+/,ew=new RegExp("^"+Qh.source),Wh=new RegExp(Qh.source+Xh.source,"gu"),Yh=new RegExp("\\d+"+Xh.source,"gu"),tw=(n,e,t)=>{let r=!1,a=!1,s=!1;for(let i=0;i<n.length;i++){let o=n[i];r&&X_.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,s=a,a=!0,i++):a&&s&&Q_.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),s=a,a=!1,r=!0):(r=e(o)===o&&t(o)!==o,s=a,a=t(o)===o&&e(o)!==o)}return n},rw=(n,e)=>(Jh.lastIndex=0,n.replace(Jh,t=>e(t))),nw=(n,e)=>(Wh.lastIndex=0,Yh.lastIndex=0,n.replace(Wh,(t,r)=>e(r)).replace(Yh,t=>e(t))),ef=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(s=>s.trim()).filter(s=>s.length).join("-"):n=n.trim(),n.length===0)return"";let t=e.locale===!1?s=>s.toLowerCase():s=>s.toLocaleLowerCase(e.locale),r=e.locale===!1?s=>s.toUpperCase():s=>s.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=tw(n,t,r)),n=n.replace(ew,""),e.preserveConsecutiveUppercase?n=rw(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),nw(n,r))};Uc.exports=ef;Uc.exports.default=ef});var If=N((Lk,xf)=>{function It(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}xf.exports=It;It.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};It.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};It.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};It.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};It.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};It.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};It.prototype.start=It.prototype.try;It.prototype.errors=function(){return this._errors};It.prototype.attempts=function(){return this._attempts};It.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(n[s]||0)+1;n[s]=i,i>=t&&(e=a,t=i)}return e}});var Pf=N(Jn=>{var bv=If();Jn.operation=function(n){var e=Jn.timeouts(n);return new bv(e,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})};Jn.timeouts=function(n){if(n instanceof Array)return[].concat(n);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in n)e[t]=n[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],a=0;a<e.retries;a++)r.push(this.createTimeout(a,e));return n&&n.forever&&!r.length&&r.push(this.createTimeout(a,e)),r.sort(function(s,i){return s-i}),r};Jn.createTimeout=function(n,e){var t=e.randomize?Math.random()+1:1,r=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,n));return r=Math.min(r,e.maxTimeout),r};Jn.wrap=function(n,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var r in n)typeof n[r]=="function"&&t.push(r)}for(var a=0;a<t.length;a++){var s=t[a],i=n[s];n[s]=function(u){var c=Jn.operation(e),l=Array.prototype.slice.call(arguments,1),d=l.pop();l.push(function(h){c.retry(h)||(h&&(arguments[0]=c.mainError()),d.apply(this,arguments))}),c.attempt(function(){u.apply(n,l)})}.bind(n,i),n[s].options=e}}});var Sf=N((Mk,Tf)=>{Tf.exports=Pf()});var Oo=N((Fk,Eo)=>{"use strict";var _v=Sf(),wv=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],Ao=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},vv=(n,e,t)=>{let r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},Av=n=>wv.includes(n),Cf=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};let a=_v.operation(e);a.attempt(async s=>{try{t(await n(s))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof Ao)a.stop(),r(i.originalError);else if(i instanceof TypeError&&!Av(i.message))a.stop(),r(i);else{vv(i,s,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}a.retry(i)||r(a.mainError())}}})});Eo.exports=Cf;Eo.exports.default=Cf;Eo.exports.AbortError=Ao});var $f=N((Xk,Xc)=>{"use strict";var Pv=Object.prototype.hasOwnProperty,Ke="~";function ai(){}Object.create&&(ai.prototype=Object.create(null),new ai().__proto__||(Ke=!1));function Tv(n,e,t){this.fn=n,this.context=e,this.once=t||!1}function Nf(n,e,t,r,a){if(typeof t!="function")throw new TypeError("The listener must be a function");var s=new Tv(t,r||n,a),i=Ke?Ke+e:e;return n._events[i]?n._events[i].fn?n._events[i]=[n._events[i],s]:n._events[i].push(s):(n._events[i]=s,n._eventsCount++),n}function To(n,e){--n._eventsCount===0?n._events=new ai:delete n._events[e]}function Ue(){this._events=new ai,this._eventsCount=0}Ue.prototype.eventNames=function(){var e=[],t,r;if(this._eventsCount===0)return e;for(r in t=this._events)Pv.call(t,r)&&e.push(Ke?r.slice(1):r);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};Ue.prototype.listeners=function(e){var t=Ke?Ke+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var a=0,s=r.length,i=new Array(s);a<s;a++)i[a]=r[a].fn;return i};Ue.prototype.listenerCount=function(e){var t=Ke?Ke+e:e,r=this._events[t];return r?r.fn?1:r.length:0};Ue.prototype.emit=function(e,t,r,a,s,i){var o=Ke?Ke+e:e;if(!this._events[o])return!1;var u=this._events[o],c=arguments.length,l,d;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),c){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,a),!0;case 5:return u.fn.call(u.context,t,r,a,s),!0;case 6:return u.fn.call(u.context,t,r,a,s,i),!0}for(d=1,l=new Array(c-1);d<c;d++)l[d-1]=arguments[d];u.fn.apply(u.context,l)}else{var h=u.length,f;for(d=0;d<h;d++)switch(u[d].once&&this.removeListener(e,u[d].fn,void 0,!0),c){case 1:u[d].fn.call(u[d].context);break;case 2:u[d].fn.call(u[d].context,t);break;case 3:u[d].fn.call(u[d].context,t,r);break;case 4:u[d].fn.call(u[d].context,t,r,a);break;default:if(!l)for(f=1,l=new Array(c-1);f<c;f++)l[f-1]=arguments[f];u[d].fn.apply(u[d].context,l)}}return!0};Ue.prototype.on=function(e,t,r){return Nf(this,e,t,r,!1)};Ue.prototype.once=function(e,t,r){return Nf(this,e,t,r,!0)};Ue.prototype.removeListener=function(e,t,r,a){var s=Ke?Ke+e:e;if(!this._events[s])return this;if(!t)return To(this,s),this;var i=this._events[s];if(i.fn)i.fn===t&&(!a||i.once)&&(!r||i.context===r)&&To(this,s);else{for(var o=0,u=[],c=i.length;o<c;o++)(i[o].fn!==t||a&&!i[o].once||r&&i[o].context!==r)&&u.push(i[o]);u.length?this._events[s]=u.length===1?u[0]:u:To(this,s)}return this};Ue.prototype.removeAllListeners=function(e){var t;return e?(t=Ke?Ke+e:e,this._events[t]&&To(this,t)):(this._events=new ai,this._eventsCount=0),this};Ue.prototype.off=Ue.prototype.removeListener;Ue.prototype.addListener=Ue.prototype.on;Ue.prefixed=Ke;Ue.EventEmitter=Ue;typeof Xc!="undefined"&&(Xc.exports=Ue)});var Lf=N((Qk,jf)=>{"use strict";jf.exports=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})))});var Mf=N((eR,Co)=>{"use strict";var Sv=Lf(),So=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Df=(n,e,t)=>new Promise((r,a)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}let s=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){a(u)}return}let i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new So(i);typeof n.cancel=="function"&&n.cancel(),a(o)},e);Sv(n.then(r,a),()=>{clearTimeout(s)})});Co.exports=Df;Co.exports.default=Df;Co.exports.TimeoutError=So});var Ff=N(Qc=>{"use strict";Object.defineProperty(Qc,"__esModule",{value:!0});function Cv(n,e,t){let r=0,a=n.length;for(;a>0;){let s=a/2|0,i=r+s;t(n[i],e)<=0?(r=++i,a-=s+1):a=s}return r}Qc.default=Cv});var Uf=N(tl=>{"use strict";Object.defineProperty(tl,"__esModule",{value:!0});var kv=Ff(),el=class{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);let r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}let a=kv.default(this._queue,r,(s,i)=>i.priority-s.priority);this._queue.splice(a,0,r)}dequeue(){let e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}};tl.default=el});var Ro=N(nl=>{"use strict";Object.defineProperty(nl,"__esModule",{value:!0});var Rv=$f(),zf=Mf(),Nv=Uf(),ko=()=>{},$v=new zf.TimeoutError,rl=class extends Rv{constructor(e){var t,r,a,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=ko,this._resolveIdle=ko,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:Nv.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(a=e.interval)===null||a===void 0?void 0:a.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=ko,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=ko,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(this._intervalId===void 0){let t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{let s=async()=>{this._pendingCount++,this._intervalCount++;try{let i=this._timeout===void 0&&t.timeout===void 0?e():zf.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&a($v)});r(await i)}catch(i){a(i)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};nl.default=rl});var ii=N((lR,Hf)=>{var Fv="2.0.0",Uv=Number.MAX_SAFE_INTEGER||9007199254740991,zv=16,Bv=250,qv=["major","premajor","minor","preminor","patch","prepatch","prerelease"];Hf.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:zv,MAX_SAFE_BUILD_LENGTH:Bv,MAX_SAFE_INTEGER:Uv,RELEASE_TYPES:qv,SEMVER_SPEC_VERSION:Fv,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}});var oi=N((dR,Vf)=>{var Hv=typeof process=="object"&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...n)=>console.error("SEMVER",...n):()=>{};Vf.exports=Hv});var us=N((Ir,Gf)=>{var{MAX_SAFE_COMPONENT_LENGTH:il,MAX_SAFE_BUILD_LENGTH:Vv,MAX_LENGTH:Gv}=ii(),Kv=oi();Ir=Gf.exports={};var Zv=Ir.re=[],Jv=Ir.safeRe=[],k=Ir.src=[],R=Ir.t={},Wv=0,ol="[a-zA-Z0-9-]",Yv=[["\\s",1],["\\d",Gv],[ol,Vv]],Xv=n=>{for(let[e,t]of Yv)n=n.split(`${e}*`).join(`${e}{0,${t}}`).split(`${e}+`).join(`${e}{1,${t}}`);return n},G=(n,e,t)=>{let r=Xv(e),a=Wv++;Kv(n,a,e),R[n]=a,k[a]=e,Zv[a]=new RegExp(e,t?"g":void 0),Jv[a]=new RegExp(r,t?"g":void 0)};G("NUMERICIDENTIFIER","0|[1-9]\\d*");G("NUMERICIDENTIFIERLOOSE","\\d+");G("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${ol}*`);G("MAINVERSION",`(${k[R.NUMERICIDENTIFIER]})\\.(${k[R.NUMERICIDENTIFIER]})\\.(${k[R.NUMERICIDENTIFIER]})`);G("MAINVERSIONLOOSE",`(${k[R.NUMERICIDENTIFIERLOOSE]})\\.(${k[R.NUMERICIDENTIFIERLOOSE]})\\.(${k[R.NUMERICIDENTIFIERLOOSE]})`);G("PRERELEASEIDENTIFIER",`(?:${k[R.NUMERICIDENTIFIER]}|${k[R.NONNUMERICIDENTIFIER]})`);G("PRERELEASEIDENTIFIERLOOSE",`(?:${k[R.NUMERICIDENTIFIERLOOSE]}|${k[R.NONNUMERICIDENTIFIER]})`);G("PRERELEASE",`(?:-(${k[R.PRERELEASEIDENTIFIER]}(?:\\.${k[R.PRERELEASEIDENTIFIER]})*))`);G("PRERELEASELOOSE",`(?:-?(${k[R.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${k[R.PRERELEASEIDENTIFIERLOOSE]})*))`);G("BUILDIDENTIFIER",`${ol}+`);G("BUILD",`(?:\\+(${k[R.BUILDIDENTIFIER]}(?:\\.${k[R.BUILDIDENTIFIER]})*))`);G("FULLPLAIN",`v?${k[R.MAINVERSION]}${k[R.PRERELEASE]}?${k[R.BUILD]}?`);G("FULL",`^${k[R.FULLPLAIN]}$`);G("LOOSEPLAIN",`[v=\\s]*${k[R.MAINVERSIONLOOSE]}${k[R.PRERELEASELOOSE]}?${k[R.BUILD]}?`);G("LOOSE",`^${k[R.LOOSEPLAIN]}$`);G("GTLT","((?:<|>)?=?)");G("XRANGEIDENTIFIERLOOSE",`${k[R.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`);G("XRANGEIDENTIFIER",`${k[R.NUMERICIDENTIFIER]}|x|X|\\*`);G("XRANGEPLAIN",`[v=\\s]*(${k[R.XRANGEIDENTIFIER]})(?:\\.(${k[R.XRANGEIDENTIFIER]})(?:\\.(${k[R.XRANGEIDENTIFIER]})(?:${k[R.PRERELEASE]})?${k[R.BUILD]}?)?)?`);G("XRANGEPLAINLOOSE",`[v=\\s]*(${k[R.XRANGEIDENTIFIERLOOSE]})(?:\\.(${k[R.XRANGEIDENTIFIERLOOSE]})(?:\\.(${k[R.XRANGEIDENTIFIERLOOSE]})(?:${k[R.PRERELEASELOOSE]})?${k[R.BUILD]}?)?)?`);G("XRANGE",`^${k[R.GTLT]}\\s*${k[R.XRANGEPLAIN]}$`);G("XRANGELOOSE",`^${k[R.GTLT]}\\s*${k[R.XRANGEPLAINLOOSE]}$`);G("COERCEPLAIN",`(^|[^\\d])(\\d{1,${il}})(?:\\.(\\d{1,${il}}))?(?:\\.(\\d{1,${il}}))?`);G("COERCE",`${k[R.COERCEPLAIN]}(?:$|[^\\d])`);G("COERCEFULL",k[R.COERCEPLAIN]+`(?:${k[R.PRERELEASE]})?(?:${k[R.BUILD]})?(?:$|[^\\d])`);G("COERCERTL",k[R.COERCE],!0);G("COERCERTLFULL",k[R.COERCEFULL],!0);G("LONETILDE","(?:~>?)");G("TILDETRIM",`(\\s*)${k[R.LONETILDE]}\\s+`,!0);Ir.tildeTrimReplace="$1~";G("TILDE",`^${k[R.LONETILDE]}${k[R.XRANGEPLAIN]}$`);G("TILDELOOSE",`^${k[R.LONETILDE]}${k[R.XRANGEPLAINLOOSE]}$`);G("LONECARET","(?:\\^)");G("CARETTRIM",`(\\s*)${k[R.LONECARET]}\\s+`,!0);Ir.caretTrimReplace="$1^";G("CARET",`^${k[R.LONECARET]}${k[R.XRANGEPLAIN]}$`);G("CARETLOOSE",`^${k[R.LONECARET]}${k[R.XRANGEPLAINLOOSE]}$`);G("COMPARATORLOOSE",`^${k[R.GTLT]}\\s*(${k[R.LOOSEPLAIN]})$|^$`);G("COMPARATOR",`^${k[R.GTLT]}\\s*(${k[R.FULLPLAIN]})$|^$`);G("COMPARATORTRIM",`(\\s*)${k[R.GTLT]}\\s*(${k[R.LOOSEPLAIN]}|${k[R.XRANGEPLAIN]})`,!0);Ir.comparatorTrimReplace="$1$2$3";G("HYPHENRANGE",`^\\s*(${k[R.XRANGEPLAIN]})\\s+-\\s+(${k[R.XRANGEPLAIN]})\\s*$`);G("HYPHENRANGELOOSE",`^\\s*(${k[R.XRANGEPLAINLOOSE]})\\s+-\\s+(${k[R.XRANGEPLAINLOOSE]})\\s*$`);G("STAR","(<|>)?=?\\s*\\*");G("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$");G("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")});var jo=N((hR,Kf)=>{var Qv=Object.freeze({loose:!0}),e0=Object.freeze({}),t0=n=>n?typeof n!="object"?Qv:n:e0;Kf.exports=t0});var ul=N((fR,Wf)=>{var Zf=/^[0-9]+$/,Jf=(n,e)=>{let t=Zf.test(n),r=Zf.test(e);return t&&r&&(n=+n,e=+e),n===e?0:t&&!r?-1:r&&!t?1:n<e?-1:1},r0=(n,e)=>Jf(e,n);Wf.exports={compareIdentifiers:Jf,rcompareIdentifiers:r0}});var ze=N((pR,ep)=>{var Lo=oi(),{MAX_LENGTH:Yf,MAX_SAFE_INTEGER:Do}=ii(),{safeRe:Xf,t:Qf}=us(),n0=jo(),{compareIdentifiers:cs}=ul(),cl=class n{constructor(e,t){if(t=n0(t),e instanceof n){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>Yf)throw new TypeError(`version is longer than ${Yf} characters`);Lo("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;let r=e.trim().match(t.loose?Xf[Qf.LOOSE]:Xf[Qf.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>Do||this.major<0)throw new TypeError("Invalid major version");if(this.minor>Do||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>Do||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(a=>{if(/^[0-9]+$/.test(a)){let s=+a;if(s>=0&&s<Do)return s}return a}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(Lo("SemVer.compare",this.version,this.options,e),!(e instanceof n)){if(typeof e=="string"&&e===this.version)return 0;e=new n(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof n||(e=new n(e,this.options)),cs(this.major,e.major)||cs(this.minor,e.minor)||cs(this.patch,e.patch)}comparePre(e){if(e instanceof n||(e=new n(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{let r=this.prerelease[t],a=e.prerelease[t];if(Lo("prerelease compare",t,r,a),r===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(r===void 0)return-1;if(r===a)continue;return cs(r,a)}while(++t)}compareBuild(e){e instanceof n||(e=new n(e,this.options));let t=0;do{let r=this.build[t],a=e.build[t];if(Lo("build compare",t,r,a),r===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(r===void 0)return-1;if(r===a)continue;return cs(r,a)}while(++t)}inc(e,t,r){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{let a=Number(r)?1:0;if(!t&&r===!1)throw new Error("invalid increment argument: identifier is empty");if(this.prerelease.length===0)this.prerelease=[a];else{let s=this.prerelease.length;for(;--s>=0;)typeof this.prerelease[s]=="number"&&(this.prerelease[s]++,s=-2);if(s===-1){if(t===this.prerelease.join(".")&&r===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(a)}}if(t){let s=[t,a];r===!1&&(s=[t]),cs(this.prerelease[0],t)===0?isNaN(this.prerelease[1])&&(this.prerelease=s):this.prerelease=s}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};ep.exports=cl});var Wn=N((mR,rp)=>{var tp=ze(),a0=(n,e,t=!1)=>{if(n instanceof tp)return n;try{return new tp(n,e)}catch(r){if(!t)return null;throw r}};rp.exports=a0});var ap=N((gR,np)=>{var s0=Wn(),i0=(n,e)=>{let t=s0(n,e);return t?t.version:null};np.exports=i0});var ip=N((yR,sp)=>{var o0=Wn(),u0=(n,e)=>{let t=o0(n.trim().replace(/^[=v]+/,""),e);return t?t.version:null};sp.exports=u0});var cp=N((bR,up)=>{var op=ze(),c0=(n,e,t,r,a)=>{typeof t=="string"&&(a=r,r=t,t=void 0);try{return new op(n instanceof op?n.version:n,t).inc(e,r,a).version}catch(s){return null}};up.exports=c0});var hp=N((_R,dp)=>{var lp=Wn(),l0=(n,e)=>{let t=lp(n,null,!0),r=lp(e,null,!0),a=t.compare(r);if(a===0)return null;let s=a>0,i=s?t:r,o=s?r:t,u=!!i.prerelease.length;if(!!o.prerelease.length&&!u)return!o.patch&&!o.minor?"major":i.patch?"patch":i.minor?"minor":"major";let l=u?"pre":"";return t.major!==r.major?l+"major":t.minor!==r.minor?l+"minor":t.patch!==r.patch?l+"patch":"prerelease"};dp.exports=l0});var pp=N((wR,fp)=>{var d0=ze(),h0=(n,e)=>new d0(n,e).major;fp.exports=h0});var gp=N((vR,mp)=>{var f0=ze(),p0=(n,e)=>new f0(n,e).minor;mp.exports=p0});var bp=N((AR,yp)=>{var m0=ze(),g0=(n,e)=>new m0(n,e).patch;yp.exports=g0});var wp=N((ER,_p)=>{var y0=Wn(),b0=(n,e)=>{let t=y0(n,e);return t&&t.prerelease.length?t.prerelease:null};_p.exports=b0});var Pt=N((OR,Ap)=>{var vp=ze(),_0=(n,e,t)=>new vp(n,t).compare(new vp(e,t));Ap.exports=_0});var Op=N((xR,Ep)=>{var w0=Pt(),v0=(n,e,t)=>w0(e,n,t);Ep.exports=v0});var Ip=N((IR,xp)=>{var A0=Pt(),E0=(n,e)=>A0(n,e,!0);xp.exports=E0});var Mo=N((PR,Tp)=>{var Pp=ze(),O0=(n,e,t)=>{let r=new Pp(n,t),a=new Pp(e,t);return r.compare(a)||r.compareBuild(a)};Tp.exports=O0});var Cp=N((TR,Sp)=>{var x0=Mo(),I0=(n,e)=>n.sort((t,r)=>x0(t,r,e));Sp.exports=I0});var Rp=N((SR,kp)=>{var P0=Mo(),T0=(n,e)=>n.sort((t,r)=>P0(r,t,e));kp.exports=T0});var ui=N((CR,Np)=>{var S0=Pt(),C0=(n,e,t)=>S0(n,e,t)>0;Np.exports=C0});var Fo=N((kR,$p)=>{var k0=Pt(),R0=(n,e,t)=>k0(n,e,t)<0;$p.exports=R0});var ll=N((RR,jp)=>{var N0=Pt(),$0=(n,e,t)=>N0(n,e,t)===0;jp.exports=$0});var dl=N((NR,Lp)=>{var j0=Pt(),L0=(n,e,t)=>j0(n,e,t)!==0;Lp.exports=L0});var Uo=N(($R,Dp)=>{var D0=Pt(),M0=(n,e,t)=>D0(n,e,t)>=0;Dp.exports=M0});var zo=N((jR,Mp)=>{var F0=Pt(),U0=(n,e,t)=>F0(n,e,t)<=0;Mp.exports=U0});var hl=N((LR,Fp)=>{var z0=ll(),B0=dl(),q0=ui(),H0=Uo(),V0=Fo(),G0=zo(),K0=(n,e,t,r)=>{switch(e){case"===":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n===t;case"!==":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n!==t;case"":case"=":case"==":return z0(n,t,r);case"!=":return B0(n,t,r);case">":return q0(n,t,r);case">=":return H0(n,t,r);case"<":return V0(n,t,r);case"<=":return G0(n,t,r);default:throw new TypeError(`Invalid operator: ${e}`)}};Fp.exports=K0});var zp=N((DR,Up)=>{var Z0=ze(),J0=Wn(),{safeRe:Bo,t:qo}=us(),W0=(n,e)=>{if(n instanceof Z0)return n;if(typeof n=="number"&&(n=String(n)),typeof n!="string")return null;e=e||{};let t=null;if(!e.rtl)t=n.match(e.includePrerelease?Bo[qo.COERCEFULL]:Bo[qo.COERCE]);else{let u=e.includePrerelease?Bo[qo.COERCERTLFULL]:Bo[qo.COERCERTL],c;for(;(c=u.exec(n))&&(!t||t.index+t[0].length!==n.length);)(!t||c.index+c[0].length!==t.index+t[0].length)&&(t=c),u.lastIndex=c.index+c[1].length+c[2].length;u.lastIndex=-1}if(t===null)return null;let r=t[2],a=t[3]||"0",s=t[4]||"0",i=e.includePrerelease&&t[5]?`-${t[5]}`:"",o=e.includePrerelease&&t[6]?`+${t[6]}`:"";return J0(`${r}.${a}.${s}${i}${o}`,e)};Up.exports=W0});var qp=N((MR,Bp)=>{var fl=class{constructor(){this.max=1e3,this.map=new Map}get(e){let t=this.map.get(e);if(t!==void 0)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&t!==void 0){if(this.map.size>=this.max){let a=this.map.keys().next().value;this.delete(a)}this.map.set(e,t)}return this}};Bp.exports=fl});var Tt=N((FR,Kp)=>{var Y0=/\s+/g,pl=class n{constructor(e,t){if(t=Q0(t),e instanceof n)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new n(e.raw,t);if(e instanceof ml)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(Y0," "),this.set=this.raw.split("||").map(r=>this.parseRange(r.trim())).filter(r=>r.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){let r=this.set[0];if(this.set=this.set.filter(a=>!Vp(a[0])),this.set.length===0)this.set=[r];else if(this.set.length>1){for(let a of this.set)if(a.length===1&&iA(a[0])){this.set=[a];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");let t=this.set[e];for(let r=0;r<t.length;r++)r>0&&(this.formatted+=" "),this.formatted+=t[r].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){let r=((this.options.includePrerelease&&aA)|(this.options.loose&&sA))+":"+e,a=Hp.get(r);if(a)return a;let s=this.options.loose,i=s?at[Ze.HYPHENRANGELOOSE]:at[Ze.HYPHENRANGE];e=e.replace(i,gA(this.options.includePrerelease)),le("hyphen replace",e),e=e.replace(at[Ze.COMPARATORTRIM],tA),le("comparator trim",e),e=e.replace(at[Ze.TILDETRIM],rA),le("tilde trim",e),e=e.replace(at[Ze.CARETTRIM],nA),le("caret trim",e);let o=e.split(" ").map(d=>oA(d,this.options)).join(" ").split(/\s+/).map(d=>mA(d,this.options));s&&(o=o.filter(d=>(le("loose invalid filter",d,this.options),!!d.match(at[Ze.COMPARATORLOOSE])))),le("range list",o);let u=new Map,c=o.map(d=>new ml(d,this.options));for(let d of c){if(Vp(d))return[d];u.set(d.value,d)}u.size>1&&u.has("")&&u.delete("");let l=[...u.values()];return Hp.set(r,l),l}intersects(e,t){if(!(e instanceof n))throw new TypeError("a Range is required");return this.set.some(r=>Gp(r,t)&&e.set.some(a=>Gp(a,t)&&r.every(s=>a.every(i=>s.intersects(i,t)))))}test(e){if(!e)return!1;if(typeof e=="string")try{e=new eA(e,this.options)}catch(t){return!1}for(let t=0;t<this.set.length;t++)if(yA(this.set[t],e,this.options))return!0;return!1}};Kp.exports=pl;var X0=qp(),Hp=new X0,Q0=jo(),ml=ci(),le=oi(),eA=ze(),{safeRe:at,t:Ze,comparatorTrimReplace:tA,tildeTrimReplace:rA,caretTrimReplace:nA}=us(),{FLAG_INCLUDE_PRERELEASE:aA,FLAG_LOOSE:sA}=ii(),Vp=n=>n.value==="<0.0.0-0",iA=n=>n.value==="",Gp=(n,e)=>{let t=!0,r=n.slice(),a=r.pop();for(;t&&r.length;)t=r.every(s=>a.intersects(s,e)),a=r.pop();return t},oA=(n,e)=>(le("comp",n,e),n=lA(n,e),le("caret",n),n=uA(n,e),le("tildes",n),n=hA(n,e),le("xrange",n),n=pA(n,e),le("stars",n),n),Je=n=>!n||n.toLowerCase()==="x"||n==="*",uA=(n,e)=>n.trim().split(/\s+/).map(t=>cA(t,e)).join(" "),cA=(n,e)=>{let t=e.loose?at[Ze.TILDELOOSE]:at[Ze.TILDE];return n.replace(t,(r,a,s,i,o)=>{le("tilde",n,r,a,s,i,o);let u;return Je(a)?u="":Je(s)?u=`>=${a}.0.0 <${+a+1}.0.0-0`:Je(i)?u=`>=${a}.${s}.0 <${a}.${+s+1}.0-0`:o?(le("replaceTilde pr",o),u=`>=${a}.${s}.${i}-${o} <${a}.${+s+1}.0-0`):u=`>=${a}.${s}.${i} <${a}.${+s+1}.0-0`,le("tilde return",u),u})},lA=(n,e)=>n.trim().split(/\s+/).map(t=>dA(t,e)).join(" "),dA=(n,e)=>{le("caret",n,e);let t=e.loose?at[Ze.CARETLOOSE]:at[Ze.CARET],r=e.includePrerelease?"-0":"";return n.replace(t,(a,s,i,o,u)=>{le("caret",n,a,s,i,o,u);let c;return Je(s)?c="":Je(i)?c=`>=${s}.0.0${r} <${+s+1}.0.0-0`:Je(o)?s==="0"?c=`>=${s}.${i}.0${r} <${s}.${+i+1}.0-0`:c=`>=${s}.${i}.0${r} <${+s+1}.0.0-0`:u?(le("replaceCaret pr",u),s==="0"?i==="0"?c=`>=${s}.${i}.${o}-${u} <${s}.${i}.${+o+1}-0`:c=`>=${s}.${i}.${o}-${u} <${s}.${+i+1}.0-0`:c=`>=${s}.${i}.${o}-${u} <${+s+1}.0.0-0`):(le("no pr"),s==="0"?i==="0"?c=`>=${s}.${i}.${o}${r} <${s}.${i}.${+o+1}-0`:c=`>=${s}.${i}.${o}${r} <${s}.${+i+1}.0-0`:c=`>=${s}.${i}.${o} <${+s+1}.0.0-0`),le("caret return",c),c})},hA=(n,e)=>(le("replaceXRanges",n,e),n.split(/\s+/).map(t=>fA(t,e)).join(" ")),fA=(n,e)=>{n=n.trim();let t=e.loose?at[Ze.XRANGELOOSE]:at[Ze.XRANGE];return n.replace(t,(r,a,s,i,o,u)=>{le("xRange",n,r,a,s,i,o,u);let c=Je(s),l=c||Je(i),d=l||Je(o),h=d;return a==="="&&h&&(a=""),u=e.includePrerelease?"-0":"",c?a===">"||a==="<"?r="<0.0.0-0":r="*":a&&h?(l&&(i=0),o=0,a===">"?(a=">=",l?(s=+s+1,i=0,o=0):(i=+i+1,o=0)):a==="<="&&(a="<",l?s=+s+1:i=+i+1),a==="<"&&(u="-0"),r=`${a+s}.${i}.${o}${u}`):l?r=`>=${s}.0.0${u} <${+s+1}.0.0-0`:d&&(r=`>=${s}.${i}.0${u} <${s}.${+i+1}.0-0`),le("xRange return",r),r})},pA=(n,e)=>(le("replaceStars",n,e),n.trim().replace(at[Ze.STAR],"")),mA=(n,e)=>(le("replaceGTE0",n,e),n.trim().replace(at[e.includePrerelease?Ze.GTE0PRE:Ze.GTE0],"")),gA=n=>(e,t,r,a,s,i,o,u,c,l,d,h)=>(Je(r)?t="":Je(a)?t=`>=${r}.0.0${n?"-0":""}`:Je(s)?t=`>=${r}.${a}.0${n?"-0":""}`:i?t=`>=${t}`:t=`>=${t}${n?"-0":""}`,Je(c)?u="":Je(l)?u=`<${+c+1}.0.0-0`:Je(d)?u=`<${c}.${+l+1}.0-0`:h?u=`<=${c}.${l}.${d}-${h}`:n?u=`<${c}.${l}.${+d+1}-0`:u=`<=${u}`,`${t} ${u}`.trim()),yA=(n,e,t)=>{for(let r=0;r<n.length;r++)if(!n[r].test(e))return!1;if(e.prerelease.length&&!t.includePrerelease){for(let r=0;r<n.length;r++)if(le(n[r].semver),n[r].semver!==ml.ANY&&n[r].semver.prerelease.length>0){let a=n[r].semver;if(a.major===e.major&&a.minor===e.minor&&a.patch===e.patch)return!0}return!1}return!0}});var ci=N((UR,Qp)=>{var li=Symbol("SemVer ANY"),bl=class n{static get ANY(){return li}constructor(e,t){if(t=Zp(t),e instanceof n){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),yl("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===li?this.value="":this.value=this.operator+this.semver.version,yl("comp",this)}parse(e){let t=this.options.loose?Jp[Wp.COMPARATORLOOSE]:Jp[Wp.COMPARATOR],r=e.match(t);if(!r)throw new TypeError(`Invalid comparator: ${e}`);this.operator=r[1]!==void 0?r[1]:"",this.operator==="="&&(this.operator=""),r[2]?this.semver=new Yp(r[2],this.options.loose):this.semver=li}toString(){return this.value}test(e){if(yl("Comparator.test",e,this.options.loose),this.semver===li||e===li)return!0;if(typeof e=="string")try{e=new Yp(e,this.options)}catch(t){return!1}return gl(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof n))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new Xp(e.value,t).test(this.value):e.operator===""?e.value===""?!0:new Xp(this.value,t).test(e.semver):(t=Zp(t),t.includePrerelease&&(this.value==="<0.0.0-0"||e.value==="<0.0.0-0")||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&e.operator.startsWith(">")||this.operator.startsWith("<")&&e.operator.startsWith("<")||this.semver.version===e.semver.version&&this.operator.includes("=")&&e.operator.includes("=")||gl(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<")||gl(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}};Qp.exports=bl;var Zp=jo(),{safeRe:Jp,t:Wp}=us(),gl=hl(),yl=oi(),Yp=ze(),Xp=Tt()});var di=N((zR,em)=>{var bA=Tt(),_A=(n,e,t)=>{try{e=new bA(e,t)}catch(r){return!1}return e.test(n)};em.exports=_A});var rm=N((BR,tm)=>{var wA=Tt(),vA=(n,e)=>new wA(n,e).set.map(t=>t.map(r=>r.value).join(" ").trim().split(" "));tm.exports=vA});var am=N((qR,nm)=>{var AA=ze(),EA=Tt(),OA=(n,e,t)=>{let r=null,a=null,s=null;try{s=new EA(e,t)}catch(i){return null}return n.forEach(i=>{s.test(i)&&(!r||a.compare(i)===-1)&&(r=i,a=new AA(r,t))}),r};nm.exports=OA});var im=N((HR,sm)=>{var xA=ze(),IA=Tt(),PA=(n,e,t)=>{let r=null,a=null,s=null;try{s=new IA(e,t)}catch(i){return null}return n.forEach(i=>{s.test(i)&&(!r||a.compare(i)===1)&&(r=i,a=new xA(r,t))}),r};sm.exports=PA});var cm=N((VR,um)=>{var _l=ze(),TA=Tt(),om=ui(),SA=(n,e)=>{n=new TA(n,e);let t=new _l("0.0.0");if(n.test(t)||(t=new _l("0.0.0-0"),n.test(t)))return t;t=null;for(let r=0;r<n.set.length;++r){let a=n.set[r],s=null;a.forEach(i=>{let o=new _l(i.semver.version);switch(i.operator){case">":o.prerelease.length===0?o.patch++:o.prerelease.push(0),o.raw=o.format();case"":case">=":(!s||om(o,s))&&(s=o);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${i.operator}`)}}),s&&(!t||om(t,s))&&(t=s)}return t&&n.test(t)?t:null};um.exports=SA});var dm=N((GR,lm)=>{var CA=Tt(),kA=(n,e)=>{try{return new CA(n,e).range||"*"}catch(t){return null}};lm.exports=kA});var Ho=N((KR,mm)=>{var RA=ze(),pm=ci(),{ANY:NA}=pm,$A=Tt(),jA=di(),hm=ui(),fm=Fo(),LA=zo(),DA=Uo(),MA=(n,e,t,r)=>{n=new RA(n,r),e=new $A(e,r);let a,s,i,o,u;switch(t){case">":a=hm,s=LA,i=fm,o=">",u=">=";break;case"<":a=fm,s=DA,i=hm,o="<",u="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(jA(n,e,r))return!1;for(let c=0;c<e.set.length;++c){let l=e.set[c],d=null,h=null;if(l.forEach(f=>{f.semver===NA&&(f=new pm(">=0.0.0")),d=d||f,h=h||f,a(f.semver,d.semver,r)?d=f:i(f.semver,h.semver,r)&&(h=f)}),d.operator===o||d.operator===u||(!h.operator||h.operator===o)&&s(n,h.semver))return!1;if(h.operator===u&&i(n,h.semver))return!1}return!0};mm.exports=MA});var ym=N((ZR,gm)=>{var FA=Ho(),UA=(n,e,t)=>FA(n,e,">",t);gm.exports=UA});var _m=N((JR,bm)=>{var zA=Ho(),BA=(n,e,t)=>zA(n,e,"<",t);bm.exports=BA});var Am=N((WR,vm)=>{var wm=Tt(),qA=(n,e,t)=>(n=new wm(n,t),e=new wm(e,t),n.intersects(e,t));vm.exports=qA});var Om=N((YR,Em)=>{var HA=di(),VA=Pt();Em.exports=(n,e,t)=>{let r=[],a=null,s=null,i=n.sort((l,d)=>VA(l,d,t));for(let l of i)HA(l,e,t)?(s=l,a||(a=l)):(s&&r.push([a,s]),s=null,a=null);a&&r.push([a,null]);let o=[];for(let[l,d]of r)l===d?o.push(l):!d&&l===i[0]?o.push("*"):d?l===i[0]?o.push(`<=${d}`):o.push(`${l} - ${d}`):o.push(`>=${l}`);let u=o.join(" || "),c=typeof e.raw=="string"?e.raw:String(e);return u.length<c.length?u:e}});var Cm=N((XR,Sm)=>{var xm=Tt(),vl=ci(),{ANY:wl}=vl,hi=di(),Al=Pt(),GA=(n,e,t={})=>{if(n===e)return!0;n=new xm(n,t),e=new xm(e,t);let r=!1;e:for(let a of n.set){for(let s of e.set){let i=ZA(a,s,t);if(r=r||i!==null,i)continue e}if(r)return!1}return!0},KA=[new vl(">=0.0.0-0")],Im=[new vl(">=0.0.0")],ZA=(n,e,t)=>{if(n===e)return!0;if(n.length===1&&n[0].semver===wl){if(e.length===1&&e[0].semver===wl)return!0;t.includePrerelease?n=KA:n=Im}if(e.length===1&&e[0].semver===wl){if(t.includePrerelease)return!0;e=Im}let r=new Set,a,s;for(let f of n)f.operator===">"||f.operator===">="?a=Pm(a,f,t):f.operator==="<"||f.operator==="<="?s=Tm(s,f,t):r.add(f.semver);if(r.size>1)return null;let i;if(a&&s){if(i=Al(a.semver,s.semver,t),i>0)return null;if(i===0&&(a.operator!==">="||s.operator!=="<="))return null}for(let f of r){if(a&&!hi(f,String(a),t)||s&&!hi(f,String(s),t))return null;for(let p of e)if(!hi(f,String(p),t))return!1;return!0}let o,u,c,l,d=s&&!t.includePrerelease&&s.semver.prerelease.length?s.semver:!1,h=a&&!t.includePrerelease&&a.semver.prerelease.length?a.semver:!1;d&&d.prerelease.length===1&&s.operator==="<"&&d.prerelease[0]===0&&(d=!1);for(let f of e){if(l=l||f.operator===">"||f.operator===">=",c=c||f.operator==="<"||f.operator==="<=",a){if(h&&f.semver.prerelease&&f.semver.prerelease.length&&f.semver.major===h.major&&f.semver.minor===h.minor&&f.semver.patch===h.patch&&(h=!1),f.operator===">"||f.operator===">="){if(o=Pm(a,f,t),o===f&&o!==a)return!1}else if(a.operator===">="&&!hi(a.semver,String(f),t))return!1}if(s){if(d&&f.semver.prerelease&&f.semver.prerelease.length&&f.semver.major===d.major&&f.semver.minor===d.minor&&f.semver.patch===d.patch&&(d=!1),f.operator==="<"||f.operator==="<="){if(u=Tm(s,f,t),u===f&&u!==s)return!1}else if(s.operator==="<="&&!hi(s.semver,String(f),t))return!1}if(!f.operator&&(s||a)&&i!==0)return!1}return!(a&&c&&!s&&i!==0||s&&l&&!a&&i!==0||h||d)},Pm=(n,e,t)=>{if(!n)return e;let r=Al(n.semver,e.semver,t);return r>0?n:r<0||e.operator===">"&&n.operator===">="?e:n},Tm=(n,e,t)=>{if(!n)return e;let r=Al(n.semver,e.semver,t);return r<0?n:r>0||e.operator==="<"&&n.operator==="<="?e:n};Sm.exports=GA});var $m=N((QR,Nm)=>{var El=us(),km=ii(),JA=ze(),Rm=ul(),WA=Wn(),YA=ap(),XA=ip(),QA=cp(),eE=hp(),tE=pp(),rE=gp(),nE=bp(),aE=wp(),sE=Pt(),iE=Op(),oE=Ip(),uE=Mo(),cE=Cp(),lE=Rp(),dE=ui(),hE=Fo(),fE=ll(),pE=dl(),mE=Uo(),gE=zo(),yE=hl(),bE=zp(),_E=ci(),wE=Tt(),vE=di(),AE=rm(),EE=am(),OE=im(),xE=cm(),IE=dm(),PE=Ho(),TE=ym(),SE=_m(),CE=Am(),kE=Om(),RE=Cm();Nm.exports={parse:WA,valid:YA,clean:XA,inc:QA,diff:eE,major:tE,minor:rE,patch:nE,prerelease:aE,compare:sE,rcompare:iE,compareLoose:oE,compareBuild:uE,sort:cE,rsort:lE,gt:dE,lt:hE,eq:fE,neq:pE,gte:mE,lte:gE,cmp:yE,coerce:bE,Comparator:_E,Range:wE,satisfies:vE,toComparators:AE,maxSatisfying:EE,minSatisfying:OE,minVersion:xE,validRange:IE,outside:PE,gtr:TE,ltr:SE,intersects:CE,simplifyRange:kE,subset:RE,SemVer:JA,re:El.re,src:El.src,tokens:El.t,SEMVER_SPEC_VERSION:km.SEMVER_SPEC_VERSION,RELEASE_TYPES:km.RELEASE_TYPES,compareIdentifiers:Rm.compareIdentifiers,rcompareIdentifiers:Rm.rcompareIdentifiers}});var Ym=N((XN,Wm)=>{"use strict";var Zm=(n=0)=>e=>`\x1B[${38+n};5;${e}m`,Jm=(n=0)=>(e,t,r)=>`\x1B[${38+n};2;${e};${t};${r}m`;function fO(){let n=new Map,e={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};e.color.gray=e.color.blackBright,e.bgColor.bgGray=e.bgColor.bgBlackBright,e.color.grey=e.color.blackBright,e.bgColor.bgGrey=e.bgColor.bgBlackBright;for(let[t,r]of Object.entries(e)){for(let[a,s]of Object.entries(r))e[a]={open:`\x1B[${s[0]}m`,close:`\x1B[${s[1]}m`},r[a]=e[a],n.set(s[0],s[1]);Object.defineProperty(e,t,{value:r,enumerable:!1})}return Object.defineProperty(e,"codes",{value:n,enumerable:!1}),e.color.close="\x1B[39m",e.bgColor.close="\x1B[49m",e.color.ansi256=Zm(),e.color.ansi16m=Jm(),e.bgColor.ansi256=Zm(10),e.bgColor.ansi16m=Jm(10),Object.defineProperties(e,{rgbToAnsi256:{value:(t,r,a)=>t===r&&r===a?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(r/255*5)+Math.round(a/255*5),enumerable:!1},hexToRgb:{value:t=>{let r=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(t.toString(16));if(!r)return[0,0,0];let{colorString:a}=r.groups;a.length===3&&(a=a.split("").map(i=>i+i).join(""));let s=Number.parseInt(a,16);return[s>>16&255,s>>8&255,s&255]},enumerable:!1},hexToAnsi256:{value:t=>e.rgbToAnsi256(...e.hexToRgb(t)),enumerable:!1}}),e}Object.defineProperty(Wm,"exports",{enumerable:!0,get:fO})});var Qg=N(Tu=>{"use strict";Tu.byteLength=zO;Tu.toByteArray=qO;Tu.fromByteArray=GO;var lr=[],Rt=[],UO=typeof Uint8Array!="undefined"?Uint8Array:Array,id="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(ra=0,Yg=id.length;ra<Yg;++ra)lr[ra]=id[ra],Rt[id.charCodeAt(ra)]=ra;var ra,Yg;Rt[45]=62;Rt[95]=63;function Xg(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function zO(n){var e=Xg(n),t=e[0],r=e[1];return(t+r)*3/4-r}function BO(n,e,t){return(e+t)*3/4-t}function qO(n){var e,t=Xg(n),r=t[0],a=t[1],s=new UO(BO(n,r,a)),i=0,o=a>0?r-4:r,u;for(u=0;u<o;u+=4)e=Rt[n.charCodeAt(u)]<<18|Rt[n.charCodeAt(u+1)]<<12|Rt[n.charCodeAt(u+2)]<<6|Rt[n.charCodeAt(u+3)],s[i++]=e>>16&255,s[i++]=e>>8&255,s[i++]=e&255;return a===2&&(e=Rt[n.charCodeAt(u)]<<2|Rt[n.charCodeAt(u+1)]>>4,s[i++]=e&255),a===1&&(e=Rt[n.charCodeAt(u)]<<10|Rt[n.charCodeAt(u+1)]<<4|Rt[n.charCodeAt(u+2)]>>2,s[i++]=e>>8&255,s[i++]=e&255),s}function HO(n){return lr[n>>18&63]+lr[n>>12&63]+lr[n>>6&63]+lr[n&63]}function VO(n,e,t){for(var r,a=[],s=e;s<t;s+=3)r=(n[s]<<16&16711680)+(n[s+1]<<8&65280)+(n[s+2]&255),a.push(HO(r));return a.join("")}function GO(n){for(var e,t=n.length,r=t%3,a=[],s=16383,i=0,o=t-r;i<o;i+=s)a.push(VO(n,i,i+s>o?o:i+s));return r===1?(e=n[t-1],a.push(lr[e>>2]+lr[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],a.push(lr[e>>10]+lr[e>>4&63]+lr[e<<2&63]+"=")),a.join("")}});var Nb=N((kq,xs)=>{var P=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},oe=-1,ce=1,J=0;P.Diff=function(n,e){return[n,e]};P.prototype.diff_main=function(n,e,t,r){typeof r=="undefined"&&(this.Diff_Timeout<=0?r=Number.MAX_VALUE:r=new Date().getTime()+this.Diff_Timeout*1e3);var a=r;if(n==null||e==null)throw new Error("Null input. (diff_main)");if(n==e)return n?[new P.Diff(J,n)]:[];typeof t=="undefined"&&(t=!0);var s=t,i=this.diff_commonPrefix(n,e),o=n.substring(0,i);n=n.substring(i),e=e.substring(i),i=this.diff_commonSuffix(n,e);var u=n.substring(n.length-i);n=n.substring(0,n.length-i),e=e.substring(0,e.length-i);var c=this.diff_compute_(n,e,s,a);return o&&c.unshift(new P.Diff(J,o)),u&&c.push(new P.Diff(J,u)),this.diff_cleanupMerge(c),c};P.prototype.diff_compute_=function(n,e,t,r){var a;if(!n)return[new P.Diff(ce,e)];if(!e)return[new P.Diff(oe,n)];var s=n.length>e.length?n:e,i=n.length>e.length?e:n,o=s.indexOf(i);if(o!=-1)return a=[new P.Diff(ce,s.substring(0,o)),new P.Diff(J,i),new P.Diff(ce,s.substring(o+i.length))],n.length>e.length&&(a[0][0]=a[2][0]=oe),a;if(i.length==1)return[new P.Diff(oe,n),new P.Diff(ce,e)];var u=this.diff_halfMatch_(n,e);if(u){var c=u[0],l=u[1],d=u[2],h=u[3],f=u[4],p=this.diff_main(c,d,t,r),m=this.diff_main(l,h,t,r);return p.concat([new P.Diff(J,f)],m)}return t&&n.length>100&&e.length>100?this.diff_lineMode_(n,e,r):this.diff_bisect_(n,e,r)};P.prototype.diff_lineMode_=function(n,e,t){var r=this.diff_linesToChars_(n,e);n=r.chars1,e=r.chars2;var a=r.lineArray,s=this.diff_main(n,e,!1,t);this.diff_charsToLines_(s,a),this.diff_cleanupSemantic(s),s.push(new P.Diff(J,""));for(var i=0,o=0,u=0,c="",l="";i<s.length;){switch(s[i][0]){case ce:u++,l+=s[i][1];break;case oe:o++,c+=s[i][1];break;case J:if(o>=1&&u>=1){s.splice(i-o-u,o+u),i=i-o-u;for(var d=this.diff_main(c,l,!1,t),h=d.length-1;h>=0;h--)s.splice(i,0,d[h]);i=i+d.length}u=0,o=0,c="",l="";break}i++}return s.pop(),s};P.prototype.diff_bisect_=function(n,e,t){for(var r=n.length,a=e.length,s=Math.ceil((r+a)/2),i=s,o=2*s,u=new Array(o),c=new Array(o),l=0;l<o;l++)u[l]=-1,c[l]=-1;u[i+1]=0,c[i+1]=0;for(var d=r-a,h=d%2!=0,f=0,p=0,m=0,g=0,y=0;y<s&&!(new Date().getTime()>t);y++){for(var b=-y+f;b<=y-p;b+=2){var A=i+b,x;b==-y||b!=y&&u[A-1]<u[A+1]?x=u[A+1]:x=u[A-1]+1;for(var _=x-b;x<r&&_<a&&n.charAt(x)==e.charAt(_);)x++,_++;if(u[A]=x,x>r)p+=2;else if(_>a)f+=2;else if(h){var v=i+d-b;if(v>=0&&v<o&&c[v]!=-1){var E=r-c[v];if(x>=E)return this.diff_bisectSplit_(n,e,x,_,t)}}}for(var O=-y+m;O<=y-g;O+=2){var v=i+O,E;O==-y||O!=y&&c[v-1]<c[v+1]?E=c[v+1]:E=c[v-1]+1;for(var S=E-O;E<r&&S<a&&n.charAt(r-E-1)==e.charAt(a-S-1);)E++,S++;if(c[v]=E,E>r)g+=2;else if(S>a)m+=2;else if(!h){var A=i+d-O;if(A>=0&&A<o&&u[A]!=-1){var x=u[A],_=i+x-A;if(E=r-E,x>=E)return this.diff_bisectSplit_(n,e,x,_,t)}}}}return[new P.Diff(oe,n),new P.Diff(ce,e)]};P.prototype.diff_bisectSplit_=function(n,e,t,r,a){var s=n.substring(0,t),i=e.substring(0,r),o=n.substring(t),u=e.substring(r),c=this.diff_main(s,i,!1,a),l=this.diff_main(o,u,!1,a);return c.concat(l)};P.prototype.diff_linesToChars_=function(n,e){var t=[],r={};t[0]="";function a(u){for(var c="",l=0,d=-1,h=t.length;d<u.length-1;){d=u.indexOf(`
`,l),d==-1&&(d=u.length-1);var f=u.substring(l,d+1);(r.hasOwnProperty?r.hasOwnProperty(f):r[f]!==void 0)?c+=String.fromCharCode(r[f]):(h==s&&(f=u.substring(l),d=u.length),c+=String.fromCharCode(h),r[f]=h,t[h++]=f),l=d+1}return c}var s=4e4,i=a(n);s=65535;var o=a(e);return{chars1:i,chars2:o,lineArray:t}};P.prototype.diff_charsToLines_=function(n,e){for(var t=0;t<n.length;t++){for(var r=n[t][1],a=[],s=0;s<r.length;s++)a[s]=e[r.charCodeAt(s)];n[t][1]=a.join("")}};P.prototype.diff_commonPrefix=function(n,e){if(!n||!e||n.charAt(0)!=e.charAt(0))return 0;for(var t=0,r=Math.min(n.length,e.length),a=r,s=0;t<a;)n.substring(s,a)==e.substring(s,a)?(t=a,s=t):r=a,a=Math.floor((r-t)/2+t);return a};P.prototype.diff_commonSuffix=function(n,e){if(!n||!e||n.charAt(n.length-1)!=e.charAt(e.length-1))return 0;for(var t=0,r=Math.min(n.length,e.length),a=r,s=0;t<a;)n.substring(n.length-a,n.length-s)==e.substring(e.length-a,e.length-s)?(t=a,s=t):r=a,a=Math.floor((r-t)/2+t);return a};P.prototype.diff_commonOverlap_=function(n,e){var t=n.length,r=e.length;if(t==0||r==0)return 0;t>r?n=n.substring(t-r):t<r&&(e=e.substring(0,t));var a=Math.min(t,r);if(n==e)return a;for(var s=0,i=1;;){var o=n.substring(a-i),u=e.indexOf(o);if(u==-1)return s;i+=u,(u==0||n.substring(a-i)==e.substring(0,i))&&(s=i,i++)}};P.prototype.diff_halfMatch_=function(n,e){if(this.Diff_Timeout<=0)return null;var t=n.length>e.length?n:e,r=n.length>e.length?e:n;if(t.length<4||r.length*2<t.length)return null;var a=this;function s(p,m,g){for(var y=p.substring(g,g+Math.floor(p.length/4)),b=-1,A="",x,_,v,E;(b=m.indexOf(y,b+1))!=-1;){var O=a.diff_commonPrefix(p.substring(g),m.substring(b)),S=a.diff_commonSuffix(p.substring(0,g),m.substring(0,b));A.length<S+O&&(A=m.substring(b-S,b)+m.substring(b,b+O),x=p.substring(0,g-S),_=p.substring(g+O),v=m.substring(0,b-S),E=m.substring(b+O))}return A.length*2>=p.length?[x,_,v,E,A]:null}var i=s(t,r,Math.ceil(t.length/4)),o=s(t,r,Math.ceil(t.length/2)),u;if(!i&&!o)return null;o?i?u=i[4].length>o[4].length?i:o:u=o:u=i;var c,l,d,h;n.length>e.length?(c=u[0],l=u[1],d=u[2],h=u[3]):(d=u[0],h=u[1],c=u[2],l=u[3]);var f=u[4];return[c,l,d,h,f]};P.prototype.diff_cleanupSemantic=function(n){for(var e=!1,t=[],r=0,a=null,s=0,i=0,o=0,u=0,c=0;s<n.length;)n[s][0]==J?(t[r++]=s,i=u,o=c,u=0,c=0,a=n[s][1]):(n[s][0]==ce?u+=n[s][1].length:c+=n[s][1].length,a&&a.length<=Math.max(i,o)&&a.length<=Math.max(u,c)&&(n.splice(t[r-1],0,new P.Diff(oe,a)),n[t[r-1]+1][0]=ce,r--,r--,s=r>0?t[r-1]:-1,i=0,o=0,u=0,c=0,a=null,e=!0)),s++;for(e&&this.diff_cleanupMerge(n),this.diff_cleanupSemanticLossless(n),s=1;s<n.length;){if(n[s-1][0]==oe&&n[s][0]==ce){var l=n[s-1][1],d=n[s][1],h=this.diff_commonOverlap_(l,d),f=this.diff_commonOverlap_(d,l);h>=f?(h>=l.length/2||h>=d.length/2)&&(n.splice(s,0,new P.Diff(J,d.substring(0,h))),n[s-1][1]=l.substring(0,l.length-h),n[s+1][1]=d.substring(h),s++):(f>=l.length/2||f>=d.length/2)&&(n.splice(s,0,new P.Diff(J,l.substring(0,f))),n[s-1][0]=ce,n[s-1][1]=d.substring(0,d.length-f),n[s+1][0]=oe,n[s+1][1]=l.substring(f),s++),s++}s++}};P.prototype.diff_cleanupSemanticLossless=function(n){function e(f,p){if(!f||!p)return 6;var m=f.charAt(f.length-1),g=p.charAt(0),y=m.match(P.nonAlphaNumericRegex_),b=g.match(P.nonAlphaNumericRegex_),A=y&&m.match(P.whitespaceRegex_),x=b&&g.match(P.whitespaceRegex_),_=A&&m.match(P.linebreakRegex_),v=x&&g.match(P.linebreakRegex_),E=_&&f.match(P.blanklineEndRegex_),O=v&&p.match(P.blanklineStartRegex_);return E||O?5:_||v?4:y&&!A&&x?3:A||x?2:y||b?1:0}for(var t=1;t<n.length-1;){if(n[t-1][0]==J&&n[t+1][0]==J){var r=n[t-1][1],a=n[t][1],s=n[t+1][1],i=this.diff_commonSuffix(r,a);if(i){var o=a.substring(a.length-i);r=r.substring(0,r.length-i),a=o+a.substring(0,a.length-i),s=o+s}for(var u=r,c=a,l=s,d=e(r,a)+e(a,s);a.charAt(0)===s.charAt(0);){r+=a.charAt(0),a=a.substring(1)+s.charAt(0),s=s.substring(1);var h=e(r,a)+e(a,s);h>=d&&(d=h,u=r,c=a,l=s)}n[t-1][1]!=u&&(u?n[t-1][1]=u:(n.splice(t-1,1),t--),n[t][1]=c,l?n[t+1][1]=l:(n.splice(t+1,1),t--))}t++}};P.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/;P.whitespaceRegex_=/\s/;P.linebreakRegex_=/[\r\n]/;P.blanklineEndRegex_=/\n\r?\n$/;P.blanklineStartRegex_=/^\r?\n\r?\n/;P.prototype.diff_cleanupEfficiency=function(n){for(var e=!1,t=[],r=0,a=null,s=0,i=!1,o=!1,u=!1,c=!1;s<n.length;)n[s][0]==J?(n[s][1].length<this.Diff_EditCost&&(u||c)?(t[r++]=s,i=u,o=c,a=n[s][1]):(r=0,a=null),u=c=!1):(n[s][0]==oe?c=!0:u=!0,a&&(i&&o&&u&&c||a.length<this.Diff_EditCost/2&&i+o+u+c==3)&&(n.splice(t[r-1],0,new P.Diff(oe,a)),n[t[r-1]+1][0]=ce,r--,a=null,i&&o?(u=c=!0,r=0):(r--,s=r>0?t[r-1]:-1,u=c=!1),e=!0)),s++;e&&this.diff_cleanupMerge(n)};P.prototype.diff_cleanupMerge=function(n){n.push(new P.Diff(J,""));for(var e=0,t=0,r=0,a="",s="",i;e<n.length;)switch(n[e][0]){case ce:r++,s+=n[e][1],e++;break;case oe:t++,a+=n[e][1],e++;break;case J:t+r>1?(t!==0&&r!==0&&(i=this.diff_commonPrefix(s,a),i!==0&&(e-t-r>0&&n[e-t-r-1][0]==J?n[e-t-r-1][1]+=s.substring(0,i):(n.splice(0,0,new P.Diff(J,s.substring(0,i))),e++),s=s.substring(i),a=a.substring(i)),i=this.diff_commonSuffix(s,a),i!==0&&(n[e][1]=s.substring(s.length-i)+n[e][1],s=s.substring(0,s.length-i),a=a.substring(0,a.length-i))),e-=t+r,n.splice(e,t+r),a.length&&(n.splice(e,0,new P.Diff(oe,a)),e++),s.length&&(n.splice(e,0,new P.Diff(ce,s)),e++),e++):e!==0&&n[e-1][0]==J?(n[e-1][1]+=n[e][1],n.splice(e,1)):e++,r=0,t=0,a="",s="";break}n[n.length-1][1]===""&&n.pop();var o=!1;for(e=1;e<n.length-1;)n[e-1][0]==J&&n[e+1][0]==J&&(n[e][1].substring(n[e][1].length-n[e-1][1].length)==n[e-1][1]?(n[e][1]=n[e-1][1]+n[e][1].substring(0,n[e][1].length-n[e-1][1].length),n[e+1][1]=n[e-1][1]+n[e+1][1],n.splice(e-1,1),o=!0):n[e][1].substring(0,n[e+1][1].length)==n[e+1][1]&&(n[e-1][1]+=n[e+1][1],n[e][1]=n[e][1].substring(n[e+1][1].length)+n[e+1][1],n.splice(e+1,1),o=!0)),e++;o&&this.diff_cleanupMerge(n)};P.prototype.diff_xIndex=function(n,e){var t=0,r=0,a=0,s=0,i;for(i=0;i<n.length&&(n[i][0]!==ce&&(t+=n[i][1].length),n[i][0]!==oe&&(r+=n[i][1].length),!(t>e));i++)a=t,s=r;return n.length!=i&&n[i][0]===oe?s:s+(e-a)};P.prototype.diff_prettyHtml=function(n){for(var e=[],t=/&/g,r=/</g,a=/>/g,s=/\n/g,i=0;i<n.length;i++){var o=n[i][0],u=n[i][1],c=u.replace(t,"&amp;").replace(r,"&lt;").replace(a,"&gt;").replace(s,"&para;<br>");switch(o){case ce:e[i]='<ins style="background:#e6ffe6;">'+c+"</ins>";break;case oe:e[i]='<del style="background:#ffe6e6;">'+c+"</del>";break;case J:e[i]="<span>"+c+"</span>";break}}return e.join("")};P.prototype.diff_text1=function(n){for(var e=[],t=0;t<n.length;t++)n[t][0]!==ce&&(e[t]=n[t][1]);return e.join("")};P.prototype.diff_text2=function(n){for(var e=[],t=0;t<n.length;t++)n[t][0]!==oe&&(e[t]=n[t][1]);return e.join("")};P.prototype.diff_levenshtein=function(n){for(var e=0,t=0,r=0,a=0;a<n.length;a++){var s=n[a][0],i=n[a][1];switch(s){case ce:t+=i.length;break;case oe:r+=i.length;break;case J:e+=Math.max(t,r),t=0,r=0;break}}return e+=Math.max(t,r),e};P.prototype.diff_toDelta=function(n){for(var e=[],t=0;t<n.length;t++)switch(n[t][0]){case ce:e[t]="+"+encodeURI(n[t][1]);break;case oe:e[t]="-"+n[t][1].length;break;case J:e[t]="="+n[t][1].length;break}return e.join("	").replace(/%20/g," ")};P.prototype.diff_fromDelta=function(n,e){for(var t=[],r=0,a=0,s=e.split(/\t/g),i=0;i<s.length;i++){var o=s[i].substring(1);switch(s[i].charAt(0)){case"+":try{t[r++]=new P.Diff(ce,decodeURI(o))}catch(l){throw new Error("Illegal escape in diff_fromDelta: "+o)}break;case"-":case"=":var u=parseInt(o,10);if(isNaN(u)||u<0)throw new Error("Invalid number in diff_fromDelta: "+o);var c=n.substring(a,a+=u);s[i].charAt(0)=="="?t[r++]=new P.Diff(J,c):t[r++]=new P.Diff(oe,c);break;default:if(s[i])throw new Error("Invalid diff operation in diff_fromDelta: "+s[i])}}if(a!=n.length)throw new Error("Delta length ("+a+") does not equal source text length ("+n.length+").");return t};P.prototype.match_main=function(n,e,t){if(n==null||e==null||t==null)throw new Error("Null input. (match_main)");return t=Math.max(0,Math.min(t,n.length)),n==e?0:n.length?n.substring(t,t+e.length)==e?t:this.match_bitap_(n,e,t):-1};P.prototype.match_bitap_=function(n,e,t){if(e.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var r=this.match_alphabet_(e),a=this;function s(x,_){var v=x/e.length,E=Math.abs(t-_);return a.Match_Distance?v+E/a.Match_Distance:E?1:v}var i=this.Match_Threshold,o=n.indexOf(e,t);o!=-1&&(i=Math.min(s(0,o),i),o=n.lastIndexOf(e,t+e.length),o!=-1&&(i=Math.min(s(0,o),i)));var u=1<<e.length-1;o=-1;for(var c,l,d=e.length+n.length,h,f=0;f<e.length;f++){for(c=0,l=d;c<l;)s(f,t+l)<=i?c=l:d=l,l=Math.floor((d-c)/2+c);d=l;var p=Math.max(1,t-l+1),m=Math.min(t+l,n.length)+e.length,g=Array(m+2);g[m+1]=(1<<f)-1;for(var y=m;y>=p;y--){var b=r[n.charAt(y-1)];if(f===0?g[y]=(g[y+1]<<1|1)&b:g[y]=(g[y+1]<<1|1)&b|((h[y+1]|h[y])<<1|1)|h[y+1],g[y]&u){var A=s(f,y-1);if(A<=i)if(i=A,o=y-1,o>t)p=Math.max(1,2*t-o);else break}}if(s(f+1,t)>i)break;h=g}return o};P.prototype.match_alphabet_=function(n){for(var e={},t=0;t<n.length;t++)e[n.charAt(t)]=0;for(var t=0;t<n.length;t++)e[n.charAt(t)]|=1<<n.length-t-1;return e};P.prototype.patch_addContext_=function(n,e){if(e.length!=0){if(n.start2===null)throw Error("patch not initialized");for(var t=e.substring(n.start2,n.start2+n.length1),r=0;e.indexOf(t)!=e.lastIndexOf(t)&&t.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)r+=this.Patch_Margin,t=e.substring(n.start2-r,n.start2+n.length1+r);r+=this.Patch_Margin;var a=e.substring(n.start2-r,n.start2);a&&n.diffs.unshift(new P.Diff(J,a));var s=e.substring(n.start2+n.length1,n.start2+n.length1+r);s&&n.diffs.push(new P.Diff(J,s)),n.start1-=a.length,n.start2-=a.length,n.length1+=a.length+s.length,n.length2+=a.length+s.length}};P.prototype.patch_make=function(n,e,t){var r,a;if(typeof n=="string"&&typeof e=="string"&&typeof t=="undefined")r=n,a=this.diff_main(r,e,!0),a.length>2&&(this.diff_cleanupSemantic(a),this.diff_cleanupEfficiency(a));else if(n&&typeof n=="object"&&typeof e=="undefined"&&typeof t=="undefined")a=n,r=this.diff_text1(a);else if(typeof n=="string"&&e&&typeof e=="object"&&typeof t=="undefined")r=n,a=e;else if(typeof n=="string"&&typeof e=="string"&&t&&typeof t=="object")r=n,a=t;else throw new Error("Unknown call format to patch_make.");if(a.length===0)return[];for(var s=[],i=new P.patch_obj,o=0,u=0,c=0,l=r,d=r,h=0;h<a.length;h++){var f=a[h][0],p=a[h][1];switch(!o&&f!==J&&(i.start1=u,i.start2=c),f){case ce:i.diffs[o++]=a[h],i.length2+=p.length,d=d.substring(0,c)+p+d.substring(c);break;case oe:i.length1+=p.length,i.diffs[o++]=a[h],d=d.substring(0,c)+d.substring(c+p.length);break;case J:p.length<=2*this.Patch_Margin&&o&&a.length!=h+1?(i.diffs[o++]=a[h],i.length1+=p.length,i.length2+=p.length):p.length>=2*this.Patch_Margin&&o&&(this.patch_addContext_(i,l),s.push(i),i=new P.patch_obj,o=0,l=d,u=c);break}f!==ce&&(u+=p.length),f!==oe&&(c+=p.length)}return o&&(this.patch_addContext_(i,l),s.push(i)),s};P.prototype.patch_deepCopy=function(n){for(var e=[],t=0;t<n.length;t++){var r=n[t],a=new P.patch_obj;a.diffs=[];for(var s=0;s<r.diffs.length;s++)a.diffs[s]=new P.Diff(r.diffs[s][0],r.diffs[s][1]);a.start1=r.start1,a.start2=r.start2,a.length1=r.length1,a.length2=r.length2,e[t]=a}return e};P.prototype.patch_apply=function(n,e){if(n.length==0)return[e,[]];n=this.patch_deepCopy(n);var t=this.patch_addPadding(n);e=t+e+t,this.patch_splitMax(n);for(var r=0,a=[],s=0;s<n.length;s++){var i=n[s].start2+r,o=this.diff_text1(n[s].diffs),u,c=-1;if(o.length>this.Match_MaxBits?(u=this.match_main(e,o.substring(0,this.Match_MaxBits),i),u!=-1&&(c=this.match_main(e,o.substring(o.length-this.Match_MaxBits),i+o.length-this.Match_MaxBits),(c==-1||u>=c)&&(u=-1))):u=this.match_main(e,o,i),u==-1)a[s]=!1,r-=n[s].length2-n[s].length1;else{a[s]=!0,r=u-i;var l;if(c==-1?l=e.substring(u,u+o.length):l=e.substring(u,c+this.Match_MaxBits),o==l)e=e.substring(0,u)+this.diff_text2(n[s].diffs)+e.substring(u+o.length);else{var d=this.diff_main(o,l,!1);if(o.length>this.Match_MaxBits&&this.diff_levenshtein(d)/o.length>this.Patch_DeleteThreshold)a[s]=!1;else{this.diff_cleanupSemanticLossless(d);for(var h=0,f,p=0;p<n[s].diffs.length;p++){var m=n[s].diffs[p];m[0]!==J&&(f=this.diff_xIndex(d,h)),m[0]===ce?e=e.substring(0,u+f)+m[1]+e.substring(u+f):m[0]===oe&&(e=e.substring(0,u+f)+e.substring(u+this.diff_xIndex(d,h+m[1].length))),m[0]!==oe&&(h+=m[1].length)}}}}}return e=e.substring(t.length,e.length-t.length),[e,a]};P.prototype.patch_addPadding=function(n){for(var e=this.Patch_Margin,t="",r=1;r<=e;r++)t+=String.fromCharCode(r);for(var r=0;r<n.length;r++)n[r].start1+=e,n[r].start2+=e;var a=n[0],s=a.diffs;if(s.length==0||s[0][0]!=J)s.unshift(new P.Diff(J,t)),a.start1-=e,a.start2-=e,a.length1+=e,a.length2+=e;else if(e>s[0][1].length){var i=e-s[0][1].length;s[0][1]=t.substring(s[0][1].length)+s[0][1],a.start1-=i,a.start2-=i,a.length1+=i,a.length2+=i}if(a=n[n.length-1],s=a.diffs,s.length==0||s[s.length-1][0]!=J)s.push(new P.Diff(J,t)),a.length1+=e,a.length2+=e;else if(e>s[s.length-1][1].length){var i=e-s[s.length-1][1].length;s[s.length-1][1]+=t.substring(0,i),a.length1+=i,a.length2+=i}return t};P.prototype.patch_splitMax=function(n){for(var e=this.Match_MaxBits,t=0;t<n.length;t++)if(!(n[t].length1<=e)){var r=n[t];n.splice(t--,1);for(var a=r.start1,s=r.start2,i="";r.diffs.length!==0;){var o=new P.patch_obj,u=!0;for(o.start1=a-i.length,o.start2=s-i.length,i!==""&&(o.length1=o.length2=i.length,o.diffs.push(new P.Diff(J,i)));r.diffs.length!==0&&o.length1<e-this.Patch_Margin;){var c=r.diffs[0][0],l=r.diffs[0][1];c===ce?(o.length2+=l.length,s+=l.length,o.diffs.push(r.diffs.shift()),u=!1):c===oe&&o.diffs.length==1&&o.diffs[0][0]==J&&l.length>2*e?(o.length1+=l.length,a+=l.length,u=!1,o.diffs.push(new P.Diff(c,l)),r.diffs.shift()):(l=l.substring(0,e-o.length1-this.Patch_Margin),o.length1+=l.length,a+=l.length,c===J?(o.length2+=l.length,s+=l.length):u=!1,o.diffs.push(new P.Diff(c,l)),l==r.diffs[0][1]?r.diffs.shift():r.diffs[0][1]=r.diffs[0][1].substring(l.length))}i=this.diff_text2(o.diffs),i=i.substring(i.length-this.Patch_Margin);var d=this.diff_text1(r.diffs).substring(0,this.Patch_Margin);d!==""&&(o.length1+=d.length,o.length2+=d.length,o.diffs.length!==0&&o.diffs[o.diffs.length-1][0]===J?o.diffs[o.diffs.length-1][1]+=d:o.diffs.push(new P.Diff(J,d))),u||n.splice(++t,0,o)}}};P.prototype.patch_toText=function(n){for(var e=[],t=0;t<n.length;t++)e[t]=n[t];return e.join("")};P.prototype.patch_fromText=function(n){var e=[];if(!n)return e;for(var t=n.split(`
`),r=0,a=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;r<t.length;){var s=t[r].match(a);if(!s)throw new Error("Invalid patch string: "+t[r]);var i=new P.patch_obj;for(e.push(i),i.start1=parseInt(s[1],10),s[2]===""?(i.start1--,i.length1=1):s[2]=="0"?i.length1=0:(i.start1--,i.length1=parseInt(s[2],10)),i.start2=parseInt(s[3],10),s[4]===""?(i.start2--,i.length2=1):s[4]=="0"?i.length2=0:(i.start2--,i.length2=parseInt(s[4],10)),r++;r<t.length;){var o=t[r].charAt(0);try{var u=decodeURI(t[r].substring(1))}catch(c){throw new Error("Illegal escape in patch_fromText: "+u)}if(o=="-")i.diffs.push(new P.Diff(oe,u));else if(o=="+")i.diffs.push(new P.Diff(ce,u));else if(o==" ")i.diffs.push(new P.Diff(J,u));else{if(o=="@")break;if(o!=="")throw new Error('Invalid patch mode "'+o+'" in: '+u)}r++}}return e};P.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0};P.patch_obj.prototype.toString=function(){var n,e;this.length1===0?n=this.start1+",0":this.length1==1?n=this.start1+1:n=this.start1+1+","+this.length1,this.length2===0?e=this.start2+",0":this.length2==1?e=this.start2+1:e=this.start2+1+","+this.length2;for(var t=["@@ -"+n+" +"+e+` @@
`],r,a=0;a<this.diffs.length;a++){switch(this.diffs[a][0]){case ce:r="+";break;case oe:r="-";break;case J:r=" ";break}t[a+1]=r+encodeURI(this.diffs[a][1])+`
`}return t.join("").replace(/%20/g," ")};xs.exports=P;xs.exports.diff_match_patch=P;xs.exports.DIFF_DELETE=oe;xs.exports.DIFF_INSERT=ce;xs.exports.DIFF_EQUAL=J});var oP={};Jd(oP,{default:()=>Wu});module.exports=Bb(oP);var Is=require("obsidian");var He=require("obsidian");var Yd=`
You are an advanced language model that performs text transformations based on specific instructions. Your task is to process input text to produce the desired output based on a given transformation type. You can handle tasks like adding emojis, making text longer or shorter, and converting text into tables, among many others. Use **Obsidian-flavored markdown** in all your transformations when applicable. Follow the examples provided to guide your responses. 

It is **very important** that you follow the examples. Do not add anything at the start of the output like "Output:" or "Here's a rephrased version of the input text:" or anything similar. Just provide the transformed text.

**Examples:**

---

**Task:** Add Emojis.  
**Prompt:** Add relevant emojis to make the text more engaging.  

**Input:**  
"Let's celebrate the success of our project."  

**Output:**  
"\u{1F389} Let's celebrate the success of our project! \u{1F680}\u{1F44F}"  

---

**Task:** Convert to Table.  
**Prompt:** Convert the text into an Obsidian table format.  

**Input:**  
"Name: John, Age: 30, Profession: Engineer"  

**Output:**  
| Name  | Age | Profession   |
|-------|-----|-------------|
| John  | 30  | Engineer|

---
`,Xd=`
You are an advanced language model specialized in following specific instructions to create and process markdown documents. Always use **Obsidian-flavored Markdown** syntax in your responses whenever applicable.

## Examples:

**Prompt:** Create a note titled "Daily Goals" with a list of tasks.  
**Output:**  
# Daily Goals  
- [ ] Task 1: Complete the project proposal  
- [ ] Task 2: Attend team meeting  
- [ ] Task 3: Review budget plan  

---

**Prompt:** Generate a note about "Meeting Notes" with a table summarizing the key points.  
**Output:**  
# Meeting Notes  

| Topic          | Discussion Summary           | Action Items           |  
|-----------------|------------------------------|------------------------|  
| Project Update | Discussed project milestones | Update Gantt chart     |  
| Budget Review  | Reviewed proposed budget     | Finalize budget draft  |  

---

**Prompt:** Create a note titled "Books to Read" with headings for different genres and a list of book titles under each genre.  
**Output:**  
# Books to Read  

## Fiction  
- *Dune* by Frank Herbert  
- *1984* by George Orwell  

## Non-Fiction  
- *Sapiens* by Yuval Noah Harari  
- *Educated* by Tara Westover  

## Science  
- *A Brief History of Time* by Stephen Hawking  
- *The Selfish Gene* by Richard Dawkins  

---

Follow this structure and style for all responses, adapting to the specific **Prompt** provided.`;var Qu={provider:"ollama",model:"llama3.2",apiKey:"",customURL:"",azureEndpoint:"",azureApiVersion:"2024-02-15-preview",selectionPrompt:Yd,cursorPrompt:Xd,customCommands:[],commandPrefix:"/",messageHistory:!1},zi=class extends He.PluginSettingTab{constructor(t,r){super(t,r);V(this,"plugin");this.plugin=r}async saveSettings(){await this.plugin.saveSettings(),this.plugin.chatapi.updateSettings(this.plugin.settings)}display(){let{containerEl:t}=this;t.empty(),new He.Setting(t).setName("Provider").setDesc("Choose between OpenAI, Ollama, Azure OpenAI, Gemini, or a custom OpenAI-compatible endpoint.").addDropdown(r=>r.addOption("openai","OpenAI").addOption("ollama","Ollama").addOption("azure","Azure OpenAI").addOption("gemini","Gemini").addOption("custom","Custom/OpenAI-compatible").setValue(this.plugin.settings.provider).onChange(async a=>{this.plugin.settings.provider=a,await this.saveSettings(),this.display()})),new He.Setting(t).setName("Model").setDesc("Specify the model to use.").addText(r=>{r.setPlaceholder("e.g., gpt-4o-mini").setValue(this.plugin.settings.model).inputEl.addEventListener("blur",async()=>{this.plugin.settings.model=r.getValue(),await this.saveSettings()})}),(this.plugin.settings.provider==="openai"||this.plugin.settings.provider==="custom"||this.plugin.settings.provider==="gemini"||this.plugin.settings.provider==="azure")&&new He.Setting(t).setName("API key").setDesc("Enter your API key.").addText(r=>{r.setPlaceholder("sk-...").setValue(this.plugin.settings.apiKey||"").inputEl.addEventListener("blur",async()=>{this.plugin.settings.apiKey=r.getValue(),await this.saveSettings()})}),this.plugin.settings.provider==="custom"&&new He.Setting(t).setName("Custom endpoint").setDesc("Enter your OpenAI-compatible base URL (e.g. https://api.groq.com/openai/v1).").addText(r=>{r.setPlaceholder("https://api.mycustomhost.com/v1").setValue(this.plugin.settings.customURL||"").inputEl.addEventListener("blur",async()=>{this.plugin.settings.customURL=r.getValue(),await this.saveSettings()})}),this.plugin.settings.provider==="azure"&&(new He.Setting(t).setName("Azure endpoint").setDesc("Enter your Azure OpenAI endpoint URL (e.g. https://your-resource.openai.azure.com).").addText(r=>{r.setPlaceholder("https://your-resource.openai.azure.com").setValue(this.plugin.settings.azureEndpoint||"").inputEl.addEventListener("blur",async()=>{this.plugin.settings.azureEndpoint=r.getValue().trim(),await this.saveSettings()})}),new He.Setting(t).setName("Azure API version").setDesc("Enter the Azure OpenAI API version to use.").addText(r=>{r.setPlaceholder("2024-02-15-preview").setValue(this.plugin.settings.azureApiVersion||"2024-02-15-preview").inputEl.addEventListener("blur",async()=>{this.plugin.settings.azureApiVersion=r.getValue().trim(),await this.saveSettings()})})),t.createEl("h3",{text:"Advanced"}),new He.Setting(t).setName("Selection prompt").setDesc("System Prompt used when the tooltip is triggered with selected text.").addTextArea(r=>{r.setPlaceholder("e.g., Summarize the selected text.").setValue(this.plugin.settings.selectionPrompt).inputEl.addEventListener("blur",async()=>{this.plugin.settings.selectionPrompt=r.getValue(),await this.saveSettings()}),r.inputEl.classList.add("wide-text-settings")}),new He.Setting(t).setName("Cursor prompt").setDesc("System Prompt used when the tooltip is triggered with selected text.").addTextArea(r=>{r.setPlaceholder("e.g., Generate text based on cursor position.").setValue(this.plugin.settings.cursorPrompt).inputEl.addEventListener("blur",async()=>{this.plugin.settings.cursorPrompt=r.getValue(),await this.saveSettings()}),r.inputEl.classList.add("wide-text-settings")}),new He.Setting(t).setName("Message History").setDesc("Enable message history, you can navigate through the history using the up/down arrow keys.").addToggle(r=>{r.setValue(this.plugin.settings.messageHistory).onChange(async a=>{this.plugin.settings.messageHistory=a,await this.saveSettings()})}),t.createEl("h3",{text:"Custom Commands"}),t.createEl("p",{text:"Add your own custom commands. Triggered with the prefix defined in the Command Prefix setting."}),new He.Setting(t).setName("Command Prefix").setDesc("The prefix used to trigger custom commands (e.g., /, !, #)").addText(r=>{r.setPlaceholder("/").setValue(this.plugin.settings.commandPrefix).inputEl.addEventListener("blur",async()=>{this.plugin.settings.commandPrefix=r.getValue().charAt(0),await this.saveSettings(),this.display()})}),this.plugin.settings.customCommands.forEach((r,a)=>{new He.Setting(t).setName(`Command: ${r.keyword}`).setDesc("Edit the command prompt.").addText(s=>{s.setValue(r.keyword).setPlaceholder("Command name").inputEl.addEventListener("blur",async()=>{this.plugin.settings.customCommands[a].keyword=s.getValue(),await this.saveSettings()})}).addTextArea(s=>{s.setValue(r.prompt).setPlaceholder("Command prompt").inputEl.addEventListener("blur",async()=>{this.plugin.settings.customCommands[a].prompt=s.getValue(),await this.saveSettings()})}).addExtraButton(s=>s.setIcon("trash").setTooltip("Delete this command").onClick(async()=>{this.plugin.settings.customCommands.splice(a,1),await this.saveSettings(),this.display()}))}),new He.Setting(t).addButton(r=>r.setButtonText("Add Command").setCta().onClick(async()=>{this.plugin.settings.customCommands.push({keyword:"new_command",prompt:""}),await this.saveSettings(),this.display()}))}};var Dr=require("@codemirror/state"),Qe=require("@codemirror/view"),js=require("obsidian");var Ns=require("@codemirror/state"),ma=require("@codemirror/view"),eh=require("@codemirror/view");var Bi=Ns.StateEffect.define(),mr=Ns.StateField.define({create(){return null},update(n,e){let t=e.effects.find(r=>r.is(Bi));return t?t.value:e.effects.some(r=>r.is(Nt))?null:n}}),Qd=ma.Decoration.mark({class:"cm-selectionBackground"}),th=Ns.StateField.define({create(n){let e=n.field(mr);return e&&e.from!==e.to?(console.log("info",e),ma.Decoration.set([Qd.range(e.from,e.to)])):ma.Decoration.none},update(n,e){let t=e.state.field(mr);return t&&t.from!==t.to?ma.Decoration.set([Qd.range(t.from,t.to)]):ma.Decoration.none},provide:n=>eh.EditorView.decorations.from(n)});var rh=require("@codemirror/autocomplete"),$s=require("@codemirror/view");function qb(n={prefix:"/",customCommands:[]}){let{prefix:e,customCommands:t}=n;return r=>{let a=r.matchBefore(new RegExp(`^\\${e}\\w*`));return!a||a.from==a.to&&!r.explicit?null:{from:a.from+1,options:t.map(s=>({label:s.keyword,type:void 0,detail:s.prompt}))}}}function nh(n={prefix:"/",customCommands:[]}){return(0,rh.autocompletion)({override:[qb(n)],tooltipClass:()=>"tooltip-autocomplete",optionClass:()=>"completion-label",icons:!1})}var Hb=$s.Decoration.mark({class:"cm-slash-command"});function ah({prefix:n,customCommands:e}){return $s.ViewPlugin.fromClass(class{constructor(t){V(this,"decorations");this.decorations=this.buildDecorations(t)}update(t){(t.docChanged||t.viewportChanged)&&(this.decorations=this.buildDecorations(t.view))}buildDecorations(t){let r=e.map(i=>i.keyword).join("|"),a=new RegExp(`\\${n}(${r})\\b`,"g"),s=t.visibleRanges.flatMap(({from:i,to:o})=>[...t.state.doc.sliceString(i,o).matchAll(a)].map(c=>c.index!==void 0?Hb.range(i+c.index,i+c.index+1+c[1].length):null).filter(c=>c!==null));return $s.Decoration.set(s)}},{decorations:t=>t.decorations})}var tc=Dr.StateEffect.define(),Nt=Dr.StateEffect.define(),Ls=Dr.StateEffect.define(),ec=class extends Qe.WidgetType{constructor(t,r,a){super();V(this,"chatApiManager");V(this,"selectionInfo");V(this,"plugin");V(this,"outerEditorView",null);V(this,"dom");V(this,"innerDom");V(this,"textFieldView");V(this,"submitButton");V(this,"loaderElement");V(this,"acceptButton");V(this,"discardButton");V(this,"messageHistoryIndex",null);V(this,"onClickOutside",null);V(this,"onEscape",null);V(this,"escapeWindows",[]);this.chatApiManager=t,this.selectionInfo=r,this.plugin=a,this.dom=createEl("div",{cls:"cm-cursor-overlay",attr:{style:"user-select: none;"}}),this.innerDom=this.dom.createEl("div",{cls:"cm-cursor-overlay-inner"})}toDOM(t){var r,a,s;if(this.outerEditorView=t,this.createPencilIcon(),this.createInputField(),this.createSubmitButton(),this.createLoader(),setTimeout(()=>{var i;(i=this.textFieldView)==null||i.focus()},0),this.onClickOutside=i=>{this.dom.contains(i.target)||this.dismissTooltip()},this.onEscape=i=>{i.key==="Escape"&&this.dismissTooltip()},window.addEventListener("mousedown",this.onClickOutside),window.addEventListener("keydown",this.onEscape),this.escapeWindows=[window],window.app&&window.app.openPopouts instanceof Function){let i=window.app.openPopouts();for(let o of i)try{o.addEventListener("keydown",this.onEscape),this.escapeWindows.push(o)}catch(u){}}else if(window.app&&Array.isArray((s=(a=(r=window.app)==null?void 0:r.workspace)==null?void 0:a.getWindows)==null?void 0:s.call(a))){let i=window.app.workspace.getWindows();for(let o of i)try{o.addEventListener("keydown",this.onEscape),this.escapeWindows.push(o)}catch(u){}}return this.dom.addEventListener("destroy",()=>{document.removeEventListener("mousedown",this.onClickOutside);for(let i of this.escapeWindows)try{i.removeEventListener("keydown",this.onEscape)}catch(o){}this.escapeWindows=[]}),document.body.classList.add("inlineai-widget-open"),this.dom}destroy(){var t;(t=this.textFieldView)==null||t.destroy(),this.innerDom.empty(),this.submitButton.remove(),this.loaderElement.remove(),this.acceptButton&&this.acceptButton.remove(),this.discardButton&&this.discardButton.remove(),document.body.classList.remove("inlineai-widget-open"),this.textFieldView=void 0,this.outerEditorView=null,this.messageHistoryIndex=null}dismissTooltip(){this.outerEditorView&&this.outerEditorView.dispatch({effects:Nt.of(null)})}createPencilIcon(){if(!this.innerDom.querySelector(".cm-pencil-icon")){let t=this.innerDom.createEl("div",{cls:"cm-pencil-icon"});(0,js.setIcon)(t,"pencil")}}createInputField(){let t=this.innerDom.createEl("div",{cls:"cm-tooltip-editor",attr:{style:"user-select: text;"}});this.textFieldView=new Qe.EditorView({state:Dr.EditorState.create({doc:"",extensions:[(0,Qe.placeholder)("Ask copilot"),Qe.keymap.of([{key:"Enter",run:()=>(this.submitAction(),!0),preventDefault:!0},{key:"Mod-a",run:r=>{let a=r.state.doc;return r.dispatch({selection:{anchor:0,head:a.length}}),!0},preventDefault:!0},{key:"ArrowUp",run:()=>{let r=this.chatApiManager.getMessageHistory();if(r.length===0||!this.textFieldView)return!0;this.messageHistoryIndex===null?this.messageHistoryIndex=r.length-1:this.messageHistoryIndex>0&&this.messageHistoryIndex--,this.messageHistoryIndex<0&&(this.messageHistoryIndex=0);let a=r[this.messageHistoryIndex].userPrompt;return this.textFieldView.dispatch({changes:{from:0,to:this.textFieldView.state.doc.length,insert:a}}),this.textFieldView.dispatch({selection:{anchor:a.length,head:a.length}}),!0},preventDefault:!0},{key:"ArrowDown",run:()=>{let r=this.chatApiManager.getMessageHistory();if(r.length===0||!this.textFieldView||this.messageHistoryIndex===null)return!0;if(this.messageHistoryIndex<r.length-1){this.messageHistoryIndex++;let a=r[this.messageHistoryIndex].userPrompt;this.textFieldView.dispatch({changes:{from:0,to:this.textFieldView.state.doc.length,insert:a}}),this.textFieldView.dispatch({selection:{anchor:a.length,head:a.length}})}else this.messageHistoryIndex=null,this.textFieldView.dispatch({changes:{from:0,to:this.textFieldView.state.doc.length,insert:""}});return!0},preventDefault:!0}]),nh({prefix:this.plugin.settings.commandPrefix,customCommands:this.plugin.settings.customCommands}),ah({prefix:this.plugin.settings.commandPrefix,customCommands:this.plugin.settings.customCommands})]}),parent:t}),this.textFieldView.dom.addEventListener("input",()=>{this.messageHistoryIndex=null})}createSubmitButton(){this.submitButton=this.innerDom.createEl("button",{cls:"submit-button tooltip-button",text:"Submit"}),(0,js.setIcon)(this.submitButton,"send-horizontal"),this.submitButton.onclick=()=>{this.submitAction()}}createLoader(){this.loaderElement=this.innerDom.createEl("div",{cls:"loader"}),this.toggleLoading(!1)}submitAction(){var a,s,i,o,u;(a=this.outerEditorView)==null||a.focus();let t=(i=(s=this.textFieldView)==null?void 0:s.state.doc.toString())!=null?i:"";if(!t.trim()){console.warn("Empty input. Submission aborted.");return}let r=(u=(o=this.selectionInfo)==null?void 0:o.text)!=null?u:"";this.toggleLoading(!0),this.chatApiManager.callSelection(t,r).then(c=>{this.showActionButtons()}).catch(c=>{console.error("Error calling AI:",c)}).finally(()=>{this.toggleLoading(!1)}),this.messageHistoryIndex=null}toggleLoading(t){t?(this.submitButton.classList.add("hidden"),this.loaderElement.classList.remove("hidden")):(this.submitButton.classList.remove("hidden"),this.loaderElement.classList.add("hidden"))}showActionButtons(){this.submitButton.classList.add("hidden"),this.createAcceptButton(),this.createDiscardButton()}createAcceptButton(){this.acceptButton||(this.acceptButton=this.innerDom.createEl("button",{cls:"accept-button tooltip-button primary-action",text:"Accept"}),(0,js.setIcon)(this.acceptButton,"check"),this.acceptButton.addEventListener("mousedown",t=>{t.preventDefault(),t.stopPropagation()}),this.acceptButton.onclick=()=>{this.acceptAction()},this.innerDom.appendChild(this.acceptButton))}createDiscardButton(){this.discardButton||(this.discardButton=this.innerDom.createEl("button",{cls:"discard-button tooltip-button",text:"Discard"}),(0,js.setIcon)(this.discardButton,"cross"),this.discardButton.addEventListener("mousedown",t=>{t.preventDefault(),t.stopPropagation()}),this.discardButton.onclick=()=>{this.discardAction()},this.innerDom.appendChild(this.discardButton))}acceptAction(){this.outerEditorView&&this.outerEditorView.dispatch({effects:Ls.of(null)}),this.dismissTooltip()}discardAction(){this.dismissTooltip()}};function Vb(n,e,t){var i,o;let r=(i=n.selection.ranges.find(u=>!u.empty))!=null?i:n.selection.main,a=(o=n.field(mr,!1))!=null?o:null,s=Qe.Decoration.widget({widget:new ec(e,a,t),above:!0,inline:!0,side:-1}).range(r.from);return Qe.Decoration.set([s])}function Gb(n,e){return Dr.StateField.define({create(t){return Qe.Decoration.none},update(t,r){return r.effects.some(a=>a.is(tc))?Vb(r.state,n,e):r.effects.some(a=>a.is(Nt))?Qe.Decoration.none:t},provide:t=>Qe.EditorView.decorations.from(t)})}function sh(n,e){return[Gb(n,e)]}var qi="RFC3986",Hi={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:n=>String(n)},ih="RFC1738";var Kb=Array.isArray,Zt=(()=>{let n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})();var rc=1024,oh=(n,e,t,r,a)=>{if(n.length===0)return n;let s=n;if(typeof n=="symbol"?s=Symbol.prototype.toString.call(n):typeof n!="string"&&(s=String(n)),t==="iso-8859-1")return escape(s).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<s.length;o+=rc){let u=s.length>=rc?s.slice(o,o+rc):s,c=[];for(let l=0;l<u.length;++l){let d=u.charCodeAt(l);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||a===ih&&(d===40||d===41)){c[c.length]=u.charAt(l);continue}if(d<128){c[c.length]=Zt[d];continue}if(d<2048){c[c.length]=Zt[192|d>>6]+Zt[128|d&63];continue}if(d<55296||d>=57344){c[c.length]=Zt[224|d>>12]+Zt[128|d>>6&63]+Zt[128|d&63];continue}l+=1,d=65536+((d&1023)<<10|u.charCodeAt(l)&1023),c[c.length]=Zt[240|d>>18]+Zt[128|d>>12&63]+Zt[128|d>>6&63]+Zt[128|d&63]}i+=c.join("")}return i};function uh(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function nc(n,e){if(Kb(n)){let t=[];for(let r=0;r<n.length;r+=1)t.push(e(n[r]));return t}return e(n)}var Zb=Object.prototype.hasOwnProperty,ch={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},Jt=Array.isArray,Jb=Array.prototype.push,lh=function(n,e){Jb.apply(n,Jt(e)?e:[e])},Wb=Date.prototype.toISOString,Ae={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:oh,encodeValuesOnly:!1,format:qi,formatter:Hi[qi],indices:!1,serializeDate(n){return Wb.call(n)},skipNulls:!1,strictNullHandling:!1};function Yb(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}var ac={};function dh(n,e,t,r,a,s,i,o,u,c,l,d,h,f,p,m,g,y){let b=n,A=y,x=0,_=!1;for(;(A=A.get(ac))!==void 0&&!_;){let L=A.get(n);if(x+=1,typeof L!="undefined"){if(L===x)throw new RangeError("Cyclic object value");_=!0}typeof A.get(ac)=="undefined"&&(x=0)}if(typeof c=="function"?b=c(e,b):b instanceof Date?b=h==null?void 0:h(b):t==="comma"&&Jt(b)&&(b=nc(b,function(L){return L instanceof Date?h==null?void 0:h(L):L})),b===null){if(s)return u&&!m?u(e,Ae.encoder,g,"key",f):e;b=""}if(Yb(b)||uh(b)){if(u){let L=m?e:u(e,Ae.encoder,g,"key",f);return[(p==null?void 0:p(L))+"="+(p==null?void 0:p(u(b,Ae.encoder,g,"value",f)))]}return[(p==null?void 0:p(e))+"="+(p==null?void 0:p(String(b)))]}let v=[];if(typeof b=="undefined")return v;let E;if(t==="comma"&&Jt(b))m&&u&&(b=nc(b,u)),E=[{value:b.length>0?b.join(",")||null:void 0}];else if(Jt(c))E=c;else{let L=Object.keys(b);E=l?L.sort(l):L}let O=o?String(e).replace(/\./g,"%2E"):String(e),S=r&&Jt(b)&&b.length===1?O+"[]":O;if(a&&Jt(b)&&b.length===0)return S+"[]";for(let L=0;L<E.length;++L){let q=E[L],H=typeof q=="object"&&typeof q.value!="undefined"?q.value:b[q];if(i&&H===null)continue;let de=d&&o?q.replace(/\./g,"%2E"):q,Ie=Jt(b)?typeof t=="function"?t(S,de):S:S+(d?"."+de:"["+de+"]");y.set(n,x);let ve=new WeakMap;ve.set(ac,y),lh(v,dh(H,Ie,t,r,a,s,i,o,t==="comma"&&m&&Jt(b)?null:u,c,l,d,h,f,p,m,g,ve))}return v}function Xb(n=Ae){if(typeof n.allowEmptyArrays!="undefined"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys!="undefined"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder!="undefined"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");let e=n.charset||Ae.charset;if(typeof n.charset!="undefined"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=qi;if(typeof n.format!="undefined"){if(!Zb.call(Hi,n.format))throw new TypeError("Unknown format option provided.");t=n.format}let r=Hi[t],a=Ae.filter;(typeof n.filter=="function"||Jt(n.filter))&&(a=n.filter);let s;if(n.arrayFormat&&n.arrayFormat in ch?s=n.arrayFormat:"indices"in n?s=n.indices?"indices":"repeat":s=Ae.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");let i=typeof n.allowDots=="undefined"?n.encodeDotInKeys?!0:Ae.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:Ae.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:Ae.allowEmptyArrays,arrayFormat:s,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:Ae.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter=="undefined"?Ae.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:Ae.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:Ae.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:Ae.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:Ae.encodeValuesOnly,filter:a,format:t,formatter:r,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:Ae.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:Ae.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:Ae.strictNullHandling}}function sc(n,e={}){let t=n,r=Xb(e),a,s;typeof r.filter=="function"?(s=r.filter,t=s("",t)):Jt(r.filter)&&(s=r.filter,a=s);let i=[];if(typeof t!="object"||t===null)return"";let o=ch[r.arrayFormat],u=o==="comma"&&r.commaRoundTrip;a||(a=Object.keys(t)),r.sort&&a.sort(r.sort);let c=new WeakMap;for(let h=0;h<a.length;++h){let f=a[h];r.skipNulls&&t[f]===null||lh(i,dh(t[f],f,o,u,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}let l=i.join(r.delimiter),d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),l.length>0?d+l:""}var ln="4.77.3";var hh=!1,dn,ic,e_,t_,r_,oc,n_,Vi,uc,cc,lc,Gi,dc;function fh(n,e={auto:!1}){if(hh)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(dn)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${dn}'\``);hh=e.auto,dn=n.kind,ic=n.fetch,e_=n.Request,t_=n.Response,r_=n.Headers,oc=n.FormData,n_=n.Blob,Vi=n.File,uc=n.ReadableStream,cc=n.getMultipartRequestOptions,lc=n.getDefaultAgent,Gi=n.fileFromPath,dc=n.isFsReadStream}var Ki=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function ph({manuallyImported:n}={}){let e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n",t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData!="undefined"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob!="undefined"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File!="undefined"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream!="undefined"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new Ki(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}dn||fh(ph(),{auto:!0});var F=class extends Error{},_e=class n extends F{constructor(e,t,r,a){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.request_id=a==null?void 0:a["x-request-id"],this.error=t;let s=t;this.code=s==null?void 0:s.code,this.param=s==null?void 0:s.param,this.type=s==null?void 0:s.type}static makeMessage(e,t,r){let a=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e||!a)return new gr({message:r,cause:Zi(t)});let s=t==null?void 0:t.error;return e===400?new ga(e,s,r,a):e===401?new ya(e,s,r,a):e===403?new ba(e,s,r,a):e===404?new _a(e,s,r,a):e===409?new wa(e,s,r,a):e===422?new va(e,s,r,a):e===429?new Aa(e,s,r,a):e>=500?new Ea(e,s,r,a):new n(e,s,r,a)}},ge=class extends _e{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},gr=class extends _e{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},$t=class extends gr{constructor({message:e}={}){super({message:e!=null?e:"Request timed out."})}},ga=class extends _e{},ya=class extends _e{},ba=class extends _e{},_a=class extends _e{},wa=class extends _e{},va=class extends _e{},Aa=class extends _e{},Ea=class extends _e{},Oa=class extends F{constructor(){super("Could not parse response content as the length limit was reached")}},xa=class extends F{constructor(){super("Could not parse response content as the request was rejected by the content filter")}};var hn=class n{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let r=n.NEWLINE_CHARS.has(t[t.length-1]||""),a=t.split(n.NEWLINE_REGEXP);return r&&a.pop(),a.length===1&&!r?(this.buffer.push(a[0]),[]):(this.buffer.length>0&&(a=[this.buffer.join("")+a[0],...a.slice(1)],this.buffer=[]),r||(this.buffer=[a.pop()||""]),a)}decodeText(e){var t;if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer!="undefined"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new F(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder!="undefined"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return(t=this.textDecoder)!=null||(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new F(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new F("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};hn.NEWLINE_CHARS=new Set([`
`,"\r"]);hn.NEWLINE_REGEXP=/\r\n|[\n\r]/g;var Wt=class n{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let i of i_(e,t))if(!s){if(i.data.startsWith("[DONE]")){s=!0;continue}if(i.event===null){let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(o&&o.error)throw new _e(void 0,o.error,void 0,void 0);yield o}else{let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(i.event=="error")throw new _e(void 0,o.error,o.message,void 0);yield{event:i.event,data:o}}}s=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{s||t.abort()}}return new n(a,t)}static fromReadableStream(e,t){let r=!1;async function*a(){let i=new hn,o=mh(e);for await(let u of o)for(let c of i.decode(u))yield c;for(let u of i.flush())yield u}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(let o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new n(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){let i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new n(()=>a(e),this.controller),new n(()=>a(t),this.controller)]}toReadableStream(){let e=this,t,r=new TextEncoder;return new uc({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{let{value:s,done:i}=await t.next();if(i)return a.close();let o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){var a;await((a=t.return)==null?void 0:a.call(t))}})}};async function*i_(n,e){if(!n.body)throw e.abort(),new F("Attempted to iterate over a response with no body");let t=new hc,r=new hn,a=mh(n.body);for await(let s of o_(a))for(let i of r.decode(s)){let o=t.decode(i);o&&(yield o)}for(let s of r.flush()){let i=t.decode(s);i&&(yield i)}}async function*o_(n){let e=new Uint8Array;for await(let t of n){if(t==null)continue;let r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,a=new Uint8Array(e.length+r.length);a.set(e),a.set(r,e.length),e=a;let s;for(;(s=u_(e))!==-1;)yield e.slice(0,s),e=e.slice(s)}e.length>0&&(yield e)}function u_(n){for(let r=0;r<n.length-2;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}var hc=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=c_(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}};function c_(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function mh(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var gh=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",yh=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Ds(n),Ds=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",l_=n=>yh(n)||gh(n)||dc(n);async function mc(n,e,t){var a,s,i;if(n=await n,yh(n))return n;if(gh(n)){let o=await n.blob();e||(e=(a=new URL(n.url).pathname.split(/[\\/]/).pop())!=null?a:"unknown_file");let u=Ds(o)?[await o.arrayBuffer()]:[o];return new Vi(u,e,t)}let r=await d_(n);if(e||(e=(s=f_(n))!=null?s:"unknown_file"),!(t!=null&&t.type)){let o=(i=r[0])==null?void 0:i.type;typeof o=="string"&&(t={...t,type:o})}return new Vi(r,e,t)}async function d_(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Ds(n))e.push(await n.arrayBuffer());else if(p_(n))for await(let r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${h_(n)}`);return e}function h_(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function f_(n){var e;return fc(n.name)||fc(n.filename)||((e=fc(n.path))==null?void 0:e.split(/[\\/]/).pop())}var fc=n=>{if(typeof n=="string")return n;if(typeof Buffer!="undefined"&&n instanceof Buffer)return String(n)},p_=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",gc=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var vt=async n=>{let e=await bh(n.body);return cc(e,n)},bh=async n=>{let e=new oc;return await Promise.all(Object.entries(n||{}).map(([t,r])=>pc(e,t,r))),e};var pc=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(l_(t)){let r=await mc(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>pc(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,a])=>pc(n,`${e}[${r}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var g_=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},y_=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ji;async function Eh(n){let{response:e}=n;if(n.options.stream)return Ia("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):Wt.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;let t=e.headers.get("content-type");if((t==null?void 0:t.includes("application/json"))||(t==null?void 0:t.includes("application/vnd.api+json"))){let s=await e.json();return Ia("response",e.status,e.url,e.headers,s),Oh(s,e)}let a=await e.text();return Ia("response",e.status,e.url,e.headers,a),a}function Oh(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var Yi=class n extends Promise{constructor(e,t=Eh){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new n(this.responsePromise,async t=>Oh(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},Xi=class{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=yc("maxRetries",t),this.timeout=yc("timeout",r),this.httpAgent=a,this.fetch=s!=null?s:ic}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...A_(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${I_()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async a=>{let s=a&&Ds(a==null?void 0:a.body)?new DataView(await a.body.arrayBuffer()):(a==null?void 0:a.body)instanceof DataView?a.body:(a==null?void 0:a.body)instanceof ArrayBuffer?new DataView(a.body):a&&ArrayBuffer.isView(a==null?void 0:a.body)?new DataView(a.body.buffer):a==null?void 0:a.body;return{method:e,path:t,...a,body:s}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer!="undefined")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder!="undefined")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var m,g,y,b,A,x;let{method:r,path:a,query:s,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:gc(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,u=this.calculateContentLength(o),c=this.buildURL(a,s);"timeout"in e&&yc("timeout",e.timeout);let l=(m=e.timeout)!=null?m:this.timeout,d=(y=(g=e.httpAgent)!=null?g:this.httpAgent)!=null?y:lc(c),h=l+1e3;typeof((b=d==null?void 0:d.options)==null?void 0:b.timeout)=="number"&&h>((A=d.options.timeout)!=null?A:0)&&(d.options.timeout=h),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let f=this.buildHeaders({options:e,headers:i,contentLength:u,retryCount:t});return{req:{method:r,...o&&{body:o},headers:f,...d&&{agent:d},signal:(x=e.signal)!=null?x:null},url:c,timeout:l}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:a}){let s={};r&&(s["content-length"]=r);let i=this.defaultHeaders(e);return vh(s,i),vh(s,t),gc(e.body)&&dn!=="node"&&delete s["content-type"],Ah(i,"x-stainless-retry-count")===void 0&&Ah(t,"x-stainless-retry-count")===void 0&&(s["x-stainless-retry-count"]=String(a)),this.validateHeaders(s,t),s}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return _e.generate(e,t,r,a)}request(e,t=null){return new Yi(this.makeRequest(e,t))}async makeRequest(e,t){var d,h,f;let r=await e,a=(d=r.maxRetries)!=null?d:this.maxRetries;t==null&&(t=a),await this.prepareOptions(r);let{req:s,url:i,timeout:o}=this.buildRequest(r,{retryCount:a-t});if(await this.prepareRequest(s,{url:i,options:r}),Ia("request",i,r,s.headers),(h=r.signal)!=null&&h.aborted)throw new ge;let u=new AbortController,c=await this.fetchWithTimeout(i,s,o,u).catch(Zi);if(c instanceof Error){if((f=r.signal)!=null&&f.aborted)throw new ge;if(t)return this.retryRequest(r,t);throw c.name==="AbortError"?new $t:new gr({cause:c})}let l=b_(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){let A=`retrying, ${t} attempts remaining`;return Ia(`response (error; ${A})`,c.status,i,l),this.retryRequest(r,t,l)}let p=await c.text().catch(A=>Zi(A).message),m=E_(p),g=m?void 0:p;throw Ia(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,l,g),this.makeStatusError(c.status,m,g,l)}return{response:c,options:r,controller:u}}requestAPIList(e,t){let r=this.makeRequest(t,null);return new bc(this,r,e)}buildURL(e,t){let r=x_(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return xh(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r!="undefined").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new F(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){let{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());let o=setTimeout(()=>a.abort(),r),u={signal:a.signal,...i};return u.method&&(u.method=u.method.toUpperCase()),this.fetch.call(void 0,e,u).finally(()=>{clearTimeout(o)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){var o;let a,s=r==null?void 0:r["retry-after-ms"];if(s){let u=parseFloat(s);Number.isNaN(u)||(a=u)}let i=r==null?void 0:r["retry-after"];if(i&&!a){let u=parseFloat(i);Number.isNaN(u)?a=Date.parse(i)-Date.now():a=u*1e3}if(!(a&&0<=a&&a<60*1e3)){let u=(o=e.maxRetries)!=null?o:this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,u)}return await yr(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${ln}`}},Ms=class{constructor(e,t,r,a){Ji.set(this,void 0),g_(this,Ji,e,"f"),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new F("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await y_(this,Ji,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ji=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},bc=class extends Yi{constructor(e,t,r){super(t,async a=>new r(e,a.response,await Eh(a),a.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},b_=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}}),__={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ue=n=>typeof n=="object"&&n!==null&&!xh(n)&&Object.keys(n).every(e=>Ih(__,e)),w_=()=>{var e,t;if(typeof Deno!="undefined"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ln,"X-Stainless-OS":wh(Deno.build.os),"X-Stainless-Arch":_h(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:(t=(e=Deno.version)==null?void 0:e.deno)!=null?t:"unknown"};if(typeof EdgeRuntime!="undefined")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ln,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process!="undefined"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ln,"X-Stainless-OS":wh(process.platform),"X-Stainless-Arch":_h(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let n=v_();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ln,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ln,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function v_(){if(typeof navigator=="undefined"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}var _h=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",wh=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),Wi,A_=()=>Wi!=null?Wi:Wi=w_(),E_=n=>{try{return JSON.parse(n)}catch(e){return}},O_=/^[a-z][a-z0-9+.-]*:/i,x_=n=>O_.test(n),yr=n=>new Promise(e=>setTimeout(e,n)),yc=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new F(`${n} must be an integer`);if(e<0)throw new F(`${n} must be a positive integer`);return e},Zi=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch(e){}return new Error(n)};var Mr=n=>{var e,t,r,a,s,i;if(typeof process!="undefined")return(r=(t=(e=process.env)==null?void 0:e[n])==null?void 0:t.trim())!=null?r:void 0;if(typeof Deno!="undefined")return(i=(s=(a=Deno.env)==null?void 0:a.get)==null?void 0:s.call(a,n))==null?void 0:i.trim()};function xh(n){if(!n)return!0;for(let e in n)return!1;return!0}function Ih(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function vh(n,e){for(let t in e){if(!Ih(e,t))continue;let r=t.toLowerCase();if(!r)continue;let a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}function Ia(n,...e){var t;typeof process!="undefined"&&((t=process==null?void 0:process.env)==null?void 0:t.DEBUG)==="true"&&console.log(`OpenAI:DEBUG:${n}`,...e)}var I_=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Ph=()=>typeof window!="undefined"&&typeof window.document!="undefined"&&typeof navigator!="undefined",P_=n=>typeof(n==null?void 0:n.get)=="function";var Ah=(n,e)=>{var r;let t=e.toLowerCase();if(P_(n)){let a=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(s,i,o)=>i+o.toUpperCase());for(let s of[e,t,e.toUpperCase(),a]){let i=n.get(s);if(i)return i}}for(let[a,s]of Object.entries(n))if(a.toLowerCase()===t)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${e} header, using the first entry.`),s[0]):s};function Pa(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}var Qi=class extends Ms{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.object=r.object}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}nextPageParams(){return null}nextPageInfo(){return null}},he=class extends Ms{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[]}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var r;let e=this.getPaginatedItems();if(!e.length)return null;let t=(r=e[e.length-1])==null?void 0:r.id;return t?{params:{after:t}}:null}};var $=class{constructor(e){this._client=e}};var Ta=class extends ${create(e,t){var r;return this._client.post("/chat/completions",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}};var Fr=class extends ${constructor(){super(...arguments),this.completions=new Ta(this._client)}};Fr.Completions=Ta;var Sa=class extends ${create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}};var Ca=class extends ${create(e,t){return this._client.post("/audio/transcriptions",vt({body:e,...t}))}};var ka=class extends ${create(e,t){return this._client.post("/audio/translations",vt({body:e,...t}))}};var Yt=class extends ${constructor(){super(...arguments),this.transcriptions=new Ca(this._client),this.translations=new ka(this._client),this.speech=new Sa(this._client)}};Yt.Transcriptions=Ca;Yt.Translations=ka;Yt.Speech=Sa;var Ur=class extends ${create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/batches",pn,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}},pn=class extends he{};Ur.BatchesPage=pn;var mn=class extends ${create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/assistants",Ra,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}},Ra=class extends he{};mn.AssistantsPage=Ra;function _c(n){return typeof n.parse=="function"}var zr=n=>(n==null?void 0:n.role)==="assistant",wc=n=>(n==null?void 0:n.role)==="function",vc=n=>(n==null?void 0:n.role)==="tool";var jt=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},fe=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ac,eo,to,Fs,Us,ro,zs,br,Bs,no,ao,Na,Th,$a=class{constructor(){Ac.add(this),this.controller=new AbortController,eo.set(this,void 0),to.set(this,()=>{}),Fs.set(this,()=>{}),Us.set(this,void 0),ro.set(this,()=>{}),zs.set(this,()=>{}),br.set(this,{}),Bs.set(this,!1),no.set(this,!1),ao.set(this,!1),Na.set(this,!1),jt(this,eo,new Promise((e,t)=>{jt(this,to,e,"f"),jt(this,Fs,t,"f")}),"f"),jt(this,Us,new Promise((e,t)=>{jt(this,ro,e,"f"),jt(this,zs,t,"f")}),"f"),fe(this,eo,"f").catch(()=>{}),fe(this,Us,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},fe(this,Ac,"m",Th).bind(this))},0)}_connected(){this.ended||(fe(this,to,"f").call(this),this._emit("connect"))}get ended(){return fe(this,Bs,"f")}get errored(){return fe(this,no,"f")}get aborted(){return fe(this,ao,"f")}abort(){this.controller.abort()}on(e,t){return(fe(this,br,"f")[e]||(fe(this,br,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=fe(this,br,"f")[e];if(!r)return this;let a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(fe(this,br,"f")[e]||(fe(this,br,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{jt(this,Na,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){jt(this,Na,!0,"f"),await fe(this,Us,"f")}_emit(e,...t){if(fe(this,Bs,"f"))return;e==="end"&&(jt(this,Bs,!0,"f"),fe(this,ro,"f").call(this));let r=fe(this,br,"f")[e];if(r&&(fe(this,br,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){let a=t[0];!fe(this,Na,"f")&&!(r!=null&&r.length)&&Promise.reject(a),fe(this,Fs,"f").call(this,a),fe(this,zs,"f").call(this,a),this._emit("end");return}if(e==="error"){let a=t[0];!fe(this,Na,"f")&&!(r!=null&&r.length)&&Promise.reject(a),fe(this,Fs,"f").call(this,a),fe(this,zs,"f").call(this,a),this._emit("end")}}_emitFinal(){}};eo=new WeakMap,to=new WeakMap,Fs=new WeakMap,Us=new WeakMap,ro=new WeakMap,zs=new WeakMap,br=new WeakMap,Bs=new WeakMap,no=new WeakMap,ao=new WeakMap,Na=new WeakMap,Ac=new WeakSet,Th=function(e){if(jt(this,no,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new ge),e instanceof ge)return jt(this,ao,!0,"f"),this._emit("abort",e);if(e instanceof F)return this._emit("error",e);if(e instanceof Error){let t=new F(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new F(String(e)))};function Sh(n,e){let t={...n};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function Ec(n){return(n==null?void 0:n.$brand)==="auto-parseable-response-format"}function Ch(n,{parser:e,callback:t}){let r={...n};return Object.defineProperties(r,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:t,enumerable:!1}}),r}function gn(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function kh(n,e){return!e||!Oc(e)?{...n,choices:n.choices.map(t=>{var r;return{...t,message:{...t.message,parsed:null,tool_calls:(r=t.message.tool_calls)!=null?r:[]}}})}:qs(n,e)}function qs(n,e){let t=n.choices.map(r=>{var a,s;if(r.finish_reason==="length")throw new Oa;if(r.finish_reason==="content_filter")throw new xa;return{...r,message:{...r.message,tool_calls:(s=(a=r.message.tool_calls)==null?void 0:a.map(i=>$_(e,i)))!=null?s:[],parsed:r.message.content&&!r.message.refusal?N_(e,r.message.content):null}}});return{...n,choices:t}}function N_(n,e){var t,r;return((t=n.response_format)==null?void 0:t.type)!=="json_schema"?null:((r=n.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function $_(n,e){var r;let t=(r=n.tools)==null?void 0:r.find(a=>{var s;return((s=a.function)==null?void 0:s.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:gn(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function Rh(n,e){var r;if(!n)return!1;let t=(r=n.tools)==null?void 0:r.find(a=>{var s;return((s=a.function)==null?void 0:s.name)===e.function.name});return gn(t)||(t==null?void 0:t.function.strict)||!1}function Oc(n){var e,t;return Ec(n.response_format)?!0:(t=(e=n.tools)==null?void 0:e.some(r=>gn(r)||r.type==="function"&&r.function.strict===!0))!=null?t:!1}function Nh(n){for(let e of n!=null?n:[]){if(e.type!=="function")throw new F(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new F(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var et=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},De,xc,so,Ic,Pc,Tc,jh,Sc,$h=10,ja=class extends $a{constructor(){super(...arguments),De.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(wc(e)||vc(e))&&e.content)this._emit("functionCallResult",e.content);else if(zr(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(zr(e)&&e.tool_calls)for(let r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new F("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),et(this,De,"m",xc).call(this)}async finalMessage(){return await this.done(),et(this,De,"m",so).call(this)}async finalFunctionCall(){return await this.done(),et(this,De,"m",Ic).call(this)}async finalFunctionCallResult(){return await this.done(),et(this,De,"m",Pc).call(this)}async totalUsage(){return await this.done(),et(this,De,"m",Tc).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=et(this,De,"m",so).call(this);t&&this._emit("finalMessage",t);let r=et(this,De,"m",xc).call(this);r&&this._emit("finalContent",r);let a=et(this,De,"m",Ic).call(this);a&&this._emit("finalFunctionCall",a);let s=et(this,De,"m",Pc).call(this);s!=null&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",et(this,De,"m",Tc).call(this))}async _createChatCompletion(e,t,r){let a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),et(this,De,"m",jh).call(this,t);let s=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(qs(s,t))}async _runChatCompletion(e,t,r){for(let a of t.messages)this._addMessage(a,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){var h;let a="function",{function_call:s="auto",stream:i,...o}=t,u=typeof s!="string"&&(s==null?void 0:s.name),{maxChatCompletions:c=$h}=r||{},l={};for(let f of t.functions)l[f.name||f.function.name]=f;let d=t.functions.map(f=>({name:f.name||f.function.name,parameters:f.parameters,description:f.description}));for(let f of t.messages)this._addMessage(f,!1);for(let f=0;f<c;++f){let m=(h=(await this._createChatCompletion(e,{...o,function_call:s,functions:d,messages:[...this.messages]},r)).choices[0])==null?void 0:h.message;if(!m)throw new F("missing message in ChatCompletion response");if(!m.function_call)return;let{name:g,arguments:y}=m.function_call,b=l[g];if(b){if(u&&u!==g){let v=`Invalid function_call: ${JSON.stringify(g)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,name:g,content:v});continue}}else{let v=`Invalid function_call: ${JSON.stringify(g)}. Available options are: ${d.map(E=>JSON.stringify(E.name)).join(", ")}. Please try again`;this._addMessage({role:a,name:g,content:v});continue}let A;try{A=_c(b)?await b.parse(y):y}catch(v){this._addMessage({role:a,name:g,content:v instanceof Error?v.message:String(v)});continue}let x=await b.function(A,this),_=et(this,De,"m",Sc).call(this,x);if(this._addMessage({role:a,name:g,content:_}),u)return}}async _runTools(e,t,r){var f,p,m;let a="tool",{tool_choice:s="auto",stream:i,...o}=t,u=typeof s!="string"&&((f=s==null?void 0:s.function)==null?void 0:f.name),{maxChatCompletions:c=$h}=r||{},l=t.tools.map(g=>{if(gn(g)){if(!g.$callback)throw new F("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:g.$callback,name:g.function.name,description:g.function.description||"",parameters:g.function.parameters,parse:g.$parseRaw,strict:!0}}}return g}),d={};for(let g of l)g.type==="function"&&(d[g.function.name||g.function.function.name]=g.function);let h="tools"in t?l.map(g=>g.type==="function"?{type:"function",function:{name:g.function.name||g.function.function.name,parameters:g.function.parameters,description:g.function.description,strict:g.function.strict}}:g):void 0;for(let g of t.messages)this._addMessage(g,!1);for(let g=0;g<c;++g){let b=(p=(await this._createChatCompletion(e,{...o,tool_choice:s,tools:h,messages:[...this.messages]},r)).choices[0])==null?void 0:p.message;if(!b)throw new F("missing message in ChatCompletion response");if(!((m=b.tool_calls)!=null&&m.length))return;for(let A of b.tool_calls){if(A.type!=="function")continue;let x=A.id,{name:_,arguments:v}=A.function,E=d[_];if(E){if(u&&u!==_){let q=`Invalid tool_call: ${JSON.stringify(_)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,tool_call_id:x,content:q});continue}}else{let q=`Invalid tool_call: ${JSON.stringify(_)}. Available options are: ${Object.keys(d).map(H=>JSON.stringify(H)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:x,content:q});continue}let O;try{O=_c(E)?await E.parse(v):v}catch(q){let H=q instanceof Error?q.message:String(q);this._addMessage({role:a,tool_call_id:x,content:H});continue}let S=await E.function(O,this),L=et(this,De,"m",Sc).call(this,S);if(this._addMessage({role:a,tool_call_id:x,content:L}),u)return}}}};De=new WeakSet,xc=function(){var e;return(e=et(this,De,"m",so).call(this).content)!=null?e:null},so=function(){var t,r;let e=this.messages.length;for(;e-- >0;){let a=this.messages[e];if(zr(a)){let{function_call:s,...i}=a,o={...i,content:(t=a.content)!=null?t:null,refusal:(r=a.refusal)!=null?r:null};return s&&(o.function_call=s),o}}throw new F("stream ended without producing a ChatCompletionMessage with role=assistant")},Ic=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){let a=this.messages[r];if(zr(a)&&(a!=null&&a.function_call))return a.function_call;if(zr(a)&&((e=a==null?void 0:a.tool_calls)!=null&&e.length))return(t=a.tool_calls.at(-1))==null?void 0:t.function}},Pc=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(wc(t)&&t.content!=null||vc(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(r=>{var a;return r.role==="assistant"&&((a=r.tool_calls)==null?void 0:a.some(s=>s.type==="function"&&s.id===t.tool_call_id))}))return t.content}},Tc=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},jh=function(e){if(e.n!=null&&e.n>1)throw new F("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Sc=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var Hs=class n extends ja{static runFunctions(e,t,r){let a=new n,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){let a=new n,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}_addMessage(e,t=!0){super._addMessage(e,t),zr(e)&&e.content&&this._emit("content",e.content)}};var Pe={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,INF:384,SPECIAL:496,ATOM:499,COLLECTION:12,ALL:511},Cc=class extends Error{},kc=class extends Error{};function j_(n,e=Pe.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return L_(n.trim(),e)}var L_=(n,e)=>{let t=n.length,r=0,a=h=>{throw new Cc(`${h} at position ${r}`)},s=h=>{throw new kc(`${h} at position ${r}`)},i=()=>(d(),r>=t&&a("Unexpected end of input"),n[r]==='"'?o():n[r]==="{"?u():n[r]==="["?c():n.substring(r,r+4)==="null"||Pe.NULL&e&&t-r<4&&"null".startsWith(n.substring(r))?(r+=4,null):n.substring(r,r+4)==="true"||Pe.BOOL&e&&t-r<4&&"true".startsWith(n.substring(r))?(r+=4,!0):n.substring(r,r+5)==="false"||Pe.BOOL&e&&t-r<5&&"false".startsWith(n.substring(r))?(r+=5,!1):n.substring(r,r+8)==="Infinity"||Pe.INFINITY&e&&t-r<8&&"Infinity".startsWith(n.substring(r))?(r+=8,1/0):n.substring(r,r+9)==="-Infinity"||Pe.MINUS_INFINITY&e&&1<t-r&&t-r<9&&"-Infinity".startsWith(n.substring(r))?(r+=9,-1/0):n.substring(r,r+3)==="NaN"||Pe.NAN&e&&t-r<3&&"NaN".startsWith(n.substring(r))?(r+=3,NaN):l()),o=()=>{let h=r,f=!1;for(r++;r<t&&(n[r]!=='"'||f&&n[r-1]==="\\");)f=n[r]==="\\"?!f:!1,r++;if(n.charAt(r)=='"')try{return JSON.parse(n.substring(h,++r-Number(f)))}catch(p){s(String(p))}else if(Pe.STR&e)try{return JSON.parse(n.substring(h,r-Number(f))+'"')}catch(p){return JSON.parse(n.substring(h,n.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},u=()=>{r++,d();let h={};try{for(;n[r]!=="}";){if(d(),r>=t&&Pe.OBJ&e)return h;let f=o();d(),r++;try{let p=i();Object.defineProperty(h,f,{value:p,writable:!0,enumerable:!0,configurable:!0})}catch(p){if(Pe.OBJ&e)return h;throw p}d(),n[r]===","&&r++}}catch(f){if(Pe.OBJ&e)return h;a("Expected '}' at end of object")}return r++,h},c=()=>{r++;let h=[];try{for(;n[r]!=="]";)h.push(i()),d(),n[r]===","&&r++}catch(f){if(Pe.ARR&e)return h;a("Expected ']' at end of array")}return r++,h},l=()=>{if(r===0){n==="-"&&Pe.NUM&e&&a("Not sure what '-' is");try{return JSON.parse(n)}catch(f){if(Pe.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch(p){}s(String(f))}}let h=r;for(n[r]==="-"&&r++;n[r]&&!",]}".includes(n[r]);)r++;r==t&&!(Pe.NUM&e)&&a("Unterminated number literal");try{return JSON.parse(n.substring(h,r))}catch(f){n.substring(h,r)==="-"&&Pe.NUM&e&&a("Not sure what '-' is");try{return JSON.parse(n.substring(h,n.lastIndexOf("e")))}catch(p){s(String(p))}}},d=()=>{for(;r<t&&` 
\r	`.includes(n[r]);)r++};return i()},Rc=n=>j_(n,Pe.ALL^Pe.NUM);var La=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},se=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ee,_r,Da,Br,Nc,io,$c,jc,Lc,oo,Dc,Lh,Ma=class n extends ja{constructor(e){super(),Ee.add(this),_r.set(this,void 0),Da.set(this,void 0),Br.set(this,void 0),La(this,_r,e,"f"),La(this,Da,[],"f")}get currentChatCompletionSnapshot(){return se(this,Br,"f")}static fromReadableStream(e){let t=new n(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let a=new n(t);return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,r){var i;super._createChatCompletion;let a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),se(this,Ee,"m",Nc).call(this);let s=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(let o of s)se(this,Ee,"m",$c).call(this,o);if((i=s.controller.signal)!=null&&i.aborted)throw new ge;return this._addChatCompletion(se(this,Ee,"m",oo).call(this))}async _fromReadableStream(e,t){var i;let r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),se(this,Ee,"m",Nc).call(this),this._connected();let a=Wt.fromReadableStream(e,this.controller),s;for await(let o of a)s&&s!==o.id&&this._addChatCompletion(se(this,Ee,"m",oo).call(this)),se(this,Ee,"m",$c).call(this,o),s=o.id;if((i=a.controller.signal)!=null&&i.aborted)throw new ge;return this._addChatCompletion(se(this,Ee,"m",oo).call(this))}[(_r=new WeakMap,Da=new WeakMap,Br=new WeakMap,Ee=new WeakSet,Nc=function(){this.ended||La(this,Br,void 0,"f")},io=function(t){let r=se(this,Da,"f")[t.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},se(this,Da,"f")[t.index]=r,r)},$c=function(t){var a,s,i,o,u,c,l,d,h,f,p,m,g,y,b,A,x,_,v,E;if(this.ended)return;let r=se(this,Ee,"m",Lh).call(this,t);this._emit("chunk",t,r);for(let O of t.choices){let S=r.choices[O.index];O.delta.content!=null&&((a=S.message)==null?void 0:a.role)==="assistant"&&((s=S.message)!=null&&s.content)&&(this._emit("content",O.delta.content,S.message.content),this._emit("content.delta",{delta:O.delta.content,snapshot:S.message.content,parsed:S.message.parsed})),O.delta.refusal!=null&&((i=S.message)==null?void 0:i.role)==="assistant"&&((o=S.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:O.delta.refusal,snapshot:S.message.refusal}),((u=O.logprobs)==null?void 0:u.content)!=null&&((c=S.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(l=O.logprobs)==null?void 0:l.content,snapshot:(h=(d=S.logprobs)==null?void 0:d.content)!=null?h:[]}),((f=O.logprobs)==null?void 0:f.refusal)!=null&&((p=S.message)==null?void 0:p.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(m=O.logprobs)==null?void 0:m.refusal,snapshot:(y=(g=S.logprobs)==null?void 0:g.refusal)!=null?y:[]});let L=se(this,Ee,"m",io).call(this,S);S.finish_reason&&(se(this,Ee,"m",Lc).call(this,S),L.current_tool_call_index!=null&&se(this,Ee,"m",jc).call(this,S,L.current_tool_call_index));for(let q of(b=O.delta.tool_calls)!=null?b:[])L.current_tool_call_index!==q.index&&(se(this,Ee,"m",Lc).call(this,S),L.current_tool_call_index!=null&&se(this,Ee,"m",jc).call(this,S,L.current_tool_call_index)),L.current_tool_call_index=q.index;for(let q of(A=O.delta.tool_calls)!=null?A:[]){let H=(x=S.message.tool_calls)==null?void 0:x[q.index];H!=null&&H.type&&((H==null?void 0:H.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(_=H.function)==null?void 0:_.name,index:q.index,arguments:H.function.arguments,parsed_arguments:H.function.parsed_arguments,arguments_delta:(E=(v=q.function)==null?void 0:v.arguments)!=null?E:""}):(H==null||H.type,void 0))}}},jc=function(t,r){var i,o,u;if(se(this,Ee,"m",io).call(this,t).done_tool_calls.has(r))return;let s=(i=t.message.tool_calls)==null?void 0:i[r];if(!s)throw new Error("no tool call snapshot");if(!s.type)throw new Error("tool call snapshot missing `type`");if(s.type==="function"){let c=(u=(o=se(this,_r,"f"))==null?void 0:o.tools)==null?void 0:u.find(l=>l.type==="function"&&l.function.name===s.function.name);this._emit("tool_calls.function.arguments.done",{name:s.function.name,index:r,arguments:s.function.arguments,parsed_arguments:gn(c)?c.$parseRaw(s.function.arguments):c!=null&&c.function.strict?JSON.parse(s.function.arguments):null})}else s.type},Lc=function(t){var a,s;let r=se(this,Ee,"m",io).call(this,t);if(t.message.content&&!r.content_done){r.content_done=!0;let i=se(this,Ee,"m",Dc).call(this);this._emit("content.done",{content:t.message.content,parsed:i?i.$parseRaw(t.message.content):null})}t.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),(a=t.logprobs)!=null&&a.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),(s=t.logprobs)!=null&&s.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},oo=function(){if(this.ended)throw new F("stream has ended, this shouldn't happen");let t=se(this,Br,"f");if(!t)throw new F("request ended without sending any chunks");return La(this,Br,void 0,"f"),La(this,Da,[],"f"),D_(t,se(this,_r,"f"))},Dc=function(){var r;let t=(r=se(this,_r,"f"))==null?void 0:r.response_format;return Ec(t)?t:null},Lh=function(t){var l,d,h,f,p,m;var r,a,s,i;let o=se(this,Br,"f"),{choices:u,...c}=t;o?Object.assign(o,c):o=La(this,Br,{...c,choices:[]},"f");for(let{delta:g,finish_reason:y,index:b,logprobs:A=null,...x}of t.choices){let _=o.choices[b];if(_||(_=o.choices[b]={finish_reason:y,index:b,message:{},logprobs:A,...x}),A)if(!_.logprobs)_.logprobs=Object.assign({},A);else{let{content:H,refusal:de,...Ie}=A;Object.assign(_.logprobs,Ie),H&&((l=(r=_.logprobs).content)!=null||(r.content=[]),_.logprobs.content.push(...H)),de&&((d=(a=_.logprobs).refusal)!=null||(a.refusal=[]),_.logprobs.refusal.push(...de))}if(y&&(_.finish_reason=y,se(this,_r,"f")&&Oc(se(this,_r,"f")))){if(y==="length")throw new Oa;if(y==="content_filter")throw new xa}if(Object.assign(_,x),!g)continue;let{content:v,refusal:E,function_call:O,role:S,tool_calls:L,...q}=g;if(Object.assign(_.message,q),E&&(_.message.refusal=(_.message.refusal||"")+E),S&&(_.message.role=S),O&&(_.message.function_call?(O.name&&(_.message.function_call.name=O.name),O.arguments&&((h=(s=_.message.function_call).arguments)!=null||(s.arguments=""),_.message.function_call.arguments+=O.arguments)):_.message.function_call=O),v&&(_.message.content=(_.message.content||"")+v,!_.message.refusal&&se(this,Ee,"m",Dc).call(this)&&(_.message.parsed=Rc(_.message.content))),L){_.message.tool_calls||(_.message.tool_calls=[]);for(let{index:H,id:de,type:Ie,function:ve,...cn}of L){let Le=(f=(i=_.message.tool_calls)[H])!=null?f:i[H]={};Object.assign(Le,cn),de&&(Le.id=de),Ie&&(Le.type=Ie),ve&&((m=Le.function)!=null||(Le.function={name:(p=ve.name)!=null?p:"",arguments:""})),ve!=null&&ve.name&&(Le.function.name=ve.name),ve!=null&&ve.arguments&&(Le.function.arguments+=ve.arguments,Rh(se(this,_r,"f"),Le)&&(Le.function.parsed_arguments=Rc(Le.function.arguments)))}}}return o},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",a=>{let s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(let a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Wt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function D_(n,e){let{id:t,choices:r,created:a,model:s,system_fingerprint:i,...o}=n,u={...o,id:t,choices:r.map(({message:c,finish_reason:l,index:d,logprobs:h,...f})=>{var A,x,_;if(!l)throw new F(`missing finish_reason for choice ${d}`);let{content:p=null,function_call:m,tool_calls:g,...y}=c,b=c.role;if(!b)throw new F(`missing role for choice ${d}`);if(m){let{arguments:v,name:E}=m;if(v==null)throw new F(`missing function_call.arguments for choice ${d}`);if(!E)throw new F(`missing function_call.name for choice ${d}`);return{...f,message:{content:p,function_call:{arguments:v,name:E},role:b,refusal:(A=c.refusal)!=null?A:null},finish_reason:l,index:d,logprobs:h}}return g?{...f,index:d,finish_reason:l,logprobs:h,message:{...y,role:b,content:p,refusal:(x=c.refusal)!=null?x:null,tool_calls:g.map((v,E)=>{let{function:O,type:S,id:L,...q}=v,{arguments:H,name:de,...Ie}=O||{};if(L==null)throw new F(`missing choices[${d}].tool_calls[${E}].id
${uo(n)}`);if(S==null)throw new F(`missing choices[${d}].tool_calls[${E}].type
${uo(n)}`);if(de==null)throw new F(`missing choices[${d}].tool_calls[${E}].function.name
${uo(n)}`);if(H==null)throw new F(`missing choices[${d}].tool_calls[${E}].function.arguments
${uo(n)}`);return{...q,id:L,type:S,function:{...Ie,name:de,arguments:H}}})}}:{...f,message:{...y,content:p,role:b,refusal:(_=c.refusal)!=null?_:null},finish_reason:l,index:d,logprobs:h}}),created:a,model:s,object:"chat.completion",...i?{system_fingerprint:i}:{}};return kh(u,e)}function uo(n){return JSON.stringify(n)}var Vs=class n extends Ma{static fromReadableStream(e){let t=new n(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){let a=new n(null),s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){let a=new n(t),s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}};var Gs=class extends ${parse(e,t){return Nh(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t==null?void 0:t.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(r=>qs(r,e))}runFunctions(e,t){return e.stream?Vs.runFunctions(this._client,e,t):Hs.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Vs.runTools(this._client,e,t):Hs.runTools(this._client,e,t)}stream(e,t){return Ma.createChatCompletion(this._client,e,t)}};var Fa=class extends ${constructor(){super(...arguments),this.completions=new Gs(this._client)}};(function(n){n.Completions=Gs})(Fa||(Fa={}));var M=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ht=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},Re,Mc,Xt,co,Lt,bn,Ua,yn,fo,ft,lo,ho,Js,Ks,Zs,Dh,Mh,Fh,Uh,zh,Bh,qh,Qt=class n extends $a{constructor(){super(...arguments),Re.add(this),Mc.set(this,[]),Xt.set(this,{}),co.set(this,{}),Lt.set(this,void 0),bn.set(this,void 0),Ua.set(this,void 0),yn.set(this,void 0),fo.set(this,void 0),ft.set(this,void 0),lo.set(this,void 0),ho.set(this,void 0),Js.set(this,void 0)}[(Mc=new WeakMap,Xt=new WeakMap,co=new WeakMap,Lt=new WeakMap,bn=new WeakMap,Ua=new WeakMap,yn=new WeakMap,fo=new WeakMap,ft=new WeakMap,lo=new WeakMap,ho=new WeakMap,Js=new WeakMap,Re=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",a=>{let s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(let a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var s;let r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let a=Wt.fromReadableStream(e,this.controller);for await(let i of a)M(this,Re,"m",Ks).call(this,i);if((s=a.controller.signal)!=null&&s.aborted)throw new ge;return this._addRun(M(this,Re,"m",Zs).call(this))}toReadableStream(){return new Wt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,a,s){let i=new n;return i._run(()=>i._runToolAssistantStream(e,t,r,a,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,a,s){var c;let i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o={...a,stream:!0},u=await e.submitToolOutputs(t,r,o,{...s,signal:this.controller.signal});this._connected();for await(let l of u)M(this,Re,"m",Ks).call(this,l);if((c=u.controller.signal)!=null&&c.aborted)throw new ge;return this._addRun(M(this,Re,"m",Zs).call(this))}static createThreadAssistantStream(e,t,r){let a=new n;return a._run(()=>a._threadAssistantStream(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}static createAssistantStream(e,t,r,a){let s=new n;return s._run(()=>s._runAssistantStream(e,t,r,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),s}currentEvent(){return M(this,lo,"f")}currentRun(){return M(this,ho,"f")}currentMessageSnapshot(){return M(this,Lt,"f")}currentRunStepSnapshot(){return M(this,Js,"f")}async finalRunSteps(){return await this.done(),Object.values(M(this,Xt,"f"))}async finalMessages(){return await this.done(),Object.values(M(this,co,"f"))}async finalRun(){if(await this.done(),!M(this,bn,"f"))throw Error("Final run was not received.");return M(this,bn,"f")}async _createThreadAssistantStream(e,t,r){var o;let a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let s={...t,stream:!0},i=await e.createAndRun(s,{...r,signal:this.controller.signal});this._connected();for await(let u of i)M(this,Re,"m",Ks).call(this,u);if((o=i.controller.signal)!=null&&o.aborted)throw new ge;return this._addRun(M(this,Re,"m",Zs).call(this))}async _createAssistantStream(e,t,r,a){var u;let s=a==null?void 0:a.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i={...r,stream:!0},o=await e.create(t,i,{...a,signal:this.controller.signal});this._connected();for await(let c of o)M(this,Re,"m",Ks).call(this,c);if((u=o.controller.signal)!=null&&u.aborted)throw new ge;return this._addRun(M(this,Re,"m",Zs).call(this))}static accumulateDelta(e,t){for(let[r,a]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=a;continue}let s=e[r];if(s==null){e[r]=a;continue}if(r==="index"||r==="type"){e[r]=a;continue}if(typeof s=="string"&&typeof a=="string")s+=a;else if(typeof s=="number"&&typeof a=="number")s+=a;else if(Pa(s)&&Pa(a))s=this.accumulateDelta(s,a);else if(Array.isArray(s)&&Array.isArray(a)){if(s.every(i=>typeof i=="string"||typeof i=="number")){s.push(...a);continue}for(let i of a){if(!Pa(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);let o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);let u=s[o];u==null?s.push(i):s[o]=this.accumulateDelta(u,i)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${a}, accValue: ${s}`);e[r]=s}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,a){return await this._createAssistantStream(t,e,r,a)}async _runToolAssistantStream(e,t,r,a,s){return await this._createToolAssistantStream(r,e,t,a,s)}};Ks=function(e){if(!this.ended)switch(ht(this,lo,e,"f"),M(this,Re,"m",Fh).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":M(this,Re,"m",qh).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":M(this,Re,"m",Mh).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":M(this,Re,"m",Dh).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Zs=function(){if(this.ended)throw new F("stream has ended, this shouldn't happen");if(!M(this,bn,"f"))throw Error("Final run has not been received");return M(this,bn,"f")},Dh=function(e){let[t,r]=M(this,Re,"m",zh).call(this,e,M(this,Lt,"f"));ht(this,Lt,t,"f"),M(this,co,"f")[t.id]=t;for(let a of r){let s=t.content[a.index];(s==null?void 0:s.type)=="text"&&this._emit("textCreated",s.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let a of e.data.delta.content){if(a.type=="text"&&a.text){let s=a.text,i=t.content[a.index];if(i&&i.type=="text")this._emit("textDelta",s,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(a.index!=M(this,Ua,"f")){if(M(this,yn,"f"))switch(M(this,yn,"f").type){case"text":this._emit("textDone",M(this,yn,"f").text,M(this,Lt,"f"));break;case"image_file":this._emit("imageFileDone",M(this,yn,"f").image_file,M(this,Lt,"f"));break}ht(this,Ua,a.index,"f")}ht(this,yn,t.content[a.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(M(this,Ua,"f")!==void 0){let a=e.data.content[M(this,Ua,"f")];if(a)switch(a.type){case"image_file":this._emit("imageFileDone",a.image_file,M(this,Lt,"f"));break;case"text":this._emit("textDone",a.text,M(this,Lt,"f"));break}}M(this,Lt,"f")&&this._emit("messageDone",e.data),ht(this,Lt,void 0,"f")}},Mh=function(e){let t=M(this,Re,"m",Uh).call(this,e);switch(ht(this,Js,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let s of r.step_details.tool_calls)s.index==M(this,fo,"f")?this._emit("toolCallDelta",s,t.step_details.tool_calls[s.index]):(M(this,ft,"f")&&this._emit("toolCallDone",M(this,ft,"f")),ht(this,fo,s.index,"f"),ht(this,ft,t.step_details.tool_calls[s.index],"f"),M(this,ft,"f")&&this._emit("toolCallCreated",M(this,ft,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ht(this,Js,void 0,"f"),e.data.step_details.type=="tool_calls"&&M(this,ft,"f")&&(this._emit("toolCallDone",M(this,ft,"f")),ht(this,ft,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},Fh=function(e){M(this,Mc,"f").push(e),this._emit("event",e)},Uh=function(e){switch(e.event){case"thread.run.step.created":return M(this,Xt,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=M(this,Xt,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let a=Qt.accumulateDelta(t,r.delta);M(this,Xt,"f")[e.data.id]=a}return M(this,Xt,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":M(this,Xt,"f")[e.data.id]=e.data;break}if(M(this,Xt,"f")[e.data.id])return M(this,Xt,"f")[e.data.id];throw new Error("No snapshot available")},zh=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let a=e.data;if(a.delta.content)for(let s of a.delta.content)if(s.index in t.content){let i=t.content[s.index];t.content[s.index]=M(this,Re,"m",Bh).call(this,s,i)}else t.content[s.index]=s,r.push(s);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Bh=function(e,t){return Qt.accumulateDelta(t,e)},qh=function(e){switch(ht(this,ho,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":ht(this,bn,e.data,"f"),M(this,ft,"f")&&(this._emit("toolCallDone",M(this,ft,"f")),ht(this,ft,void 0,"f"));break;case"thread.run.cancelling":break}};var _n=class extends ${create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},r){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,za,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}},za=class extends he{};_n.MessagesPage=za;var wn=class extends ${retrieve(e,t,r,a={},s){return ue(a)?this.retrieve(e,t,r,{},a):this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{query:a,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,t,r={},a){return ue(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Ba,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}},Ba=class extends he{};wn.RunStepsPage=Ba;var wr=class extends ${constructor(){super(...arguments),this.steps=new wn(this._client)}create(e,t,r){var i;let{include:a,...s}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:a},body:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers},stream:(i=t.stream)!=null?i:!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},r){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,qa,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}createAndStream(e,t,r){return Qt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){let a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:s,response:i}=await this.retrieve(e,t,{...r,headers:{...r==null?void 0:r.headers,...a}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{let u=i.headers.get("openai-poll-after-ms");if(u){let c=parseInt(u);isNaN(c)||(o=c)}}await yr(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,r){return Qt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,a){var s;return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers},stream:(s=r.stream)!=null?s:!1})}async submitToolOutputsAndPoll(e,t,r,a){let s=await this.submitToolOutputs(e,t,r,a);return await this.poll(e,s.id,a)}submitToolOutputsStream(e,t,r,a){return Qt.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,a)}},qa=class extends he{};wr.RunsPage=qa;wr.Steps=wn;wr.RunStepsPage=Ba;var er=class extends ${constructor(){super(...arguments),this.runs=new wr(this._client),this.messages=new _n(this._client)}create(e={},t){return ue(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}createAndRun(e,t){var r;return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers},stream:(r=e.stream)!=null?r:!1})}async createAndRunPoll(e,t){let r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return Qt.createThreadAssistantStream(e,this._client.beta.threads,t)}};er.Runs=wr;er.RunsPage=qa;er.Messages=_n;er.MessagesPage=za;var Hh=async n=>{let e=await Promise.allSettled(n),t=e.filter(a=>a.status==="rejected");if(t.length){for(let a of t)console.error(a.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}let r=[];for(let a of e)a.status==="fulfilled"&&r.push(a.value);return r};var vn=class extends ${create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e,t={},r){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,qr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}async poll(e,t,r){let a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let s=await this.retrieve(e,t,{...r,headers:a}).withResponse(),i=s.data;switch(i.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{let u=s.response.headers.get("openai-poll-after-ms");if(u){let c=parseInt(u);isNaN(c)||(o=c)}}await yr(o);break;case"failed":case"completed":return i}}}async upload(e,t,r){let a=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:a.id},r)}async uploadAndPoll(e,t,r){let a=await this.upload(e,t,r);return await this.poll(e,a.id,r)}},qr=class extends he{};vn.VectorStoreFilesPage=qr;var Ha=class extends ${create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t);return await this.poll(e,a.id,r)}listFiles(e,t,r={},a){return ue(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,qr,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}async poll(e,t,r){let a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:s,response:i}=await this.retrieve(e,t,{...r,headers:a}).withResponse();switch(s.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{let u=i.headers.get("openai-poll-after-ms");if(u){let c=parseInt(u);isNaN(c)||(o=c)}}await yr(o);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},a){var h;if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let s=(h=a==null?void 0:a.maxConcurrency)!=null?h:5,i=Math.min(s,t.length),o=this._client,u=t.values(),c=[...r];async function l(f){for(let p of f){let m=await o.files.create({file:p,purpose:"assistants"},a);c.push(m.id)}}let d=Array(i).fill(u).map(l);return await Hh(d),await this.createAndPoll(e,{file_ids:c})}};var tr=class extends ${constructor(){super(...arguments),this.files=new vn(this._client),this.fileBatches=new Ha(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/vector_stores",Va,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}},Va=class extends he{};tr.VectorStoresPage=Va;tr.Files=vn;tr.VectorStoreFilesPage=qr;tr.FileBatches=Ha;var At=class extends ${constructor(){super(...arguments),this.vectorStores=new tr(this._client),this.chat=new Fa(this._client),this.assistants=new mn(this._client),this.threads=new er(this._client)}};At.VectorStores=tr;At.VectorStoresPage=Va;At.Assistants=mn;At.AssistantsPage=Ra;At.Threads=er;var An=class extends ${create(e,t){var r;return this._client.post("/completions",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}};var En=class extends ${create(e,t){return this._client.post("/embeddings",{body:e,...t})}};var Hr=class extends ${create(e,t){return this._client.post("/files",vt({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/files",On,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t==null?void 0:t.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){let a=new Set(["processed","error","deleted"]),s=Date.now(),i=await this.retrieve(e);for(;!i.status||!a.has(i.status);)if(await yr(t),i=await this.retrieve(e),Date.now()-s>r)throw new $t({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}},On=class extends he{};Hr.FileObjectsPage=On;var xn=class extends ${list(e,t={},r){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Ga,{query:t,...r})}},Ga=class extends he{};xn.FineTuningJobCheckpointsPage=Ga;var rr=class extends ${constructor(){super(...arguments),this.checkpoints=new xn(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Ka,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return ue(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Za,{query:t,...r})}},Ka=class extends he{},Za=class extends he{};rr.FineTuningJobsPage=Ka;rr.FineTuningJobEventsPage=Za;rr.Checkpoints=xn;rr.FineTuningJobCheckpointsPage=Ga;var nr=class extends ${constructor(){super(...arguments),this.jobs=new rr(this._client)}};nr.Jobs=rr;nr.FineTuningJobsPage=Ka;nr.FineTuningJobEventsPage=Za;var In=class extends ${createVariation(e,t){return this._client.post("/images/variations",vt({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",vt({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}};var Vr=class extends ${retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Pn,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}},Pn=class extends Qi{};Vr.ModelsPage=Pn;var Tn=class extends ${create(e,t){return this._client.post("/moderations",{body:e,...t})}};var Ja=class extends ${create(e,t,r){return this._client.post(`/uploads/${e}/parts`,vt({body:t,...r}))}};var Gr=class extends ${constructor(){super(...arguments),this.parts=new Ja(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(`/uploads/${e}/complete`,{body:t,...r})}};Gr.Parts=Ja;var Gh,W=class extends Xi{constructor({baseURL:e=Mr("OPENAI_BASE_URL"),apiKey:t=Mr("OPENAI_API_KEY"),organization:r=(i=>(i=Mr("OPENAI_ORG_ID"))!=null?i:null)(),project:a=(o=>(o=Mr("OPENAI_PROJECT_ID"))!=null?o:null)(),...s}={}){var c;if(t===void 0)throw new F("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let u={apiKey:t,organization:r,project:a,...s,baseURL:e||"https://api.openai.com/v1"};if(!u.dangerouslyAllowBrowser&&Ph())throw new F(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:u.baseURL,timeout:(c=u.timeout)!=null?c:6e5,httpAgent:u.httpAgent,maxRetries:u.maxRetries,fetch:u.fetch}),this.completions=new An(this),this.chat=new Fr(this),this.embeddings=new En(this),this.files=new Hr(this),this.images=new In(this),this.audio=new Yt(this),this.moderations=new Tn(this),this.models=new Vr(this),this.fineTuning=new nr(this),this.beta=new At(this),this.batches=new Ur(this),this.uploads=new Gr(this),this._options=u,this.apiKey=t,this.organization=r,this.project=a}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return sc(e,{arrayFormat:"brackets"})}};Gh=W;W.OpenAI=Gh;W.DEFAULT_TIMEOUT=6e5;W.OpenAIError=F;W.APIError=_e;W.APIConnectionError=gr;W.APIConnectionTimeoutError=$t;W.APIUserAbortError=ge;W.NotFoundError=_a;W.ConflictError=wa;W.RateLimitError=Aa;W.BadRequestError=ga;W.AuthenticationError=ya;W.InternalServerError=Ea;W.PermissionDeniedError=ba;W.UnprocessableEntityError=va;W.toFile=mc;W.fileFromPath=Gi;W.Completions=An;W.Chat=Fr;W.Embeddings=En;W.Files=Hr;W.FileObjectsPage=On;W.Images=In;W.Audio=Yt;W.Moderations=Tn;W.Models=Vr;W.ModelsPage=Pn;W.FineTuning=nr;W.Beta=At;W.Batches=Ur;W.BatchesPage=pn;W.Uploads=Gr;var po=class extends W{constructor({baseURL:e=Mr("OPENAI_BASE_URL"),apiKey:t=Mr("AZURE_OPENAI_API_KEY"),apiVersion:r=Mr("OPENAI_API_VERSION"),endpoint:a,deployment:s,azureADTokenProvider:i,dangerouslyAllowBrowser:o,...u}={}){if(!r)throw new F("The OPENAI_API_VERSION environment variable is missing or empty; either provide it, or instantiate the AzureOpenAI client with an apiVersion option, like new AzureOpenAI({ apiVersion: 'My API Version' }).");if(typeof i=="function"&&(o=!0),!i&&!t)throw new F("Missing credentials. Please pass one of `apiKey` and `azureADTokenProvider`, or set the `AZURE_OPENAI_API_KEY` environment variable.");if(i&&t)throw new F("The `apiKey` and `azureADTokenProvider` arguments are mutually exclusive; only one can be passed at a time.");if(t!=null||(t=Vh),u.defaultQuery={...u.defaultQuery,"api-version":r},e){if(a)throw new F("baseURL and endpoint are mutually exclusive")}else{if(a||(a=process.env.AZURE_OPENAI_ENDPOINT),!a)throw new F("Must provide one of the `baseURL` or `endpoint` arguments, or the `AZURE_OPENAI_ENDPOINT` environment variable");e=`${a}/openai`}super({apiKey:t,baseURL:e,...u,...o!==void 0?{dangerouslyAllowBrowser:o}:{}}),this.apiVersion="",this._azureADTokenProvider=i,this.apiVersion=r,this._deployment=s}buildRequest(e){if(Y_.has(e.path)&&e.method==="post"&&e.body!==void 0){if(!Pa(e.body))throw new Error("Expected request body to be an object");let t=this._deployment||e.body.model;t!==void 0&&!this.baseURL.includes("/deployments")&&(e.path=`/deployments/${t}${e.path}`)}return super.buildRequest(e)}async _getAzureADToken(){if(typeof this._azureADTokenProvider=="function"){let e=await this._azureADTokenProvider();if(!e||typeof e!="string")throw new F(`Expected 'azureADTokenProvider' argument to return a string but it returned ${e}`);return e}}authHeaders(e){return{}}async prepareOptions(e){var r,a;if((r=e.headers)!=null&&r["api-key"])return super.prepareOptions(e);let t=await this._getAzureADToken();if((a=e.headers)!=null||(e.headers={}),t)e.headers.Authorization=`Bearer ${t}`;else if(this.apiKey!==Vh)e.headers["api-key"]=this.apiKey;else throw new F("Unable to handle auth");return super.prepareOptions(e)}},Y_=new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations"]),Vh="<Missing Key>";function Fc(n,e=Wa){n=n.trim();let t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function Wa(n){if(typeof n=="undefined")return null;try{return JSON.parse(n)}catch(s){}let e="",t=[],r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch(s){return null}}var rf=wt(Zh(),1),aw=wt(tf(),1);function nf(n,e){return(e==null?void 0:e[n])||(0,rf.default)(n)}function af(n,e,t){let r={};for(let a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function sf(n){return Array.isArray(n)?[...n]:{...n}}function sw(n,e){let t=sf(n);for(let[r,a]of Object.entries(e)){let[s,...i]=r.split(".").reverse(),o=t;for(let u of i.reverse()){if(o[u]===void 0)break;o[u]=sf(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function zc(n){let e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var Dt=class n{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,zc(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof n||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r,[o,...u]=a.split(".").reverse();for(let c of u.reverse()){if(!(c in s)||s[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof s[c]=="object"&&s[c]!=null?i[c]={}:Array.isArray(s[c])&&(i[c]=[])),s=s[c],i=i[c]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:af(Object.keys(t).length?sw(r,t):r,nf,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function Et(n,e){var t;return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?(t=Ws(n,e))!=null?t:[...n,...e]:[...n,{type:"text",text:e}]}function of(n,e){return n==="error"||e==="error"?"error":"success"}function iw(n,e){function t(r,a){if(typeof r!="object"||r===null||r===void 0)return r;if(a>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(i=>t(i,a+1));let s={};for(let i of Object.keys(r))s[i]=t(r[i],a+1);return s}return JSON.stringify(t(n,0),null,2)}var Ve=class extends Dt{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}getType(){return this._getType()}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;let t=iw(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}};function ye(n,e){let t={...n};for(let[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;t[r]+=a}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=ye(t[r],a);else if(Array.isArray(t[r]))t[r]=Ws(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function Ws(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{let t=[...n];for(let r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){let a=t.findIndex(s=>s.index===r.index);a!==-1?t[a]=ye(t[a],r):t.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}function uf(n,e){if(!n&&!e)throw new Error("Cannot merge two undefined objects.");if(!n||!e)return n||e;if(typeof n!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof n}
Right ${typeof e}`);if(typeof n=="string"&&typeof e=="string")return n+e;if(Array.isArray(n)&&Array.isArray(e))return Ws(n,e);if(typeof n=="object"&&typeof e=="object")return ye(n,e);if(n===e)return n;throw new Error(`Can not merge objects of different types.
Left ${n}
Right ${e}`)}var tt=class extends Ve{};function cf(n){return typeof n.role=="string"}function Kr(n){return typeof(n==null?void 0:n._getType)=="function"}function lf(n){return Kr(n)&&typeof n.concat=="function"}function df(n){return n!=null&&typeof n=="object"&&"lc_direct_tool_output"in n&&n.lc_direct_tool_output===!0}var vr=class extends Ve{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){typeof e=="string"&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},Ya=class n extends tt{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){var t;return new n({content:Et(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),artifact:uf(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:(t=this.id)!=null?t:e.id,status:of(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function hf(n){let e=[],t=[];for(let r of n)if(r.function){let a=r.function.name;try{let s=JSON.parse(r.function.arguments),i={name:a||"",args:s||{},id:r.id};e.push(i)}catch(s){t.push({name:a,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}var Me=class extends Ve{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){var a,s,i,o,u;let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t!=null?t:{}};else{r=e;let c=(a=r.additional_kwargs)==null?void 0:a.tool_calls,l=r.tool_calls;c!=null&&c.length>0&&(l===void 0||l.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(c!=null&&l===void 0){let[d,h]=hf(c);r.tool_calls=d!=null?d:[],r.invalid_tool_calls=h!=null?h:[]}else r.tool_calls=(s=r.tool_calls)!=null?s:[],r.invalid_tool_calls=(i=r.invalid_tool_calls)!=null?i:[]}catch(d){r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=(o=r.tool_calls)!=null?o:this.tool_calls,this.invalid_tool_calls=(u=r.invalid_tool_calls)!=null?u:this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}};function Ys(n){return n._getType()==="ai"}function Bc(n){return n._getType()==="ai"}var Te=class n extends tt{constructor(e){var r,a,s,i,o;let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:(r=e.tool_calls)!=null?r:[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{let u=[],c=[];for(let l of e.tool_call_chunks){let d={};try{if(d=Wa(l.args||"{}"),d===null||typeof d!="object"||Array.isArray(d))throw new Error("Malformed tool call chunk args.");u.push({name:(a=l.name)!=null?a:"",args:d,id:l.id,type:"tool_call"})}catch(h){c.push({name:l.name,args:l.args,id:l.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:u,invalid_tool_calls:c,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=(s=t.tool_call_chunks)!=null?s:this.tool_call_chunks,this.tool_calls=(i=t.tool_calls)!=null?i:this.tool_calls,this.invalid_tool_calls=(o=t.invalid_tool_calls)!=null?o:this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){var r,a,s,i,o,u,c,l,d,h,f,p,m,g,y,b,A,x,_,v,E,O,S,L,q,H,de,Ie,ve,cn,Le,Ps,Ts,Ss,Cs,ks,Ui,Rd,Nd,$d,jd,Ld,Dd,Md,Fd,Ud,zd,Bd,qd,Hd,Vd,Gd,Kd;let t={content:Et(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:(r=this.id)!=null?r:e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let pa=Ws(this.tool_call_chunks,e.tool_call_chunks);pa!==void 0&&pa.length>0&&(t.tool_call_chunks=pa)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let pa={...(((s=(a=this.usage_metadata)==null?void 0:a.input_token_details)==null?void 0:s.audio)!==void 0||((o=(i=e.usage_metadata)==null?void 0:i.input_token_details)==null?void 0:o.audio)!==void 0)&&{audio:((l=(c=(u=this.usage_metadata)==null?void 0:u.input_token_details)==null?void 0:c.audio)!=null?l:0)+((f=(h=(d=e.usage_metadata)==null?void 0:d.input_token_details)==null?void 0:h.audio)!=null?f:0)},...(((m=(p=this.usage_metadata)==null?void 0:p.input_token_details)==null?void 0:m.cache_read)!==void 0||((y=(g=e.usage_metadata)==null?void 0:g.input_token_details)==null?void 0:y.cache_read)!==void 0)&&{cache_read:((x=(A=(b=this.usage_metadata)==null?void 0:b.input_token_details)==null?void 0:A.cache_read)!=null?x:0)+((E=(v=(_=e.usage_metadata)==null?void 0:_.input_token_details)==null?void 0:v.cache_read)!=null?E:0)},...(((S=(O=this.usage_metadata)==null?void 0:O.input_token_details)==null?void 0:S.cache_creation)!==void 0||((q=(L=e.usage_metadata)==null?void 0:L.input_token_details)==null?void 0:q.cache_creation)!==void 0)&&{cache_creation:((Ie=(de=(H=this.usage_metadata)==null?void 0:H.input_token_details)==null?void 0:de.cache_creation)!=null?Ie:0)+((Le=(cn=(ve=e.usage_metadata)==null?void 0:ve.input_token_details)==null?void 0:cn.cache_creation)!=null?Le:0)}},Zd={...(((Ts=(Ps=this.usage_metadata)==null?void 0:Ps.output_token_details)==null?void 0:Ts.audio)!==void 0||((Cs=(Ss=e.usage_metadata)==null?void 0:Ss.output_token_details)==null?void 0:Cs.audio)!==void 0)&&{audio:((Rd=(Ui=(ks=this.usage_metadata)==null?void 0:ks.output_token_details)==null?void 0:Ui.audio)!=null?Rd:0)+((jd=($d=(Nd=e.usage_metadata)==null?void 0:Nd.output_token_details)==null?void 0:$d.audio)!=null?jd:0)},...(((Dd=(Ld=this.usage_metadata)==null?void 0:Ld.output_token_details)==null?void 0:Dd.reasoning)!==void 0||((Fd=(Md=e.usage_metadata)==null?void 0:Md.output_token_details)==null?void 0:Fd.reasoning)!==void 0)&&{reasoning:((Bd=(zd=(Ud=this.usage_metadata)==null?void 0:Ud.output_token_details)==null?void 0:zd.reasoning)!=null?Bd:0)+((Vd=(Hd=(qd=e.usage_metadata)==null?void 0:qd.output_token_details)==null?void 0:Hd.reasoning)!=null?Vd:0)}},Yu=(Gd=this.usage_metadata)!=null?Gd:{input_tokens:0,output_tokens:0,total_tokens:0},Xu=(Kd=e.usage_metadata)!=null?Kd:{input_tokens:0,output_tokens:0,total_tokens:0},jb={input_tokens:Yu.input_tokens+Xu.input_tokens,output_tokens:Yu.output_tokens+Xu.output_tokens,total_tokens:Yu.total_tokens+Xu.total_tokens,...Object.keys(pa).length>0&&{input_token_details:pa},...Object.keys(Zd).length>0&&{output_token_details:Zd}};t.usage_metadata=jb}return new n(t)}};var ar=class n extends Ve{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return n}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},Sn=class n extends tt{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){var t;return new n({content:Et(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),role:this.role,id:(t=this.id)!=null?t:e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}};var Cn=class n extends tt{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){var t,r;return new n({content:Et(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),name:(t=this.name)!=null?t:"",id:(r=this.id)!=null?r:e.id})}};var pt=class extends Ve{static lc_name(){return"HumanMessage"}_getType(){return"human"}},kn=class n extends tt{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){var t;return new n({content:Et(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),id:(t=this.id)!=null?t:e.id})}};var Zr=class extends Ve{static lc_name(){return"SystemMessage"}_getType(){return"system"}},Jr=class n extends tt{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){var t;return new n({content:Et(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),id:(t=this.id)!=null?t:e.id})}};function mo(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function Qa(n){return!!(n&&typeof n=="object"&&"type"in n&&n.type==="tool_call")}var Xa=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}};function uw(n){return Qa(n)?n:typeof n.id=="string"&&n.type==="function"&&typeof n.function=="object"&&n.function!==null&&"arguments"in n.function&&typeof n.function.arguments=="string"&&"name"in n.function&&typeof n.function.name=="string"?{id:n.id,args:JSON.parse(n.function.arguments),name:n.function.name,type:"tool_call"}:n}function cw(n){return typeof n=="object"&&n!=null&&n.lc===1&&Array.isArray(n.id)&&n.kwargs!=null&&typeof n.kwargs=="object"}function qc(n){let e,t;if(cw(n)){let r=n.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":e="unknown",t=n.kwargs}else{let{type:r,...a}=n;e=r,t=a}if(e==="human"||e==="user")return new pt(t);if(e==="ai"||e==="assistant"){let{tool_calls:r,...a}=t;if(!Array.isArray(r))return new Me(t);let s=r.map(uw);return new Me({...a,tool_calls:s})}else{if(e==="system")return new Zr(t);if(e==="developer")return new Zr({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in t)return new vr({...t,content:t.content,tool_call_id:t.tool_call_id,name:t.name});throw mo(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(n,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Rn(n){if(typeof n=="string")return new pt(n);if(Kr(n))return n;if(Array.isArray(n)){let[e,t]=n;return qc({type:e,content:t})}else if(cf(n)){let{role:e,...t}=n;return qc({...t,type:e})}else return qc(n)}function Xs(n,e="Human",t="AI"){let r=[];for(let a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);let i=a.name?`${a.name}, `:"",o=typeof a.content=="string"?a.content:JSON.stringify(a.content,null,2);r.push(`${s}: ${i}${o}`)}return r.join(`
`)}function Hc(n){var t;let e=n._getType();if(e==="human")return new kn({...n});if(e==="ai"){let r={...n};return"tool_calls"in r&&(r={...r,tool_call_chunks:(t=r.tool_calls)==null?void 0:t.map(a=>({...a,type:"tool_call_chunk",index:void 0,args:JSON.stringify(a.args)}))}),new Te({...r})}else{if(e==="system")return new Jr({...n});if(e==="function")return new Cn({...n});if(ar.isInstance(n))return new Sn({...n});throw new Error("Unknown message type.")}}var ne;(function(n){n.assertEqual=a=>a;function e(a){}n.assertIs=e;function t(a){throw new Error}n.assertNever=t,n.arrayToEnum=a=>{let s={};for(let i of a)s[i]=i;return s},n.getValidEnumValues=a=>{let s=n.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),i={};for(let o of s)i[o]=a[o];return n.objectValues(i)},n.objectValues=a=>n.objectKeys(a).map(function(s){return a[s]}),n.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{let s=[];for(let i in a)Object.prototype.hasOwnProperty.call(a,i)&&s.push(i);return s},n.find=(a,s)=>{for(let i of a)if(s(i))return i},n.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&isFinite(a)&&Math.floor(a)===a;function r(a,s=" | "){return a.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}n.joinValues=r,n.jsonStringifyReplacer=(a,s)=>typeof s=="bigint"?s.toString():s})(ne||(ne={}));var Gc;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(Gc||(Gc={}));var C=ne.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Er=n=>{switch(typeof n){case"undefined":return C.undefined;case"string":return C.string;case"number":return isNaN(n)?C.nan:C.number;case"boolean":return C.boolean;case"function":return C.function;case"bigint":return C.bigint;case"symbol":return C.symbol;case"object":return Array.isArray(n)?C.array:n===null?C.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?C.promise:typeof Map!="undefined"&&n instanceof Map?C.map:typeof Set!="undefined"&&n instanceof Set?C.set:typeof Date!="undefined"&&n instanceof Date?C.date:C.object;default:return C.unknown}},I=ne.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),lw=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:"),mt=class n extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};let t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){let t=e||function(s){return s.message},r={_errors:[]},a=s=>{for(let i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(a);else if(i.code==="invalid_return_type")a(i.returnTypeError);else if(i.code==="invalid_arguments")a(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,u=0;for(;u<i.path.length;){let c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return a(this),r}static assert(e){if(!(e instanceof n))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,ne.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){let t={},r=[];for(let a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}};mt.create=n=>new mt(n);var rs=(n,e)=>{let t;switch(n.code){case I.invalid_type:n.received===C.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case I.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,ne.jsonStringifyReplacer)}`;break;case I.unrecognized_keys:t=`Unrecognized key(s) in object: ${ne.joinValues(n.keys,", ")}`;break;case I.invalid_union:t="Invalid input";break;case I.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${ne.joinValues(n.options)}`;break;case I.invalid_enum_value:t=`Invalid enum value. Expected ${ne.joinValues(n.options)}, received '${n.received}'`;break;case I.invalid_arguments:t="Invalid function arguments";break;case I.invalid_return_type:t="Invalid function return type";break;case I.invalid_date:t="Invalid date";break;case I.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:ne.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case I.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case I.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case I.custom:t="Invalid input";break;case I.invalid_intersection_types:t="Intersection results could not be merged";break;case I.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case I.not_finite:t="Number must be finite";break;default:t=e.defaultError,ne.assertNever(n)}return{message:t}},mf=rs;function dw(n){mf=n}function go(){return mf}var yo=n=>{let{data:e,path:t,errorMaps:r,issueData:a}=n,s=[...t,...a.path||[]],i={...a,path:s};if(a.message!==void 0)return{...a,path:s,message:a.message};let o="",u=r.filter(c=>!!c).slice().reverse();for(let c of u)o=c(i,{data:e,defaultError:o}).message;return{...a,path:s,message:o}},hw=[];function T(n,e){let t=go(),r=yo({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===rs?void 0:rs].filter(a=>!!a)});n.common.issues.push(r)}var Fe=class n{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let a of t){if(a.status==="aborted")return B;a.status==="dirty"&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let a of t){let s=await a.key,i=await a.value;r.push({key:s,value:i})}return n.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let a of t){let{key:s,value:i}=a;if(s.status==="aborted"||i.status==="aborted")return B;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value!="undefined"||a.alwaysSet)&&(r[s.value]=i.value)}return{status:e.value,value:r}}},B=Object.freeze({status:"aborted"}),ts=n=>({status:"dirty",value:n}),Ge=n=>({status:"valid",value:n}),Kc=n=>n.status==="aborted",Zc=n=>n.status==="dirty",Nn=n=>n.status==="valid",ti=n=>typeof Promise!="undefined"&&n instanceof Promise;function bo(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)}function gf(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t}var j;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(j||(j={}));var Qs,ei,Ot=class{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},ff=(n,e)=>{if(Nn(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new mt(n.common.issues);return this._error=t,this._error}}};function K(n){if(!n)return{};let{errorMap:e,invalid_type_error:t,required_error:r,description:a}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(i,o)=>{var u,c;let{message:l}=n;return i.code==="invalid_enum_value"?{message:l!=null?l:o.defaultError}:typeof o.data=="undefined"?{message:(u=l!=null?l:r)!==null&&u!==void 0?u:o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:(c=l!=null?l:t)!==null&&c!==void 0?c:o.defaultError}},description:a}}var Z=class{get description(){return this._def.description}_getType(e){return Er(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Er(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Fe,ctx:{common:e.parent.common,data:e.data,parsedType:Er(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(ti(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;let a={common:{issues:[],async:(r=t==null?void 0:t.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Er(e)},s=this._parseSync({data:e,path:a.path,parent:a});return ff(a,s)}"~validate"(e){var t,r;let a={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Er(e)};if(!this["~standard"].async)try{let s=this._parseSync({data:e,path:[],parent:a});return Nn(s)?{value:s.value}:{issues:a.common.issues}}catch(s){!((r=(t=s==null?void 0:s.message)===null||t===void 0?void 0:t.toLowerCase())===null||r===void 0)&&r.includes("encountered")&&(this["~standard"].async=!0),a.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:a}).then(s=>Nn(s)?{value:s.value}:{issues:a.common.issues})}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Er(e)},a=this._parse({data:e,path:r.path,parent:r}),s=await(ti(a)?a:Promise.resolve(a));return ff(r,s)}refine(e,t){let r=a=>typeof t=="string"||typeof t=="undefined"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,s)=>{let i=e(a),o=()=>s.addIssue({code:I.custom,...r(a)});return typeof Promise!="undefined"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,a)=>e(r)?!0:(a.addIssue(typeof t=="function"?t(r,a):t),!1))}_refinement(e){return new gt({schema:this,typeName:w.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return rt.create(this,this._def)}nullable(){return ir.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return xr.create(this)}promise(){return Xr.create(this,this._def)}or(e){return Un.create([this,e],this._def)}and(e){return zn.create(this,e,this._def)}transform(e){return new gt({...K(this._def),schema:this,typeName:w.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new Gn({...K(this._def),innerType:this,defaultValue:t,typeName:w.ZodDefault})}brand(){return new ri({typeName:w.ZodBranded,type:this,...K(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new Kn({...K(this._def),innerType:this,catchValue:t,typeName:w.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return ni.create(this,e)}readonly(){return Zn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},fw=/^c[^\s-]{8,}$/i,pw=/^[0-9a-z]+$/,mw=/^[0-9A-HJKMNP-TV-Z]{26}$/i,gw=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,yw=/^[a-z0-9_-]{21}$/i,bw=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,_w=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,ww=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,vw="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",Vc,Aw=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Ew=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Ow=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,xw=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Iw=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Pw=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,yf="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Tw=new RegExp(`^${yf}$`);function bf(n){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`),e}function Sw(n){return new RegExp(`^${bf(n)}$`)}function _f(n){let e=`${yf}T${bf(n)}`,t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Cw(n,e){return!!((e==="v4"||!e)&&Aw.test(n)||(e==="v6"||!e)&&Ow.test(n))}function kw(n,e){if(!bw.test(n))return!1;try{let[t]=n.split("."),r=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),a=JSON.parse(atob(r));return!(typeof a!="object"||a===null||!a.typ||!a.alg||e&&a.alg!==e)}catch(t){return!1}}function Rw(n,e){return!!((e==="v4"||!e)&&Ew.test(n)||(e==="v6"||!e)&&xw.test(n))}var Wr=class n extends Z{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==C.string){let s=this._getOrReturnCtx(e);return T(s,{code:I.invalid_type,expected:C.string,received:s.parsedType}),B}let r=new Fe,a;for(let s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:I.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="max")e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:I.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="length"){let i=e.data.length>s.value,o=e.data.length<s.value;(i||o)&&(a=this._getOrReturnCtx(e,a),i?T(a,{code:I.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&T(a,{code:I.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),r.dirty())}else if(s.kind==="email")ww.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"email",code:I.invalid_string,message:s.message}),r.dirty());else if(s.kind==="emoji")Vc||(Vc=new RegExp(vw,"u")),Vc.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"emoji",code:I.invalid_string,message:s.message}),r.dirty());else if(s.kind==="uuid")gw.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"uuid",code:I.invalid_string,message:s.message}),r.dirty());else if(s.kind==="nanoid")yw.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"nanoid",code:I.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid")fw.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"cuid",code:I.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid2")pw.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"cuid2",code:I.invalid_string,message:s.message}),r.dirty());else if(s.kind==="ulid")mw.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"ulid",code:I.invalid_string,message:s.message}),r.dirty());else if(s.kind==="url")try{new URL(e.data)}catch(i){a=this._getOrReturnCtx(e,a),T(a,{validation:"url",code:I.invalid_string,message:s.message}),r.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"regex",code:I.invalid_string,message:s.message}),r.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),T(a,{code:I.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),r.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),T(a,{code:I.invalid_string,validation:{startsWith:s.value},message:s.message}),r.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),T(a,{code:I.invalid_string,validation:{endsWith:s.value},message:s.message}),r.dirty()):s.kind==="datetime"?_f(s).test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{code:I.invalid_string,validation:"datetime",message:s.message}),r.dirty()):s.kind==="date"?Tw.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{code:I.invalid_string,validation:"date",message:s.message}),r.dirty()):s.kind==="time"?Sw(s).test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{code:I.invalid_string,validation:"time",message:s.message}),r.dirty()):s.kind==="duration"?_w.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"duration",code:I.invalid_string,message:s.message}),r.dirty()):s.kind==="ip"?Cw(e.data,s.version)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"ip",code:I.invalid_string,message:s.message}),r.dirty()):s.kind==="jwt"?kw(e.data,s.alg)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"jwt",code:I.invalid_string,message:s.message}),r.dirty()):s.kind==="cidr"?Rw(e.data,s.version)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"cidr",code:I.invalid_string,message:s.message}),r.dirty()):s.kind==="base64"?Iw.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"base64",code:I.invalid_string,message:s.message}),r.dirty()):s.kind==="base64url"?Pw.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"base64url",code:I.invalid_string,message:s.message}),r.dirty()):ne.assertNever(s);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(a=>e.test(a),{validation:t,code:I.invalid_string,...j.errToObj(r)})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...j.errToObj(e)})}url(e){return this._addCheck({kind:"url",...j.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...j.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...j.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...j.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...j.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...j.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...j.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...j.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...j.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...j.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...j.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...j.errToObj(e)})}datetime(e){var t,r;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)=="undefined"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,local:(r=e==null?void 0:e.local)!==null&&r!==void 0?r:!1,...j.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)=="undefined"?null:e==null?void 0:e.precision,...j.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...j.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...j.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...j.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...j.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...j.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...j.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...j.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...j.errToObj(t)})}nonempty(e){return this.min(1,j.errToObj(e))}trim(){return new n({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};Wr.create=n=>{var e;return new Wr({checks:[],typeName:w.ZodString,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...K(n)})};function Nw(n,e){let t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,a=t>r?t:r,s=parseInt(n.toFixed(a).replace(".","")),i=parseInt(e.toFixed(a).replace(".",""));return s%i/Math.pow(10,a)}var $n=class n extends Z{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==C.number){let s=this._getOrReturnCtx(e);return T(s,{code:I.invalid_type,expected:C.number,received:s.parsedType}),B}let r,a=new Fe;for(let s of this._def.checks)s.kind==="int"?ne.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{code:I.invalid_type,expected:"integer",received:"float",message:s.message}),a.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:I.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:I.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="multipleOf"?Nw(e.data,s.value)!==0&&(r=this._getOrReturnCtx(e,r),T(r,{code:I.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{code:I.not_finite,message:s.message}),a.dirty()):ne.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,j.toString(t))}gt(e,t){return this.setLimit("min",e,!1,j.toString(t))}lte(e,t){return this.setLimit("max",e,!0,j.toString(t))}lt(e,t){return this.setLimit("max",e,!1,j.toString(t))}setLimit(e,t,r,a){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:j.toString(a)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:j.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:j.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:j.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:j.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:j.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:j.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:j.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:j.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:j.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&ne.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}};$n.create=n=>new $n({checks:[],typeName:w.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...K(n)});var jn=class n extends Z{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch(s){return this._getInvalidInput(e)}if(this._getType(e)!==C.bigint)return this._getInvalidInput(e);let r,a=new Fe;for(let s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:I.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:I.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),T(r,{code:I.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):ne.assertNever(s);return{status:a.value,value:e.data}}_getInvalidInput(e){let t=this._getOrReturnCtx(e);return T(t,{code:I.invalid_type,expected:C.bigint,received:t.parsedType}),B}gte(e,t){return this.setLimit("min",e,!0,j.toString(t))}gt(e,t){return this.setLimit("min",e,!1,j.toString(t))}lte(e,t){return this.setLimit("max",e,!0,j.toString(t))}lt(e,t){return this.setLimit("max",e,!1,j.toString(t))}setLimit(e,t,r,a){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:j.toString(a)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:j.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:j.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:j.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:j.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:j.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};jn.create=n=>{var e;return new jn({checks:[],typeName:w.ZodBigInt,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...K(n)})};var Ln=class extends Z{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==C.boolean){let r=this._getOrReturnCtx(e);return T(r,{code:I.invalid_type,expected:C.boolean,received:r.parsedType}),B}return Ge(e.data)}};Ln.create=n=>new Ln({typeName:w.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...K(n)});var Dn=class n extends Z{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==C.date){let s=this._getOrReturnCtx(e);return T(s,{code:I.invalid_type,expected:C.date,received:s.parsedType}),B}if(isNaN(e.data.getTime())){let s=this._getOrReturnCtx(e);return T(s,{code:I.invalid_date}),B}let r=new Fe,a;for(let s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:I.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),r.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:I.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),r.dirty()):ne.assertNever(s);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:j.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:j.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}};Dn.create=n=>new Dn({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:w.ZodDate,...K(n)});var ns=class extends Z{_parse(e){if(this._getType(e)!==C.symbol){let r=this._getOrReturnCtx(e);return T(r,{code:I.invalid_type,expected:C.symbol,received:r.parsedType}),B}return Ge(e.data)}};ns.create=n=>new ns({typeName:w.ZodSymbol,...K(n)});var Mn=class extends Z{_parse(e){if(this._getType(e)!==C.undefined){let r=this._getOrReturnCtx(e);return T(r,{code:I.invalid_type,expected:C.undefined,received:r.parsedType}),B}return Ge(e.data)}};Mn.create=n=>new Mn({typeName:w.ZodUndefined,...K(n)});var Fn=class extends Z{_parse(e){if(this._getType(e)!==C.null){let r=this._getOrReturnCtx(e);return T(r,{code:I.invalid_type,expected:C.null,received:r.parsedType}),B}return Ge(e.data)}};Fn.create=n=>new Fn({typeName:w.ZodNull,...K(n)});var Yr=class extends Z{constructor(){super(...arguments),this._any=!0}_parse(e){return Ge(e.data)}};Yr.create=n=>new Yr({typeName:w.ZodAny,...K(n)});var Or=class extends Z{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Ge(e.data)}};Or.create=n=>new Or({typeName:w.ZodUnknown,...K(n)});var Mt=class extends Z{_parse(e){let t=this._getOrReturnCtx(e);return T(t,{code:I.invalid_type,expected:C.never,received:t.parsedType}),B}};Mt.create=n=>new Mt({typeName:w.ZodNever,...K(n)});var as=class extends Z{_parse(e){if(this._getType(e)!==C.undefined){let r=this._getOrReturnCtx(e);return T(r,{code:I.invalid_type,expected:C.void,received:r.parsedType}),B}return Ge(e.data)}};as.create=n=>new as({typeName:w.ZodVoid,...K(n)});var xr=class n extends Z{_parse(e){let{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==C.array)return T(t,{code:I.invalid_type,expected:C.array,received:t.parsedType}),B;if(a.exactLength!==null){let i=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(i||o)&&(T(t,{code:i?I.too_big:I.too_small,minimum:o?a.exactLength.value:void 0,maximum:i?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(T(t,{code:I.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(T(t,{code:I.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>a.type._parseAsync(new Ot(t,i,t.path,o)))).then(i=>Fe.mergeArray(r,i));let s=[...t.data].map((i,o)=>a.type._parseSync(new Ot(t,i,t.path,o)));return Fe.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new n({...this._def,minLength:{value:e,message:j.toString(t)}})}max(e,t){return new n({...this._def,maxLength:{value:e,message:j.toString(t)}})}length(e,t){return new n({...this._def,exactLength:{value:e,message:j.toString(t)}})}nonempty(e){return this.min(1,e)}};xr.create=(n,e)=>new xr({type:n,minLength:null,maxLength:null,exactLength:null,typeName:w.ZodArray,...K(e)});function es(n){if(n instanceof nt){let e={};for(let t in n.shape){let r=n.shape[t];e[t]=rt.create(es(r))}return new nt({...n._def,shape:()=>e})}else return n instanceof xr?new xr({...n._def,type:es(n.element)}):n instanceof rt?rt.create(es(n.unwrap())):n instanceof ir?ir.create(es(n.unwrap())):n instanceof sr?sr.create(n.items.map(e=>es(e))):n}var nt=class n extends Z{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),t=ne.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==C.object){let c=this._getOrReturnCtx(e);return T(c,{code:I.invalid_type,expected:C.object,received:c.parsedType}),B}let{status:r,ctx:a}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof Mt&&this._def.unknownKeys==="strip"))for(let c in a.data)i.includes(c)||o.push(c);let u=[];for(let c of i){let l=s[c],d=a.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new Ot(a,d,a.path,c)),alwaysSet:c in a.data})}if(this._def.catchall instanceof Mt){let c=this._def.unknownKeys;if(c==="passthrough")for(let l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:a.data[l]}});else if(c==="strict")o.length>0&&(T(a,{code:I.unrecognized_keys,keys:o}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let c=this._def.catchall;for(let l of o){let d=a.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new Ot(a,d,a.path,l)),alwaysSet:l in a.data})}}return a.common.async?Promise.resolve().then(async()=>{let c=[];for(let l of u){let d=await l.key,h=await l.value;c.push({key:d,value:h,alwaysSet:l.alwaysSet})}return c}).then(c=>Fe.mergeObjectSync(r,c)):Fe.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return j.errToObj,new n({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,s,i,o;let u=(i=(s=(a=this._def).errorMap)===null||s===void 0?void 0:s.call(a,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=j.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new n({...this._def,unknownKeys:"strip"})}passthrough(){return new n({...this._def,unknownKeys:"passthrough"})}extend(e){return new n({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new n({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:w.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new n({...this._def,catchall:e})}pick(e){let t={};return ne.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}omit(e){let t={};return ne.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}deepPartial(){return es(this)}partial(e){let t={};return ne.objectKeys(this.shape).forEach(r=>{let a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}),new n({...this._def,shape:()=>t})}required(e){let t={};return ne.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let s=this.shape[r];for(;s instanceof rt;)s=s._def.innerType;t[r]=s}}),new n({...this._def,shape:()=>t})}keyof(){return wf(ne.objectKeys(this.shape))}};nt.create=(n,e)=>new nt({shape:()=>n,unknownKeys:"strip",catchall:Mt.create(),typeName:w.ZodObject,...K(e)});nt.strictCreate=(n,e)=>new nt({shape:()=>n,unknownKeys:"strict",catchall:Mt.create(),typeName:w.ZodObject,...K(e)});nt.lazycreate=(n,e)=>new nt({shape:n,unknownKeys:"strip",catchall:Mt.create(),typeName:w.ZodObject,...K(e)});var Un=class extends Z{_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;function a(s){for(let o of s)if(o.result.status==="valid")return o.result;for(let o of s)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;let i=s.map(o=>new mt(o.ctx.common.issues));return T(t,{code:I.invalid_union,unionErrors:i}),B}if(t.common.async)return Promise.all(r.map(async s=>{let i={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(a);{let s,i=[];for(let u of r){let c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!s&&(s={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;let o=i.map(u=>new mt(u));return T(t,{code:I.invalid_union,unionErrors:o}),B}}get options(){return this._def.options}};Un.create=(n,e)=>new Un({options:n,typeName:w.ZodUnion,...K(e)});var Ar=n=>n instanceof Bn?Ar(n.schema):n instanceof gt?Ar(n.innerType()):n instanceof qn?[n.value]:n instanceof Hn?n.options:n instanceof Vn?ne.objectValues(n.enum):n instanceof Gn?Ar(n._def.innerType):n instanceof Mn?[void 0]:n instanceof Fn?[null]:n instanceof rt?[void 0,...Ar(n.unwrap())]:n instanceof ir?[null,...Ar(n.unwrap())]:n instanceof ri||n instanceof Zn?Ar(n.unwrap()):n instanceof Kn?Ar(n._def.innerType):[],_o=class n extends Z{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==C.object)return T(t,{code:I.invalid_type,expected:C.object,received:t.parsedType}),B;let r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(T(t,{code:I.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),B)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let a=new Map;for(let s of t){let i=Ar(s.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let o of i){if(a.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);a.set(o,s)}}return new n({typeName:w.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...K(r)})}};function Jc(n,e){let t=Er(n),r=Er(e);if(n===e)return{valid:!0,data:n};if(t===C.object&&r===C.object){let a=ne.objectKeys(e),s=ne.objectKeys(n).filter(o=>a.indexOf(o)!==-1),i={...n,...e};for(let o of s){let u=Jc(n[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===C.array&&r===C.array){if(n.length!==e.length)return{valid:!1};let a=[];for(let s=0;s<n.length;s++){let i=n[s],o=e[s],u=Jc(i,o);if(!u.valid)return{valid:!1};a.push(u.data)}return{valid:!0,data:a}}else return t===C.date&&r===C.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}var zn=class extends Z{_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=(s,i)=>{if(Kc(s)||Kc(i))return B;let o=Jc(s.value,i.value);return o.valid?((Zc(s)||Zc(i))&&t.dirty(),{status:t.value,value:o.data}):(T(r,{code:I.invalid_intersection_types}),B)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([s,i])=>a(s,i)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}};zn.create=(n,e,t)=>new zn({left:n,right:e,typeName:w.ZodIntersection,...K(t)});var sr=class n extends Z{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==C.array)return T(r,{code:I.invalid_type,expected:C.array,received:r.parsedType}),B;if(r.data.length<this._def.items.length)return T(r,{code:I.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),B;!this._def.rest&&r.data.length>this._def.items.length&&(T(r,{code:I.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let s=[...r.data].map((i,o)=>{let u=this._def.items[o]||this._def.rest;return u?u._parse(new Ot(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(s).then(i=>Fe.mergeArray(t,i)):Fe.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new n({...this._def,rest:e})}};sr.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new sr({items:n,typeName:w.ZodTuple,rest:null,...K(e)})};var wo=class n extends Z{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==C.object)return T(r,{code:I.invalid_type,expected:C.object,received:r.parsedType}),B;let a=[],s=this._def.keyType,i=this._def.valueType;for(let o in r.data)a.push({key:s._parse(new Ot(r,o,r.path,o)),value:i._parse(new Ot(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?Fe.mergeObjectAsync(t,a):Fe.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof Z?new n({keyType:e,valueType:t,typeName:w.ZodRecord,...K(r)}):new n({keyType:Wr.create(),valueType:e,typeName:w.ZodRecord,...K(t)})}},ss=class extends Z{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==C.map)return T(r,{code:I.invalid_type,expected:C.map,received:r.parsedType}),B;let a=this._def.keyType,s=this._def.valueType,i=[...r.data.entries()].map(([o,u],c)=>({key:a._parse(new Ot(r,o,r.path,[c,"key"])),value:s._parse(new Ot(r,u,r.path,[c,"value"]))}));if(r.common.async){let o=new Map;return Promise.resolve().then(async()=>{for(let u of i){let c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return B;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{let o=new Map;for(let u of i){let c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return B;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}};ss.create=(n,e,t)=>new ss({valueType:e,keyType:n,typeName:w.ZodMap,...K(t)});var is=class n extends Z{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==C.set)return T(r,{code:I.invalid_type,expected:C.set,received:r.parsedType}),B;let a=this._def;a.minSize!==null&&r.data.size<a.minSize.value&&(T(r,{code:I.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&r.data.size>a.maxSize.value&&(T(r,{code:I.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());let s=this._def.valueType;function i(u){let c=new Set;for(let l of u){if(l.status==="aborted")return B;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}let o=[...r.data.values()].map((u,c)=>s._parse(new Ot(r,u,r.path,c)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new n({...this._def,minSize:{value:e,message:j.toString(t)}})}max(e,t){return new n({...this._def,maxSize:{value:e,message:j.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}};is.create=(n,e)=>new is({valueType:n,minSize:null,maxSize:null,typeName:w.ZodSet,...K(e)});var vo=class n extends Z{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==C.function)return T(t,{code:I.invalid_type,expected:C.function,received:t.parsedType}),B;function r(o,u){return yo({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,go(),rs].filter(c=>!!c),issueData:{code:I.invalid_arguments,argumentsError:u}})}function a(o,u){return yo({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,go(),rs].filter(c=>!!c),issueData:{code:I.invalid_return_type,returnTypeError:u}})}let s={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof Xr){let o=this;return Ge(async function(...u){let c=new mt([]),l=await o._def.args.parseAsync(u,s).catch(f=>{throw c.addIssue(r(u,f)),c}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,s).catch(f=>{throw c.addIssue(a(d,f)),c})})}else{let o=this;return Ge(function(...u){let c=o._def.args.safeParse(u,s);if(!c.success)throw new mt([r(u,c.error)]);let l=Reflect.apply(i,this,c.data),d=o._def.returns.safeParse(l,s);if(!d.success)throw new mt([a(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new n({...this._def,args:sr.create(e).rest(Or.create())})}returns(e){return new n({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new n({args:e||sr.create([]).rest(Or.create()),returns:t||Or.create(),typeName:w.ZodFunction,...K(r)})}},Bn=class extends Z{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};Bn.create=(n,e)=>new Bn({getter:n,typeName:w.ZodLazy,...K(e)});var qn=class extends Z{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return T(t,{received:t.data,code:I.invalid_literal,expected:this._def.value}),B}return{status:"valid",value:e.data}}get value(){return this._def.value}};qn.create=(n,e)=>new qn({value:n,typeName:w.ZodLiteral,...K(e)});function wf(n,e){return new Hn({values:n,typeName:w.ZodEnum,...K(e)})}var Hn=class n extends Z{constructor(){super(...arguments),Qs.set(this,void 0)}_parse(e){if(typeof e.data!="string"){let t=this._getOrReturnCtx(e),r=this._def.values;return T(t,{expected:ne.joinValues(r),received:t.parsedType,code:I.invalid_type}),B}if(bo(this,Qs,"f")||gf(this,Qs,new Set(this._def.values),"f"),!bo(this,Qs,"f").has(e.data)){let t=this._getOrReturnCtx(e),r=this._def.values;return T(t,{received:t.data,code:I.invalid_enum_value,options:r}),B}return Ge(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return n.create(e,{...this._def,...t})}exclude(e,t=this._def){return n.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}};Qs=new WeakMap;Hn.create=wf;var Vn=class extends Z{constructor(){super(...arguments),ei.set(this,void 0)}_parse(e){let t=ne.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==C.string&&r.parsedType!==C.number){let a=ne.objectValues(t);return T(r,{expected:ne.joinValues(a),received:r.parsedType,code:I.invalid_type}),B}if(bo(this,ei,"f")||gf(this,ei,new Set(ne.getValidEnumValues(this._def.values)),"f"),!bo(this,ei,"f").has(e.data)){let a=ne.objectValues(t);return T(r,{received:r.data,code:I.invalid_enum_value,options:a}),B}return Ge(e.data)}get enum(){return this._def.values}};ei=new WeakMap;Vn.create=(n,e)=>new Vn({values:n,typeName:w.ZodNativeEnum,...K(e)});var Xr=class extends Z{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==C.promise&&t.common.async===!1)return T(t,{code:I.invalid_type,expected:C.promise,received:t.parsedType}),B;let r=t.parsedType===C.promise?t.data:Promise.resolve(t.data);return Ge(r.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}};Xr.create=(n,e)=>new Xr({type:n,typeName:w.ZodPromise,...K(e)});var gt=class extends Z{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===w.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:i=>{T(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),a.type==="preprocess"){let i=a.transform(r.data,s);if(r.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return B;let u=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return u.status==="aborted"?B:u.status==="dirty"||t.value==="dirty"?ts(u.value):u});{if(t.value==="aborted")return B;let o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?B:o.status==="dirty"||t.value==="dirty"?ts(o.value):o}}if(a.type==="refinement"){let i=o=>{let u=a.refinement(o,s);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){let o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?B:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?B:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(r.common.async===!1){let i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!Nn(i))return i;let o=a.transform(i.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>Nn(i)?Promise.resolve(a.transform(i.value,s)).then(o=>({status:t.value,value:o})):i);ne.assertNever(a)}};gt.create=(n,e,t)=>new gt({schema:n,typeName:w.ZodEffects,effect:e,...K(t)});gt.createWithPreprocess=(n,e,t)=>new gt({schema:e,effect:{type:"preprocess",transform:n},typeName:w.ZodEffects,...K(t)});var rt=class extends Z{_parse(e){return this._getType(e)===C.undefined?Ge(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};rt.create=(n,e)=>new rt({innerType:n,typeName:w.ZodOptional,...K(e)});var ir=class extends Z{_parse(e){return this._getType(e)===C.null?Ge(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};ir.create=(n,e)=>new ir({innerType:n,typeName:w.ZodNullable,...K(e)});var Gn=class extends Z{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===C.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};Gn.create=(n,e)=>new Gn({innerType:n,typeName:w.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...K(e)});var Kn=class extends Z{_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return ti(a)?a.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new mt(r.common.issues)},input:r.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new mt(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}};Kn.create=(n,e)=>new Kn({innerType:n,typeName:w.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...K(e)});var os=class extends Z{_parse(e){if(this._getType(e)!==C.nan){let r=this._getOrReturnCtx(e);return T(r,{code:I.invalid_type,expected:C.nan,received:r.parsedType}),B}return{status:"valid",value:e.data}}};os.create=n=>new os({typeName:w.ZodNaN,...K(n)});var $w=Symbol("zod_brand"),ri=class extends Z{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}},ni=class n extends Z{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let s=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?B:s.status==="dirty"?(t.dirty(),ts(s.value)):this._def.out._parseAsync({data:s.value,path:r.path,parent:r})})();{let a=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?B:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:r.path,parent:r})}}static create(e,t){return new n({in:e,out:t,typeName:w.ZodPipeline})}},Zn=class extends Z{_parse(e){let t=this._def.innerType._parse(e),r=a=>(Nn(a)&&(a.value=Object.freeze(a.value)),a);return ti(t)?t.then(a=>r(a)):r(t)}unwrap(){return this._def.innerType}};Zn.create=(n,e)=>new Zn({innerType:n,typeName:w.ZodReadonly,...K(e)});function vf(n,e={},t){return n?Yr.create().superRefine((r,a)=>{var s,i;if(!n(r)){let o=typeof e=="function"?e(r):typeof e=="string"?{message:e}:e,u=(i=(s=o.fatal)!==null&&s!==void 0?s:t)!==null&&i!==void 0?i:!0,c=typeof o=="string"?{message:o}:o;a.addIssue({code:"custom",...c,fatal:u})}}):Yr.create()}var jw={object:nt.lazycreate},w;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(w||(w={}));var Lw=(n,e={message:`Input not instance of ${n.name}`})=>vf(t=>t instanceof n,e),Af=Wr.create,Ef=$n.create,Dw=os.create,Mw=jn.create,Of=Ln.create,Fw=Dn.create,Uw=ns.create,zw=Mn.create,Bw=Fn.create,qw=Yr.create,Hw=Or.create,Vw=Mt.create,Gw=as.create,Kw=xr.create,Zw=nt.create,Jw=nt.strictCreate,Ww=Un.create,Yw=_o.create,Xw=zn.create,Qw=sr.create,ev=wo.create,tv=ss.create,rv=is.create,nv=vo.create,av=Bn.create,sv=qn.create,iv=Hn.create,ov=Vn.create,uv=Xr.create,pf=gt.create,cv=rt.create,lv=ir.create,dv=gt.createWithPreprocess,hv=ni.create,fv=()=>Af().optional(),pv=()=>Ef().optional(),mv=()=>Of().optional(),gv={string:n=>Wr.create({...n,coerce:!0}),number:n=>$n.create({...n,coerce:!0}),boolean:n=>Ln.create({...n,coerce:!0}),bigint:n=>jn.create({...n,coerce:!0}),date:n=>Dn.create({...n,coerce:!0})},yv=B,xt=Object.freeze({__proto__:null,defaultErrorMap:rs,setErrorMap:dw,getErrorMap:go,makeIssue:yo,EMPTY_PATH:hw,addIssueToContext:T,ParseStatus:Fe,INVALID:B,DIRTY:ts,OK:Ge,isAborted:Kc,isDirty:Zc,isValid:Nn,isAsync:ti,get util(){return ne},get objectUtil(){return Gc},ZodParsedType:C,getParsedType:Er,ZodType:Z,datetimeRegex:_f,ZodString:Wr,ZodNumber:$n,ZodBigInt:jn,ZodBoolean:Ln,ZodDate:Dn,ZodSymbol:ns,ZodUndefined:Mn,ZodNull:Fn,ZodAny:Yr,ZodUnknown:Or,ZodNever:Mt,ZodVoid:as,ZodArray:xr,ZodObject:nt,ZodUnion:Un,ZodDiscriminatedUnion:_o,ZodIntersection:zn,ZodTuple:sr,ZodRecord:wo,ZodMap:ss,ZodSet:is,ZodFunction:vo,ZodLazy:Bn,ZodLiteral:qn,ZodEnum:Hn,ZodNativeEnum:Vn,ZodPromise:Xr,ZodEffects:gt,ZodTransformer:gt,ZodOptional:rt,ZodNullable:ir,ZodDefault:Gn,ZodCatch:Kn,ZodNaN:os,BRAND:$w,ZodBranded:ri,ZodPipeline:ni,ZodReadonly:Zn,custom:vf,Schema:Z,ZodSchema:Z,late:jw,get ZodFirstPartyTypeKind(){return w},coerce:gv,any:qw,array:Kw,bigint:Mw,boolean:Of,date:Fw,discriminatedUnion:Yw,effect:pf,enum:iv,function:nv,instanceof:Lw,intersection:Xw,lazy:av,literal:sv,map:tv,nan:Dw,nativeEnum:ov,never:Vw,null:Bw,nullable:lv,number:Ef,object:Zw,oboolean:mv,onumber:pv,optional:cv,ostring:fv,pipeline:hv,preprocess:dv,promise:uv,record:ev,set:rv,strictObject:Jw,string:Af,symbol:Uw,transformer:pf,tuple:Qw,undefined:zw,union:Ww,unknown:Hw,void:Gw,NEVER:yv,ZodIssueCode:I,quotelessJson:lw,ZodError:mt});var rd=wt(Oo(),1);var kf=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Ev(n){return typeof n=="string"&&kf.test(n)}var Qr=Ev;var Ne=[];for(xo=0;xo<256;++xo)Ne.push((xo+256).toString(16).slice(1));var xo;function Rf(n,e=0){return(Ne[n[e+0]]+Ne[n[e+1]]+Ne[n[e+2]]+Ne[n[e+3]]+"-"+Ne[n[e+4]]+Ne[n[e+5]]+"-"+Ne[n[e+6]]+Ne[n[e+7]]+"-"+Ne[n[e+8]]+Ne[n[e+9]]+"-"+Ne[n[e+10]]+Ne[n[e+11]]+Ne[n[e+12]]+Ne[n[e+13]]+Ne[n[e+14]]+Ne[n[e+15]]).toLowerCase()}var Io,Ov=new Uint8Array(16);function Wc(){if(!Io&&(Io=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Io))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Io(Ov)}var xv=typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Yc={randomUUID:xv};function Iv(n,e,t){if(Yc.randomUUID&&!e&&!n)return Yc.randomUUID();n=n||{};var r=n.random||(n.rng||Wc)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(var a=0;a<16;++a)e[t+a]=r[a];return e}return Rf(r)}var pe=Iv;var Bf=wt(Oo(),1),No=wt(Ro(),1);var jv=(...n)=>fetch(...n),Lv=Symbol.for("ls:fetch_implementation");var D=()=>{var n;return(n=globalThis[Lv])!=null?n:jv};var Dv=[400,401,403,404,405,406,407,408],Mv=[409],si=class{constructor(e){var t,r;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(t=e.maxConcurrency)!=null?t:1/0,this.maxRetries=(r=e.maxRetries)!=null?r:6,"default"in No.default?this.queue=new No.default.default({concurrency:this.maxConcurrency}):this.queue=new No.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>(0,Bf.default)(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||(a==null?void 0:a.code)==="ECONNABORTED")throw a;let s=a==null?void 0:a.response,i=s==null?void 0:s.status;if(i){if(Dv.includes(+i))throw a;if(Mv.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>D()(...e).then(t=>t.ok?t:Promise.reject(t)))}};function al(n){return typeof(n==null?void 0:n._getType)=="function"}function sl(n){let e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}function Q(n,e){if(!Qr(n)){let t=e!==void 0?`Invalid UUID for ${e}: ${n}`:`Invalid UUID: ${n}`;throw new Error(t)}return n}var qf={};function $o(n){qf[n]||(console.warn(n),qf[n]=!0)}var NE=wt($m(),1);function Pr(n){if(!n||n.split("/").length>2||n.startsWith("/")||n.endsWith("/")||n.split(":").length>2)throw new Error(`Invalid identifier format: ${n}`);let[e,t]=n.split(":"),r=t||"latest";if(e.includes("/")){let[a,s]=e.split("/",2);if(!a||!s)throw new Error(`Invalid identifier format: ${n}`);return[a,s,r]}else{if(!e)throw new Error(`Invalid identifier format: ${n}`);return["-",e,r]}}var Ol=class extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}};async function X(n,e,t){let r;if(n.ok){t&&(r=await n.text());return}r=await n.text();let a=`Failed to ${e}. Received status [${n.status}]: ${n.statusText}. Server response: ${r}`;throw n.status===409?new Ol(a):new Error(a)}var jm="[...]",$E={result:"[Circular]"},Vo=[],ls=[];function jE(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function st(n,e,t,r){var i;try{return JSON.stringify(n,e,t)}catch(o){if(!((i=o.message)!=null&&i.includes("Converting circular structure to JSON")))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),typeof r=="undefined"&&(r=jE()),Il(n,"",0,[],void 0,0,r);var a;try{ls.length===0?a=JSON.stringify(n,e,t):a=JSON.stringify(n,LE(e),t)}catch(u){return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Vo.length!==0;){var s=Vo.pop();s.length===4?Object.defineProperty(s[0],s[1],s[3]):s[0][s[1]]=s[2]}}return a}}function xl(n,e,t,r){var a=Object.getOwnPropertyDescriptor(r,t);a.get!==void 0?a.configurable?(Object.defineProperty(r,t,{value:n}),Vo.push([r,t,e,a])):ls.push([e,t,n]):(r[t]=n,Vo.push([r,t,e]))}function Il(n,e,t,r,a,s,i){s+=1;var o;if(typeof n=="object"&&n!==null){for(o=0;o<r.length;o++)if(r[o]===n){xl($E,n,e,a);return}if(typeof i.depthLimit!="undefined"&&s>i.depthLimit){xl(jm,n,e,a);return}if(typeof i.edgesLimit!="undefined"&&t+1>i.edgesLimit){xl(jm,n,e,a);return}if(r.push(n),Array.isArray(n))for(o=0;o<n.length;o++)Il(n[o],o,o,r,n,s,i);else{var u=Object.keys(n);for(o=0;o<u.length;o++){var c=u[o];Il(n[c],c,o,r,n,s,i)}}r.pop()}}function LE(n){return n=typeof n!="undefined"?n:function(e,t){return t},function(e,t){if(ls.length>0)for(var r=0;r<ls.length;r++){var a=ls[r];if(a[1]===e&&a[0]===t){t=a[2],ls.splice(r,1);break}}return n.call(this,e,t)}}function Lm(n){var s,i;let e=Ko(),t=Dm(),r=(s=n.extra)!=null?s:{},a=r.metadata;return n.extra={...r,runtime:{...e,...r==null?void 0:r.runtime},metadata:{...t,...t.revision_id||n.revision_id?{revision_id:(i=n.revision_id)!=null?i:t.revision_id}:{},...a}},n}var DE=()=>{let n=Tr("TRACING_SAMPLING_RATE");if(n===void 0)return;let e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},ME=n=>{let t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function FE(n){let e=[];for await(let t of n)e.push(t);return e}function Pl(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}var UE=async n=>{var e;if((n==null?void 0:n.status)===429){let t=parseInt((e=n.headers.get("retry-after"))!=null?e:"30",10)*1e3;if(t>0)return await new Promise(r=>setTimeout(r,t)),!0}return!1},Tl=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t,r=new Promise(s=>{t=s}),a=st(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:r,size:a}),this.sizeBytes+=a,r}pop(e){var a,s;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");let t=[],r=0;for(;r+((s=(a=this.peek())==null?void 0:a.size)!=null?s:0)<e&&this.items.length>0;){let i=this.items.shift();i&&(t.push(i),r+=i.size,this.sizeBytes-=i.size)}if(t.length===0&&this.items.length>0){let i=this.items.shift();t.push(i),r+=i.size,this.sizeBytes-=i.size}return[t.map(i=>({action:i.action,item:i.payload})),()=>t.forEach(i=>i.itemPromiseResolve())]}},zE=20971520,BE=2500,Yn=class n{constructor(e={}){var r,a,s,i,o,u,c,l,d,h,f,p,m,g,y,b;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Tl}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:or("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1});let t=n.getDefaultClientConfig();if(this.tracingSampleRate=DE(),this.apiUrl=(a=Pl((r=e.apiUrl)!=null?r:t.apiUrl))!=null?a:"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Pl((s=e.apiKey)!=null?s:t.apiKey),this.webUrl=Pl((i=e.webUrl)!=null?i:t.webUrl),(o=this.webUrl)!=null&&o.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=(u=e.timeout_ms)!=null?u:9e4,this.caller=new si((c=e.callerOptions)!=null?c:{}),this.traceBatchConcurrency=(l=e.traceBatchConcurrency)!=null?l:this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.batchIngestCaller=new si({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...(d=e.callerOptions)!=null?d:{},onFailedResponseHook:UE}),this.hideInputs=(f=(h=e.hideInputs)!=null?h:e.anonymizer)!=null?f:t.hideInputs,this.hideOutputs=(m=(p=e.hideOutputs)!=null?p:e.anonymizer)!=null?m:t.hideOutputs,this.autoBatchTracing=(g=e.autoBatchTracing)!=null?g:this.autoBatchTracing,this.blockOnRootRunFinalization=(y=e.blockOnRootRunFinalization)!=null?y:this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=(b=e.manualFlushMode)!=null?b:this.manualFlushMode}static getDefaultClientConfig(){var s;let e=Tr("API_KEY"),t=(s=Tr("ENDPOINT"))!=null?s:"https://api.smith.langchain.com",r=Tr("HIDE_INPUTS")==="true",a=Tr("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:ME(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let e={"User-Agent":`langsmith-js/${Go}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){var i;let r=(i=t==null?void 0:t.toString())!=null?i:"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(D(),a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(s,`Failed to fetch ${e}`),s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let a=Number(t.get("offset"))||0,s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(s));let i=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(D(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(o,`Failed to fetch ${e}`);let u=r?r(await o.json()):await o.json();if(u.length===0||(yield u,u.length<s))break;a+=u.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let s=t?{...t}:{};for(;;){let o=await(await this.caller.call(D(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];let u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let r=[];for(let a of e)this.filteredPostUuids.has(a.id)?this.filteredPostUuids.delete(a.id):r.push(a);return r}else{let r=[];for(let a of e)a.id!==a.trace_id&&!this.filteredPostUuids.has(a.trace_id)||Math.random()<this.tracingSampleRate?r.push(a):this.filteredPostUuids.add(a.id);return r}}async _getBatchSizeLimitBytes(){var t,r,a;let e=await this._ensureServerInfo();return(a=(r=this.batchSizeBytesLimit)!=null?r:(t=e.batch_ingest_config)==null?void 0:t.size_limit_bytes)!=null?a:zE}async _getMultiPartSupport(){var t,r;return(r=(t=(await this._ensureServerInfo()).instance_flags)==null?void 0:t.dataset_examples_multipart_enabled)!=null?r:!1}drainAutoBatchQueue(e){let t=[];for(;this.autoBatchQueue.items.length>0;){let[r,a]=this.autoBatchQueue.pop(e);if(!r.length){a();break}let s=this._processBatch(r,a).catch(console.error);t.push(s)}return Promise.all(t)}async _processBatch(e,t){var r;if(!e.length){t();return}try{let a={runCreates:e.filter(i=>i.action==="create").map(i=>i.item),runUpdates:e.filter(i=>i.action==="update").map(i=>i.item)},s=await this._ensureServerInfo();(r=s==null?void 0:s.batch_ingest_config)!=null&&r.use_multipart_endpoint?await this.multipartIngestRuns(a):await this.batchIngestRuns(a)}finally{t()}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.action==="create"&&(e.item=Lm(e.item));let t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;let r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){let e=await D()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(BE),...this.fetchOptions});return await X(e,"get server info"),e.json()}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{var e;if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(t){console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to batch operations and default limits.")}return(e=this._serverInfo)!=null?e:{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){let e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){var o;if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;let a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:(o=e.start_time)!=null?o:Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}let s=Lm(a),i=await this.caller.call(D(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:st(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){var o,u;if(e===void 0&&t===void 0)return;let r=(o=e==null?void 0:e.map(c=>this.prepareRunCreateOrUpdateInputs(c)))!=null?o:[],a=(u=t==null?void 0:t.map(c=>this.prepareRunCreateOrUpdateInputs(c)))!=null?u:[];if(r.length>0&&a.length>0){let c=r.reduce((d,h)=>(h.id&&(d[h.id]=h),d),{}),l=[];for(let d of a)d.id!==void 0&&c[d.id]?c[d.id]={...c[d.id],...d}:l.push(d);r=Object.values(c),a=l}let s={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!s.post.length&&!s.patch.length)return;let i={post:[],patch:[]};for(let c of["post","patch"]){let l=c,d=s[l].reverse(),h=d.pop();for(;h!==void 0;)i[l].push(h),h=d.pop()}(i.post.length>0||i.patch.length>0)&&await this._postBatchIngestRuns(st(i))}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(D(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r={},a=[];for(let l of e!=null?e:[]){let d=this.prepareRunCreateOrUpdateInputs(l);d.id!==void 0&&d.attachments!==void 0&&(r[d.id]=d.attachments),delete d.attachments,a.push(d)}let s=[];for(let l of t!=null?t:[])s.push(this.prepareRunCreateOrUpdateInputs(l));if(a.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(s.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&s.length>0){let l=a.reduce((h,f)=>(f.id&&(h[f.id]=f),h),{}),d=[];for(let h of s)h.id!==void 0&&l[h.id]?l[h.id]={...l[h.id],...h}:d.push(h);a=Object.values(l),s=d}if(a.length===0&&s.length===0)return;let u=[],c=[];for(let[l,d]of[["post",a],["patch",s]])for(let h of d){let{inputs:f,outputs:p,events:m,attachments:g,...y}=h,b={inputs:f,outputs:p,events:m},A=st(y);c.push({name:`${l}.${y.id}`,payload:new Blob([A],{type:`application/json; length=${A.length}`})});for(let[x,_]of Object.entries(b)){if(_===void 0)continue;let v=st(_);c.push({name:`${l}.${y.id}.${x}`,payload:new Blob([v],{type:`application/json; length=${v.length}`})})}if(y.id!==void 0){let x=r[y.id];if(x){delete r[y.id];for(let[_,v]of Object.entries(x)){let E,O;if(Array.isArray(v)?[E,O]=v:(E=v.mimeType,O=v.data),_.includes(".")){console.warn(`Skipping attachment '${_}' for run ${y.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}c.push({name:`attachment.${y.id}.${_}`,payload:new Blob([O],{type:`${E}; length=${O.byteLength}`})})}}}u.push(`trace=${y.trace_id},id=${y.id}`)}await this._sendMultipartRequest(c,u.join("; "))}async _sendMultipartRequest(e,t){try{let r="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=[];for(let u of e)a.push(new Blob([`--${r}\r
`])),a.push(new Blob([`Content-Disposition: form-data; name="${u.name}"\r
`,`Content-Type: ${u.payload.type}\r
\r
`])),a.push(u.payload),a.push(new Blob([`\r
`]));a.push(new Blob([`--${r}--\r
`]));let i=await new Blob(a).arrayBuffer(),o=await this.batchIngestCaller.call(D(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${r}`},body:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(o,"ingest multipart runs",!0)}catch(r){console.warn(`${r.message.trim()}

Context: ${t}`)}}async updateRun(e,t){Q(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));let r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:r}).catch(console.error);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}let a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(D(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:st(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(s,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Q(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r!=null&&r.projectName?a=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?a=r==null?void 0:r.projectId:a=(await this.readProject({projectName:Tr("PROJECT")||"default"})).id;let s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){let a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await FE(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>{var o,u;return((o=s==null?void 0:s.dotted_order)!=null?o:"").localeCompare((u=i==null?void 0:i.dotted_order)!=null?u:"")});for(let s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(let s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){let{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:c,runType:l,error:d,id:h,query:f,filter:p,traceFilter:m,treeFilter:g,limit:y,select:b}=e,A=[];if(t&&(A=Array.isArray(t)?t:[t]),r){let E=Array.isArray(r)?r:[r],O=await Promise.all(E.map(S=>this.readProject({projectName:S}).then(L=>L.id)));A.push(...O)}let x=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],_={session:A.length?A:null,run_type:l,reference_example:i,query:f,filter:p,trace_filter:m,tree_filter:g,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:d,id:h,limit:y,trace:s,select:b||x,is_root:c},v=0;for await(let E of this._getCursorPaginatedList("/runs/query",_))if(y){if(v>=y)break;if(E.length+v>y){yield*E.slice(0,y-v);break}v+=E.length,yield*E}else yield*E}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:s,projectIds:i,referenceExampleIds:o,startTime:u,endTime:c,error:l,query:d,filter:h,traceFilter:f,treeFilter:p,isRoot:m,dataSourceType:g}){let y=i||[];s&&(y=[...i||[],...await Promise.all(s.map(v=>this.readProject({projectName:v}).then(E=>E.id)))]);let A=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:y,reference_example:o,start_time:u,end_time:c,error:l,query:d,filter:h,trace_filter:f,tree_filter:p,is_root:m,data_source_type:g}).filter(([v,E])=>E!==void 0));return await(await this.caller.call(D(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(A),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||pe()};Q(e);let s=await(await this.caller.call(D(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){Q(e);let t=await this.caller.call(D(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(t,"unshare run",!0)}async readRunSharedLink(e){Q(e);let r=await(await this.caller.call(D(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(t!==void 0)for(let i of t)r.append("id",i);return Q(e),await(await this.caller.call(D(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),Q(e);let a=await(await this.caller.call(D(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};Q(e);let s=await(await this.caller.call(D(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){Q(e);let t=await this.caller.call(D(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(t,"unshare dataset",!0)}async readSharedDataset(e){return Q(e),await(await this.caller.call(D(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async listSharedExamples(e,t){let r={};t!=null&&t.exampleIds&&(r.id=t.exampleIds);let a=new URLSearchParams;Object.entries(r).forEach(([o,u])=>{Array.isArray(u)?u.forEach(c=>a.append(o,c)):a.append(o,u)});let s=await this.caller.call(D(),`${this.apiUrl}/public/${e}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await s.json();if(!s.ok)throw"detail"in i?new Error(`Failed to list shared examples.
Status: ${s.status}
Message: ${i.detail.join(`
`)}`):new Error(`Failed to list shared examples: ${s.status} ${s.statusText}`);return i.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){let o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=s||{};r&&(c.metadata=r);let l={name:e,extra:c,description:t};i!==null&&(l.reference_dataset_id=i);let d=await this.caller.call(D(),u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(d,"create project"),await d.json()}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){let o=`${this.apiUrl}/sessions/${e}`,u=s;a&&(u={...u||{},metadata:a});let c={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(D(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(l,"update project"),await l.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions",a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Q(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");let s=await this.caller.call(D(),`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch(i){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions",s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Q(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());let i=await this._get(a,s),o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i,metadata:o}={}){let u=new URLSearchParams;if(e!==void 0)for(let c of e)u.append("id",c);if(t!==void 0&&u.append("name",t),r!==void 0&&u.append("name_contains",r),a!==void 0)u.append("reference_dataset",a);else if(s!==void 0){let c=await this.readDataset({datasetName:s});u.append("reference_dataset",c.id)}i!==void 0&&u.append("reference_free",i.toString()),o!==void 0&&u.append("metadata",JSON.stringify(o));for await(let c of this._getPaginated("/sessions",u))yield*c}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,Q(r);let a=await this.caller.call(D(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(a,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){let u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach(h=>{c.append("input_keys",h)}),a.forEach(h=>{c.append("output_keys",h)}),s&&c.append("description",s),i&&c.append("data_type",i),o&&c.append("name",o);let l=await this.caller.call(D(),u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(l,"upload CSV"),await l.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:a,outputsSchema:s,metadata:i}={}){let o={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),a&&(o.inputs_schema_definition=a),s&&(o.outputs_schema_definition=s);let u=await this.caller.call(D(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(u,"create dataset"),await u.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets",a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)Q(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");let s=await this._get(r,a),i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);let i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s,metadata:i}={}){let o="/datasets",u=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(let c of r)u.append("id",c);a!==void 0&&u.append("name",a),s!==void 0&&u.append("name_contains",s),i!==void 0&&u.append("metadata",JSON.stringify(i));for await(let c of this._getPaginated(o,u))yield*c}async updateDataset(e){let{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");let s=t!=null?t:(await this.readDataset({datasetName:r})).id;Q(s);let i=await this.caller.call(D(),`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(i,"update dataset"),await i.json()}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)Q(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");let s=await this.caller.call(D(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(s,`delete ${r}`),await s.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let a=e;if(!a&&!t)throw new Error("Must provide either datasetName or datasetId");if(a&&t)throw new Error("Must provide either datasetName or datasetId, not both");a||(a=(await this.readDataset({datasetName:t})).id),Q(a);let s={tag:r},i=await this.caller.call(D(),`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(i,"index dataset"),await i.json()}async similarExamples(e,t,r,{filter:a}={}){let s={limit:r,inputs:e};a!==void 0&&(s.filter=a),Q(t);let i=await this.caller.call(D(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(i,"fetch similar examples"),(await i.json()).examples}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:s,exampleId:i,metadata:o,split:u,sourceRunId:c}){let l=r;if(l===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:a})).id);let d=s||new Date,h={dataset_id:l,inputs:e,outputs:t,created_at:d==null?void 0:d.toISOString(),id:i,metadata:o,split:u,source_run_id:c},f=await this.caller.call(D(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(h),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(f,"create example"),await f.json()}async createExamples(e){let{inputs:t,outputs:r,metadata:a,sourceRunIds:s,exampleIds:i,datasetId:o,datasetName:u}=e,c=o;if(c===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(c!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");c===void 0&&(c=(await this.readDataset({datasetName:u})).id);let l=t.map((f,p)=>({dataset_id:c,inputs:f,outputs:r?r[p]:void 0,metadata:a?a[p]:void 0,split:e.splits?e.splits[p]:void 0,id:i?i[p]:void 0,source_run_id:s?s[p]:void 0})),d=await this.caller.call(D(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(d,"create examples"),await d.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let a=e.map(i=>al(i)?sl(i):i),s=al(t)?sl(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){Q(e);let t=`/examples/${e}`,r=await this._get(t),{attachment_urls:a,...s}=r,i=s;return a&&(i.attachments=Object.entries(a).reduce((o,[u,c])=>(o[u.slice(11)]={presigned_url:c.presigned_url},o),{})),i}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:s,inlineS3Urls:i,metadata:o,limit:u,offset:c,filter:l,includeAttachments:d}={}){let h;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(t!==void 0)h=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let f=new URLSearchParams({dataset:h}),p=a?typeof a=="string"?a:a==null?void 0:a.toISOString():void 0;p&&f.append("as_of",p);let m=i!=null?i:!0;if(f.append("inline_s3_urls",m.toString()),r!==void 0)for(let y of r)f.append("id",y);if(s!==void 0)for(let y of s)f.append("splits",y);if(o!==void 0){let y=JSON.stringify(o);f.append("metadata",y)}u!==void 0&&f.append("limit",u.toString()),c!==void 0&&f.append("offset",c.toString()),l!==void 0&&f.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(y=>f.append("select",y));let g=0;for await(let y of this._getPaginated("/examples",f)){for(let b of y){let{attachment_urls:A,...x}=b,_=x;A&&(_.attachments=Object.entries(A).reduce((v,[E,O])=>(v[E.slice(11)]={presigned_url:O.presigned_url},v),{})),yield _,g++}if(u!==void 0&&g>=u)break}}async deleteExample(e){Q(e);let t=`/examples/${e}`,r=await this.caller.call(D(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(r,`delete ${t}`),await r.json()}async updateExample(e,t){Q(e);let r=await this.caller.call(D(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(r,"update example"),await r.json()}async updateExamples(e){let t=await this.caller.call(D(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(t,"update examples"),await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:t})).id:a=e,Q(a);let s=new URLSearchParams,i=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return i&&s.append("as_of",i),await this._get(`/datasets/${a}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:s=!1}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,Q(i);let o={split_name:r,examples:a.map(c=>(Q(c),c)),remove:s},u=await this.caller.call(D(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(u,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){$o("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));let o=await t.evaluateRun(i,s),[u,c]=await this._logEvaluationFeedback(o,i,r);return c[0]}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:d,projectId:h,comparativeExperimentId:f}){var b;if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");let p={type:u!=null?u:"api",metadata:o!=null?o:{}};c!==void 0&&(p==null?void 0:p.metadata)!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:c}),(p==null?void 0:p.metadata)!==void 0&&((b=p.metadata.__run)==null?void 0:b.run_id)!==void 0&&Q(p.metadata.__run.run_id);let m={id:l!=null?l:pe(),run_id:e,key:t,score:r,value:a,correction:s,comment:i,feedback_source:p,comparative_experiment_id:f,feedbackConfig:d,session_id:h},g=`${this.apiUrl}/feedback`,y=await this.caller.call(D(),g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(y,"create feedback",!0),m}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){let i={};t!=null&&(i.score=t),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),Q(e);let o=await this.caller.call(D(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(o,"update feedback",!0)}async readFeedback(e){Q(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Q(e);let t=`/feedback/${e}`,r=await this.caller.call(D(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(r,`delete ${t}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(let s of t)a.append("key",s);if(r)for(let s of r)a.append("source",s);for await(let s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){let s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(D(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:s,metadata:i,id:o}){var l;if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");let u={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:s,created_at:(l=a!=null?a:new Date)==null?void 0:l.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(D(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){Q(e);let t=new URLSearchParams({run_id:e});for await(let r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:t=[e],t}async _logEvaluationFeedback(e,t,r){let a=this._selectEvalResults(e),s=[];for(let i of a){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let u=null;i.targetRunId?u=i.targetRunId:t&&(u=t.id),s.push(await this.createFeedback(u,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[a,s]}async logEvaluationFeedback(e,t,r){let[a]=await this._logEvaluationFeedback(e,t,r);return a}async*listAnnotationQueues(e={}){let{queueIds:t,name:r,nameContains:a,limit:s}=e,i=new URLSearchParams;t&&t.forEach((u,c)=>{Q(u,`queueIds[${c}]`),i.append("ids",u)}),r&&i.append("name",r),a&&i.append("name_contains",a),i.append("limit",(s!==void 0?Math.min(s,100):100).toString());let o=0;for await(let u of this._getPaginated("/annotation-queues",i))if(yield*u,o++,s!==void 0&&o>=s)break}async createAnnotationQueue(e){let{name:t,description:r,queueId:a}=e,s={name:t,description:r,id:a||pe()},i=await this.caller.call(D(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(s).filter(([u,c])=>c!==void 0))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(i,"create annotation queue"),await i.json()}async readAnnotationQueue(e){let t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){let{name:r,description:a}=t,s=await this.caller.call(D(),`${this.apiUrl}/annotation-queues/${Q(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:a}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(s,"update annotation queue")}async deleteAnnotationQueue(e){let t=await this.caller.call(D(),`${this.apiUrl}/annotation-queues/${Q(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){let r=await this.caller.call(D(),`${this.apiUrl}/annotation-queues/${Q(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map((a,s)=>Q(a,`runIds[${s}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){let r=`/annotation-queues/${Q(e,"queueId")}/run`,a=await this.caller.call(D(),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(a,"get run from annotation queue"),await a.json()}async _currentTenantIsOwner(e){let t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){let r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){let t=await this.caller.call(D(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){let a=typeof r.detail=="string"?r.detail:JSON.stringify(r.detail),s=new Error(`Error ${t.status}: ${t.statusText}
${a}`);throw s.statusCode=t.status,s}if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){let[r,a,s]=Pr(e),i=await this.caller.call(D(),`${this.apiUrl}/likes/${r}/${a}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(i,`${t?"like":"unlike"} prompt`),await i.json()}async _getPromptUrl(e){let[t,r,a]=Pr(e);if(await this._currentTenantIsOwner(t)){let s=await this._getSettings();return a!=="latest"?`${this.getHostUrl()}/prompts/${r}/${a.substring(0,8)}?organizationId=${s.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${s.id}`}else return a!=="latest"?`${this.getHostUrl()}/hub/${t}/${r}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(let t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*t}async*listPrompts(e){var r;let t=new URLSearchParams;t.append("sort_field",(r=e==null?void 0:e.sortField)!=null?r:"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&t.append("is_public",e.isPublic.toString()),e!=null&&e.query&&t.append("query",e.query);for await(let a of this._getPaginated("/repos",t,s=>s.repos))yield*a}async getPrompt(e){let[t,r,a]=Pr(e),s=await this.caller.call(D(),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(s.status===404)return null;await X(s,"get prompt");let i=await s.json();return i.repo?i.repo:null}async createPrompt(e,t){let r=await this._getSettings();if(t!=null&&t.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);let[a,s,i]=Pr(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);let o={repo_handle:s,...(t==null?void 0:t.description)&&{description:t.description},...(t==null?void 0:t.readme)&&{readme:t.readme},...(t==null?void 0:t.tags)&&{tags:t.tags},is_public:!!(t!=null&&t.isPublic)},u=await this.caller.call(D(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(u,"create prompt");let{repo:c}=await u.json();return c}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[a,s,i]=Pr(e),o=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${a}/${s}`):r==null?void 0:r.parentCommitHash,u={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},c=await this.caller.call(D(),`${this.apiUrl}/commits/${a}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(c,"create commit");let l=await c.json();return this._getPromptUrl(`${a}/${s}${l.commit_hash?`:${l.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");let r=new FormData;for(let i of t){let o=i.id,u={...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split}},c=st(u),l=new Blob([c],{type:"application/json"});if(r.append(o,l),i.inputs){let d=st(i.inputs),h=new Blob([d],{type:"application/json"});r.append(`${o}.inputs`,h)}if(i.outputs){let d=st(i.outputs),h=new Blob([d],{type:"application/json"});r.append(`${o}.outputs`,h)}if(i.attachments)for(let[d,h]of Object.entries(i.attachments)){let f,p;Array.isArray(h)?[f,p]=h:(f=h.mimeType,p=h.data);let m=new Blob([p],{type:`${f}; length=${p.byteLength}`});r.append(`${o}.attachment.${d}`,m)}if(i.attachments_operations){let d=st(i.attachments_operations),h=new Blob([d],{type:"application/json"});r.append(`${o}.attachments_operations`,h)}}return await(await this.caller.call(D(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"PATCH",headers:this.headers,body:r})).json()}async uploadExamplesMultipart(e,t=[]){var i;if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");let r=new FormData;for(let o of t){let u=((i=o.id)!=null?i:pe()).toString(),c={created_at:o.created_at,...o.metadata&&{metadata:o.metadata},...o.split&&{split:o.split}},l=st(c),d=new Blob([l],{type:"application/json"});r.append(u,d);let h=st(o.inputs),f=new Blob([h],{type:"application/json"});if(r.append(`${u}.inputs`,f),o.outputs){let p=st(o.outputs),m=new Blob([p],{type:"application/json"});r.append(`${u}.outputs`,m)}if(o.attachments)for(let[p,m]of Object.entries(o.attachments)){let g,y;Array.isArray(m)?[g,y]=m:(g=m.mimeType,y=m.data);let b=new Blob([y],{type:`${g}; length=${y.byteLength}`});r.append(`${u}.attachment.${p}`,b)}}return await(await this.caller.call(D(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:r})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[r,a]=Pr(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);let s={};if((t==null?void 0:t.description)!==void 0&&(s.description=t.description),(t==null?void 0:t.readme)!==void 0&&(s.readme=t.readme),(t==null?void 0:t.tags)!==void 0&&(s.tags=t.tags),(t==null?void 0:t.isPublic)!==void 0&&(s.is_public=t.isPublic),(t==null?void 0:t.isArchived)!==void 0&&(s.is_archived=t.isArchived),Object.keys(s).length===0)throw new Error("No valid update options provided");let i=await this.caller.call(D(),`${this.apiUrl}/repos/${r}/${a}`,{method:"PATCH",body:JSON.stringify(s),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[t,r,a]=Pr(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return await(await this.caller.call(D(),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async pullPromptCommit(e,t){let[r,a,s]=Pr(e),i=await this.caller.call(D(),`${this.apiUrl}/commits/${r}/${a}/${s}${t!=null&&t.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(i,"pull prompt commit");let o=await i.json();return{owner:r,repo:a,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){let r=await this.pullPromptCommit(e,{includeModel:t==null?void 0:t.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(a=>a!=="object")&&await this.updatePrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}):await this.createPrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}),t!=null&&t.object?await this.createCommit(e,t==null?void 0:t.object,{parentCommitHash:t==null?void 0:t.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){var h,f;let{sourceApiUrl:r=this.apiUrl,datasetName:a}=t,[s,i]=this.parseTokenOrUrl(e,r),o=new n({apiUrl:s,apiKey:"placeholder"}),u=await o.readSharedDataset(i),c=a||u.name;try{if(await this.hasDataset({datasetId:c})){console.log(`Dataset ${c} already exists in your tenant. Skipping.`);return}}catch(p){}let l=await o.listSharedExamples(i),d=await this.createDataset(c,{description:u.description,dataType:u.data_type||"kv",inputsSchema:(h=u.inputs_schema_definition)!=null?h:void 0,outputsSchema:(f=u.outputs_schema_definition)!=null?f:void 0});try{await this.createExamples({inputs:l.map(p=>p.inputs),outputs:l.flatMap(p=>p.outputs?[p.outputs]:[]),datasetId:d.id})}catch(p){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),p}}parseTokenOrUrl(e,t,r=2,a="dataset"){try{return Q(e),[t,e]}catch(s){}try{let i=new URL(e).pathname.split("/").filter(o=>o!=="");if(i.length>=r){let o=i[i.length-r];return[t,o]}else throw new Error(`Invalid public ${a} URL: ${e}`)}catch(s){throw new Error(`Invalid public ${a} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()])}};var Go="0.2.14";var Cr,qE=()=>typeof window!="undefined"&&typeof window.document!="undefined",HE=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",VE=()=>typeof window!="undefined"&&window.name==="nodejs"||typeof navigator!="undefined"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Mm=()=>typeof Deno!="undefined",GE=()=>typeof process!="undefined"&&typeof process.versions!="undefined"&&typeof process.versions.node!="undefined"&&!Mm(),KE=()=>Cr||(qE()?Cr="browser":GE()?Cr="node":HE()?Cr="webworker":VE()?Cr="jsdom":Mm()?Cr="deno":Cr="other",Cr),Sl;function Ko(){if(Sl===void 0){let n=KE(),e=JE();Sl={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Go,...e}}return Sl}function Dm(){let n=ZE()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(let[r,a]of Object.entries(n))(r.startsWith("LANGCHAIN_")||r.startsWith("LANGSMITH_"))&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function ZE(){try{return typeof process!="undefined"&&process.env?Object.entries(process.env).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch(n){return}}function or(n){var e;try{return typeof process!="undefined"?(e=process.env)==null?void 0:e[n]:void 0}catch(t){return}}function Tr(n){return or(`LANGSMITH_${n}`)||or(`LANGCHAIN_${n}`)}var Cl;function JE(){if(Cl!==void 0)return Cl;let n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of n){let r=or(t);r!==void 0&&(e[t]=r)}return Cl=e,e}var Fm=n=>n!==void 0?n:!!["TRACING_V2","TRACING"].find(t=>Tr(t)==="true");var Zo=Symbol.for("lc:context_variables");function WE(n){return n.replace(/[-:.]/g,"")}function YE(n,e,t=1){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return WE(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}var Jo=class n{constructor(e,t){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t}static fromHeader(e){let t=e.split(","),r={},a=[];for(let s of t){let[i,o]=s.split("="),u=decodeURIComponent(o);i==="langsmith-metadata"?r=JSON.parse(u):i==="langsmith-tags"&&(a=u.split(","))}return new n(r,a)}toHeader(){let e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}},Sr=class n{constructor(e){var o,u,c,l,d;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Wo(e)){Object.assign(this,{...e});return}let t=n.getDefaultConfig(),{metadata:r,...a}=e,s=(o=a.client)!=null?o:n.getSharedClient(),i={...r,...(u=a==null?void 0:a.extra)==null?void 0:u.metadata};if(a.extra={...a.extra,metadata:i},Object.assign(this,{...t,...a,client:s}),this.trace_id||(this.parent_run?this.trace_id=(c=this.parent_run.trace_id)!=null?c:this.id:this.trace_id=this.id),(l=this.execution_order)!=null||(this.execution_order=1),(d=this.child_execution_order)!=null||(this.child_execution_order=1),!this.dotted_order){let h=YE(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+h:this.dotted_order=h}}static getDefaultConfig(){var e,t,r;return{id:pe(),run_type:"chain",project_name:(t=(e=or("LANGCHAIN_PROJECT"))!=null?e:or("LANGCHAIN_SESSION"))!=null?t:"default",child_runs:[],api_url:(r=or("LANGCHAIN_ENDPOINT"))!=null?r:"http://localhost:1984",api_key:or("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return n.sharedClient||(n.sharedClient=new Yn),n.sharedClient}createChild(e){var u,c,l,d,h,f,p;let t=this.child_execution_order+1,r=new n({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});Zo in this&&(r[Zo]=this[Zo]);let a=Symbol.for("lc:child_config"),s=(c=(u=e.extra)==null?void 0:u[a])!=null?c:this.extra[a];if(QE(s)){let m={...s},g=XE(m.callbacks)?(d=(l=m.callbacks).copy)==null?void 0:d.call(l):void 0;g&&(Object.assign(g,{_parentRunId:r.id}),(p=(f=(h=g.handlers)==null?void 0:h.find(zm))==null?void 0:f.updateFromRunTree)==null||p.call(f,r),m.callbacks=g),r.extra[a]=m}let i=new Set,o=this;for(;o!=null&&!i.has(o.id);)i.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(r),r}async end(e,t,r=Date.now(),a){var s,i,o;this.outputs=(s=this.outputs)!=null?s:e,this.error=(i=this.error)!=null?i:t,this.end_time=(o=this.end_time)!=null?o:r,a&&Object.keys(a).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...a}}:{metadata:a})}_convertToCreate(e,t,r=!0){var u,c;let a=(u=e.extra)!=null?u:{};if(a.runtime||(a.runtime={}),t)for(let[l,d]of Object.entries(t))a.runtime[l]||(a.runtime[l]=d);let s,i;return r?(i=(c=e.parent_run)==null?void 0:c.id,s=[]):(s=e.child_runs.map(l=>this._convertToCreate(l,t,r)),i=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:a,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:s,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{let t=Ko(),r=await this._convertToCreate(this,t,!0);if(await this.client.createRun(r),!e){$o("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(let a of this.child_runs)await a.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(){var e;try{let t={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:(e=this.parent_run)==null?void 0:e.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments};await this.client.updateRun(this.id,t)}catch(t){console.error(`Error in patchRun for run ${this.id}`,t)}}toJSON(){return this._convertToCreate(this,void 0,!1)}static fromRunnableConfig(e,t){var c,l,d,h,f,p,m;let r=e==null?void 0:e.callbacks,a,s,i,o=Fm();if(r){let g=(l=(c=r==null?void 0:r.getParentRunId)==null?void 0:c.call(r))!=null?l:"",y=(d=r==null?void 0:r.handlers)==null?void 0:d.find(b=>(b==null?void 0:b.name)=="langchain_tracer");a=(h=y==null?void 0:y.getRun)==null?void 0:h.call(y,g),s=y==null?void 0:y.projectName,i=y==null?void 0:y.client,o=o||!!y}return a?new n({name:a.name,id:a.id,trace_id:a.trace_id,dotted_order:a.dotted_order,client:i,tracingEnabled:o,project_name:s,tags:[...new Set(((f=a==null?void 0:a.tags)!=null?f:[]).concat((p=e==null?void 0:e.tags)!=null?p:[]))],extra:{metadata:{...(m=a==null?void 0:a.extra)==null?void 0:m.metadata,...e==null?void 0:e.metadata}}}).createChild(t):new n({...t,client:i,tracingEnabled:o,project_name:s})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){var c,l,d,h;let r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,a=r["langsmith-trace"];if(!a||typeof a!="string")return;let s=a.trim(),i=s.split(".").map(f=>{let[p,m]=f.split("Z");return{strTime:p,time:Date.parse(p+"Z"),uuid:m}}),o=i[0].uuid,u={...t,name:(c=t==null?void 0:t.name)!=null?c:"parent",run_type:(l=t==null?void 0:t.run_type)!=null?l:"chain",start_time:(d=t==null?void 0:t.start_time)!=null?d:Date.now(),id:(h=i.at(-1))==null?void 0:h.uuid,trace_id:o,dotted_order:s};if(r.baggage&&typeof r.baggage=="string"){let f=Jo.fromHeader(r.baggage);u.metadata=f.metadata,u.tags=f.tags}return new n(u)}toHeaders(e){var r;let t={"langsmith-trace":this.dotted_order,baggage:new Jo((r=this.extra)==null?void 0:r.metadata,this.tags).toHeader()};if(e)for(let[a,s]of Object.entries(t))e.set(a,s);return t}};Object.defineProperty(Sr,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function Wo(n){return n!==void 0&&typeof n.createChild=="function"&&typeof n.postRun=="function"}function zm(n){return typeof n=="object"&&n!=null&&typeof n.name=="string"&&n.name==="langchain_tracer"}function Um(n){return Array.isArray(n)&&n.some(e=>zm(e))}function XE(n){return typeof n=="object"&&n!=null&&Array.isArray(n.handlers)}function QE(n){var e;return n!==void 0&&typeof n.callbacks=="object"&&(Um((e=n.callbacks)==null?void 0:e.handlers)||Um(n.callbacks))}var Rl=class{getStore(){}run(e,t){return t()}},kl=Symbol.for("ls:tracing_async_local_storage"),eO=new Rl,Nl=class{getInstance(){var e;return(e=globalThis[kl])!=null?e:eO}initializeGlobalInstance(e){globalThis[kl]===void 0&&(globalThis[kl]=e)}},tO=new Nl,Bm=()=>{let n=tO.getInstance().getStore();if(!Wo(n))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join(`
`));return n};var kN=Symbol.for("langsmith:traceable:root");function Yo(n){return typeof n=="function"&&"langsmith:traceable"in n}var $l={};Jd($l,{JsonPatchError:()=>me,_areEquals:()=>pi,applyOperation:()=>Qn,applyPatch:()=>en,applyReducer:()=>sO,deepClone:()=>nO,getValueByPointer:()=>ru,validate:()=>Hm,validator:()=>nu});var rO=Object.prototype.hasOwnProperty;function Qo(n,e){return rO.call(n,e)}function eu(n){if(Array.isArray(n)){let t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Qo(n,t)&&e.push(t);return e}function Be(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function tu(n){let e=0,t=n.length,r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function ur(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function fi(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function Xo(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(Xo(n[t]))return!0}else if(typeof n=="object"){let t=eu(n),r=t.length;for(var e=0;e<r;e++)if(Xo(n[t[e]]))return!0}}return!1}function qm(n,e){let t=[n];for(let r in e){let a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a!="undefined"&&t.push(`${r}: ${a}`)}return t.join(`
`)}var Xn=class extends Error{constructor(e,t,r,a,s){super(qm(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=qm(e,{name:t,index:r,operation:a,tree:s})}};var me=Xn,nO=Be,ds={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=ru(t,this.path);r&&(r=Be(r));let a=Qn(t,{op:"remove",path:this.from}).removed;return Qn(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){let r=ru(t,this.from);return Qn(t,{op:"add",path:this.path,value:Be(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:pi(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},aO={add:function(n,e,t){return tu(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:ds.move,copy:ds.copy,test:ds.test,_get:ds._get};function ru(n,e){if(e=="")return n;var t={op:"_get",path:e};return Qn(n,t),t.value}function Qn(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):nu(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=ru(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=pi(n,e.value),i.test===!1)throw new me("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new me("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=Be(n));let o=(e.path||"").split("/"),u=n,c=1,l=o.length,d,h,f;for(typeof t=="function"?f=t:f=nu;;){if(h=o[c],h&&h.indexOf("~")!=-1&&(h=fi(h)),a&&(h=="__proto__"||h=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(u[h]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&f(e,0,n,d)),c++,Array.isArray(u)){if(h==="-")h=u.length;else{if(t&&!tu(h))throw new me("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);tu(h)&&(h=~~h)}if(c>=l){if(t&&e.op==="add"&&h>u.length)throw new me("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);let p=aO[e.op].call(e,u,h,n);if(p.test===!1)throw new me("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}}else if(c>=l){let p=ds[e.op].call(e,u,h,n);if(p.test===!1)throw new me("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}if(u=u[h],t&&c<l&&(!u||typeof u!="object"))throw new me("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function en(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new me("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=Be(n));let s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=Qn(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function sO(n,e,t){let r=Qn(n,e);if(r.test===!1)throw new me("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function nu(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new me("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(ds[n.op]){if(typeof n.path!="string")throw new me("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new me('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new me("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new me("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&Xo(n.value))throw new me("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new me("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new me("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=Hm([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new me("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new me("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function Hm(n,e,t){try{if(!Array.isArray(n))throw new me("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)en(Be(e),Be(n),t||!0);else{t=t||nu;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof me)return a;throw a}}function pi(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!pi(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!pi(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}function Vm(n,e,t,r,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var s=eu(e),i=eu(n),o=!1,u=!1,c=i.length-1;c>=0;c--){var l=i[c],d=n[l];if(Qo(e,l)&&!(e[l]===void 0&&d!==void 0&&Array.isArray(e)===!1)){var h=e[l];typeof d=="object"&&d!=null&&typeof h=="object"&&h!=null&&Array.isArray(d)===Array.isArray(h)?Vm(d,h,t,r+"/"+ur(l),a):d!==h&&(o=!0,a&&t.push({op:"test",path:r+"/"+ur(l),value:Be(d)}),t.push({op:"replace",path:r+"/"+ur(l),value:Be(h)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:r+"/"+ur(l),value:Be(d)}),t.push({op:"remove",path:r+"/"+ur(l)}),u=!0):(a&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}),o=!0)}if(!(!u&&s.length==i.length))for(var c=0;c<s.length;c++){var l=s[c];!Qo(n,l)&&e[l]!==void 0&&t.push({op:"add",path:r+"/"+ur(l),value:Be(e[l])})}}}function au(n,e,t=!1){var r=[];return Vm(n,e,r,"",t),r}var zN={...$l,JsonPatchError:Xn,deepClone:Be,escapePathComponent:ur,unescapePathComponent:fi};var iO=()=>typeof window!="undefined"&&typeof window.document!="undefined",oO=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",uO=()=>typeof window!="undefined"&&window.name==="nodejs"||typeof navigator!="undefined"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Ll=()=>typeof Deno!="undefined",cO=()=>typeof process!="undefined"&&typeof process.versions!="undefined"&&typeof process.versions.node!="undefined"&&!Ll(),lO=()=>{let n;return iO()?n="browser":cO()?n="node":oO()?n="webworker":uO()?n="jsdom":Ll()?n="deno":n="other",n},jl;async function Gm(){return jl===void 0&&(jl={library:"langchain-js",runtime:lO()}),jl}function ae(n){var e;try{return typeof process!="undefined"?(e=process.env)==null?void 0:e[n]:Ll()?Deno==null?void 0:Deno.env.get(n):void 0}catch(t){return}}var Dl=class{};function Ml(n){return"lc_prefer_streaming"in n&&n.lc_prefer_streaming}var ea=class n extends Dl{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,zc(this.constructor)]}constructor(e){var t,r,a,s,i,o,u;super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:ae("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=(t=e.ignoreLLM)!=null?t:this.ignoreLLM,this.ignoreChain=(r=e.ignoreChain)!=null?r:this.ignoreChain,this.ignoreAgent=(a=e.ignoreAgent)!=null?a:this.ignoreAgent,this.ignoreRetriever=(s=e.ignoreRetriever)!=null?s:this.ignoreRetriever,this.ignoreCustomEvent=(i=e.ignoreCustomEvent)!=null?i:this.ignoreCustomEvent,this.raiseError=(o=e.raiseError)!=null?o:this.raiseError,this.awaitHandlers=this.raiseError||((u=e._awaitHandler)!=null?u:this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Dt.prototype.toJSON.call(this)}toJSONNotImplemented(){return Dt.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:pe()}),Object.assign(this,e)}}return new t}},Km=n=>{let e=n;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"};function Fl(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function dO(n){return n.replace(/[-:.]/g,"")}function hO(n,e,t){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return dO(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}function hs(n){return typeof n._addRunToRunMap=="function"}var St=class extends ea{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){let t=hO(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){let a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){var r;let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,a,s,i,o,u){let c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d!=null?d:{},tags:i||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,t,r,a,s,i,o,u){var l,d,h;let c=(l=this.runMap.get(r))!=null?l:this._createRunForLLMStart(e,t,r,a,s,i,o,u);return await((d=this.onRunCreate)==null?void 0:d.call(this,c)),await((h=this.onLLMStart)==null?void 0:h.call(this,c)),c}_createRunForChatModelStart(e,t,r,a,s,i,o,u){let c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d!=null?d:{},tags:i||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,t,r,a,s,i,o,u){var l,d,h;let c=(l=this.runMap.get(r))!=null?l:this._createRunForChatModelStart(e,t,r,a,s,i,o,u);return await((d=this.onRunCreate)==null?void 0:d.call(this,c)),await((h=this.onLLMStart)==null?void 0:h.call(this,c)),c}async handleLLMEnd(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onLLMEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleLLMError(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onLLMError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}_createRunForChainStart(e,t,r,a,s,i,o,u){let c=this._getExecutionOrder(a),l=Date.now(),d={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o!=null?o:"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,r,a,s,i,o,u){var l,d,h;let c=(l=this.runMap.get(r))!=null?l:this._createRunForChainStart(e,t,r,a,s,i,o,u);return await((d=this.onRunCreate)==null?void 0:d.call(this,c)),await((h=this.onChainStart)==null?void 0:h.call(this,c)),c}async handleChainEnd(e,t,r,a,s){var o;let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Fl(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=Fl(s.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){var o;let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=Fl(s.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForToolStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o!=null?o:e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,r,a,s,i,o){var c,l,d;let u=(c=this.runMap.get(r))!=null?c:this._createRunForToolStart(e,t,r,a,s,i,o);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onToolStart)==null?void 0:d.call(this,u)),u}async handleToolEnd(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onToolEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onToolError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var s;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentAction)==null?void 0:s.call(this,r))}async handleAgentEnd(e,t){var a;let r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentEnd)==null?void 0:a.call(this,r)))}_createRunForRetrieverStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o!=null?o:e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,r,a,s,i,o){var c,l,d;let u=(c=this.runMap.get(r))!=null?c:this._createRunForRetrieverStart(e,t,r,a,s,i,o);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onRetrieverStart)==null?void 0:d.call(this,u)),u}async handleRetrieverEnd(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var a;let r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((a=this.onText)==null?void 0:a.call(this,r)))}async handleLLMNewToken(e,t,r,a,s,i){var u;let o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}};var Ul=wt(Ym(),1);function We(n,e){return`${n.open}${e}${n.close}`}function Ct(n,e){try{return JSON.stringify(n,null,2)}catch(t){return e}}function Xm(n){return typeof n=="string"?n.trim():n==null?n:Ct(n,n.toString())}function tn(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:it}=Ul.default,mi=class extends St{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{let o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?We(Ul.default.bold,o):o}).join(" > ");return We(it.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${We(it.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Ct(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${We(it.cyan,"[chain/end]")} [${t}] [${tn(e)}] Exiting Chain run with output: ${Ct(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${We(it.red,"[chain/error]")} [${t}] [${tn(e)}] Chain run errored with error: ${Ct(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${We(it.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Ct(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${We(it.cyan,"[llm/end]")} [${t}] [${tn(e)}] Exiting LLM run with output: ${Ct(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${We(it.red,"[llm/error]")} [${t}] [${tn(e)}] LLM run errored with error: ${Ct(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${We(it.green,"[tool/start]")} [${t}] Entering Tool run with input: "${Xm(e.inputs.input)}"`)}onToolEnd(e){var r;let t=this.getBreadcrumbs(e);console.log(`${We(it.cyan,"[tool/end]")} [${t}] [${tn(e)}] Exiting Tool run with output: "${Xm((r=e.outputs)==null?void 0:r.output)}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${We(it.red,"[tool/error]")} [${t}] [${tn(e)}] Tool run errored with error: ${Ct(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${We(it.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Ct(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${We(it.cyan,"[retriever/end]")} [${t}] [${tn(e)}] Exiting Retriever run with output: ${Ct(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${We(it.red,"[retriever/error]")} [${t}] [${tn(e)}] Retriever run errored with error: ${Ct(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${We(it.blue,"[agent/action]")} [${r}] Agent selected action: ${Ct(t.actions[t.actions.length-1],"[action]")}`)}};var zl,Qm=()=>{if(zl===void 0){let n=ae("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};zl=new Yn(n)}return zl};var fs=class n extends St{constructor(e={}){var i;super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:a}=e;this.projectName=(i=r!=null?r:ae("LANGCHAIN_PROJECT"))!=null?i:ae("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a!=null?a:Qm();let s=n.getTraceableRunTree();s&&this.updateFromRunTree(s)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Gm()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){var s,i,o;let t=e,r=new Set;for(;t.parent_run&&!(r.has(t.id)||(r.add(t.id),!t.parent_run));)t=t.parent_run;r.clear();let a=[t];for(;a.length>0;){let u=a.shift();!u||r.has(u.id)||(r.add(u.id),this.runMap.set(u.id,u),u.child_runs&&a.push(...u.child_runs))}this.client=(s=e.client)!=null?s:this.client,this.projectName=(i=e.project_name)!=null?i:this.projectName,this.exampleId=(o=e.reference_example_id)!=null?o:this.exampleId}convertToRunTree(e){let t={},r=[];for(let[a,s]of this.runMap){let i=new Sr({...s,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[a]=i,r.push([a,s.dotted_order])}r.sort((a,s)=>!a[1]||!s[1]?0:a[1].localeCompare(s[1]));for(let[a]of r){let s=this.runMap.get(a),i=t[a];if(!(!s||!i)&&s.parent_run_id){let o=t[s.parent_run_id];o&&(o.child_runs.push(i),i.parent_run=o)}}return t[e]}static getTraceableRunTree(){try{return Bm()}catch(e){return}}};var su=wt(Ro(),1);var eg=Symbol.for("ls:tracing_async_local_storage"),ta=Symbol.for("lc:context_variables"),tg=n=>{globalThis[eg]=n},rn=()=>globalThis[eg];var gi;function pO(){let n="default"in su.default?su.default.default:su.default;return new n({autoStart:!0,concurrency:1})}function mO(){return typeof gi=="undefined"&&(gi=pO()),gi}async function be(n,e){if(e===!0){let t=rn();t!==void 0?await t.run(void 0,async()=>n()):await n()}else gi=mO(),gi.add(async()=>{let t=rn();t!==void 0?await t.run(void 0,async()=>n()):await n()})}var rg=n=>n!==void 0?n:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>ae(t)==="true");function Bl(n){var r;let e=rn();if(e===void 0)return;let t=e.getStore();return(r=t==null?void 0:t[ta])==null?void 0:r[n]}var gO=Symbol("lc:configure_hooks"),ng=()=>Bl(gO)||[];function ag(n){return n?Array.isArray(n)||"name"in n?{callbacks:n}:n:{}}var ql=class{setHandler(e){return this.setHandlers([e])}},ps=class{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>be(async()=>{var o;try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,t,this.runId,this.tags,this.metadata))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}},Hl=class extends ps{getChild(e){let t=new $e(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw a}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`),t.raiseError)throw e}},t.awaitHandlers)))}},iu=class extends ps{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>be(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,t!=null?t:{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${c}`),o.raiseError)throw c}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}},Vl=class extends ps{getChild(e){let t=new $e(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>be(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>be(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}},Gl=class extends ps{getChild(e){let t=new $e(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}},$e=class n extends ql{constructor(e,t){var r,a,s,i,o,u;super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(r=t==null?void 0:t.handlers)!=null?r:this.handlers,this.inheritableHandlers=(a=t==null?void 0:t.inheritableHandlers)!=null?a:this.inheritableHandlers,this.tags=(s=t==null?void 0:t.tags)!=null?s:this.tags,this.inheritableTags=(i=t==null?void 0:t.inheritableTags)!=null?i:this.inheritableTags,this.metadata=(o=t==null?void 0:t.metadata)!=null?o:this.metadata,this.inheritableMetadata=(u=t==null?void 0:t.inheritableMetadata)!=null?u:this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{let d=l===0&&r?r:pe();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return hs(h)&&h._createRunForLLMStart(e,[c],d,this._parentRunId,s,this.tags,this.metadata,u),be(async()=>{var f;try{await((f=h.handleLLMStart)==null?void 0:f.call(h,e,[c],d,this._parentRunId,s,this.tags,this.metadata,u))}catch(p){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`),h.raiseError)throw p}},h.awaitHandlers)})),new iu(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{let d=l===0&&r?r:pe();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return hs(h)&&h._createRunForChatModelStart(e,[c],d,this._parentRunId,s,this.tags,this.metadata,u),be(async()=>{var f,p;try{if(h.handleChatModelStart)await((f=h.handleChatModelStart)==null?void 0:f.call(h,e,[c],d,this._parentRunId,s,this.tags,this.metadata,u));else if(h.handleLLMStart){let m=Xs(c);await((p=h.handleLLMStart)==null?void 0:p.call(h,e,[m],d,this._parentRunId,s,this.tags,this.metadata,u))}}catch(m){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${m}`),h.raiseError)throw m}},h.awaitHandlers)})),new iu(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=pe(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return hs(u)&&u._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,o),be(async()=>{var c;try{await((c=u.handleChainStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,a,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Vl(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=pe(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return hs(u)&&u._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),be(async()=>{var c;try{await((c=u.handleToolStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Gl(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=pe(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return hs(u)&&u._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),be(async()=>{var c;try{await((c=u.handleRetrieverStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Hl(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>be(async()=>{var o;if(!i.ignoreCustomEvent)try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,t,r,this.tags,this.metadata))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let a of this.handlers){let s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(let a of this.tags){let s=this.inheritableTags.includes(a);r.addTags([a],s)}for(let a of Object.keys(this.metadata)){let s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(let a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends ea{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:pe()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static configure(e,t,r,a,s,i,o){return this._configureSync(e,t,r,a,s,i,o)}static _configureSync(e,t,r,a,s,i,o){var h,f,p,m,g;let u;(e||t)&&(Array.isArray(e)||!e?(u=new n,u.setHandlers((h=e==null?void 0:e.map(yi))!=null?h:[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(yi):t==null?void 0:t.handlers,!1));let c=ae("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=((f=fs.getTraceableRunTree())==null?void 0:f.tracingEnabled)||rg(),d=l||((p=ae("LANGCHAIN_TRACING"))!=null?p:!1);if(c||d){if(u||(u=new n),c&&!u.handlers.some(y=>y.name===mi.prototype.name)){let y=new mi;u.addHandler(y,!0)}if(d&&!u.handlers.some(y=>y.name==="langchain_tracer")&&l){let y=new fs;u.addHandler(y,!0),u._parentRunId=(g=(m=fs.getTraceableRunTree())==null?void 0:m.id)!=null?g:u._parentRunId}}for(let{contextVar:y,inheritable:b=!0,handlerClass:A,envVar:x}of ng()){let _=x&&ae(x)==="true"&&A,v,E=y!==void 0?Bl(y):void 0;E&&Km(E)?v=E:_&&(v=new A({})),v!==void 0&&(u||(u=new n),u.handlers.some(O=>O.name===v.name)||u.addHandler(v,b))}return(r||a)&&u&&(u.addTags(r!=null?r:[]),u.addTags(a!=null?a:[],!1)),(s||i)&&u&&(u.addMetadata(s!=null?s:{}),u.addMetadata(i!=null?i:{},!1)),u}};function yi(n){return"name"in n?n:ea.fromMethods(n)}var ou=class{getStore(){}run(e,t){return t()}enterWith(e){}},yO=new ou,sg=Symbol.for("lc:child_config"),Kl=class{getInstance(){var e;return(e=rn())!=null?e:yO}getRunnableConfig(){var t,r;return(r=(t=this.getInstance().getStore())==null?void 0:t.extra)==null?void 0:r[sg]}runWithConfig(e,t,r){var l;let a=$e._configureSync(e==null?void 0:e.callbacks,void 0,e==null?void 0:e.tags,void 0,e==null?void 0:e.metadata),s=this.getInstance(),i=s.getStore(),o=a==null?void 0:a.getParentRunId(),u=(l=a==null?void 0:a.handlers)==null?void 0:l.find(d=>(d==null?void 0:d.name)==="langchain_tracer"),c;return u&&o?c=u.convertToRunTree(o):r||(c=new Sr({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[sg]:e}),i!==void 0&&i[ta]!==void 0&&(c[ta]=i[ta]),s.run(c,t)}initializeGlobalInstance(e){rn()===void 0&&tg(e)}},ot=new Kl;var uu=25;async function ut(n){return $e._configureSync(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function cu(...n){var t,r,a;let e={};for(let s of n.filter(i=>!!i))for(let i of Object.keys(s))if(i==="metadata")e[i]={...e[i],...s[i]};else if(i==="tags"){let o=(t=e[i])!=null?t:[];e[i]=[...new Set(o.concat((r=s[i])!=null?r:[]))]}else if(i==="configurable")e[i]={...e[i],...s[i]};else if(i==="timeout")e.timeout===void 0?e.timeout=s.timeout:s.timeout!==void 0&&(e.timeout=Math.min(e.timeout,s.timeout));else if(i==="signal")e.signal===void 0?e.signal=s.signal:s.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,s.signal]):e.signal=s.signal);else if(i==="callbacks"){let o=e.callbacks,u=s.callbacks;if(Array.isArray(u))if(!o)e.callbacks=u;else if(Array.isArray(o))e.callbacks=o.concat(u);else{let c=o.copy();for(let l of u)c.addHandler(yi(l),!0);e.callbacks=c}else if(u)if(!o)e.callbacks=u;else if(Array.isArray(o)){let c=u.copy();for(let l of o)c.addHandler(yi(l),!0);e.callbacks=c}else e.callbacks=new $e(u._parentRunId,{handlers:o.handlers.concat(u.handlers),inheritableHandlers:o.inheritableHandlers.concat(u.inheritableHandlers),tags:Array.from(new Set(o.tags.concat(u.tags))),inheritableTags:Array.from(new Set(o.inheritableTags.concat(u.inheritableTags))),metadata:{...o.metadata,...u.metadata}})}else{let o=i;e[o]=(a=s[o])!=null?a:e[o]}return e}var bO=new Set(["string","number","boolean"]);function ee(n){var r;let e=ot.getRunnableConfig(),t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){let{runId:a,runName:s,...i}=e;t=Object.entries(i).reduce((o,[u,c])=>(c!==void 0&&(o[u]=c),o),t)}if(n&&(t=Object.entries(n).reduce((a,[s,i])=>(i!==void 0&&(a[s]=i),a),t)),t!=null&&t.configurable)for(let a of Object.keys(t.configurable))bO.has(typeof t.configurable[a])&&!((r=t.metadata)!=null&&r[a])&&(t.metadata||(t.metadata={}),t.metadata[a]=t.configurable[a]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");let a=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,a])):t.signal=a,delete t.timeout}return t}function we(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s,runId:i}={}){let o=ee(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),s!==void 0&&(o.configurable={...o.configurable,...s}),i!==void 0&&delete o.runId,o}function Ft(n){return n?{configurable:n.configurable,recursionLimit:n.recursionLimit,callbacks:n.callbacks,tags:n.tags,metadata:n.metadata,maxConcurrency:n.maxConcurrency,timeout:n.timeout,signal:n.signal}:void 0}async function cr(n,e){if(e===void 0)return n;let t;return Promise.race([n.catch(r=>{if(!(e!=null&&e.aborted))throw r}),new Promise((r,a)=>{t=()=>{a(new Error("Aborted"))},e.addEventListener("abort",t),e.aborted&&a(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",t))}var qe=class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){let t=e.getReader();return new n({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};function Zl(n,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){let s=await n.next();for(let i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function Se(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){let t={...n};for(let[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Se(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}var kr=class{constructor(e){var t,r;Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=(r=e.signal)!=null?r:(t=this.config)==null?void 0:t.signal,this.setup=new Promise((a,s)=>{ot.runWithConfig(Ft(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(a,s):this.firstResult.then(i=>a(void 0),s)},!0)})}async next(...e){var t;return(t=this.signal)==null||t.throwIfAborted(),this.firstResultUsed?ot.runWithConfig(Ft(this.config),this.signal?async()=>cr(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function ig(n,e,t,r,...a){let s=new kr({generator:e,startSetup:t,signal:r}),i=await s.setup;return{output:n(s,i,...a),setup:i}}var Ut=class{constructor(e){var t;Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=(t=e.ops)!=null?t:[]}concat(e){let t=this.ops.concat(e.ops),r=en({},t);return new bi({ops:t,state:r[r.length-1].newDocument})}},bi=class n extends Ut{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=en(this.state,e.ops);return new n({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=en({},e.ops);return new n({ops:e.ops,state:t[t.length-1].newDocument})}},cg=n=>n.name==="log_stream_tracer";async function og(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function ug(n,e){let{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function _O(n){return n!==void 0&&n.message!==void 0}var _i=class extends St{constructor(e){var t,r;super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(t=e==null?void 0:e.autoClose)!=null?t:!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(r=e==null?void 0:e._schemaFormat)!=null?r:this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=qe.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){var a;if(e.id===this.rootId)return!1;let t=(a=e.tags)!=null?a:[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let a=this.keyMapByRunId[e];a&&await this.writer.write(new Ut({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var a,s,i;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Ut({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:(a=e.tags)!=null?a:[],metadata:(i=(s=e.extra)==null?void 0:s.metadata)!=null?i:{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await og(e,this._schemaFormat)),await this.writer.write(new Ut({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await og(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await ug(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new Ut({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new Ut({ops:[{op:"replace",path:"/final_output",value:await ug(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a=this.keyMapByRunId[e.id];if(a===void 0)return;let s=e.inputs.messages!==void 0,i;s?_O(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new Te({id:`run-${e.id}`,content:t}):i=t;let o=new Ut({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}};var lu="__run",kt=class n{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},ct=class n extends kt{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}};function du({name:n,serialized:e}){return n!==void 0?n:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}var lg=n=>n.name==="event_stream_tracer",hu=class extends St{constructor(e){var t;super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(t=e==null?void 0:e.autoClose)!=null?t:!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=qe.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){var a;let t=(a=e.tags)!=null?a:[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}function s(o,u){return o==="llm"&&typeof u=="string"?new kt({text:u}):u}let i=this.tappedPromises.get(e);if(i===void 0){let o;i=new Promise(u=>{o=u}),this.tappedPromises.set(e,i);try{let u={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...u,data:{chunk:s(a.runType,r.value)}},a),yield r.value;for await(let c of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...u,data:{chunk:s(a.runType,c)}},a),yield c}finally{o()}}else{yield r.value;for await(let o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){var i,o,u,c,l,d;let t=du(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:(i=e.tags)!=null?i:[],metadata:(u=(o=e.extra)==null?void 0:o.metadata)!=null?u:{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);let s=`on_${r}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:(c=e.tags)!=null?c:[],run_id:e.id,metadata:(d=(l=e.extra)==null?void 0:l.metadata)!=null?d:{}},a)}async onLLMNewToken(e,t,r){let a=this.runInfoMap.get(e.id),s,i;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(a.runType==="chat_model")i="on_chat_model_stream",(r==null?void 0:r.chunk)===void 0?s=new Te({content:t,id:`run-${e.id}`}):s=r.chunk.message;else if(a.runType==="llm")i="on_llm_stream",(r==null?void 0:r.chunk)===void 0?s=new kt({text:t}):s=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:i,data:{chunk:s},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}}async onLLMEnd(e){var i,o,u,c;let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let a=(i=e.outputs)==null?void 0:i.generations,s;if(t.runType==="chat_model"){for(let l of a!=null?a:[]){if(s!==void 0)break;s=(o=l[0])==null?void 0:o.message}r="on_chat_model_end"}else if(t.runType==="llm")s={generations:a==null?void 0:a.map(l=>l.map(d=>({text:d.text,generationInfo:d.generationInfo}))),llmOutput:(c=(u=e.outputs)==null?void 0:u.llmOutput)!=null?c:{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){var i,o,u,c,l,d,h;let t=du(e),r=(i=e.run_type)!=null?i:"chain",a={tags:(o=e.tags)!=null?o:[],metadata:(c=(u=e.extra)==null?void 0:u.metadata)!=null?c:{},name:t,runType:e.run_type},s={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(s={},a.inputs={}):e.inputs.input!==void 0?(s.input=e.inputs.input,a.inputs=e.inputs.input):(s.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:s,name:t,tags:(l=e.tags)!=null?l:[],run_id:e.id,metadata:(h=(d=e.extra)==null?void 0:d.metadata)!=null?h:{}},a)}async onChainEnd(e){var o,u,c,l,d;let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,a=(u=(o=e.inputs)!=null?o:t.inputs)!=null?u:{},i={output:(l=(c=e.outputs)==null?void 0:c.output)!=null?l:e.outputs,input:a};a.input&&Object.keys(a).length===1&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:(d=t.metadata)!=null?d:{}},t)}async onToolStart(e){var a,s,i,o,u,c,l,d;let t=du(e),r={tags:(a=e.tags)!=null?a:[],metadata:(i=(s=e.extra)==null?void 0:s.metadata)!=null?i:{},name:t,runType:"tool",inputs:(o=e.inputs)!=null?o:{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:(u=e.inputs)!=null?u:{}},name:t,run_id:e.id,tags:(c=e.tags)!=null?c:[],metadata:(d=(l=e.extra)==null?void 0:l.metadata)!=null?d:{}},r)}async onToolEnd(e){var a;let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=((a=e.outputs)==null?void 0:a.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){var s,i,o,u,c,l;let t=du(e),a={tags:(s=e.tags)!=null?s:[],metadata:(o=(i=e.extra)==null?void 0:i.metadata)!=null?o:{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:(u=e.tags)!=null?u:[],run_id:e.id,metadata:(l=(c=e.extra)==null?void 0:c.metadata)!=null?l:{}},a)}async onRetrieverEnd(e){var r,a;let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:(a=(r=e.outputs)==null?void 0:r.documents)!=null?a:e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){let a=this.runInfoMap.get(r);if(a===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};var dg=wt(Oo(),1),fu=wt(Ro(),1),wO=[400,401,402,403,404,405,406,407,409],vO=n=>{var t,r,a;if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;let e=(r=(t=n==null?void 0:n.response)==null?void 0:t.status)!=null?r:n==null?void 0:n.status;if(e&&wO.includes(+e))throw n;if(((a=n==null?void 0:n.error)==null?void 0:a.code)==="insufficient_quota"){let s=new Error(n==null?void 0:n.message);throw s.name="InsufficientQuotaError",s}},Rr=class{constructor(e){var r,a,s;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(r=e.maxConcurrency)!=null?r:1/0,this.maxRetries=(a=e.maxRetries)!=null?a:6,this.onFailedAttempt=(s=e.onFailedAttempt)!=null?s:vO;let t="default"in fu.default?fu.default.default:fu.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,dg.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var wi=class extends St{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function vi(n){return n?n.lc_runnable:!1}var pu=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){var s;let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,a=(s=e.tags)!=null?s:[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(i=>{var o;return(o=this.includeTags)==null?void 0:o.includes(i)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(i=>{var o;return!((o=this.excludeTags)!=null&&o.includes(i))})),r}};var fg=Symbol("Let zodToJsonSchema decide on which parser to use"),hg={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},pg=n=>typeof n=="string"?{...hg,name:n}:{...hg,...n};var mg=n=>{let e=pg(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function Jl(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function te(n,e,t,r,a){n[e]=t,Jl(n,e,r,a)}function gg(){return{}}function yg(n,e){var r,a,s;let t={type:"array"};return(r=n.type)!=null&&r._def&&((s=(a=n.type)==null?void 0:a._def)==null?void 0:s.typeName)!==w.ZodAny&&(t.items=U(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&te(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&te(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(te(t,"minItems",n.exactLength.value,n.exactLength.message,e),te(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function bg(n,e){let t={type:"integer",format:"int64"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?te(t,"minimum",r.value,r.message,e):te(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),te(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?te(t,"maximum",r.value,r.message,e):te(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),te(t,"maximum",r.value,r.message,e));break;case"multipleOf":te(t,"multipleOf",r.value,r.message,e);break}return t}function _g(){return{type:"boolean"}}function mu(n,e){return U(n.type._def,e)}var wg=(n,e)=>U(n.innerType._def,e);function Wl(n,e,t){let r=t!=null?t:e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>Wl(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return AO(n,e)}}var AO=(n,e)=>{let t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(let r of n.checks)switch(r.kind){case"min":te(t,"minimum",r.value,r.message,e);break;case"max":te(t,"maximum",r.value,r.message,e);break}return t};function vg(n,e){return{...U(n.innerType._def,e),default:n.defaultValue()}}function Ag(n,e){return e.effectStrategy==="input"?U(n.schema._def,e):{}}function Eg(n){return{type:"string",enum:Array.from(n.values)}}var EO=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function Og(n,e){let t=[U(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),U(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s),r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,a=[];return t.forEach(s=>{if(EO(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){let{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function xg(n,e){let t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}var Yl,zt={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Yl===void 0&&(Yl=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Yl),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function gu(n,e){let t={type:"string"};if(n.checks)for(let r of n.checks)switch(r.kind){case"min":te(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":te(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Bt(t,"email",r.message,e);break;case"format:idn-email":Bt(t,"idn-email",r.message,e);break;case"pattern:zod":Ye(t,zt.email,r.message,e);break}break;case"url":Bt(t,"uri",r.message,e);break;case"uuid":Bt(t,"uuid",r.message,e);break;case"regex":Ye(t,r.regex,r.message,e);break;case"cuid":Ye(t,zt.cuid,r.message,e);break;case"cuid2":Ye(t,zt.cuid2,r.message,e);break;case"startsWith":Ye(t,RegExp(`^${Xl(r.value,e)}`),r.message,e);break;case"endsWith":Ye(t,RegExp(`${Xl(r.value,e)}$`),r.message,e);break;case"datetime":Bt(t,"date-time",r.message,e);break;case"date":Bt(t,"date",r.message,e);break;case"time":Bt(t,"time",r.message,e);break;case"duration":Bt(t,"duration",r.message,e);break;case"length":te(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),te(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"includes":{Ye(t,RegExp(Xl(r.value,e)),r.message,e);break}case"ip":{r.version!=="v6"&&Bt(t,"ipv4",r.message,e),r.version!=="v4"&&Bt(t,"ipv6",r.message,e);break}case"base64url":Ye(t,zt.base64url,r.message,e);break;case"jwt":Ye(t,zt.jwt,r.message,e);break;case"cidr":{r.version!=="v6"&&Ye(t,zt.ipv4Cidr,r.message,e),r.version!=="v4"&&Ye(t,zt.ipv6Cidr,r.message,e);break}case"emoji":Ye(t,zt.emoji(),r.message,e);break;case"ulid":{Ye(t,zt.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Bt(t,"binary",r.message,e);break}case"contentEncoding:base64":{te(t,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{Ye(t,zt.base64,r.message,e);break}}break}case"nanoid":Ye(t,zt.nanoid,r.message,e);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}function Xl(n,e){return e.patternStrategy==="escape"?xO(n):n}var OO=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function xO(n){let e="";for(let t=0;t<n.length;t++)OO.has(n[t])||(e+="\\"),e+=n[t];return e}function Bt(n,e,t,r){var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):te(n,"format",e,t,r)}function Ye(n,e,t,r){var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Ig(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):te(n,"pattern",Ig(e,r),t,r)}function Ig(n,e){var u;if(!e.applyRegexFlags||!n.flags)return n.source;let t={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=t.i?n.source.toLowerCase():n.source,a="",s=!1,i=!1,o=!1;for(let c=0;c<r.length;c++){if(s){a+=r[c],s=!1;continue}if(t.i){if(i){if(r[c].match(/[a-z]/)){o?(a+=r[c],a+=`${r[c-2]}-${r[c]}`.toUpperCase(),o=!1):r[c+1]==="-"&&((u=r[c+2])!=null&&u.match(/[a-z]/))?(a+=r[c],o=!0):a+=`${r[c]}${r[c].toUpperCase()}`;continue}}else if(r[c].match(/[a-z]/)){a+=`[${r[c]}${r[c].toUpperCase()}]`;continue}}if(t.m){if(r[c]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(r[c]==="$"){a+=`($|(?=[\r
]))`;continue}}if(t.s&&r[c]==="."){a+=i?`${r[c]}\r
`:`[${r[c]}\r
]`;continue}a+=r[c],r[c]==="\\"?s=!0:i&&r[c]==="]"?i=!1:!i&&r[c]==="["&&(i=!0)}try{new RegExp(a)}catch(c){return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a}function yu(n,e){var r,a,s,i,o,u,c;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===w.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((l,d)=>{var h;return{...l,[d]:(h=U(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",d]}))!=null?h:{}}},{}),additionalProperties:!1};let t={type:"object",additionalProperties:(a=U(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?a:{}};if(e.target==="openApi3")return t;if(((s=n.keyType)==null?void 0:s._def.typeName)===w.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){let{type:l,...d}=gu(n.keyType._def,e);return{...t,propertyNames:d}}else{if(((o=n.keyType)==null?void 0:o._def.typeName)===w.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};if(((u=n.keyType)==null?void 0:u._def.typeName)===w.ZodBranded&&n.keyType._def.type._def.typeName===w.ZodString&&((c=n.keyType._def.type._def.checks)!=null&&c.length)){let{type:l,...d}=mu(n.keyType._def,e);return{...t,propertyNames:d}}}return t}function Pg(n,e){if(e.mapStrategy==="record")return yu(n,e);let t=U(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=U(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function Tg(n){let e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function Sg(){return{not:{}}}function Cg(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var Ai={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Rg(n,e){if(e.target==="openApi3")return kg(n,e);let t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in Ai&&(!r._def.checks||!r._def.checks.length))){let r=t.reduce((a,s)=>{let i=Ai[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=t.reduce((a,s)=>{let i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){let a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return kg(n,e)}var kg=(n,e)=>{let t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>U(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function Ng(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:Ai[n.innerType._def.typeName],nullable:!0}:{type:[Ai[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let r=U(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let t=U(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function $g(n,e){let t={type:"number"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"int":t.type="integer",Jl(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?te(t,"minimum",r.value,r.message,e):te(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),te(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?te(t,"maximum",r.value,r.message,e):te(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),te(t,"maximum",r.value,r.message,e));break;case"multipleOf":te(t,"multipleOf",r.value,r.message,e);break}return t}function IO(n,e){var t,r;return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":(t=U(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?t:!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":(r=U(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?r:!0}function jg(n,e){let t=e.target==="openAi",r={type:"object",...Object.entries(n.shape()).reduce((a,[s,i])=>{if(i===void 0||i._def===void 0)return a;let o=i.isOptional();o&&t&&(i instanceof rt&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);let u=U(i._def,{...e,currentPath:[...e.currentPath,"properties",s],propertyPath:[...e.currentPath,"properties",s]});return u===void 0?a:{properties:{...a.properties,[s]:u},required:o?a.required:[...a.required,s]}},{properties:{},required:[]}),additionalProperties:IO(n,e)};return r.required.length||delete r.required,r}var Lg=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return U(n.innerType._def,e);let t=U(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}};var Dg=(n,e)=>{if(e.pipeStrategy==="input")return U(n.in._def,e);if(e.pipeStrategy==="output")return U(n.out._def,e);let t=U(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=U(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function Mg(n,e){return U(n.type._def,e)}function Fg(n,e){let r={type:"array",uniqueItems:!0,items:U(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&te(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&te(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function Ug(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>U(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:U(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>U(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function zg(){return{not:{}}}function Bg(){return{}}var qg=(n,e)=>U(n.innerType._def,e);function U(n,e,t=!1){var i;let r=e.seen.get(n);if(e.override){let o=(i=e.override)==null?void 0:i.call(e,n,e,r,t);if(o!==fg)return o}if(r&&!t){let o=PO(r,e);if(o!==void 0)return o}let a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);let s=SO(n,n.typeName,e);return s&&CO(n,e,s),a.jsonSchema=s,s}var PO=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:TO(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},TO=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},SO=(n,e,t)=>{switch(e){case w.ZodString:return gu(n,t);case w.ZodNumber:return $g(n,t);case w.ZodObject:return jg(n,t);case w.ZodBigInt:return bg(n,t);case w.ZodBoolean:return _g();case w.ZodDate:return Wl(n,t);case w.ZodUndefined:return zg();case w.ZodNull:return Cg(t);case w.ZodArray:return yg(n,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return Rg(n,t);case w.ZodIntersection:return Og(n,t);case w.ZodTuple:return Ug(n,t);case w.ZodRecord:return yu(n,t);case w.ZodLiteral:return xg(n,t);case w.ZodEnum:return Eg(n);case w.ZodNativeEnum:return Tg(n);case w.ZodNullable:return Ng(n,t);case w.ZodOptional:return Lg(n,t);case w.ZodMap:return Pg(n,t);case w.ZodSet:return Fg(n,t);case w.ZodLazy:return U(n.getter()._def,t);case w.ZodPromise:return Mg(n,t);case w.ZodNaN:case w.ZodNever:return Sg();case w.ZodEffects:return Ag(n,t);case w.ZodAny:return gg();case w.ZodUnknown:return Bg();case w.ZodDefault:return vg(n,t);case w.ZodBranded:return mu(n,t);case w.ZodReadonly:return qg(n,t);case w.ZodCatch:return wg(n,t);case w.ZodPipeline:return Dg(n,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(r=>{})(e)}},CO=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t);var lt=(n,e)=>{var u;let t=mg(e),r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((c,[l,d])=>{var h;return{...c,[l]:(h=U(d._def,{...t,currentPath:[...t.basePath,t.definitionPath,l]},!0))!=null?h:{}}},{}):void 0,a=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,s=(u=U(n._def,a===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,a]},!1))!=null?u:{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(s.title=i);let o=a===void 0?r?{...s,[t.definitionPath]:r}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:s}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in o||"oneOf"in o||"allOf"in o||"type"in o&&Array.isArray(o.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),o};function Ql(n){return n.replace(/[^a-zA-Z-_0-9]/g,"_")}var kO=["*","_","`"];function RO(n){let e="";for(let[t,r]of Object.entries(n))e+=`	classDef ${t} ${r};
`;return e}function Hg(n,e,t){var f,p,m,g,y;let{firstNode:r,lastNode:a,nodeColors:s,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t!=null?t:{},c=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){let b="default",A={[b]:"{0}({1})"};r!==void 0&&(A[r]="{0}([{1}]):::first"),a!==void 0&&(A[a]="{0}([{1}]):::last");for(let[x,_]of Object.entries(n)){let v=(f=_.name.split(":").pop())!=null?f:"",O=kO.some(L=>v.startsWith(L)&&v.endsWith(L))?`<p>${v}</p>`:v;Object.keys((p=_.metadata)!=null?p:{}).length&&(O+=`<hr/><small><em>${Object.entries((m=_.metadata)!=null?m:{}).map(([L,q])=>`${L} = ${q}`).join(`
`)}</em></small>`);let S=((g=A[x])!=null?g:A[b]).replace("{0}",Ql(x)).replace("{1}",O);c+=`	${S}
`}}let l={};for(let b of e){let A=b.source.split(":"),x=b.target.split(":"),_=A.filter((v,E)=>v===x[E]).join(":");l[_]||(l[_]=[]),l[_].push(b)}let d=new Set;function h(b,A){let x=b.length===1&&b[0].source===b[0].target;if(A&&!x){let _=A.split(":").pop();if(d.has(_))throw new Error(`Found duplicate subgraph '${_}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(_),c+=`	subgraph ${_}
`}for(let _ of b){let{source:v,target:E,data:O,conditional:S}=_,L="";if(O!==void 0){let q=O,H=q.split(" ");H.length>u&&(q=Array.from({length:Math.ceil(H.length/u)},(de,Ie)=>H.slice(Ie*u,(Ie+1)*u).join(" ")).join("&nbsp;<br>&nbsp;")),L=S?` -. &nbsp;${q}&nbsp; .-> `:` -- &nbsp;${q}&nbsp; --> `}else L=S?" -.-> ":" --> ";c+=`	${Ql(v)}${L}${Ql(E)};
`}for(let _ in l)_.startsWith(`${A}:`)&&_!==A&&h(l[_],_);A&&!x&&(c+=`	end
`)}h((y=l[""])!=null?y:[],"");for(let b in l)!b.includes(":")&&b!==""&&h(l[b],b);return i&&(c+=RO(s!=null?s:{})),c}async function Vg(n,e){let{backgroundColor:t="white"}=e!=null?e:{},r=btoa(n);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));let a=`https://mermaid.ink/img/${r}?bgColor=${t}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}function NO(n,e){var t;if(n!==void 0&&!Qr(n))return n;if(vi(e))try{let r=e.getName();return r=r.startsWith("Runnable")?r.slice(8):r,r}catch(r){return e.getName()}else return(t=e.name)!=null?t:"UnknownSchema"}function $O(n){return vi(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...lt(n.data.schema),title:n.data.name}}}var Ei=class n{constructor(e){var t,r;Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=(t=e==null?void 0:e.nodes)!=null?t:this.nodes,this.edges=(r=e==null?void 0:e.edges)!=null?r:this.edges}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Qr(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...$O(t)})),edges:this.edges.map(t=>{let r={source:e[t.source],target:e[t.target]};return typeof t.data!="undefined"&&(r.data=t.data),typeof t.conditional!="undefined"&&(r.conditional=t.conditional),r})}}addNode(e,t,r){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let a=t!=null?t:pe(),s={id:a,data:e,name:NO(t,e),metadata:r};return this.nodes[a]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let s={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(s),s}firstNode(){return Gg(this)}lastNode(){return Kg(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map(c=>c.id).every(Qr)&&(r="");let s=c=>r?`${r}:${c}`:c;Object.entries(e.nodes).forEach(([c,l])=>{this.nodes[s(c)]={...l,id:s(c)}});let i=e.edges.map(c=>({...c,source:s(c.source),target:s(c.target)}));this.edges=[...this.edges,...i];let o=e.firstNode(),u=e.lastNode();return[o?{id:s(o.id),data:o.data}:void 0,u?{id:s(u.id),data:u.data}:void 0]}trimFirstNode(){let e=this.firstNode();e&&Gg(this,[e.id])&&this.removeNode(e)}trimLastNode(){let e=this.lastNode();e&&Kg(this,[e.id])&&this.removeNode(e)}reid(){let e=Object.fromEntries(Object.values(this.nodes).map(a=>[a.id,a.name])),t=new Map;Object.values(e).forEach(a=>{t.set(a,(t.get(a)||0)+1)});let r=a=>{let s=e[a];return Qr(a)&&t.get(s)===1?s:a};return new n({nodes:Object.fromEntries(Object.entries(this.nodes).map(([a,s])=>[r(a),{...s,id:r(a)}])),edges:this.edges.map(a=>({...a,source:r(a.source),target:r(a.target)}))})}drawMermaid(e){let{withStyles:t,curveStyle:r,nodeColors:a={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:s}=e!=null?e:{},i=this.reid(),o=i.firstNode(),u=i.lastNode();return Hg(i.nodes,i.edges,{firstNode:o==null?void 0:o.id,lastNode:u==null?void 0:u.id,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:s})}async drawMermaidPng(e){let t=this.drawMermaid(e);return Vg(t,{backgroundColor:e==null?void 0:e.backgroundColor})}};function Gg(n,e=[]){let t=new Set(n.edges.filter(a=>!e.includes(a.source)).map(a=>a.target)),r=[];for(let a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function Kg(n,e=[]){let t=new Set(n.edges.filter(a=>!e.includes(a.target)).map(a=>a.source)),r=[];for(let a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function Zg(n){let e=new TextEncoder,t=new ReadableStream({async start(r){for await(let a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return qe.fromReadableStream(t)}function ed(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}var Jg=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function bu(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*td(n,e){for(;;){let{value:t,done:r}=ot.runWithConfig(Ft(n),e.next.bind(e),!0);if(r)break;yield t}}async function*_u(n,e){let t=e[Symbol.asyncIterator]();for(;;){let{value:r,done:a}=await ot.runWithConfig(Ft(n),t.next.bind(e),!0);if(a)break;yield r}}function Oe(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}var ie=class extends Dt{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){var r,a;let t=(a=(r=this.name)!=null?r:this.constructor.lc_name())!=null?a:this.constructor.name;return e?`${t}${e}`:t}bind(e){return new $r({bound:this,kwargs:e,config:{}})}map(){return new wu({bound:this})}withRetry(e){return new vu({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new $r({bound:this,config:e,kwargs:{}})}withFallbacks(e){let t=Array.isArray(e)?e:e.fallbacks;return new Au({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(ee);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,s)=>ee(s===0?e:r))}return Array.from({length:t},()=>ee(e))}async batch(e,t,r){var u,c;let a=this._getOptionsList(t!=null?t:{},e.length),s=(c=(u=a[0])==null?void 0:u.maxConcurrency)!=null?c:r==null?void 0:r.maxConcurrency,i=new Rr({maxConcurrency:s,onFailedAttempt:l=>{throw l}}),o=e.map((l,d)=>i.call(async()=>{try{return await this.invoke(l,a[d])}catch(h){if(r!=null&&r.returnExceptions)return h;throw h}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=ee(t),a=new kr({generator:this._streamIterator(e,r),config:r});return await a.setup,qe.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=ee(e):t=ee({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){var u;let a=ee(r),s=await ut(a),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),Oe(t,"input"),a.runId,a==null?void 0:a.runType,void 0,void 0,(u=a==null?void 0:a.runName)!=null?u:this.getName()));delete a.runId;let o;try{let c=e.call(this,t,a,i);o=await cr(c,r==null?void 0:r.signal)}catch(c){throw await(i==null?void 0:i.handleChainError(c)),c}return await(i==null?void 0:i.handleChainEnd(Oe(o,"output"))),o}async _batchWithConfig(e,t,r,a){var c;let s=this._getOptionsList(r!=null?r:{},t.length),i=await Promise.all(s.map(ut)),o=await Promise.all(i.map(async(l,d)=>{var f;let h=await(l==null?void 0:l.handleChainStart(this.toJSON(),Oe(t[d],"input"),s[d].runId,s[d].runType,void 0,void 0,(f=s[d].runName)!=null?f:this.getName()));return delete s[d].runId,h})),u;try{let l=e.call(this,t,s,o,a);u=await cr(l,(c=s==null?void 0:s[0])==null?void 0:c.signal)}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(Oe(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0,u=ee(r),c=await ut(u);async function*l(){for await(let h of e){if(s)if(a===void 0)a=h;else try{a=Se(a,h)}catch(f){a=void 0,s=!1}yield h}}let d;try{let h=await ig(t.bind(this),l(),async()=>{var g;return c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,(g=u.runName)!=null?g:this.getName())},r==null?void 0:r.signal,u);delete u.runId,d=h.setup;let f=d==null?void 0:d.handlers.find(lg),p=h.output;f!==void 0&&d!==void 0&&(p=f.tapOutputIterable(d.runId,p));let m=d==null?void 0:d.handlers.find(cg);m!==void 0&&d!==void 0&&(p=m.tapOutputIterable(d.runId,p));for await(let g of p)if(yield g,o)if(i===void 0)i=g;else try{i=Se(i,g)}catch(y){i=void 0,o=!1}}catch(h){throw await(d==null?void 0:d.handleChainError(h,void 0,void 0,void 0,{inputs:Oe(a,"input")})),h}await(d==null?void 0:d.handleChainEnd(i!=null?i:{},void 0,void 0,void 0,{inputs:Oe(a,"input")}))}getGraph(e){let t=new Ei,r=t.addNode({name:`${this.getName()}Input`,schema:xt.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:xt.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new qt({first:this,last:Nr(e)})}pick(e){return this.pipe(new Eu(e))}assign(e){return this.pipe(new ms(new nn({steps:e})))}async*transform(e,t){let r;for await(let a of e)r===void 0?r=a:r=Se(r,a);yield*this._streamIterator(r,ee(t))}async*streamLog(e,t,r){let a=new _i({...r,autoClose:!1,_schemaFormat:"original"}),s=ee(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){let{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let u=a.copy();u.addHandler(t,!0),r.callbacks=u}let s=this.stream(e,r);async function i(){try{let u=await s;for await(let c of u){let l=new Ut({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(l)}}finally{await t.writer.close()}}let o=i();try{for await(let u of t)yield u}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?Zg(a):qe.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){var f,p;let a=new hu({...r,autoClose:!1}),s=ee(t),i=(f=s.runId)!=null?f:pe();s.runId=i;let o=s.callbacks;if(o===void 0)s.callbacks=[a];else if(Array.isArray(o))s.callbacks=o.concat(a);else{let m=o.copy();m.addHandler(a,!0),s.callbacks=m}let u=this;async function c(){try{let m=await u.stream(e,s),g=a.tapOutputIterable(i,m);for await(let y of g);}finally{await a.finish()}}let l=c(),d=!1,h;try{for await(let m of a){if(!d){m.data.input=e,d=!0,h=m.run_id,yield m;continue}m.run_id===h&&m.event.endsWith("_end")&&(p=m.data)!=null&&p.input&&delete m.data.input,yield m}}finally{await l}}async*_streamEventsV1(e,t,r){var p,m,g;let a,s=!1,i=ee(t),o=(p=i.tags)!=null?p:[],u=(m=i.metadata)!=null?m:{},c=(g=i.runName)!=null?g:this.getName(),l=new _i({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new pu({...r}),h=this._streamLog(e,l,i);for await(let y of h){if(a?a=a.concat(y):a=bi.fromRunLogPatch(y),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;let _={...a.state},v={run_id:_.id,event:`on_${_.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};d.includeEvent(v,_.type)&&(yield v)}let b=y.ops.filter(_=>_.path.startsWith("/logs/")).map(_=>_.path.split("/")[2]),A=[...new Set(b)];for(let _ of A){let v,E={},O=a.state.logs[_];if(O.end_time===void 0?O.streamed_output.length>0?v="stream":v="start":v="end",v==="start")O.inputs!==void 0&&(E.input=O.inputs);else if(v==="end")O.inputs!==void 0&&(E.input=O.inputs),E.output=O.final_output;else if(v==="stream"){let S=O.streamed_output.length;if(S!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${S} instead. Encountered in: "${O.name}"`);E={chunk:O.streamed_output[0]},O.streamed_output=[]}yield{event:`on_${O.type}_${v}`,name:O.name,run_id:O.id,tags:O.tags,metadata:O.metadata,data:E}}let{state:x}=a;if(x.streamed_output.length>0){let _=x.streamed_output.length;if(_!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${_} instead. Encountered in: "${x.name}"`);let v={chunk:x.streamed_output[0]};x.streamed_output=[];let E={event:`on_${x.type}_stream`,run_id:x.id,tags:o,metadata:u,name:c,data:v};d.includeEvent(E,x.type)&&(yield E)}}let f=a==null?void 0:a.state;if(f!==void 0){let y={event:`on_${f.type}_end`,name:c,run_id:f.id,tags:o,metadata:u,data:{output:f.final_output}};d.includeEvent(y,f.type)&&(yield y)}}static isRunnable(e){return vi(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new $r({bound:this,config:{},configFactories:[a=>({callbacks:[new wi({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return LO(this,e)}},$r=class n extends ie{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=cu(this.config,...e);return cu(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(ee(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(ee(s),this.kwargs))):await this._mergeConfig(ee(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(ee(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(ee(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(ee(t),this.kwargs))}streamEvents(e,t,r){let a=this,s=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(ee(t),a.kwargs),version:t.version},r)};return qe.fromAsyncGenerator(s())}static isRunnableBinding(e){return e.bound&&ie.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new wi({config:a,onStart:e,onEnd:t,onError:r})]})]})}},wu=class n extends ie{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new n({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,we(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},vu=class extends $r{static lc_name(){return"RunnableRetry"}constructor(e){var t,r;super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=(t=e.maxAttemptNumber)!=null?t:this.maxAttemptNumber,this.onFailedAttempt=(r=e.onFailedAttempt)!=null?r:this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return we(t,{callbacks:r==null?void 0:r.getChild(a)})}async _invoke(e,t,r){return(0,rd.default)(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,a){let s={};try{await(0,rd.default)(async i=>{let o=e.map((h,f)=>f).filter(h=>s[h.toString()]===void 0||s[h.toString()]instanceof Error),u=o.map(h=>e[h]),c=o.map(h=>this._patchConfigForRetry(i,t==null?void 0:t[h],r==null?void 0:r[h])),l=await super.batch(u,c,{...a,returnExceptions:!0}),d;for(let h=0;h<l.length;h+=1){let f=l[h],p=o[h];f instanceof Error&&d===void 0&&(d=f,d.input=u[h]),s[p.toString()]=f}if(d)throw d;return l},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((a==null?void 0:a.returnExceptions)!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},qt=class n extends ie{static lc_name(){return"RunnableSequence"}constructor(e){var t,r;super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=(t=e.middle)!=null?t:this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=(r=e.omitSequenceTags)!=null?r:this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){var u;let r=ee(t),a=await ut(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),Oe(e,"input"),r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;let i=e,o;try{let c=[this.first,...this.middle];for(let l=0;l<c.length;l+=1){let h=c[l].invoke(i,we(r,{callbacks:s==null?void 0:s.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`)}));i=await cr(h,t==null?void 0:t.signal)}if((u=t==null?void 0:t.signal)!=null&&u.aborted)throw new Error("Aborted");o=await this.last.invoke(i,we(r,{callbacks:s==null?void 0:s.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(c){throw await(s==null?void 0:s.handleChainError(c)),c}return await(s==null?void 0:s.handleChainEnd(Oe(o,"output"))),o}async batch(e,t,r){var u;let a=this._getOptionsList(t!=null?t:{},e.length),s=await Promise.all(a.map(ut)),i=await Promise.all(s.map(async(c,l)=>{let d=await(c==null?void 0:c.handleChainStart(this.toJSON(),Oe(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName));return delete a[l].runId,d})),o=e;try{for(let c=0;c<this.steps.length;c+=1){let d=this.steps[c].batch(o,i.map((h,f)=>{let p=h==null?void 0:h.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`);return we(a[f],{callbacks:p})}),r);o=await cr(d,(u=a[0])==null?void 0:u.signal)}}catch(c){throw await Promise.all(i.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(i.map(c=>c==null?void 0:c.handleChainEnd(Oe(o,"output")))),o}async*_streamIterator(e,t){var d;let r=await ut(t),{runId:a,...s}=t!=null?t:{},i=await(r==null?void 0:r.handleChainStart(this.toJSON(),Oe(e,"input"),a,void 0,void 0,void 0,s==null?void 0:s.runName)),o=[this.first,...this.middle,this.last],u=!0,c;async function*l(){yield e}try{let h=o[0].transform(l(),we(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let f=1;f<o.length;f+=1)h=await o[f].transform(h,we(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:`seq:step:${f+1}`)}));for await(let f of h)if((d=t==null?void 0:t.signal)==null||d.throwIfAborted(),yield f,u)if(c===void 0)c=f;else try{c=Se(c,f)}catch(p){c=void 0,u=!1}}catch(h){throw await(i==null?void 0:i.handleChainError(h)),h}await(i==null?void 0:i.handleChainEnd(Oe(c,"output")))}getGraph(e){let t=new Ei,r=null;return this.steps.forEach((a,s)=>{let i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);let o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){var t;return n.isRunnableSequence(e)?new n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:(t=this.name)!=null?t:e.name}):new n({first:this.first,middle:[...this.middle,this.last],last:Nr(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&ie.isRunnable(e)}static from([e,...t],r){let a={};return typeof r=="string"?a.name=r:r!==void 0&&(a=r),new n({...a,first:Nr(e),middle:t.slice(0,-1).map(Nr),last:Nr(t[t.length-1])})}},nn=class n extends ie{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=Nr(r)}static from(e){return new n({steps:e})}async invoke(e,t){let r=ee(t),a=await ut(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;let i={};try{let o=Object.entries(this.steps).map(async([u,c])=>{i[u]=await c.invoke(e,we(r,{callbacks:s==null?void 0:s.getChild(`map:key:${u}`)}))});await cr(Promise.all(o),t==null?void 0:t.signal)}catch(o){throw await(s==null?void 0:s.handleChainError(o)),o}return await(s==null?void 0:s.handleChainEnd(i)),i}async*_transform(e,t,r){let a={...this.steps},s=Zl(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],c)=>{let l=u.transform(s[c],we(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){let o=Promise.race(i.values()),{key:u,result:c,gen:l}=await cr(o,r==null?void 0:r.signal);i.delete(u),c.done||(yield{[u]:c.value},i.set(u,l.next().then(d=>({key:u,gen:l,result:d}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=ee(t),s=new kr({generator:this.transform(r(),a),config:a});return await s.setup,qe.fromAsyncGenerator(s)}},nd=class n extends ie{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Yo(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t!=null?t:{},1),a=await ut(r),s=this.func(we(r,{callbacks:a}),e);return cr(s,r==null?void 0:r.signal)}async*_streamIterator(e,t){var s,i;let[r]=this._getOptionsList(t!=null?t:{},1),a=await this.invoke(e,t);if(bu(a)){for await(let o of a)(s=r==null?void 0:r.signal)==null||s.throwIfAborted(),yield o;return}if(Jg(a)){for(;;){(i=r==null?void 0:r.signal)==null||i.throwIfAborted();let o=a.next();if(o.done)break;yield o.value}return}yield a}static from(e){return new n({func:e})}};function jO(n){if(Yo(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var jr=class n extends ie{static lc_name(){return"RunnableLambda"}constructor(e){if(Yo(e.func))return nd.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),jO(e.func),this.func=e.func}static from(e){return new n({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{var o;let i=we(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((o=t==null?void 0:t.recursionLimit)!=null?o:uu)-1});ot.runWithConfig(Ft(i),async()=>{var u,c,l;try{let d=await this.func(e,{...i});if(d&&ie.isRunnable(d)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");d=await d.invoke(e,{...i,recursionLimit:((u=i.recursionLimit)!=null?u:uu)-1})}else if(bu(d)){let h;for await(let f of _u(i,d))if((c=t==null?void 0:t.signal)==null||c.throwIfAborted(),h===void 0)h=f;else try{h=Se(h,f)}catch(p){h=f}d=h}else if(ed(d)){let h;for(let f of td(i,d))if((l=t==null?void 0:t.signal)==null||l.throwIfAborted(),h===void 0)h=f;else try{h=Se(h,f)}catch(p){h=f}d=h}a(d)}catch(d){s(d)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,r){var o,u,c;let a;for await(let l of e)if(a===void 0)a=l;else try{a=Se(a,l)}catch(d){a=l}let s=we(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((o=r==null?void 0:r.recursionLimit)!=null?o:uu)-1}),i=await new Promise((l,d)=>{ot.runWithConfig(Ft(s),async()=>{try{let h=await this.func(a,{...s,config:s});l(h)}catch(h){d(h)}})});if(i&&ie.isRunnable(i)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");let l=await i.stream(a,s);for await(let d of l)yield d}else if(bu(i))for await(let l of _u(s,i))(u=r==null?void 0:r.signal)==null||u.throwIfAborted(),yield l;else if(ed(i))for(let l of td(s,i))(c=r==null?void 0:r.signal)==null||c.throwIfAborted(),yield l;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=ee(t),s=new kr({generator:this.transform(r(),a),config:a});return await s.setup,qe.fromAsyncGenerator(s)}};var Au=class extends ie{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=ee(t),a=await ut(r),{runId:s,...i}=r,o=await(a==null?void 0:a.handleChainStart(this.toJSON(),Oe(e,"input"),s,void 0,void 0,void 0,i==null?void 0:i.runName)),u=we(i,{callbacks:o==null?void 0:o.getChild()});return await ot.runWithConfig(u,async()=>{var d;let l;for(let h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();try{let f=await h.invoke(e,u);return await(o==null?void 0:o.handleChainEnd(Oe(f,"output"))),f}catch(f){l===void 0&&(l=f)}}throw l===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(l)),l)})}async*_streamIterator(e,t){var d;let r=ee(t),a=await ut(r),{runId:s,...i}=r,o=await(a==null?void 0:a.handleChainStart(this.toJSON(),Oe(e,"input"),s,void 0,void 0,void 0,i==null?void 0:i.runName)),u,c;for(let h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();let f=we(i,{callbacks:o==null?void 0:o.getChild()});try{let p=await h.stream(e,f);c=_u(f,p);break}catch(p){u===void 0&&(u=p)}}if(c===void 0){let h=u!=null?u:new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(h)),h}let l;try{for await(let h of c){yield h;try{l=l===void 0?l:Se(l,h)}catch(f){l=void 0}}}catch(h){throw await(o==null?void 0:o.handleChainError(h)),h}await(o==null?void 0:o.handleChainEnd(Oe(l,"output")))}async batch(e,t,r){var u;if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");let a=this._getOptionsList(t!=null?t:{},e.length),s=await Promise.all(a.map(c=>ut(c))),i=await Promise.all(s.map(async(c,l)=>{let d=await(c==null?void 0:c.handleChainStart(this.toJSON(),Oe(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName));return delete a[l].runId,d})),o;for(let c of this.runnables()){(u=a[0].signal)==null||u.throwIfAborted();try{let l=await c.batch(e,i.map((d,h)=>we(a[h],{callbacks:d==null?void 0:d.getChild()})),r);return await Promise.all(i.map((d,h)=>d==null?void 0:d.handleChainEnd(Oe(l[h],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function Nr(n){if(typeof n=="function")return new jr({func:n});if(ie.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){let e={};for(let[t,r]of Object.entries(n))e[t]=Nr(r);return new nn({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var ms=class extends ie{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof nn&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let a=this.mapper.getStepsKeys(),[s,i]=Zl(e),o=this.mapper.transform(i,we(r,{callbacks:t==null?void 0:t.getChild()})),u=o.next();for await(let c of s){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);let l=Object.fromEntries(Object.entries(c).filter(([d])=>!a.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(let c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=ee(t),s=new kr({generator:this.transform(r(),a),config:a});return await s.setup,qe.fromAsyncGenerator(s)}},Eu=class extends ie{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=ee(t),s=new kr({generator:this.transform(r(),a),config:a});return await s.setup,qe.fromAsyncGenerator(s)}},Oi=class extends $r{constructor(e){var r;let t=qt.from([jr.from(async a=>{let s;if(Qa(a))try{s=await this.schema.parseAsync(a.args)}catch(i){throw new Xa("Received tool input did not match expected schema",JSON.stringify(a.args))}else s=a;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:(r=e.config)!=null?r:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function LO(n,e){var a,s,i;let t=(a=e.name)!=null?a:n.getName(),r=(i=e.description)!=null?i:(s=e.schema)==null?void 0:s.description;return e.schema.constructor===xt.ZodString?new Oi({name:t,description:r,schema:xt.object({input:xt.string()}).transform(o=>o.input),bound:n}):new Oi({name:t,description:r,schema:e.schema,bound:n})}var DO=typeof window=="object"?window:{},Y="0123456789abcdef".split(""),MO=[-2147483648,8388608,32768,128],Ht=[24,16,8,0];var Ce=[];function Vt(n){n?(Ce[0]=Ce[16]=Ce[1]=Ce[2]=Ce[3]=Ce[4]=Ce[5]=Ce[6]=Ce[7]=Ce[8]=Ce[9]=Ce[10]=Ce[11]=Ce[12]=Ce[13]=Ce[14]=Ce[15]=0,this.blocks=Ce):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Vt.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===DO.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<Ht[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<Ht[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<Ht[a++&3],i[a>>2]|=(128|t&63)<<Ht[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<Ht[a++&3],i[a>>2]|=(128|t>>6&63)<<Ht[a++&3],i[a>>2]|=(128|t&63)<<Ht[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<Ht[a++&3],i[a>>2]|=(128|t>>12&63)<<Ht[a++&3],i[a>>2]|=(128|t>>6&63)<<Ht[a++&3],i[a>>2]|=(128|t&63)<<Ht[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Vt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=MO[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};Vt.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0};Vt.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return Y[n>>28&15]+Y[n>>24&15]+Y[n>>20&15]+Y[n>>16&15]+Y[n>>12&15]+Y[n>>8&15]+Y[n>>4&15]+Y[n&15]+Y[e>>28&15]+Y[e>>24&15]+Y[e>>20&15]+Y[e>>16&15]+Y[e>>12&15]+Y[e>>8&15]+Y[e>>4&15]+Y[e&15]+Y[t>>28&15]+Y[t>>24&15]+Y[t>>20&15]+Y[t>>16&15]+Y[t>>12&15]+Y[t>>8&15]+Y[t>>4&15]+Y[t&15]+Y[r>>28&15]+Y[r>>24&15]+Y[r>>20&15]+Y[r>>16&15]+Y[r>>12&15]+Y[r>>8&15]+Y[r>>4&15]+Y[r&15]+Y[a>>28&15]+Y[a>>24&15]+Y[a>>20&15]+Y[a>>16&15]+Y[a>>12&15]+Y[a>>8&15]+Y[a>>4&15]+Y[a&15]};Vt.prototype.toString=Vt.prototype.hex;Vt.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]};Vt.prototype.array=Vt.prototype.digest;Vt.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};var ad=n=>new Vt(!0).update(n).hex();var Wg=(...n)=>ad(n.join("_"));var sd=class{},FO=new Map,Ou=class n extends sd{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e!=null?e:new Map}lookup(e,t){var r;return Promise.resolve((r=this.cache.get(Wg(e,t)))!=null?r:null)}async update(e,t,r){this.cache.set(Wg(e,t),r)}static global(){return new n(FO)}};var xu=class extends Dt{},Iu=class extends xu{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new pt(this.value)]}},Pu=class extends xu{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Xs(this.messages)}toChatMessages(){return this.messages}};var ey=wt(Qg(),1);var KO=Object.defineProperty,ZO=(n,e,t)=>e in n?KO(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,JO=(n,e,t)=>(ZO(n,typeof e!="symbol"?e+"":e,t),t);function WO(n,e){let t=Array.from({length:n.length},(r,a)=>({start:a,end:a+1}));for(;t.length>1;){let r=null;for(let a=0;a<t.length-1;a++){let s=n.slice(t[a].start,t[a+1].end),i=e.get(s.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,a])}if(r!=null){let a=r[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function YO(n,e){return n.length===1?[e.get(n.join(","))]:WO(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function XO(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var od=class{constructor(n,e){V(this,"specialTokens");V(this,"inverseSpecialTokens");V(this,"patStr");V(this,"textEncoder",new TextEncoder);V(this,"textDecoder",new TextDecoder("utf-8"));V(this,"rankMap",new Map);V(this,"textMap",new Map);this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,a)=>{let[s,i,...o]=a.split(" "),u=Number.parseInt(i,10);return o.forEach((c,l)=>r[c]=u+l),r},{});for(let[r,a]of Object.entries(t)){let s=ey.default.toByteArray(r);this.rankMap.set(s.join(","),a),this.textMap.set(a,s)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[a,s])=>(r[s]=this.textEncoder.encode(a),r),{})}encode(n,e=[],t="all"){var c;let r=new RegExp(this.patStr,"ug"),a=od.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!i.has(l)):t);if(o.size>0){let l=od.specialTokenRegex([...o]),d=n.match(l);if(d!=null)throw new Error(`The text contains a special token that is not allowed: ${d[0]}`)}let u=0;for(;;){let l=null,d=u;for(;a.lastIndex=d,l=a.exec(n),!(l==null||i.has(l[0]));)d=l.index+1;let h=(c=l==null?void 0:l.index)!=null?c:n.length;for(let p of n.substring(u,h).matchAll(r)){let m=this.textEncoder.encode(p[0]),g=this.rankMap.get(m.join(","));if(g!=null){s.push(g);continue}s.push(...YO(m,this.rankMap))}if(l==null)break;let f=this.specialTokens[l[0]];s.push(f),u=l.index+l[0].length}return s}decode(n){var s;let e=[],t=0;for(let i=0;i<n.length;++i){let o=n[i],u=(s=this.textMap.get(o))!=null?s:this.inverseSpecialTokens[o];u!=null&&(e.push(u),t+=u.length)}let r=new Uint8Array(t),a=0;for(let i of e)r.set(i,a),a+=i.length;return this.textDecoder.decode(r)}},Su=od;JO(Su,"specialTokenRegex",n=>new RegExp(n.map(e=>XO(e)).join("|"),"g"));function ud(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1-2024-12-17":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}var Cu={},QO=new Rr({});async function ex(n){return n in Cu||(Cu[n]=QO.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new Su(e)).catch(e=>{throw delete Cu[n],e})),await Cu[n]}async function ty(n){return ex(ud(n))}var tx=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;function gs(n){return typeof n!="object"||!n?!1:!!("type"in n&&n.type==="function"&&"function"in n&&typeof n.function=="object"&&n.function&&"name"in n.function&&"parameters"in n.function)}var rx=()=>!1,xi=class extends ie{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){var t,r,a;super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=(t=e.verbose)!=null?t:rx(),this.callbacks=e.callbacks,this.tags=(r=e.tags)!=null?r:[],this.metadata=(a=e.metadata)!=null?a:{}}},Ii=class extends xi{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){let{cache:a,...s}=r;super({callbacks:e!=null?e:t,...s}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof a=="object"?this.cache=a:a?this.cache=Ou.global():this.cache=void 0,this.caller=new Rr(r!=null?r:{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await ty("modelName"in this?tx(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new Iu(e):Array.isArray(e)?new Pu(e.map(Rn)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};var yt=class extends ie{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=ee(t);return this.func&&await this.func(e,r),this._callWithConfig(a=>Promise.resolve(a),e,r)}async*transform(e,t){let r=ee(t),a,s=!0;for await(let i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,s)if(a===void 0)a=i;else try{a=Se(a,i)}catch(o){a=void 0,s=!1}this.func&&a!==void 0&&await this.func(a,r)}static assign(e){return new ms(new nn({steps:e}))}};function an(n){return typeof(n==null?void 0:n.parse)=="function"}var sn=class n extends Ii{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptionsCompat(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){let r=n._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){var r;if(this._streamResponseChunks===n.prototype._streamResponseChunks)yield this.invoke(e,t);else{let s=n._convertInputToPromptValue(e).toChatMessages(),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(t),u={...i.metadata,...this.getLsParams(o)},c=await $e.configure(i.callbacks,this.callbacks,i.tags,this.tags,u,this.metadata,{verbose:this.verbose}),l={options:o,invocation_params:this==null?void 0:this.invocationParams(o),batch_size:1},d=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),[s],i.runId,void 0,l,void 0,void 0,i.runName)),h,f;try{for await(let p of this._streamResponseChunks(s,o,d==null?void 0:d[0])){if(p.message.id==null){let m=(r=d==null?void 0:d.at(0))==null?void 0:r.runId;m!=null&&p.message._updateId(`run-${m}`)}p.message.response_metadata={...p.generationInfo,...p.message.response_metadata},yield p.message,h?h=h.concat(p):h=p,Bc(p.message)&&p.message.usage_metadata!==void 0&&(f={tokenUsage:{promptTokens:p.message.usage_metadata.input_tokens,completionTokens:p.message.usage_metadata.output_tokens,totalTokens:p.message.usage_metadata.total_tokens}})}}catch(p){throw await Promise.all((d!=null?d:[]).map(m=>m==null?void 0:m.handleLLMError(p))),p}await Promise.all((d!=null?d:[]).map(p=>p==null?void 0:p.handleLLMEnd({generations:[[h]],llmOutput:f})))}}getLsParams(e){let t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r){var f,p;let a=e.map(m=>m.map(Rn)),s={...r.metadata,...this.getLsParams(t)},i=await $e.configure(r.callbacks,this.callbacks,r.tags,this.tags,s,this.metadata,{verbose:this.verbose}),o={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1},u=await(i==null?void 0:i.handleChatModelStart(this.toJSON(),a,r.runId,void 0,o,void 0,void 0,r.runName)),c=[],l=[];if(!!(u!=null&&u[0].handlers.find(Ml))&&a.length===1&&this._streamResponseChunks!==n.prototype._streamResponseChunks)try{let m=await this._streamResponseChunks(a[0],t,u==null?void 0:u[0]),g,y;for await(let b of m){if(b.message.id==null){let A=(f=u==null?void 0:u.at(0))==null?void 0:f.runId;A!=null&&b.message._updateId(`run-${A}`)}g===void 0?g=b:g=Se(g,b),Bc(b.message)&&b.message.usage_metadata!==void 0&&(y={tokenUsage:{promptTokens:b.message.usage_metadata.input_tokens,completionTokens:b.message.usage_metadata.output_tokens,totalTokens:b.message.usage_metadata.total_tokens}})}if(g===void 0)throw new Error("Received empty response from chat model call.");c.push([g]),await(u==null?void 0:u[0].handleLLMEnd({generations:c,llmOutput:y}))}catch(m){throw await(u==null?void 0:u[0].handleLLMError(m)),m}else{let m=await Promise.allSettled(a.map((g,y)=>this._generate(g,{...t,promptIndex:y},u==null?void 0:u[y])));await Promise.all(m.map(async(g,y)=>{var b,A,x;if(g.status==="fulfilled"){let _=g.value;for(let v of _.generations){if(v.message.id==null){let E=(b=u==null?void 0:u.at(0))==null?void 0:b.runId;E!=null&&v.message._updateId(`run-${E}`)}v.message.response_metadata={...v.generationInfo,...v.message.response_metadata}}return _.generations.length===1&&(_.generations[0].message.response_metadata={..._.llmOutput,..._.generations[0].message.response_metadata}),c[y]=_.generations,l[y]=_.llmOutput,(A=u==null?void 0:u[y])==null?void 0:A.handleLLMEnd({generations:[_.generations],llmOutput:_.llmOutput})}else return await((x=u==null?void 0:u[y])==null?void 0:x.handleLLMError(g.reason)),Promise.reject(g.reason)}))}let h={generations:c,llmOutput:l.length?(p=this._combineLLMOutput)==null?void 0:p.call(this,...l):void 0};return Object.defineProperty(h,lu,{value:u?{runIds:u==null?void 0:u.map(m=>m.runId)}:void 0,configurable:!0}),h}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){let i=e.map(g=>g.map(Rn)),o={...s.metadata,...this.getLsParams(a)},u=await $e.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1,cached:!0},l=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),i,s.runId,void 0,c,void 0,void 0,s.runName)),d=[],f=(await Promise.allSettled(i.map(async(g,y)=>{let b=n._convertInputToPromptValue(g).toString(),A=await t.lookup(b,r);return A==null&&d.push(y),A}))).map((g,y)=>({result:g,runManager:l==null?void 0:l[y]})).filter(({result:g})=>g.status==="fulfilled"&&g.value!=null||g.status==="rejected"),p=[];await Promise.all(f.map(async({result:g,runManager:y},b)=>{if(g.status==="fulfilled"){let A=g.value;return p[b]=A,A.length&&await(y==null?void 0:y.handleLLMNewToken(A[0].text)),y==null?void 0:y.handleLLMEnd({generations:[A]})}else return await(y==null?void 0:y.handleLLMError(g.reason)),Promise.reject(g.reason)}));let m={generations:p,missingPromptIndices:d};return Object.defineProperty(m,lu,{value:l?{runIds:l==null?void 0:l.map(g=>g.runId)}:void 0,configurable:!0}),m}async generate(e,t,r){var f,p;let a;Array.isArray(t)?a={stop:t}:a=t;let s=e.map(m=>m.map(Rn)),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(a);if(i.callbacks=(f=i.callbacks)!=null?f:r,!this.cache)return this._generateUncached(s,o,i);let{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d}=await this._generateCached({messages:s,cache:u,llmStringKey:c,parsedOptions:o,handledOptions:i}),h={};if(d.length>0){let m=await this._generateUncached(d.map(g=>s[g]),o,i);await Promise.all(m.generations.map(async(g,y)=>{let b=d[y];l[b]=g;let A=n._convertInputToPromptValue(s[b]).toString();return u.update(A,c,g)})),h=(p=m.llmOutput)!=null?p:{}}return{generations:l,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let a=e.map(s=>s.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(Rn)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new pt(e),s=await this.call([a],t,r);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}withStructuredOutput(e,t){var m;if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t!=null&&t.strict)throw new Error('"strict" mode is not supported for this model by default.');let r=e,a=t==null?void 0:t.name,s=(m=r.description)!=null?m:"A function available to call.",i=t==null?void 0:t.method,o=t==null?void 0:t.includeRaw;if(i==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=a!=null?a:"extract",c;an(r)?c=[{type:"function",function:{name:u,description:s,parameters:lt(r)}}]:("name"in r&&(u=r.name),c=[{type:"function",function:{name:u,description:s,parameters:r}}]);let l=this.bindTools(c),d=jr.from(g=>{if(!g.tool_calls||g.tool_calls.length===0)throw new Error("No tool calls found in the response.");let y=g.tool_calls.find(b=>b.name===u);if(!y)throw new Error(`No tool call found with name ${u}.`);return y.args});if(!o)return l.pipe(d).withConfig({runName:"StructuredOutput"});let h=yt.assign({parsed:(g,y)=>d.invoke(g.raw,y)}),f=yt.assign({parsed:()=>null}),p=h.withFallbacks({fallbacks:[f]});return qt.from([{raw:l},p]).withConfig({runName:"StructuredOutputRunnable"})}};var Pi=class extends ie{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,a)=>this.parseResult([{text:r}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,a)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"})}},ys=class extends Pi{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},dr=class extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");mo(this,"OUTPUT_PARSING_FAILURE")}};function Ti(n,e){let t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;let r=n.length;if(r!==e.length)return!1;for(let a=0;a<r;a++)if(!Ti(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;let r=Object.keys(n),a=Object.keys(e);if(r.length!==a.length)return!1;for(let i of r)if(!Ti(n[i],e[i]))return!1;return!0}return n===e}var yF=typeof self!="undefined"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");var ax=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,sx=[0,31,28,31,30,31,30,31,31,30,31,30,31],ix=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,ox=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,ux=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,cx=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,lx=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,dx=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,hx=/^(?:\/(?:[^~/]|~0|~1)*)*$/,fx=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,px=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,mx=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,gx=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,yx=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,bx=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,_x=n=>{if(n[0]==='"')return!1;let[e,t,...r]=n.split("@");return!e||!t||r.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(a=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(a))},wx=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,vx=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,Ax=n=>n.length>1&&n.length<80&&(/^P\d+([.,]\d+)?W$/.test(n)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(n)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(n));function dt(n){return n.test.bind(n)}var Ex={date:ry,time:ny.bind(void 0,!1),"date-time":Px,duration:Ax,uri:Cx,"uri-reference":dt(ux),"uri-template":dt(cx),url:dt(lx),email:_x,hostname:dt(ox),ipv4:dt(wx),ipv6:dt(vx),regex:Rx,uuid:dt(dx),"json-pointer":dt(hx),"json-pointer-uri-fragment":dt(fx),"relative-json-pointer":dt(px)},Ox={...Ex,date:dt(mx),time:dt(gx),"date-time":dt(yx),"uri-reference":dt(bx)};function xx(n){return n%4===0&&(n%100!==0||n%400===0)}function ry(n){let e=n.match(ax);if(!e)return!1;let t=+e[1],r=+e[2],a=+e[3];return r>=1&&r<=12&&a>=1&&a<=(r==2&&xx(t)?29:sx[r])}function ny(n,e){let t=e.match(ix);if(!t)return!1;let r=+t[1],a=+t[2],s=+t[3],i=!!t[5];return(r<=23&&a<=59&&s<=59||r==23&&a==59&&s==60)&&(!n||i)}var Ix=/t|\s/i;function Px(n){let e=n.split(Ix);return e.length==2&&ry(e[0])&&ny(!0,e[1])}var Tx=/\/|:/,Sx=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function Cx(n){return Tx.test(n)&&Sx.test(n)}var kx=/[^\\]\\Z/;function Rx(n){if(kx.test(n))return!1;try{return new RegExp(n,"u"),!0}catch(e){return!1}}var ay;(function(n){n[n.Flag=1]="Flag",n[n.Basic=2]="Basic",n[n.Detailed=4]="Detailed"})(ay||(ay={}));var bs=class extends ys{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},na=class extends bs{constructor(e){var t;super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(t=e==null?void 0:e.diff)!=null?t:this.diff}async*_transform(e){let t,r;for await(let a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let s;if(lf(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new ct({message:a,text:a.content})}else if(Kr(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new ct({message:Hc(a),text:a.content})}else s=new kt({text:a});r===void 0?r=s:r=r.concat(s);let i=await this.parsePartialResult([r]);i!=null&&!Ti(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}getFormatInstructions(){return""}};var Si=class extends ys{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=xt.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,xt.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(lt(this.schema))}
\`\`\`
`}async parse(e){try{let r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(a,s)=>`"${s.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(t){throw new dr(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};var aa=class extends na{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?au(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Fc(e[0].text)}async parse(e){return Fc(e,JSON.parse)}getFormatInstructions(){return""}};function ld(n,e){var a;if(n.function===void 0)return;let t;if(e!=null&&e.partial)try{t=Wa((a=n.function.arguments)!=null?a:"{}")}catch(s){return}else try{t=JSON.parse(n.function.arguments)}catch(s){throw new dr([`Function "${n.function.name}" arguments:`,"",n.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}let r={name:n.function.name,args:t,type:"tool_call"};return e!=null&&e.returnId&&(r.id=n.id),r}function sy(n){if(n.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}}function iy(n,e){var t,r;return{name:(t=n.function)==null?void 0:t.name,args:(r=n.function)==null?void 0:r.arguments,id:n.id,error:e,type:"invalid_tool_call"}}var cd=class extends na{static lc_name(){return"JsonOutputToolsParser"}constructor(e){var t;super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(t=e==null?void 0:e.returnId)!=null?t:this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){var i;let r=e[0].message,a;if(Ys(r)&&((i=r.tool_calls)!=null&&i.length)?a=r.tool_calls.map(o=>{let{id:u,...c}=o;return this.returnId?{id:u,...c}:c}):r.additional_kwargs.tool_calls!==void 0&&(a=JSON.parse(JSON.stringify(r.additional_kwargs.tool_calls)).map(u=>ld(u,{returnId:this.returnId,partial:t}))),!a)return[];let s=[];for(let o of a)if(o!==void 0){let u={type:o.name,args:o.args,id:o.id};s.push(u)}return s}},Ci=class extends cd{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){var t;super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=(t=e.returnSingle)!=null?t:this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new dr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let r=(await super.parsePartialResult(e)).filter(s=>s.type===this.keyName),a=r;if(r.length)return this.returnId||(a=r.map(s=>s.args)),this.returnSingle?a[0]:a}async parseResult(e){let r=(await super.parsePartialResult(e,!1)).filter(i=>i.type===this.keyName),a=r;return r.length?(this.returnId||(a=r.map(i=>i.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(i=>this._validateResult(i)))):void 0}};var uy=Symbol("Let zodToJsonSchema decide on which parser to use"),oy={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},cy=n=>typeof n=="string"?{...oy,basePath:["#"],definitions:{},name:n}:{...oy,basePath:["#"],definitions:{},...n};var ki=n=>"_def"in n?n._def:n;function ly(n){if(!n)return!0;for(let e in n)return!1;return!0}var dy=n=>{let e=cy(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[ki(a),{def:ki(a),path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function dd(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function re(n,e,t,r,a){n[e]=t,dd(n,e,r,a)}function hy(){return{}}function fy(n,e){var r,a;let t={type:"array"};return((a=(r=n.type)==null?void 0:r._def)==null?void 0:a.typeName)!==w.ZodAny&&(t.items=z(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&re(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&re(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(re(t,"minItems",n.exactLength.value,n.exactLength.message,e),re(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function py(n,e){let t={type:"integer",format:"int64"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?re(t,"minimum",r.value,r.message,e):re(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),re(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?re(t,"maximum",r.value,r.message,e):re(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),re(t,"maximum",r.value,r.message,e));break;case"multipleOf":re(t,"multipleOf",r.value,r.message,e);break}return t}function my(){return{type:"boolean"}}function gy(n,e){return z(n.type._def,e)}var yy=(n,e)=>z(n.innerType._def,e);function hd(n,e,t){let r=t!=null?t:e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>hd(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return $x(n,e)}}var $x=(n,e)=>{let t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(let r of n.checks)switch(r.kind){case"min":re(t,"minimum",r.value,r.message,e);break;case"max":re(t,"maximum",r.value,r.message,e);break}return t};function by(n,e){return{...z(n.innerType._def,e),default:n.defaultValue()}}function _y(n,e,t){return e.effectStrategy==="input"?z(n.schema._def,e,t):{}}function wy(n){return{type:"string",enum:[...n.values]}}var jx=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function vy(n,e){let t=[z(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),z(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s),r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,a=[];return t.forEach(s=>{if(jx(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){let{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function Ay(n,e){let t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}var fd,sa={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(fd===void 0&&(fd=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),fd),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function ku(n,e){let t={type:"string"};function r(a){return e.patternStrategy==="escape"?Lx(a):a}if(n.checks)for(let a of n.checks)switch(a.kind){case"min":re(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":re(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Gt(t,"email",a.message,e);break;case"format:idn-email":Gt(t,"idn-email",a.message,e);break;case"pattern:zod":Kt(t,sa.email,a.message,e);break}break;case"url":Gt(t,"uri",a.message,e);break;case"uuid":Gt(t,"uuid",a.message,e);break;case"regex":Kt(t,a.regex,a.message,e);break;case"cuid":Kt(t,sa.cuid,a.message,e);break;case"cuid2":Kt(t,sa.cuid2,a.message,e);break;case"startsWith":Kt(t,RegExp(`^${r(a.value)}`),a.message,e);break;case"endsWith":Kt(t,RegExp(`${r(a.value)}$`),a.message,e);break;case"datetime":Gt(t,"date-time",a.message,e);break;case"date":Gt(t,"date",a.message,e);break;case"time":Gt(t,"time",a.message,e);break;case"duration":Gt(t,"duration",a.message,e);break;case"length":re(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),re(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{Kt(t,RegExp(r(a.value)),a.message,e);break}case"ip":{a.version!=="v6"&&Gt(t,"ipv4",a.message,e),a.version!=="v4"&&Gt(t,"ipv6",a.message,e);break}case"emoji":Kt(t,sa.emoji,a.message,e);break;case"ulid":{Kt(t,sa.ulid,a.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Gt(t,"binary",a.message,e);break}case"contentEncoding:base64":{re(t,"contentEncoding","base64",a.message,e);break}case"pattern:zod":{Kt(t,sa.base64,a.message,e);break}}break}case"nanoid":Kt(t,sa.nanoid,a.message,e);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}var Lx=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Gt=(n,e,t,r)=>{var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):re(n,"format",e,t,r)},Kt=(n,e,t,r)=>{var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Ey(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):re(n,"pattern",Ey(e,r),t,r)},Ey=(n,e)=>{var c;let t=typeof n=="function"?n():n;if(!e.applyRegexFlags||!t.flags)return t.source;let r={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},a=r.i?t.source.toLowerCase():t.source,s="",i=!1,o=!1,u=!1;for(let l=0;l<a.length;l++){if(i){s+=a[l],i=!1;continue}if(r.i){if(o){if(a[l].match(/[a-z]/)){u?(s+=a[l],s+=`${a[l-2]}-${a[l]}`.toUpperCase(),u=!1):a[l+1]==="-"&&((c=a[l+2])!=null&&c.match(/[a-z]/))?(s+=a[l],u=!0):s+=`${a[l]}${a[l].toUpperCase()}`;continue}}else if(a[l].match(/[a-z]/)){s+=`[${a[l]}${a[l].toUpperCase()}]`;continue}}if(r.m){if(a[l]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(a[l]==="$"){s+=`($|(?=[\r
]))`;continue}}if(r.s&&a[l]==="."){s+=o?`${a[l]}\r
`:`[${a[l]}\r
]`;continue}s+=a[l],a[l]==="\\"?i=!0:o&&a[l]==="]"?o=!1:!o&&a[l]==="["&&(o=!0)}try{let l=new RegExp(s)}catch(l){return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s};function Ru(n,e){var r,a,s,i,o;if(e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===w.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((u,c)=>{var l;return{...u,[c]:(l=z(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]}))!=null?l:{}}},{}),additionalProperties:!1};let t={type:"object",additionalProperties:(a=z(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?a:{}};if(e.target==="openApi3")return t;if(((s=n.keyType)==null?void 0:s._def.typeName)===w.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){let u=Object.entries(ku(n.keyType._def,e)).reduce((c,[l,d])=>l==="type"?c:{...c,[l]:d},{});return{...t,propertyNames:u}}else if(((o=n.keyType)==null?void 0:o._def.typeName)===w.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function Oy(n,e){if(e.mapStrategy==="record")return Ru(n,e);let t=z(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=z(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function xy(n){let e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function Iy(){return{not:{}}}function Py(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var Ri={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Sy(n,e){if(e.target==="openApi3")return Ty(n,e);let t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in Ri&&(!r._def.checks||!r._def.checks.length))){let r=t.reduce((a,s)=>{let i=Ri[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=t.reduce((a,s)=>{let i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){let a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return Ty(n,e)}var Ty=(n,e)=>{let t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>z(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function Cy(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:Ri[n.innerType._def.typeName],nullable:!0}:{type:[Ri[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let r=z(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let t=z(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function ky(n,e){let t={type:"number"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"int":t.type="integer",dd(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?re(t,"minimum",r.value,r.message,e):re(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),re(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?re(t,"maximum",r.value,r.message,e):re(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),re(t,"maximum",r.value,r.message,e));break;case"multipleOf":re(t,"multipleOf",r.value,r.message,e);break}return t}function Dx(n,e){var t,r;return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":(t=z(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?t:!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":(r=z(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?r:!0}function Ry(n,e){let t={type:"object",...Object.entries(n.shape()).reduce((r,[a,s])=>{if(s===void 0||s._def===void 0)return r;let i=z(s._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return i===void 0?r:{properties:{...r.properties,[a]:i},required:s.isOptional()&&!e.openaiStrictMode?r.required:[...r.required,a]}},{properties:{},required:[]}),additionalProperties:Dx(n,e)};return t.required.length||delete t.required,t}var Ny=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return z(n.innerType._def,e);let t=z(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}};var $y=(n,e)=>{if(e.pipeStrategy==="input")return z(n.in._def,e);if(e.pipeStrategy==="output")return z(n.out._def,e);let t=z(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=z(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function jy(n,e){return z(n.type._def,e)}function Ly(n,e){let r={type:"array",uniqueItems:!0,items:z(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&re(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&re(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function Dy(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>z(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:z(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>z(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function My(){return{not:{}}}function Fy(){return{}}var Uy=(n,e)=>z(n.innerType._def,e);function z(n,e,t=!1){var i;let r=e.seen.get(n);if(e.override){let o=(i=e.override)==null?void 0:i.call(e,n,e,r,t);if(o!==uy)return o}if(r&&!t){let o=Mx(r,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}let a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);let s=Ux(n,n.typeName,e,t);return s&&zx(n,e,s),a.jsonSchema=s,s}var Mx=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"extract-to-root":let t=n.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=n.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:Fx(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((r,a)=>e.currentPath[a]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Fx=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Ux=(n,e,t,r)=>{switch(e){case w.ZodString:return ku(n,t);case w.ZodNumber:return ky(n,t);case w.ZodObject:return Ry(n,t);case w.ZodBigInt:return py(n,t);case w.ZodBoolean:return my();case w.ZodDate:return hd(n,t);case w.ZodUndefined:return My();case w.ZodNull:return Py(t);case w.ZodArray:return fy(n,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return Sy(n,t);case w.ZodIntersection:return vy(n,t);case w.ZodTuple:return Dy(n,t);case w.ZodRecord:return Ru(n,t);case w.ZodLiteral:return Ay(n,t);case w.ZodEnum:return wy(n);case w.ZodNativeEnum:return xy(n);case w.ZodNullable:return Cy(n,t);case w.ZodOptional:return Ny(n,t);case w.ZodMap:return Oy(n,t);case w.ZodSet:return Ly(n,t);case w.ZodLazy:return z(n.getter()._def,t);case w.ZodPromise:return jy(n,t);case w.ZodNaN:case w.ZodNever:return Iy();case w.ZodEffects:return _y(n,t,r);case w.ZodAny:return hy();case w.ZodUnknown:return Fy();case w.ZodDefault:return by(n,t);case w.ZodBranded:return gy(n,t);case w.ZodReadonly:return Uy(n,t);case w.ZodCatch:return yy(n,t);case w.ZodPipeline:return $y(n,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(a=>{})(e)}},zx=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t);var zy=(n,e)=>{var u;let t=dy(e),r=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,a=(u=z(n._def,r===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,r]},!1))!=null?u:{},s=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;s!==void 0&&(a.title=s);let i=(()=>{var d;if(ly(t.definitions))return;let c={},l=new Set;for(let h=0;h<500;h++){let f=Object.entries(t.definitions).filter(([p])=>!l.has(p));if(f.length===0)break;for(let[p,m]of f)c[p]=(d=z(ki(m),{...t,currentPath:[...t.basePath,t.definitionPath,p]},!0))!=null?d:{},l.add(p)}return c})(),o=r===void 0?i?{...a,[t.definitionPath]:i}:a:t.nameStrategy==="duplicate-ref"?{...a,...i||t.seenRefs.size?{[t.definitionPath]:{...i,...t.seenRefs.size?{[r]:a}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,r].join("/"),[t.definitionPath]:{...i,[r]:a}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function By(n,e){return zy(n,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function qy(n,e,t){return Sh({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:By(n,{name:e})}},r=>n.parse(JSON.parse(r)))}function Hy(n){return Ch({type:"function",function:{name:n.name,parameters:By(n.parameters,{name:n.name}),strict:!0,...n.description?{description:n.description}:void 0}},{callback:n.function,parser:e=>n.parameters.parse(JSON.parse(e))})}function Lr(n){let{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:a,baseURL:s,azureADTokenProvider:i,azureOpenAIEndpoint:o}=n;if((r||i)&&a&&e)return`${a}/${e}`;if((r||i)&&o&&e)return`${o}/openai/deployments/${e}`;if(r||i){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return s}function Nu(n,e){let t=typeof e=="number"?void 0:e;return{name:n.name,description:n.description,parameters:lt(n.schema),...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}}function $u(n,e){let t=typeof e=="number"?void 0:e,r;return ia(n)?r={type:"function",function:Nu(n)}:r=n,(t==null?void 0:t.strict)!==void 0&&(r.function.strict=t.strict),r}function Bx(n){return n!==void 0&&Array.isArray(n.lc_namespace)}function qx(n){return n!==void 0&&ie.isRunnable(n)&&"lc_name"in n.constructor&&typeof n.constructor.lc_name=="function"&&n.constructor.lc_name()==="RunnableToolLike"}function Hx(n){return!!n&&typeof n=="object"&&"name"in n&&"schema"in n&&an(n.schema)}function ia(n){return Hx(n)||qx(n)||Bx(n)}function Ni(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function oa(n){let e;return n.constructor.name===$t.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===ge.name?(e=new Error(n.message),e.name="AbortError"):n.status===400&&n.message.includes("tool_calls")?e=Ni(n,"INVALID_TOOL_RESULTS"):n.status===401?e=Ni(n,"MODEL_AUTHENTICATION"):n.status===429?e=Ni(n,"MODEL_RATE_LIMIT"):n.status===404?e=Ni(n,"MODEL_NOT_FOUND"):e=n,e}function Vy(n){if(n)return n==="any"||n==="required"?"required":n==="auto"?"auto":n==="none"?"none":typeof n=="string"?{type:"function",function:{name:n}}:n}function Vx(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function Gy(n){var t;let e=["namespace functions {",""];for(let r of n)r.description&&e.push(`// ${r.description}`),Object.keys((t=r.parameters.properties)!=null?t:{}).length>0?(e.push(`type ${r.name} = (_: {`),e.push(Ky(r.parameters,0)),e.push("}) => any;")):e.push(`type ${r.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Ky(n,e){var r,a;let t=[];for(let[s,i]of Object.entries((r=n.properties)!=null?r:{}))i.description&&e<2&&t.push(`// ${i.description}`),(a=n.required)!=null&&a.includes(s)?t.push(`${s}: ${ju(i,e)},`):t.push(`${s}?: ${ju(i,e)},`);return t.map(s=>" ".repeat(e)+s).join(`
`)}function ju(n,e){if(Vx(n))return n.anyOf.map(t=>ju(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Ky(n,e+2),"}"].join(`
`);case"array":return n.items?`${ju(n.items,e)}[]`:"any[]";default:return""}}function Zy(n,e){let t;if(ia(n)){let r=Hy({name:n.name,parameters:n.schema,description:n.description});r.function.parameters?t={type:r.type,function:{name:r.function.name,description:r.function.description,parameters:r.function.parameters,...(e==null?void 0:e.strict)!==void 0?{strict:e.strict}:{}}}:t={type:"function",function:Nu(n,e)}}else t=n;return(e==null?void 0:e.strict)!==void 0&&(t.function.strict=e.strict),t}function Gx(n){return n.role!=="system"&&n.role!=="developer"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function Wy(n){let e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!ar.isInstance(n))throw new Error("Invalid generic chat message");return Gx(n)}default:throw new Error(`Unknown message type: ${e}`)}}function Kx(n,e,t){var a;let r=n.tool_calls;switch(n.role){case"assistant":{let s=[],i=[];for(let c of r!=null?r:[])try{s.push(ld(c,{returnId:!0}))}catch(l){i.push(iy(c,l.message))}let o={function_call:n.function_call,tool_calls:r};t!==void 0&&(o.__raw_response=e);let u={model_name:e.model,...e.system_fingerprint?{usage:{...e.usage},system_fingerprint:e.system_fingerprint}:{}};return n.audio&&(o.audio=n.audio),new Me({content:n.content||"",tool_calls:s,invalid_tool_calls:i,additional_kwargs:o,response_metadata:u,id:e.id})}default:return new ar(n.content||"",(a=n.role)!=null?a:"unknown")}}function Zx(n,e,t,r){var u,c,l,d;let a=(u=n.role)!=null?u:t,s=(c=n.content)!=null?c:"",i;n.function_call?i={function_call:n.function_call}:n.tool_calls?i={tool_calls:n.tool_calls}:i={},r&&(i.__raw_response=e),n.audio&&(i.audio={...n.audio,index:e.choices[0].index});let o={usage:{...e.usage}};if(a==="user")return new kn({content:s,response_metadata:o});if(a==="assistant"){let h=[];if(Array.isArray(n.tool_calls))for(let f of n.tool_calls)h.push({name:(l=f.function)==null?void 0:l.name,args:(d=f.function)==null?void 0:d.arguments,id:f.id,index:f.index,type:"tool_call_chunk"});return new Te({content:s,tool_call_chunks:h,additional_kwargs:i,id:e.id,response_metadata:o})}else return a==="system"?new Jr({content:s,response_metadata:o}):a==="developer"?new Jr({content:s,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):a==="function"?new Cn({content:s,additional_kwargs:i,name:n.name,response_metadata:o}):a==="tool"?new Ya({content:s,additional_kwargs:i,tool_call_id:n.tool_call_id,response_metadata:o}):new Sn({content:s,role:a,response_metadata:o})}function pd(n,e){return n.flatMap(t=>{var s;let r=Wy(t);r==="system"&&(e!=null&&e.startsWith("o1"))&&(r="developer");let a={role:r,content:t.content};if(t.name!=null&&(a.name=t.name),t.additional_kwargs.function_call!=null&&(a.function_call=t.additional_kwargs.function_call,a.content=null),Ys(t)&&((s=t.tool_calls)!=null&&s.length)?(a.tool_calls=t.tool_calls.map(sy),a.content=null):(t.additional_kwargs.tool_calls!=null&&(a.tool_calls=t.additional_kwargs.tool_calls),t.tool_call_id!=null&&(a.tool_call_id=t.tool_call_id)),t.additional_kwargs.audio&&typeof t.additional_kwargs.audio=="object"&&"id"in t.additional_kwargs.audio){let i={role:"assistant",audio:{id:t.additional_kwargs.audio.id}};return[a,i]}return a})}function Jy(n,e){return gs(n)?(e==null?void 0:e.strict)!==void 0?{...n,function:{...n.function,strict:e.strict}}:n:Zy(n,e)}var ua=class extends sn{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){var r,a,s,i,o,u,c,l,d,h,f,p,m,g,y,b,A,x,_,v,E,O,S,L,q,H,de,Ie,ve,cn,Le,Ps,Ts,Ss,Cs;if(super(e!=null?e:{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(i=(s=(r=e==null?void 0:e.apiKey)!=null?r:e==null?void 0:e.openAIApiKey)!=null?s:(a=e==null?void 0:e.configuration)==null?void 0:a.apiKey)!=null?i:ae("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=(o=e==null?void 0:e.azureOpenAIApiKey)!=null?o:ae("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=(u=e==null?void 0:e.azureADTokenProvider)!=null?u:void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=(c=e==null?void 0:e.azureOpenAIApiInstanceName)!=null?c:ae("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(l=e==null?void 0:e.azureOpenAIApiDeploymentName)!=null?l:ae("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(d=e==null?void 0:e.azureOpenAIApiVersion)!=null?d:ae("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(h=e==null?void 0:e.azureOpenAIBasePath)!=null?h:ae("AZURE_OPENAI_BASE_PATH"),this.organization=(p=(f=e==null?void 0:e.configuration)==null?void 0:f.organization)!=null?p:ae("OPENAI_ORGANIZATION"),this.azureOpenAIEndpoint=(m=e==null?void 0:e.azureOpenAIEndpoint)!=null?m:ae("AZURE_OPENAI_ENDPOINT"),this.modelName=(y=(g=e==null?void 0:e.model)!=null?g:e==null?void 0:e.modelName)!=null?y:this.model,this.model=this.modelName,this.modelKwargs=(b=e==null?void 0:e.modelKwargs)!=null?b:{},this.timeout=e==null?void 0:e.timeout,this.temperature=(A=e==null?void 0:e.temperature)!=null?A:this.temperature,this.topP=(x=e==null?void 0:e.topP)!=null?x:this.topP,this.frequencyPenalty=(_=e==null?void 0:e.frequencyPenalty)!=null?_:this.frequencyPenalty,this.presencePenalty=(v=e==null?void 0:e.presencePenalty)!=null?v:this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(E=e==null?void 0:e.n)!=null?E:this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(O=e==null?void 0:e.stopSequences)!=null?O:e==null?void 0:e.stop,this.stopSequences=this==null?void 0:this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoningEffort=e==null?void 0:e.reasoningEffort,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath&&!this.azureOpenAIEndpoint)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName&&this.azureOpenAIBasePath){let ks=this.azureOpenAIBasePath.split("/openai/deployments/");if(ks.length===2){let[,Ui]=ks;this.azureOpenAIApiDeploymentName=Ui}}if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=(S=this.apiKey)!=null?S:"",this.streamUsage=!1}this.streaming=(L=e==null?void 0:e.streaming)!=null?L:!1,this.streamUsage=(q=e==null?void 0:e.streamUsage)!=null?q:this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:(de=t==null?void 0:t.basePath)!=null?de:(H=e==null?void 0:e.configuration)==null?void 0:H.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:(Le=(Ie=t==null?void 0:t.baseOptions)==null?void 0:Ie.headers)!=null?Le:(cn=(ve=e==null?void 0:e.configuration)==null?void 0:ve.baseOptions)==null?void 0:cn.headers,defaultQuery:(Cs=(Ps=t==null?void 0:t.baseOptions)==null?void 0:Ps.params)!=null?Cs:(Ss=(Ts=e==null?void 0:e.configuration)==null?void 0:Ts.baseOptions)==null?void 0:Ss.params,...t,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){var r,a;let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:(r=t.temperature)!=null?r:void 0,ls_max_tokens:(a=t.max_tokens)!=null?a:void 0,ls_stop:e.stop}}bindTools(e,t){let r;return(t==null?void 0:t.strict)!==void 0?r=t.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this.bind({tools:e.map(a=>Jy(a,{strict:r})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&Lu(e.json_schema.schema)?qy(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){var o,u,c;let r;(e==null?void 0:e.strict)!==void 0?r=e.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling);let a={};(e==null?void 0:e.stream_options)!==void 0?a={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t!=null&&t.streaming)&&(a={stream_options:{include_usage:!0}});let s={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(o=e==null?void 0:e.stop)!=null?o:this.stopSequences,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:(u=e==null?void 0:e.tools)!=null&&u.length?e.tools.map(l=>Jy(l,{strict:r})):void 0,tool_choice:Vy(e==null?void 0:e.tool_choice),response_format:this.createResponseFormat(e==null?void 0:e.response_format),seed:e==null?void 0:e.seed,...a,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,...this.audio||e!=null&&e.audio?{audio:this.audio||(e==null?void 0:e.audio)}:{},...this.modalities||e!=null&&e.modalities?{modalities:this.modalities||(e==null?void 0:e.modalities)}:{},...this.modelKwargs};(e==null?void 0:e.prediction)!==void 0&&(s.prediction=e.prediction);let i=(c=e==null?void 0:e.reasoning_effort)!=null?c:this.reasoningEffort;return i!==void 0&&(s.reasoning_effort=i),s}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){var c,l,d,h,f,p,m,g,y,b,A,x,_,v;let a=pd(e,this.model),s={...this.invocationParams(t,{streaming:!0}),messages:a,stream:!0},i,o=await this.completionWithRetry(s,t),u;for await(let E of o){let O=(c=E==null?void 0:E.choices)==null?void 0:c[0];if(E.usage&&(u=E.usage),!O)continue;let{delta:S}=O;if(!S)continue;let L=Zx(S,E,i,this.__includeRawResponse);i=(l=S.role)!=null?l:i;let q={prompt:(d=t.promptIndex)!=null?d:0,completion:(h=O.index)!=null?h:0};if(typeof L.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let H={...q};O.finish_reason!=null&&(H.finish_reason=O.finish_reason,H.system_fingerprint=E.system_fingerprint,H.model_name=E.model),this.logprobs&&(H.logprobs=O.logprobs);let de=new ct({message:L,text:L.content,generationInfo:H});yield de,await(r==null?void 0:r.handleLLMNewToken((f=de.text)!=null?f:"",q,void 0,void 0,void 0,{chunk:de}))}if(u){let E={...((p=u.prompt_tokens_details)==null?void 0:p.audio_tokens)!==null&&{audio:(m=u.prompt_tokens_details)==null?void 0:m.audio_tokens},...((g=u.prompt_tokens_details)==null?void 0:g.cached_tokens)!==null&&{cache_read:(y=u.prompt_tokens_details)==null?void 0:y.cached_tokens}},O={...((b=u.completion_tokens_details)==null?void 0:b.audio_tokens)!==null&&{audio:(A=u.completion_tokens_details)==null?void 0:A.audio_tokens},...((x=u.completion_tokens_details)==null?void 0:x.reasoning_tokens)!==null&&{reasoning:(_=u.completion_tokens_details)==null?void 0:_.reasoning_tokens}};yield new ct({message:new Te({content:"",response_metadata:{usage:{...u}},usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens,...Object.keys(E).length>0&&{input_token_details:E},...Object.keys(O).length>0&&{output_token_details:O}}}),text:""})}if((v=t.signal)!=null&&v.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){var o,u,c,l,d,h,f,p,m,g;let a={},s=this.invocationParams(t),i=pd(e,this.model);if(s.stream){let y=this._streamResponseChunks(e,t,r),b={};for await(let O of y){O.message.response_metadata={...O.generationInfo,...O.message.response_metadata};let S=(u=(o=O.generationInfo)==null?void 0:o.completion)!=null?u:0;b[S]===void 0?b[S]=O:b[S]=b[S].concat(O)}let A=Object.entries(b).sort(([O],[S])=>parseInt(O,10)-parseInt(S,10)).map(([O,S])=>S),{functions:x,function_call:_}=this.invocationParams(t),v=await this.getEstimatedTokenCountFromPrompt(e,x,_),E=await this.getNumTokensFromGenerations(A);return a.input_tokens=v,a.output_tokens=E,a.total_tokens=v+E,{generations:A,llmOutput:{estimatedTokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}else{let y;t.response_format&&t.response_format.type==="json_schema"?y=await this.betaParsedCompletionWithRetry({...s,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}):y=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});let{completion_tokens:b,prompt_tokens:A,total_tokens:x,prompt_tokens_details:_,completion_tokens_details:v}=(c=y==null?void 0:y.usage)!=null?c:{};b&&(a.output_tokens=((l=a.output_tokens)!=null?l:0)+b),A&&(a.input_tokens=((d=a.input_tokens)!=null?d:0)+A),x&&(a.total_tokens=((h=a.total_tokens)!=null?h:0)+x),((_==null?void 0:_.audio_tokens)!==null||(_==null?void 0:_.cached_tokens)!==null)&&(a.input_token_details={...(_==null?void 0:_.audio_tokens)!==null&&{audio:_==null?void 0:_.audio_tokens},...(_==null?void 0:_.cached_tokens)!==null&&{cache_read:_==null?void 0:_.cached_tokens}}),((v==null?void 0:v.audio_tokens)!==null||(v==null?void 0:v.reasoning_tokens)!==null)&&(a.output_token_details={...(v==null?void 0:v.audio_tokens)!==null&&{audio:v==null?void 0:v.audio_tokens},...(v==null?void 0:v.reasoning_tokens)!==null&&{reasoning:v==null?void 0:v.reasoning_tokens}});let E=[];for(let O of(f=y==null?void 0:y.choices)!=null?f:[]){let L={text:(m=(p=O.message)==null?void 0:p.content)!=null?m:"",message:Kx((g=O.message)!=null?g:{role:"assistant"},y,this.__includeRawResponse)};L.generationInfo={...O.finish_reason?{finish_reason:O.finish_reason}:{},...O.logprobs?{logprobs:O.logprobs}:{}},Ys(L.message)&&(L.message.usage_metadata=a),L.message=new Me(Object.fromEntries(Object.entries(L.message).filter(([q])=>!q.startsWith("lc_")))),E.push(L)}return{generations:E,llmOutput:{tokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){let s=Gy(t);a+=await this.getNumTokens(s),a+=9}return t&&e.find(s=>s._getType()==="system")&&(a-=4),r==="none"?a+=1:typeof r=="object"&&(a+=await this.getNumTokens(r.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var a;return(a=r.message.additional_kwargs)!=null&&a.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,a)=>r+a,0)}async getNumTokensFromMessages(e){let t=0,r=0,a=0;this.model==="gpt-3.5-turbo-0301"?(r=4,a=-1):(r=3,a=1);let s=await Promise.all(e.map(async i=>{var h,f,p,m,g,y;let o=await this.getNumTokens(i.content),u=await this.getNumTokens(Wy(i)),c=i.name!==void 0?a+await this.getNumTokens(i.name):0,l=o+r+u+c,d=i;if(d._getType()==="function"&&(l-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(l+=3),(f=d==null?void 0:d.additional_kwargs.function_call)!=null&&f.name&&(l+=await this.getNumTokens((p=d.additional_kwargs.function_call)==null?void 0:p.name)),(m=d.additional_kwargs.function_call)!=null&&m.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse((g=d.additional_kwargs.function_call)==null?void 0:g.arguments)))}catch(b){console.error("Error parsing function arguments",b,JSON.stringify(d.additional_kwargs.function_call)),l+=await this.getNumTokens((y=d.additional_kwargs.function_call)==null?void 0:y.arguments)}return t+=l,l}));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(a){throw oa(a)}})}async betaParsedCompletionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(a){throw oa(a)}})}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint},a=Lr(r),s={...this.clientConfig,baseURL:a,timeout:this.timeout,maxRetries:0};s.baseURL||delete s.baseURL,this.client=new W(s)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>{var a,s,i;return r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=(a=r.tokenUsage.completionTokens)!=null?a:0,t.tokenUsage.promptTokens+=(s=r.tokenUsage.promptTokens)!=null?s:0,t.tokenUsage.totalTokens+=(i=r.tokenUsage.totalTokens)!=null?i:0),t},{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){var h,f;let r,a,s,i;Jx(e)?(r=e.schema,a=e.name,s=e.method,i=e.includeRaw):(r=e,a=t==null?void 0:t.name,s=t==null?void 0:t.method,i=t==null?void 0:t.includeRaw);let o,u;if((t==null?void 0:t.strict)!==void 0&&s==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(s==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),Lu(r)?u=Si.fromZodSchema(r):u=new aa;else if(s==="jsonSchema")o=this.bind({response_format:{type:"json_schema",json_schema:{name:a!=null?a:"extract",description:r.description,schema:r,strict:t==null?void 0:t.strict}}}),Lu(r)?u=Si.fromZodSchema(r):u=new aa;else{let p=a!=null?a:"extract";if(Lu(r)){let m=lt(r);o=this.bind({tools:[{type:"function",function:{name:p,description:m.description,parameters:m}}],tool_choice:{type:"function",function:{name:p}},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),u=new Ci({returnSingle:!0,keyName:p,zodSchema:r})}else{let m;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(m=r,p=r.name):(p=(h=r.title)!=null?h:p,m={name:p,description:(f=r.description)!=null?f:"",parameters:r}),o=this.bind({tools:[{type:"function",function:m}],tool_choice:{type:"function",function:{name:p}},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),u=new Ci({returnSingle:!0,keyName:p})}}if(!i)return o.pipe(u);let c=yt.assign({parsed:(p,m)=>u.invoke(p.raw,m)}),l=yt.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[l]});return qt.from([{raw:o},d])}};function Lu(n){return typeof(n==null?void 0:n.parse)=="function"}function Jx(n){return n!==void 0&&typeof n.schema=="object"}var Du=class extends ua{_llmType(){return"azure_openai"}get lc_aliases(){return{openAIApiKey:"openai_api_key",openAIApiVersion:"openai_api_version",openAIBasePath:"openai_api_base",deploymentName:"deployment_name",azureOpenAIEndpoint:"azure_endpoint",azureOpenAIApiVersion:"openai_api_version",azureOpenAIBasePath:"openai_api_base",azureOpenAIApiDeploymentName:"deployment_name"}}constructor(e){var r,a,s;let t=e&&{...e};t&&(t.azureOpenAIApiDeploymentName=(r=t.azureOpenAIApiDeploymentName)!=null?r:t.deploymentName,t.azureOpenAIApiKey=(a=t.azureOpenAIApiKey)!=null?a:t.openAIApiKey,t.azureOpenAIApiVersion=(s=t.azureOpenAIApiVersion)!=null?s:t.openAIApiVersion),super(t)}getLsParams(e){let t=super.getLsParams(e);return t.ls_provider="azure",t}_getClientOptions(e){var r;if(!this.client){let a={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,azureADTokenProvider:this.azureADTokenProvider,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint},s=Lr(a),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};this.azureADTokenProvider||(i.apiKey=a.azureOpenAIApiKey),i.baseURL||delete i.baseURL,i.defaultHeaders={...i.defaultHeaders,"User-Agent":(r=i.defaultHeaders)!=null&&r["User-Agent"]?`${i.defaultHeaders["User-Agent"]}: langchainjs-azure-openai-v2`:"langchainjs-azure-openai-v2"},this.client=new po({apiVersion:this.azureOpenAIApiVersion,azureADTokenProvider:this.azureADTokenProvider,deployment:this.azureOpenAIApiDeploymentName,...i})}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}toJSON(){let e=super.toJSON();function t(r){return typeof r=="object"&&r!=null}if(t(e)&&t(e.kwargs)){if(delete e.kwargs.azure_openai_base_path,delete e.kwargs.azure_openai_api_deployment_name,delete e.kwargs.azure_openai_api_key,delete e.kwargs.azure_openai_api_version,delete e.kwargs.azure_open_ai_base_path,!e.kwargs.azure_endpoint&&this.azureOpenAIEndpoint&&(e.kwargs.azure_endpoint=this.azureOpenAIEndpoint),!e.kwargs.azure_endpoint&&this.azureOpenAIBasePath){let r=this.azureOpenAIBasePath.split("/openai/deployments/");if(r.length===2&&r[0].startsWith("http")){let[a]=r;e.kwargs.azure_endpoint=a}}if(!e.kwargs.azure_endpoint&&this.azureOpenAIApiInstanceName&&(e.kwargs.azure_endpoint=`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/`),!e.kwargs.deployment_name&&this.azureOpenAIApiDeploymentName&&(e.kwargs.deployment_name=this.azureOpenAIApiDeploymentName),!e.kwargs.deployment_name&&this.azureOpenAIBasePath){let r=this.azureOpenAIBasePath.split("/openai/deployments/");if(r.length===2){let[,a]=r;e.kwargs.deployment_name=a}}e.kwargs.azure_endpoint&&e.kwargs.deployment_name&&e.kwargs.openai_api_base&&delete e.kwargs.openai_api_base,e.kwargs.azure_openai_api_instance_name&&e.kwargs.azure_endpoint&&delete e.kwargs.azure_openai_api_instance_name}return e}};var md=class extends xi{get lc_namespace(){return["langchain","tools"]}constructor(e){var t,r;super(e!=null?e:{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.verboseParsingErrors=(t=e==null?void 0:e.verboseParsingErrors)!=null?t:this.verboseParsingErrors,this.responseFormat=(r=e==null?void 0:e.responseFormat)!=null?r:this.responseFormat}async invoke(e,t){let r,a,s=ee(t);return Qa(e)?(r=e.id,a=e.args,s={...s,toolCall:e,configurable:{...s.configurable,tool_call_id:r}}):a=e,this.call(a,s)}async call(e,t,r){let a;try{a=await this.schema.parseAsync(e)}catch(f){let p="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(p=`${p}
Details: ${f.message}`),new Xa(p,JSON.stringify(e))}let s=ag(t),i=$e.configure(s.callbacks,this.callbacks,s.tags||r,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),o=await(i==null?void 0:i.handleToolStart(this.toJSON(),typeof a=="string"?a:JSON.stringify(a),s.runId,void 0,void 0,void 0,s.runName));delete s.runId;let u;try{u=await this._call(a,o,s)}catch(f){throw await(o==null?void 0:o.handleToolError(f)),f}let c,l;if(this.responseFormat==="content_and_artifact")if(Array.isArray(u)&&u.length===2)[c,l]=u;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(u)}`);else c=u;let d;s&&"configurable"in s&&(d=s.configurable.tool_call_id);let h=Yx({content:c,artifact:l,toolCallId:d,name:this.name});return await(o==null?void 0:o.handleToolEnd(h)),h}},Mu=class extends md{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:xt.object({input:xt.string().optional()}).transform(t=>t.input)})}call(e,t){return super.call(typeof e=="string"||!e?{input:e}:e,t)}};function Yx(n){let{content:e,artifact:t,toolCallId:r}=n;return r&&!df(e)?typeof e=="string"||Array.isArray(e)&&e.every(a=>typeof a=="object")?new vr({content:e,artifact:t,tool_call_id:r,name:n.name}):new vr({content:Xx(e),artifact:t,tool_call_id:r,name:n.name}):e}function Xx(n){try{return JSON.stringify(n,null,2)}catch(e){return`${n}`}}var gd=class extends Mu{static lc_name(){return"DallEAPIWrapper"}constructor(e){var s,i,o,u,c,l,d,h,f,p;(e==null?void 0:e.responseFormat)!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=(i=(s=e==null?void 0:e.apiKey)!=null?s:e==null?void 0:e.openAIApiKey)!=null?i:ae("OPENAI_API_KEY"),r=(o=e==null?void 0:e.organization)!=null?o:ae("OPENAI_ORGANIZATION"),a={apiKey:t,organization:r,dangerouslyAllowBrowser:!0,baseUrl:e==null?void 0:e.baseUrl};this.client=new W(a),this.model=(c=(u=e==null?void 0:e.model)!=null?u:e==null?void 0:e.modelName)!=null?c:this.model,this.style=(l=e==null?void 0:e.style)!=null?l:this.style,this.quality=(d=e==null?void 0:e.quality)!=null?d:this.quality,this.n=(h=e==null?void 0:e.n)!=null?h:this.n,this.size=(f=e==null?void 0:e.size)!=null?f:this.size,this.dallEResponseFormat=(p=e==null?void 0:e.dallEResponseFormat)!=null?p:this.dallEResponseFormat,this.user=e==null?void 0:e.user}processMultipleGeneratedUrls(e){return this.dallEResponseFormat==="url"?e.flatMap(t=>t.data.flatMap(a=>a.url?{type:"image_url",image_url:a.url}:[]).filter(a=>a!==void 0&&a.type==="image_url"&&typeof a.image_url=="string"&&a.image_url!==void 0)):e.flatMap(t=>t.data.flatMap(a=>a.b64_json?{type:"image_url",image_url:{url:a.b64_json}}:[]).filter(a=>a!==void 0&&a.type==="image_url"&&typeof a.image_url=="object"&&"url"in a.image_url&&typeof a.image_url.url=="string"&&a.image_url.url!==void 0))}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let s=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(s)}let r=await this.client.images.generate(t),a="";return this.dallEResponseFormat==="url"?[a]=r.data.map(s=>s.url).filter(s=>s!=="undefined"):[a]=r.data.map(s=>s.b64_json).filter(s=>s!=="undefined"),a}};Object.defineProperty(gd,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var je=typeof globalThis!="undefined"&&globalThis||typeof self!="undefined"&&self||typeof global!="undefined"&&global||{},Xe={searchParams:"URLSearchParams"in je,iterable:"Symbol"in je&&"iterator"in Symbol,blob:"FileReader"in je&&"Blob"in je&&function(){try{return new Blob,!0}catch(n){return!1}}(),formData:"FormData"in je,arrayBuffer:"ArrayBuffer"in je};function Qx(n){return n&&DataView.prototype.isPrototypeOf(n)}Xe.arrayBuffer&&(Qy=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],tb=ArrayBuffer.isView||function(n){return n&&Qy.indexOf(Object.prototype.toString.call(n))>-1});var Qy,tb;function _s(n){if(typeof n!="string"&&(n=String(n)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(n)||n==="")throw new TypeError('Invalid character in header field name: "'+n+'"');return n.toLowerCase()}function bd(n){return typeof n!="string"&&(n=String(n)),n}function _d(n){var e={next:function(){var t=n.shift();return{done:t===void 0,value:t}}};return Xe.iterable&&(e[Symbol.iterator]=function(){return e}),e}function xe(n){this.map={},n instanceof xe?n.forEach(function(e,t){this.append(t,e)},this):Array.isArray(n)?n.forEach(function(e){if(e.length!=2)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+e.length);this.append(e[0],e[1])},this):n&&Object.getOwnPropertyNames(n).forEach(function(e){this.append(e,n[e])},this)}xe.prototype.append=function(n,e){n=_s(n),e=bd(e);var t=this.map[n];this.map[n]=t?t+", "+e:e};xe.prototype.delete=function(n){delete this.map[_s(n)]};xe.prototype.get=function(n){return n=_s(n),this.has(n)?this.map[n]:null};xe.prototype.has=function(n){return this.map.hasOwnProperty(_s(n))};xe.prototype.set=function(n,e){this.map[_s(n)]=bd(e)};xe.prototype.forEach=function(n,e){for(var t in this.map)this.map.hasOwnProperty(t)&&n.call(e,this.map[t],t,this)};xe.prototype.keys=function(){var n=[];return this.forEach(function(e,t){n.push(t)}),_d(n)};xe.prototype.values=function(){var n=[];return this.forEach(function(e){n.push(e)}),_d(n)};xe.prototype.entries=function(){var n=[];return this.forEach(function(e,t){n.push([t,e])}),_d(n)};Xe.iterable&&(xe.prototype[Symbol.iterator]=xe.prototype.entries);function yd(n){if(!n._noBody){if(n.bodyUsed)return Promise.reject(new TypeError("Already read"));n.bodyUsed=!0}}function rb(n){return new Promise(function(e,t){n.onload=function(){e(n.result)},n.onerror=function(){t(n.error)}})}function eI(n){var e=new FileReader,t=rb(e);return e.readAsArrayBuffer(n),t}function tI(n){var e=new FileReader,t=rb(e),r=/charset=([A-Za-z0-9_-]+)/.exec(n.type),a=r?r[1]:"utf-8";return e.readAsText(n,a),t}function rI(n){for(var e=new Uint8Array(n),t=new Array(e.length),r=0;r<e.length;r++)t[r]=String.fromCharCode(e[r]);return t.join("")}function eb(n){if(n.slice)return n.slice(0);var e=new Uint8Array(n.byteLength);return e.set(new Uint8Array(n)),e.buffer}function nb(){return this.bodyUsed=!1,this._initBody=function(n){this.bodyUsed=this.bodyUsed,this._bodyInit=n,n?typeof n=="string"?this._bodyText=n:Xe.blob&&Blob.prototype.isPrototypeOf(n)?this._bodyBlob=n:Xe.formData&&FormData.prototype.isPrototypeOf(n)?this._bodyFormData=n:Xe.searchParams&&URLSearchParams.prototype.isPrototypeOf(n)?this._bodyText=n.toString():Xe.arrayBuffer&&Xe.blob&&Qx(n)?(this._bodyArrayBuffer=eb(n.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):Xe.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(n)||tb(n))?this._bodyArrayBuffer=eb(n):this._bodyText=n=Object.prototype.toString.call(n):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||(typeof n=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):Xe.searchParams&&URLSearchParams.prototype.isPrototypeOf(n)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},Xe.blob&&(this.blob=function(){var n=yd(this);if(n)return n;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var n=yd(this);return n||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}else{if(Xe.blob)return this.blob().then(eI);throw new Error("could not read as ArrayBuffer")}},this.text=function(){var n=yd(this);if(n)return n;if(this._bodyBlob)return tI(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(rI(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},Xe.formData&&(this.formData=function(){return this.text().then(sI)}),this.json=function(){return this.text().then(JSON.parse)},this}var nI=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function aI(n){var e=n.toUpperCase();return nI.indexOf(e)>-1?e:n}function la(n,e){if(!(this instanceof la))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');e=e||{};var t=e.body;if(n instanceof la){if(n.bodyUsed)throw new TypeError("Already read");this.url=n.url,this.credentials=n.credentials,e.headers||(this.headers=new xe(n.headers)),this.method=n.method,this.mode=n.mode,this.signal=n.signal,!t&&n._bodyInit!=null&&(t=n._bodyInit,n.bodyUsed=!0)}else this.url=String(n);if(this.credentials=e.credentials||this.credentials||"same-origin",(e.headers||!this.headers)&&(this.headers=new xe(e.headers)),this.method=aI(e.method||this.method||"GET"),this.mode=e.mode||this.mode||null,this.signal=e.signal||this.signal||function(){if("AbortController"in je){var s=new AbortController;return s.signal}}(),this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&t)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(t),(this.method==="GET"||this.method==="HEAD")&&(e.cache==="no-store"||e.cache==="no-cache")){var r=/([?&])_=[^&]*/;if(r.test(this.url))this.url=this.url.replace(r,"$1_="+new Date().getTime());else{var a=/\?/;this.url+=(a.test(this.url)?"&":"?")+"_="+new Date().getTime()}}}la.prototype.clone=function(){return new la(this,{body:this._bodyInit})};function sI(n){var e=new FormData;return n.trim().split("&").forEach(function(t){if(t){var r=t.split("="),a=r.shift().replace(/\+/g," "),s=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(a),decodeURIComponent(s))}}),e}function iI(n){var e=new xe,t=n.replace(/\r?\n[\t ]+/g," ");return t.split("\r").map(function(r){return r.indexOf(`
`)===0?r.substr(1,r.length):r}).forEach(function(r){var a=r.split(":"),s=a.shift().trim();if(s){var i=a.join(":").trim();try{e.append(s,i)}catch(o){console.warn("Response "+o.message)}}}),e}nb.call(la.prototype);function hr(n,e){if(!(this instanceof hr))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(e||(e={}),this.type="default",this.status=e.status===void 0?200:e.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=e.statusText===void 0?"":""+e.statusText,this.headers=new xe(e.headers),this.url=e.url||"",this._initBody(n)}nb.call(hr.prototype);hr.prototype.clone=function(){return new hr(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new xe(this.headers),url:this.url})};hr.error=function(){var n=new hr(null,{status:200,statusText:""});return n.ok=!1,n.status=0,n.type="error",n};var oI=[301,302,303,307,308];hr.redirect=function(n,e){if(oI.indexOf(e)===-1)throw new RangeError("Invalid status code");return new hr(null,{status:e,headers:{location:n}})};var ca=je.DOMException;try{new ca}catch(n){ca=function(e,t){this.message=e,this.name=t;var r=Error(e);this.stack=r.stack},ca.prototype=Object.create(Error.prototype),ca.prototype.constructor=ca}function ab(n,e){return new Promise(function(t,r){var a=new la(n,e);if(a.signal&&a.signal.aborted)return r(new ca("Aborted","AbortError"));var s=new XMLHttpRequest;function i(){s.abort()}s.onload=function(){var c={statusText:s.statusText,headers:iI(s.getAllResponseHeaders()||"")};a.url.indexOf("file://")===0&&(s.status<200||s.status>599)?c.status=200:c.status=s.status,c.url="responseURL"in s?s.responseURL:c.headers.get("X-Request-URL");var l="response"in s?s.response:s.responseText;setTimeout(function(){t(new hr(l,c))},0)},s.onerror=function(){setTimeout(function(){r(new TypeError("Network request failed"))},0)},s.ontimeout=function(){setTimeout(function(){r(new TypeError("Network request timed out"))},0)},s.onabort=function(){setTimeout(function(){r(new ca("Aborted","AbortError"))},0)};function o(c){try{return c===""&&je.location.href?je.location.href:c}catch(l){return c}}if(s.open(a.method,o(a.url),!0),a.credentials==="include"?s.withCredentials=!0:a.credentials==="omit"&&(s.withCredentials=!1),"responseType"in s&&(Xe.blob?s.responseType="blob":Xe.arrayBuffer&&(s.responseType="arraybuffer")),e&&typeof e.headers=="object"&&!(e.headers instanceof xe||je.Headers&&e.headers instanceof je.Headers)){var u=[];Object.getOwnPropertyNames(e.headers).forEach(function(c){u.push(_s(c)),s.setRequestHeader(c,bd(e.headers[c]))}),a.headers.forEach(function(c,l){u.indexOf(l)===-1&&s.setRequestHeader(l,c)})}else a.headers.forEach(function(c,l){s.setRequestHeader(l,c)});a.signal&&(a.signal.addEventListener("abort",i),s.onreadystatechange=function(){s.readyState===4&&a.signal.removeEventListener("abort",i)}),s.send(typeof a._bodyInit=="undefined"?null:a._bodyInit)})}ab.polyfill=!0;je.fetch||(je.fetch=ab,je.Headers=xe,je.Request=la,je.Response=hr);var uI="0.5.11",cI=Object.defineProperty,lI=(n,e,t)=>e in n?cI(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,wd=(n,e,t)=>(lI(n,typeof e!="symbol"?e+"":e,t),t),Ad=class n extends Error{constructor(e,t){super(e),this.error=e,this.status_code=t,this.name="ResponseError",Error.captureStackTrace&&Error.captureStackTrace(this,n)}},Ed=class{constructor(e,t,r){wd(this,"abortController"),wd(this,"itr"),wd(this,"doneCallback"),this.abortController=e,this.itr=t,this.doneCallback=r}abort(){this.abortController.abort()}async*[Symbol.asyncIterator](){for await(let e of this.itr){if("error"in e)throw new Error(e.error);if(yield e,e.done||e.status==="success"){this.doneCallback();return}}throw new Error("Did not receive done or success response in stream.")}},Od=async n=>{var r;if(n.ok)return;let e=`Error ${n.status}: ${n.statusText}`,t=null;if((r=n.headers.get("content-type"))!=null&&r.includes("application/json"))try{t=await n.json(),e=t.error||e}catch(a){console.log("Failed to parse error response as JSON")}else try{console.log("Getting text from response"),e=await n.text()||e}catch(a){console.log("Failed to get text from error response")}throw new Ad(e,n.status)};function dI(){return typeof window!="undefined"&&window.navigator?`${window.navigator.platform.toLowerCase()} Browser/${navigator.userAgent};`:typeof process!="undefined"?`${process.arch} ${process.platform} Node.js/${process.version}`:""}var xd=async(n,e,t={})=>{let r={"Content-Type":"application/json",Accept:"application/json","User-Agent":`ollama-js/${uI} (${dI()})`};t.headers||(t.headers={});let a=Object.fromEntries(Object.entries(t.headers).filter(([s])=>!Object.keys(r).some(i=>i.toLowerCase()===s.toLowerCase())));return t.headers={...r,...a},n(e,t)},sb=async(n,e,t)=>{let r=await xd(n,e,{headers:t==null?void 0:t.headers});return await Od(r),r};var ws=async(n,e,t,r)=>{let s=(o=>o!==null&&typeof o=="object"&&!Array.isArray(o))(t)?JSON.stringify(t):t,i=await xd(n,e,{method:"POST",body:s,signal:r==null?void 0:r.signal,headers:r==null?void 0:r.headers});return await Od(i),i},hI=async(n,e,t,r)=>{let a=await xd(n,e,{method:"DELETE",body:JSON.stringify(t),headers:r==null?void 0:r.headers});return await Od(a),a},fI=async function*(n){var a;let e=new TextDecoder("utf-8"),t="",r=n.getReader();for(;;){let{done:s,value:i}=await r.read();if(s)break;t+=e.decode(i);let o=t.split(`
`);t=(a=o.pop())!=null?a:"";for(let u of o)try{yield JSON.parse(u)}catch(c){console.warn("invalid json: ",u)}}for(let s of t.split(`
`).filter(i=>i!==""))try{yield JSON.parse(s)}catch(i){console.warn("invalid json: ",s)}},pI=n=>{if(!n)return"http://127.0.0.1:11434";let e=n.includes("://");n.startsWith(":")&&(n=`http://127.0.0.1${n}`,e=!0),e||(n=`http://${n}`);let t=new URL(n),r=t.port;r||(e?r=t.protocol==="https:"?"443":"80":r="11434");let a=`${t.protocol}//${t.hostname}:${r}${t.pathname}`;return a.endsWith("/")&&(a=a.slice(0,-1)),a},mI=Object.defineProperty,gI=(n,e,t)=>e in n?mI(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,vd=(n,e,t)=>(gI(n,typeof e!="symbol"?e+"":e,t),t),vs=class{constructor(e){var t,r;vd(this,"config"),vd(this,"fetch"),vd(this,"ongoingStreamedRequests",[]),this.config={host:"",headers:e==null?void 0:e.headers},e!=null&&e.proxy||(this.config.host=pI((t=e==null?void 0:e.host)!=null?t:"http://127.0.0.1:11434")),this.fetch=(r=e==null?void 0:e.fetch)!=null?r:fetch}abort(){for(let e of this.ongoingStreamedRequests)e.abort();this.ongoingStreamedRequests.length=0}async processStreamableRequest(e,t){var s;t.stream=(s=t.stream)!=null?s:!1;let r=`${this.config.host}/api/${e}`;if(t.stream){let i=new AbortController,o=await ws(this.fetch,r,t,{signal:i.signal,headers:this.config.headers});if(!o.body)throw new Error("Missing body");let u=fI(o.body),c=new Ed(i,u,()=>{let l=this.ongoingStreamedRequests.indexOf(c);l>-1&&this.ongoingStreamedRequests.splice(l,1)});return this.ongoingStreamedRequests.push(c),c}return await(await ws(this.fetch,r,t,{headers:this.config.headers})).json()}async encodeImage(e){if(typeof e!="string"){let t=new Uint8Array(e),r="",a=t.byteLength;for(let s=0;s<a;s++)r+=String.fromCharCode(t[s]);return btoa(r)}return e}async generate(e){return e.images&&(e.images=await Promise.all(e.images.map(this.encodeImage.bind(this)))),this.processStreamableRequest("generate",e)}async chat(e){if(e.messages)for(let t of e.messages)t.images&&(t.images=await Promise.all(t.images.map(this.encodeImage.bind(this))));return this.processStreamableRequest("chat",e)}async create(e){return this.processStreamableRequest("create",{name:e.model,stream:e.stream,modelfile:e.modelfile,quantize:e.quantize})}async pull(e){return this.processStreamableRequest("pull",{name:e.model,stream:e.stream,insecure:e.insecure})}async push(e){return this.processStreamableRequest("push",{name:e.model,stream:e.stream,insecure:e.insecure})}async delete(e){return await hI(this.fetch,`${this.config.host}/api/delete`,{name:e.model},{headers:this.config.headers}),{status:"success"}}async copy(e){return await ws(this.fetch,`${this.config.host}/api/copy`,{...e},{headers:this.config.headers}),{status:"success"}}async list(){return await(await sb(this.fetch,`${this.config.host}/api/tags`,{headers:this.config.headers})).json()}async show(e){return await(await ws(this.fetch,`${this.config.host}/api/show`,{...e},{headers:this.config.headers})).json()}async embed(e){return await(await ws(this.fetch,`${this.config.host}/api/embed`,{...e},{headers:this.config.headers})).json()}async embeddings(e){return await(await ws(this.fetch,`${this.config.host}/api/embeddings`,{...e},{headers:this.config.headers})).json()}async ps(){return await(await sb(this.fetch,`${this.config.host}/api/ps`,{headers:this.config.headers})).json()}},yI=new vs;function Id(n,e){var t,r;return new Te({content:(t=n.content)!=null?t:"",tool_call_chunks:(r=n.tool_calls)==null?void 0:r.map(a=>({name:a.function.name,args:JSON.stringify(a.function.arguments),type:"tool_call_chunk",index:0,id:pe()})),response_metadata:e==null?void 0:e.responseMetadata,usage_metadata:e==null?void 0:e.usageMetadata})}function ib(n){let e=n.match(/^data:.*?;base64,(.*)$/);return e?e[1]:""}function bI(n){var a,s,i;if(typeof n.content=="string")return[{role:"assistant",content:n.content}];let t=n.content.filter(o=>o.type==="text"&&typeof o.text=="string").map(o=>({role:"assistant",content:o.text})),r;if(n.content.find(o=>o.type==="tool_use")&&((a=n.tool_calls)!=null&&a.length)){let o=(s=n.tool_calls)==null?void 0:s.map(u=>({id:u.id,type:"function",function:{name:u.name,arguments:u.args}}));o&&(r={role:"assistant",tool_calls:o,content:""})}else if(n.content.find(o=>o.type==="tool_use")&&!((i=n.tool_calls)!=null&&i.length))throw new Error("'tool_use' content type is not supported without tool calls.");return[...t,...r?[r]:[]]}function _I(n){return typeof n.content=="string"?[{role:"user",content:n.content}]:n.content.map(e=>{if(e.type==="text")return{role:"user",content:e.text};if(e.type==="image_url"){if(typeof e.image_url=="string")return{role:"user",content:"",images:[ib(e.image_url)]};if(e.image_url.url&&typeof e.image_url.url=="string")return{role:"user",content:"",images:[ib(e.image_url.url)]}}throw new Error(`Unsupported content type: ${e.type}`)})}function wI(n){if(typeof n.content=="string")return[{role:"system",content:n.content}];if(n.content.every(e=>e.type==="text"&&typeof e.text=="string"))return n.content.map(e=>({role:"system",content:e.text}));throw new Error(`Unsupported content type(s): ${n.content.map(e=>e.type).join(", ")}`)}function vI(n){if(typeof n.content!="string")throw new Error("Non string tool message content is not supported");return[{role:"tool",content:n.content}]}function ob(n){return n.flatMap(e=>{if(["human","generic"].includes(e._getType()))return _I(e);if(e._getType()==="ai")return bI(e);if(e._getType()==="system")return wI(e);if(e._getType()==="tool")return vI(e);throw new Error(`Unsupported message type: ${e._getType()}`)})}var Fu=class extends sn{static lc_name(){return"ChatOllama"}constructor(e){var t,r,a;super(e!=null?e:{}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"llama3"}),Object.defineProperty(this,"numa",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numCtx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numBatch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mainGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowVram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"f16Kv",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitsAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vocabOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMmap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMlock",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"embeddingOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numThread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numKeep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numPredict",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tfsZ",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"typicalP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatLastN",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatTau",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatEta",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"penalizeNewline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keepAlive",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkOrPullModel",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:"http://127.0.0.1:11434"}),this.client=new vs({host:e==null?void 0:e.baseUrl,headers:e==null?void 0:e.headers}),this.baseUrl=(t=e==null?void 0:e.baseUrl)!=null?t:this.baseUrl,this.model=(r=e==null?void 0:e.model)!=null?r:this.model,this.numa=e==null?void 0:e.numa,this.numCtx=e==null?void 0:e.numCtx,this.numBatch=e==null?void 0:e.numBatch,this.numGpu=e==null?void 0:e.numGpu,this.mainGpu=e==null?void 0:e.mainGpu,this.lowVram=e==null?void 0:e.lowVram,this.f16Kv=e==null?void 0:e.f16Kv,this.logitsAll=e==null?void 0:e.logitsAll,this.vocabOnly=e==null?void 0:e.vocabOnly,this.useMmap=e==null?void 0:e.useMmap,this.useMlock=e==null?void 0:e.useMlock,this.embeddingOnly=e==null?void 0:e.embeddingOnly,this.numThread=e==null?void 0:e.numThread,this.numKeep=e==null?void 0:e.numKeep,this.seed=e==null?void 0:e.seed,this.numPredict=e==null?void 0:e.numPredict,this.topK=e==null?void 0:e.topK,this.topP=e==null?void 0:e.topP,this.tfsZ=e==null?void 0:e.tfsZ,this.typicalP=e==null?void 0:e.typicalP,this.repeatLastN=e==null?void 0:e.repeatLastN,this.temperature=e==null?void 0:e.temperature,this.repeatPenalty=e==null?void 0:e.repeatPenalty,this.presencePenalty=e==null?void 0:e.presencePenalty,this.frequencyPenalty=e==null?void 0:e.frequencyPenalty,this.mirostat=e==null?void 0:e.mirostat,this.mirostatTau=e==null?void 0:e.mirostatTau,this.mirostatEta=e==null?void 0:e.mirostatEta,this.penalizeNewline=e==null?void 0:e.penalizeNewline,this.streaming=e==null?void 0:e.streaming,this.format=e==null?void 0:e.format,this.keepAlive=e==null?void 0:e.keepAlive,this.checkOrPullModel=(a=e==null?void 0:e.checkOrPullModel)!=null?a:this.checkOrPullModel}_llmType(){return"ollama"}async pull(e,t){let{stream:r,insecure:a,logProgress:s}={stream:!0,...t};if(r)for await(let i of await this.client.pull({model:e,insecure:a,stream:r}))s&&console.log(i);else{let i=await this.client.pull({model:e,insecure:a});s&&console.log(i)}}bindTools(e,t){return this.bind({tools:e.map(r=>$u(r)),...t})}getLsParams(e){var r,a,s,i;let t=this.invocationParams(e);return{ls_provider:"ollama",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:(a=(r=t.options)==null?void 0:r.temperature)!=null?a:void 0,ls_max_tokens:(i=(s=t.options)==null?void 0:s.num_predict)!=null?i:void 0,ls_stop:e.stop}}invocationParams(e){var t;if(e!=null&&e.tool_choice)throw new Error("Tool choice is not supported for ChatOllama.");return{model:this.model,format:this.format,keep_alive:this.keepAlive,options:{numa:this.numa,num_ctx:this.numCtx,num_batch:this.numBatch,num_gpu:this.numGpu,main_gpu:this.mainGpu,low_vram:this.lowVram,f16_kv:this.f16Kv,logits_all:this.logitsAll,vocab_only:this.vocabOnly,use_mmap:this.useMmap,use_mlock:this.useMlock,embedding_only:this.embeddingOnly,num_thread:this.numThread,num_keep:this.numKeep,seed:this.seed,num_predict:this.numPredict,top_k:this.topK,top_p:this.topP,tfs_z:this.tfsZ,typical_p:this.typicalP,repeat_last_n:this.repeatLastN,temperature:this.temperature,repeat_penalty:this.repeatPenalty,presence_penalty:this.presencePenalty,frequency_penalty:this.frequencyPenalty,mirostat:this.mirostat,mirostat_tau:this.mirostatTau,mirostat_eta:this.mirostatEta,penalize_newline:this.penalizeNewline,stop:e==null?void 0:e.stop},tools:(t=e==null?void 0:e.tools)!=null&&t.length?e.tools.map(r=>$u(r)):void 0}}async checkModelExistsOnMachine(e){let{models:t}=await this.client.list();return!!t.find(r=>r.name===e||r.name===`${e}:latest`)}async _generate(e,t,r){var i;this.checkOrPullModel&&(await this.checkModelExistsOnMachine(this.model)||await this.pull(this.model,{logProgress:!0}));let a;for await(let o of this._streamResponseChunks(e,t,r))a?a=Se(a,o.message):a=o.message;let s=new Me({id:a==null?void 0:a.id,content:(i=a==null?void 0:a.content)!=null?i:"",tool_calls:a==null?void 0:a.tool_calls,response_metadata:a==null?void 0:a.response_metadata,usage_metadata:a==null?void 0:a.usage_metadata});return{generations:[{text:typeof s.content=="string"?s.content:"",message:s}]}}async*_streamResponseChunks(e,t,r){var c,l,d,h,f,p,m;this.checkOrPullModel&&(await this.checkModelExistsOnMachine(this.model)||await this.pull(this.model,{logProgress:!0}));let a=this.invocationParams(t),s=ob(e),i={input_tokens:0,output_tokens:0,total_tokens:0};if(a.tools&&a.tools.length>0){let g=await this.client.chat({...a,messages:s,stream:!1}),{message:y,...b}=g;return i.input_tokens+=(c=b.prompt_eval_count)!=null?c:0,i.output_tokens+=(l=b.eval_count)!=null?l:0,i.total_tokens=i.input_tokens+i.output_tokens,yield new ct({text:y.content,message:Id(y,{responseMetadata:b,usageMetadata:i})}),r==null?void 0:r.handleLLMNewToken(y.content)}let o=await this.client.chat({...a,messages:s,stream:!0}),u;for await(let g of o){(d=t.signal)!=null&&d.aborted&&this.client.abort();let{message:y,...b}=g;i.input_tokens+=(h=b.prompt_eval_count)!=null?h:0,i.output_tokens+=(f=b.eval_count)!=null?f:0,i.total_tokens=i.input_tokens+i.output_tokens,u=b,yield new ct({text:(p=y.content)!=null?p:"",message:Id(y)}),await(r==null?void 0:r.handleLLMNewToken((m=y.content)!=null?m:""))}yield new ct({text:"",message:new Te({content:"",response_metadata:u,usage_metadata:i})})}};var ub;(function(n){n.STRING="string",n.NUMBER="number",n.INTEGER="integer",n.BOOLEAN="boolean",n.ARRAY="array",n.OBJECT="object"})(ub||(ub={}));var cb;(function(n){n.LANGUAGE_UNSPECIFIED="language_unspecified",n.PYTHON="python"})(cb||(cb={}));var lb;(function(n){n.OUTCOME_UNSPECIFIED="outcome_unspecified",n.OUTCOME_OK="outcome_ok",n.OUTCOME_FAILED="outcome_failed",n.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"})(lb||(lb={}));var db=["user","model","function","system"],hb;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",n.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY"})(hb||(hb={}));var fb;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(fb||(fb={}));var pb;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(pb||(pb={}));var mb;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER"})(mb||(mb={}));var $i;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.LANGUAGE="LANGUAGE",n.BLOCKLIST="BLOCKLIST",n.PROHIBITED_CONTENT="PROHIBITED_CONTENT",n.SPII="SPII",n.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",n.OTHER="OTHER"})($i||($i={}));var gb;(function(n){n.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",n.RETRIEVAL_QUERY="RETRIEVAL_QUERY",n.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",n.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",n.CLASSIFICATION="CLASSIFICATION",n.CLUSTERING="CLUSTERING"})(gb||(gb={}));var da;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.AUTO="AUTO",n.ANY="ANY",n.NONE="NONE"})(da||(da={}));var yb;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.MODE_DYNAMIC="MODE_DYNAMIC"})(yb||(yb={}));var ke=class extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}},on=class extends ke{constructor(e,t){super(e),this.response=t}},zu=class extends ke{constructor(e,t,r,a){super(e),this.status=t,this.statusText=r,this.errorDetails=a}},fr=class extends ke{},Bu=class extends ke{};var AI="https://generativelanguage.googleapis.com",EI="v1beta",OI="0.24.0",xI="genai-js",ha;(function(n){n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents"})(ha||(ha={}));var Pd=class{constructor(e,t,r,a,s){this.model=e,this.task=t,this.apiKey=r,this.stream=a,this.requestOptions=s}toString(){var e,t;let r=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||EI,s=`${((t=this.requestOptions)===null||t===void 0?void 0:t.baseUrl)||AI}/${r}/${this.model}:${this.task}`;return this.stream&&(s+="?alt=sse"),s}};function II(n){let e=[];return n!=null&&n.apiClient&&e.push(n.apiClient),e.push(`${xI}/${OI}`),e.join(" ")}async function PI(n){var e;let t=new Headers;t.append("Content-Type","application/json"),t.append("x-goog-api-client",II(n.requestOptions)),t.append("x-goog-api-key",n.apiKey);let r=(e=n.requestOptions)===null||e===void 0?void 0:e.customHeaders;if(r){if(!(r instanceof Headers))try{r=new Headers(r)}catch(a){throw new fr(`unable to convert customHeaders value ${JSON.stringify(r)} to Headers: ${a.message}`)}for(let[a,s]of r.entries()){if(a==="x-goog-api-key")throw new fr(`Cannot set reserved header name ${a}`);if(a==="x-goog-api-client")throw new fr(`Header name ${a} can only be set using the apiClient field`);t.append(a,s)}}return t}async function TI(n,e,t,r,a,s){let i=new Pd(n,e,t,r,s);return{url:i.toString(),fetchOptions:Object.assign(Object.assign({},RI(s)),{method:"POST",headers:await PI(i),body:a})}}async function Di(n,e,t,r,a,s={},i=fetch){let{url:o,fetchOptions:u}=await TI(n,e,t,r,a,s);return SI(o,u,i)}async function SI(n,e,t=fetch){let r;try{r=await t(n,e)}catch(a){CI(a,n)}return r.ok||await kI(r,n),r}function CI(n,e){let t=n;throw t.name==="AbortError"?(t=new Bu(`Request aborted when fetching ${e.toString()}: ${n.message}`),t.stack=n.stack):n instanceof zu||n instanceof fr||(t=new ke(`Error fetching from ${e.toString()}: ${n.message}`),t.stack=n.stack),t}async function kI(n,e){let t="",r;try{let a=await n.json();t=a.error.message,a.error.details&&(t+=` ${JSON.stringify(a.error.details)}`,r=a.error.details)}catch(a){}throw new zu(`Error fetching from ${e.toString()}: [${n.status} ${n.statusText}] ${t}`,n.status,n.statusText,r)}function RI(n){let e={};if((n==null?void 0:n.signal)!==void 0||(n==null?void 0:n.timeout)>=0){let t=new AbortController;(n==null?void 0:n.timeout)>=0&&setTimeout(()=>t.abort(),n.timeout),n!=null&&n.signal&&n.signal.addEventListener("abort",()=>{t.abort()}),e.signal=t.signal}return e}function Sd(n){return n.text=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),Uu(n.candidates[0]))throw new on(`${un(n)}`,n);return NI(n)}else if(n.promptFeedback)throw new on(`Text not available. ${un(n)}`,n);return""},n.functionCall=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Uu(n.candidates[0]))throw new on(`${un(n)}`,n);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),bb(n)[0]}else if(n.promptFeedback)throw new on(`Function call not available. ${un(n)}`,n)},n.functionCalls=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Uu(n.candidates[0]))throw new on(`${un(n)}`,n);return bb(n)}else if(n.promptFeedback)throw new on(`Function call not available. ${un(n)}`,n)},n}function NI(n){var e,t,r,a;let s=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(let i of(a=(r=n.candidates)===null||r===void 0?void 0:r[0].content)===null||a===void 0?void 0:a.parts)i.text&&s.push(i.text),i.executableCode&&s.push("\n```"+i.executableCode.language+`
`+i.executableCode.code+"\n```\n"),i.codeExecutionResult&&s.push("\n```\n"+i.codeExecutionResult.output+"\n```\n");return s.length>0?s.join(""):""}function bb(n){var e,t,r,a;let s=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(let i of(a=(r=n.candidates)===null||r===void 0?void 0:r[0].content)===null||a===void 0?void 0:a.parts)i.functionCall&&s.push(i.functionCall);if(s.length>0)return s}var $I=[$i.RECITATION,$i.SAFETY,$i.LANGUAGE];function Uu(n){return!!n.finishReason&&$I.includes(n.finishReason)}function un(n){var e,t,r;let a="";if((!n.candidates||n.candidates.length===0)&&n.promptFeedback)a+="Response was blocked",!((e=n.promptFeedback)===null||e===void 0)&&e.blockReason&&(a+=` due to ${n.promptFeedback.blockReason}`),!((t=n.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(a+=`: ${n.promptFeedback.blockReasonMessage}`);else if(!((r=n.candidates)===null||r===void 0)&&r[0]){let s=n.candidates[0];Uu(s)&&(a+=`Candidate was blocked due to ${s.finishReason}`,s.finishMessage&&(a+=`: ${s.finishMessage}`))}return a}function ji(n){return this instanceof ji?(this.v=n,this):new ji(n)}function jI(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(n,e||[]),a,s=[];return a={},i("next"),i("throw"),i("return"),a[Symbol.asyncIterator]=function(){return this},a;function i(h){r[h]&&(a[h]=function(f){return new Promise(function(p,m){s.push([h,f,p,m])>1||o(h,f)})})}function o(h,f){try{u(r[h](f))}catch(p){d(s[0][3],p)}}function u(h){h.value instanceof ji?Promise.resolve(h.value.v).then(c,l):d(s[0][2],h)}function c(h){o("next",h)}function l(h){o("throw",h)}function d(h,f){h(f),s.shift(),s.length&&o(s[0][0],s[0][1])}}var _b=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function LI(n){let e=n.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=FI(e),[r,a]=t.tee();return{stream:MI(r),response:DI(a)}}async function DI(n){let e=[],t=n.getReader();for(;;){let{done:r,value:a}=await t.read();if(r)return Sd(UI(e));e.push(a)}}function MI(n){return jI(this,arguments,function*(){let t=n.getReader();for(;;){let{value:r,done:a}=yield ji(t.read());if(a)break;yield yield ji(Sd(r))}})}function FI(n){let e=n.getReader();return new ReadableStream({start(r){let a="";return s();function s(){return e.read().then(({value:i,done:o})=>{if(o){if(a.trim()){r.error(new ke("Failed to parse stream"));return}r.close();return}a+=i;let u=a.match(_b),c;for(;u;){try{c=JSON.parse(u[1])}catch(l){r.error(new ke(`Error parsing JSON response: "${u[1]}"`));return}r.enqueue(c),a=a.substring(u[0].length),u=a.match(_b)}return s()}).catch(i=>{let o=i;throw o.stack=i.stack,o.name==="AbortError"?o=new Bu("Request aborted when reading from the stream"):o=new ke("Error reading from the stream"),o})}}})}function UI(n){let e=n[n.length-1],t={promptFeedback:e==null?void 0:e.promptFeedback};for(let r of n){if(r.candidates){let a=0;for(let s of r.candidates)if(t.candidates||(t.candidates=[]),t.candidates[a]||(t.candidates[a]={index:a}),t.candidates[a].citationMetadata=s.citationMetadata,t.candidates[a].groundingMetadata=s.groundingMetadata,t.candidates[a].finishReason=s.finishReason,t.candidates[a].finishMessage=s.finishMessage,t.candidates[a].safetyRatings=s.safetyRatings,s.content&&s.content.parts){t.candidates[a].content||(t.candidates[a].content={role:s.content.role||"user",parts:[]});let i={};for(let o of s.content.parts)o.text&&(i.text=o.text),o.functionCall&&(i.functionCall=o.functionCall),o.executableCode&&(i.executableCode=o.executableCode),o.codeExecutionResult&&(i.codeExecutionResult=o.codeExecutionResult),Object.keys(i).length===0&&(i.text=""),t.candidates[a].content.parts.push(i)}a++}r.usageMetadata&&(t.usageMetadata=r.usageMetadata)}return t}async function Ob(n,e,t,r){let a=await Di(e,ha.STREAM_GENERATE_CONTENT,n,!0,JSON.stringify(t),r);return LI(a)}async function xb(n,e,t,r){let s=await(await Di(e,ha.GENERATE_CONTENT,n,!1,JSON.stringify(t),r)).json();return{response:Sd(s)}}function Ib(n){if(n!=null){if(typeof n=="string")return{role:"system",parts:[{text:n}]};if(n.text)return{role:"system",parts:[n]};if(n.parts)return n.role?n:{role:"system",parts:n.parts}}}function Li(n){let e=[];if(typeof n=="string")e=[{text:n}];else for(let t of n)typeof t=="string"?e.push({text:t}):e.push(t);return zI(e)}function zI(n){let e={role:"user",parts:[]},t={role:"function",parts:[]},r=!1,a=!1;for(let s of n)"functionResponse"in s?(t.parts.push(s),a=!0):(e.parts.push(s),r=!0);if(r&&a)throw new ke("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!a)throw new ke("No content is provided for sending chat message.");return r?e:t}function BI(n,e){var t;let r={model:e==null?void 0:e.model,generationConfig:e==null?void 0:e.generationConfig,safetySettings:e==null?void 0:e.safetySettings,tools:e==null?void 0:e.tools,toolConfig:e==null?void 0:e.toolConfig,systemInstruction:e==null?void 0:e.systemInstruction,cachedContent:(t=e==null?void 0:e.cachedContent)===null||t===void 0?void 0:t.name,contents:[]},a=n.generateContentRequest!=null;if(n.contents){if(a)throw new fr("CountTokensRequest must have one of contents or generateContentRequest, not both.");r.contents=n.contents}else if(a)r=Object.assign(Object.assign({},r),n.generateContentRequest);else{let s=Li(n);r.contents=[s]}return{generateContentRequest:r}}function wb(n){let e;return n.contents?e=n:e={contents:[Li(n)]},n.systemInstruction&&(e.systemInstruction=Ib(n.systemInstruction)),e}function qI(n){return typeof n=="string"||Array.isArray(n)?{content:Li(n)}:n}var vb=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],HI={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function VI(n){let e=!1;for(let t of n){let{role:r,parts:a}=t;if(!e&&r!=="user")throw new ke(`First content should be with role 'user', got ${r}`);if(!db.includes(r))throw new ke(`Each item should include role field. Got ${r} but valid roles are: ${JSON.stringify(db)}`);if(!Array.isArray(a))throw new ke("Content should have 'parts' property with an array of Parts");if(a.length===0)throw new ke("Each Content should have at least one part");let s={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(let o of a)for(let u of vb)u in o&&(s[u]+=1);let i=HI[r];for(let o of vb)if(!i.includes(o)&&s[o]>0)throw new ke(`Content with role '${r}' can't contain '${o}' part`);e=!0}}function Ab(n){var e;if(n.candidates===void 0||n.candidates.length===0)return!1;let t=(e=n.candidates[0])===null||e===void 0?void 0:e.content;if(t===void 0||t.parts===void 0||t.parts.length===0)return!1;for(let r of t.parts)if(r===void 0||Object.keys(r).length===0||r.text!==void 0&&r.text==="")return!1;return!0}var Eb="SILENT_ERROR",Td=class{constructor(e,t,r,a={}){this.model=t,this.params=r,this._requestOptions=a,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,r!=null&&r.history&&(VI(r.history),this._history=r.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var r,a,s,i,o,u;await this._sendPromise;let c=Li(e),l={safetySettings:(r=this.params)===null||r===void 0?void 0:r.safetySettings,generationConfig:(a=this.params)===null||a===void 0?void 0:a.generationConfig,tools:(s=this.params)===null||s===void 0?void 0:s.tools,toolConfig:(i=this.params)===null||i===void 0?void 0:i.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(u=this.params)===null||u===void 0?void 0:u.cachedContent,contents:[...this._history,c]},d=Object.assign(Object.assign({},this._requestOptions),t),h;return this._sendPromise=this._sendPromise.then(()=>xb(this._apiKey,this.model,l,d)).then(f=>{var p;if(Ab(f.response)){this._history.push(c);let m=Object.assign({parts:[],role:"model"},(p=f.response.candidates)===null||p===void 0?void 0:p[0].content);this._history.push(m)}else{let m=un(f.response);m&&console.warn(`sendMessage() was unsuccessful. ${m}. Inspect response object for details.`)}h=f}),await this._sendPromise,h}async sendMessageStream(e,t={}){var r,a,s,i,o,u;await this._sendPromise;let c=Li(e),l={safetySettings:(r=this.params)===null||r===void 0?void 0:r.safetySettings,generationConfig:(a=this.params)===null||a===void 0?void 0:a.generationConfig,tools:(s=this.params)===null||s===void 0?void 0:s.tools,toolConfig:(i=this.params)===null||i===void 0?void 0:i.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(u=this.params)===null||u===void 0?void 0:u.cachedContent,contents:[...this._history,c]},d=Object.assign(Object.assign({},this._requestOptions),t),h=Ob(this._apiKey,this.model,l,d);return this._sendPromise=this._sendPromise.then(()=>h).catch(f=>{throw new Error(Eb)}).then(f=>f.response).then(f=>{if(Ab(f)){this._history.push(c);let p=Object.assign({},f.candidates[0].content);p.role||(p.role="model"),this._history.push(p)}else{let p=un(f);p&&console.warn(`sendMessageStream() was unsuccessful. ${p}. Inspect response object for details.`)}}).catch(f=>{f.message!==Eb&&console.error(f)}),h}};async function GI(n,e,t,r){return(await Di(e,ha.COUNT_TOKENS,n,!1,JSON.stringify(t),r)).json()}async function KI(n,e,t,r){return(await Di(e,ha.EMBED_CONTENT,n,!1,JSON.stringify(t),r)).json()}async function ZI(n,e,t,r){let a=t.requests.map(i=>Object.assign(Object.assign({},i),{model:e}));return(await Di(e,ha.BATCH_EMBED_CONTENTS,n,!1,JSON.stringify({requests:a}),r)).json()}var qu=class{constructor(e,t,r={}){this.apiKey=e,this._requestOptions=r,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=Ib(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var r;let a=wb(e),s=Object.assign(Object.assign({},this._requestOptions),t);return xb(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(r=this.cachedContent)===null||r===void 0?void 0:r.name},a),s)}async generateContentStream(e,t={}){var r;let a=wb(e),s=Object.assign(Object.assign({},this._requestOptions),t);return Ob(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(r=this.cachedContent)===null||r===void 0?void 0:r.name},a),s)}startChat(e){var t;return new Td(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(t=this.cachedContent)===null||t===void 0?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){let r=BI(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),a=Object.assign(Object.assign({},this._requestOptions),t);return GI(this.apiKey,this.model,r,a)}async embedContent(e,t={}){let r=qI(e),a=Object.assign(Object.assign({},this._requestOptions),t);return KI(this.apiKey,this.model,r,a)}async batchEmbedContents(e,t={}){let r=Object.assign(Object.assign({},this._requestOptions),t);return ZI(this.apiKey,this.model,e,r)}};var As=class{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new ke("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new qu(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,r){if(!e.name)throw new fr("Cached content must contain a `name` field.");if(!e.model)throw new fr("Cached content must contain a `model` field.");let a=["model","systemInstruction"];for(let i of a)if(t!=null&&t[i]&&e[i]&&(t==null?void 0:t[i])!==e[i]){if(i==="model"){let o=t.model.startsWith("models/")?t.model.replace("models/",""):t.model,u=e.model.startsWith("models/")?e.model.replace("models/",""):e.model;if(o===u)continue}throw new fr(`Different value for "${i}" specified in modelParams (${t[i]}) and cachedContent (${e[i]})`)}let s=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new qu(this.apiKey,s,r)}};function pr(n){if(typeof n=="object"&&n!==null){let e={...n};"additionalProperties"in e&&delete e.additionalProperties,"$schema"in e&&delete e.$schema,"strict"in e&&delete e.strict;for(let t in e)t in e&&(Array.isArray(e[t])?e[t]=e[t].map(pr):typeof e[t]=="object"&&e[t]!==null&&(e[t]=pr(e[t])));return e}return n}function Mi(n){let e=pr(lt(n)),{$schema:t,...r}=e;return r}function Pb(n){let e=pr(n),{$schema:t,...r}=e;return r}function JI(n){var t;let e=n._getType();return ar.isInstance(n)?n.role:e==="tool"?e:(t=n.name)!=null?t:e}function WI(n){switch(n){case"ai":case"model":return"model";case"system":return"system";case"human":return"user";case"tool":case"function":return"function";default:throw new Error(`Unknown / unsupported author: ${n}`)}}function YI(n){if("mimeType"in n&&"data"in n)return{inlineData:{mimeType:n.mimeType,data:n.data}};if("mimeType"in n&&"fileUri"in n)return{fileData:{mimeType:n.mimeType,fileUri:n.fileUri}};throw new Error("Invalid media content")}function XI(n,e){if(typeof n.content=="string"&&n.content!=="")return[{text:n.content}];let t=[],r=[],a=[];return"tool_calls"in n&&Array.isArray(n.tool_calls)&&n.tool_calls.length>0?t=n.tool_calls.map(s=>({functionCall:{name:s.name,args:s.args}})):n.getType()==="tool"&&n.name&&n.content?r=[{functionResponse:{name:n.name,response:n.content}}]:Array.isArray(n.content)&&(a=n.content.map(s=>{var i;if(s.type==="text")return{text:s.text};if(s.type==="executableCode")return{executableCode:s.executableCode};if(s.type==="codeExecutionResult")return{codeExecutionResult:s.codeExecutionResult};if(s.type==="image_url"){if(!e)throw new Error("This model does not support images");let o;if(typeof s.image_url=="string")o=s.image_url;else if(typeof s.image_url=="object"&&"url"in s.image_url)o=s.image_url.url;else throw new Error("Please provide image as base64 encoded data URL");let[u,c]=o.split(",");if(!u.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");let[l,d]=u.replace(/^data:/,"").split(";");if(d!=="base64")throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:c,mimeType:l}}}else{if(s.type==="media")return YI(s);if(s.type==="tool_use")return{functionCall:{name:s.name,args:s.input}};if((i=s.type)!=null&&i.includes("/")&&s.type.split("/").length===2&&"data"in s&&typeof s.data=="string")return{inlineData:{mimeType:s.type,data:s.data}}}throw new Error(`Unknown content type ${s.type}`)})),[...a,...t,...r]}function Cd(n,e,t=!1){return n.reduce((r,a,s)=>{if(!Kr(a))throw new Error("Unsupported message input");let i=JI(a);if(i==="system"&&s!==0)throw new Error("System message should be the first one");let o=WI(i),u=r.content[r.content.length];if(!r.mergeWithPreviousContent&&u&&u.role===o)throw new Error("Google Generative AI requires alternate messages between authors");let c=XI(a,e);if(r.mergeWithPreviousContent){let h=r.content[r.content.length-1];if(!h)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return h.parts.push(...c),{mergeWithPreviousContent:!1,content:r.content}}let l=o;(l==="function"||l==="system"&&!t)&&(l="user");let d={role:l,parts:c};return{mergeWithPreviousContent:i==="system"&&!t,content:[...r.content,d]}},{content:[],mergeWithPreviousContent:!1}).content}function Tb(n,e){var c,l,d;if(!n.candidates||n.candidates.length===0||!n.candidates[0])return{generations:[],llmOutput:{filters:n.promptFeedback}};let t=n.functionCalls(),[r]=n.candidates,{content:a,...s}=r,i;(a==null?void 0:a.parts.length)===1&&a.parts[0].text?i=a.parts[0].text:i=a.parts.map(h=>"text"in h?{type:"text",text:h.text}:"executableCode"in h?{type:"executableCode",executableCode:h.executableCode}:"codeExecutionResult"in h?{type:"codeExecutionResult",codeExecutionResult:h.codeExecutionResult}:h);let o="";return typeof i=="string"?o=i:"text"in i[0]&&(o=i[0].text),{generations:[{text:o,message:new Me({content:i,tool_calls:t==null?void 0:t.map(h=>({...h,type:"tool_call"})),additional_kwargs:{...s},usage_metadata:e==null?void 0:e.usageMetadata}),generationInfo:s}],llmOutput:{tokenUsage:{promptTokens:(c=e==null?void 0:e.usageMetadata)==null?void 0:c.input_tokens,completionTokens:(l=e==null?void 0:e.usageMetadata)==null?void 0:l.output_tokens,totalTokens:(d=e==null?void 0:e.usageMetadata)==null?void 0:d.total_tokens}}}}function Sb(n,e){if(!n.candidates||n.candidates.length===0)return null;let t=n.functionCalls(),[r]=n.candidates,{content:a,...s}=r,i;a!=null&&a.parts&&a.parts.every(c=>"text"in c)?i=a.parts.map(c=>c.text).join(""):a.parts&&(i=a.parts.map(c=>"text"in c?{type:"text",text:c.text}:"executableCode"in c?{type:"executableCode",executableCode:c.executableCode}:"codeExecutionResult"in c?{type:"codeExecutionResult",codeExecutionResult:c.codeExecutionResult}:c));let o="";i&&typeof i=="string"?o=i:i&&typeof i=="object"&&"text"in i[0]&&(o=i[0].text);let u=[];return t&&u.push(...t.map(c=>({...c,args:JSON.stringify(c.args),index:e.index,type:"tool_call_chunk"}))),new ct({text:o,message:new Te({content:i||"",name:a?a.role:void 0,tool_call_chunks:u,additional_kwargs:{},usage_metadata:e.usageMetadata}),generationInfo:s})}function Cb(n){return n.every(e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations))?n:[{functionDeclarations:n.map(e=>{var t;if(ia(e)){let r=Mi(e.schema);return{name:e.name,description:e.description,parameters:r}}return gs(e)?{name:e.function.name,description:(t=e.function.description)!=null?t:"A function available to call.",parameters:Pb(e.function.parameters)}:e})}]}var Fi=class extends Pi{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){var t;super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=(t=e.returnSingle)!=null?t:this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new dr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let t=e.flatMap(s=>{let{message:i}=s;return!("tool_calls"in i)||!Array.isArray(i.tool_calls)?[]:i.tool_calls});if(t[0]===void 0)throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");let[r]=t;return await this._validateResult(r.args)}};function kd(n,e){let t=QI(n),r=tP(t,e);return{tools:t,toolConfig:r}}function QI(n){let e=[],t=[];return n.forEach(a=>{if(ia(a)){let[s]=Cb([a]);s.functionDeclarations&&e.push(...s.functionDeclarations)}else if(gs(a)){let{functionDeclarations:s}=eP(a);if(s)e.push(...s);else throw new Error("Failed to convert OpenAI structured tool to GenerativeAI tool")}else t.push(a)}),t.find(a=>"functionDeclarations"in a)?t.map(a=>{if((e==null?void 0:e.length)>0&&"functionDeclarations"in a){let s={functionDeclarations:[...a.functionDeclarations||[],...e]};return e=[],s}return a}):[...t,...e.length>0?[{functionDeclarations:e}]:[]]}function eP(n){return{functionDeclarations:[{name:n.function.name,description:n.function.description,parameters:pr(n.function.parameters)}]}}function tP(n,e){var s;if(!n.length||!e)return;let{toolChoice:t,allowedFunctionNames:r}=e,a={any:da.ANY,auto:da.AUTO,none:da.NONE};if(t&&["any","auto","none"].includes(t))return{functionCallingConfig:{mode:(s=a[t])!=null?s:"MODE_UNSPECIFIED",allowedFunctionNames:r}};if(typeof t=="string"||r)return{functionCallingConfig:{mode:da.ANY,allowedFunctionNames:[...r!=null?r:[],...t&&typeof t=="string"?[t]:[]]}}}var Hu=class extends sn{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get lc_aliases(){return{apiKey:"google_api_key"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")||this.model.startsWith("gemini-2")}constructor(e){var t,r,a,s,i,o,u,c,l;if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","google_genai"]}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"json",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"convertSystemMessageToHumanContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e.model.replace(/^models\//,""),this.maxOutputTokens=(t=e.maxOutputTokens)!=null?t:this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=(r=e.temperature)!=null?r:this.temperature,this.temperature&&(this.temperature<0||this.temperature>2))throw new Error("`temperature` must be in the range of [0.0,2.0]");if(this.topP=(a=e.topP)!=null?a:this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=(s=e.topK)!=null?s:this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=(i=e.stopSequences)!=null?i:this.stopSequences,this.apiKey=(o=e.apiKey)!=null?o:ae("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=(u=e.safetySettings)!=null?u:this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(h=>h.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=(c=e.streaming)!=null?c:this.streaming,this.json=e.json,this.client=new As(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK,...this.json?{responseMimeType:"application/json"}:{}}},{apiVersion:e.apiVersion,baseUrl:e.baseUrl}),this.streamUsage=(l=e.streamUsage)!=null?l:this.streamUsage}useCachedContent(e,t,r){this.apiKey&&(this.client=new As(this.apiKey).getGenerativeModelFromCachedContent(e,t,r))}get useSystemInstruction(){return typeof this.convertSystemMessageToHumanContent=="boolean"?!this.convertSystemMessageToHumanContent:this.computeUseSystemInstruction}get computeUseSystemInstruction(){return this.model==="gemini-1.0-pro-001"||this.model.startsWith("gemini-pro-vision")||this.model.startsWith("gemini-1.0-pro-vision")?!1:this.model!=="gemini-pro"}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){var r;return this.bind({tools:(r=kd(e))==null?void 0:r.tools,...t})}invocationParams(e){var r;let t=(r=e==null?void 0:e.tools)!=null&&r.length?kd(e.tools,{toolChoice:e.tool_choice,allowedFunctionNames:e.allowedFunctionNames}):void 0;return e!=null&&e.responseSchema?(this.client.generationConfig.responseSchema=e.responseSchema,this.client.generationConfig.responseMimeType="application/json"):(this.client.generationConfig.responseSchema=void 0,this.client.generationConfig.responseMimeType=this.json?"application/json":void 0),{...t!=null&&t.tools?{tools:t.tools}:{},...t!=null&&t.toolConfig?{toolConfig:t.toolConfig}:{}}}async _generate(e,t,r){var l,d,h,f,p,m;let a=Cd(e,this._isMultimodalModel,this.useSystemInstruction),s=a;if(a[0].role==="system"){let[g]=a;this.client.systemInstruction=g,s=a.slice(1)}let i=this.invocationParams(t);if(this.streaming){let g={},y=this._streamResponseChunks(e,t,r),b={};for await(let x of y){let _=(d=(l=x.generationInfo)==null?void 0:l.completion)!=null?d:0;b[_]===void 0?b[_]=x:b[_]=b[_].concat(x)}return{generations:Object.entries(b).sort(([x],[_])=>parseInt(x,10)-parseInt(_,10)).map(([x,_])=>_),llmOutput:{estimatedTokenUsage:g}}}let o=await this.completionWithRetry({...i,contents:s}),u;if("usageMetadata"in o.response){let g=o.response.usageMetadata;u={input_tokens:(h=g.promptTokenCount)!=null?h:0,output_tokens:(f=g.candidatesTokenCount)!=null?f:0,total_tokens:(p=g.totalTokenCount)!=null?p:0}}let c=Tb(o.response,{usageMetadata:u});return await(r==null?void 0:r.handleLLMNewToken((m=c.generations[0].text)!=null?m:"")),c}async*_streamResponseChunks(e,t,r){var d,h,f,p,m;let a=Cd(e,this._isMultimodalModel,this.useSystemInstruction),s=a;if(a[0].role==="system"){let[g]=a;this.client.systemInstruction=g,s=a.slice(1)}let o={...this.invocationParams(t),contents:s},u=await this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{let{stream:g}=await this.client.generateContentStream(o);return g}),c,l=0;for await(let g of u){if("usageMetadata"in g&&this.streamUsage!==!1&&t.streamUsage!==!1){let b=g.usageMetadata;if(!c)c={input_tokens:(d=b.promptTokenCount)!=null?d:0,output_tokens:(h=b.candidatesTokenCount)!=null?h:0,total_tokens:(f=b.totalTokenCount)!=null?f:0};else{let A=((p=b.candidatesTokenCount)!=null?p:0)-c.output_tokens;c={input_tokens:0,output_tokens:A,total_tokens:A}}}let y=Sb(g,{usageMetadata:c,index:l});l+=1,y&&(yield y,await(r==null?void 0:r.handleLLMNewToken((m=y.text)!=null?m:"")))}}async completionWithRetry(e,t){return this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{var r;try{return await this.client.generateContent(e)}catch(a){throw(r=a.message)!=null&&r.includes("400 Bad Request")&&(a.status=400),a}})}withStructuredOutput(e,t){var h,f;let r=e,a=t==null?void 0:t.name,s=t==null?void 0:t.method,i=t==null?void 0:t.includeRaw;if(s==="jsonMode")throw new Error('ChatGoogleGenerativeAI only supports "jsonSchema" or "functionCalling" as a method.');let o,u;if(s==="functionCalling"){let p=a!=null?a:"extract",m;if(an(r)){let g=Mi(r);m=[{functionDeclarations:[{name:p,description:(h=g.description)!=null?h:"A function available to call.",parameters:g}]}],u=new Fi({returnSingle:!0,keyName:p,zodSchema:r})}else{let g;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(g=r,g.parameters=pr(r.parameters),p=r.name):g={name:p,description:(f=r.description)!=null?f:"",parameters:pr(r)},m=[{functionDeclarations:[g]}],u=new Fi({returnSingle:!0,keyName:p})}o=this.bind({tools:m,tool_choice:p})}else{let p=an(r)?Mi(r):pr(r);o=this.bind({responseSchema:p}),u=new aa}if(!i)return o.pipe(u).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});let c=yt.assign({parsed:(p,m)=>u.invoke(p.raw,m)}),l=yt.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[l]});return qt.from([{raw:o},d]).withConfig({runName:"StructuredOutputRunnable"})}};var bt=require("obsidian");var Vu=require("@codemirror/state");var Es=Vu.StateEffect.define(),fa=Vu.StateField.define({create(){return null},update(n,e){if(e.effects.some(t=>t.is(Es))){let t=e.effects.find(r=>r.is(Es));return t?t.value:n}return e.effects.some(t=>t.is(Nt))?null:n}});function kb(n,e,t){for(let r of t){let a=`${e}${r.keyword}`;if(n.includes(a))return n.replace(a,r.prompt)}return n}var Os=class{constructor(e){V(this,"items",[]);V(this,"maxLength");this.maxLength=e}enqueue(e){this.items.length>0&&this.items[this.items.length-1]===e||(this.items.length>=this.maxLength&&this.items.shift(),this.items.push(e))}dequeue(){return this.items.shift()}peek(){return this.items[0]}size(){return this.items.length}isEmpty(){return this.items.length===0}getItems(){return[...this.items]}};var Rb=20,Gu=class{constructor(e,t){V(this,"chatClient");V(this,"app");V(this,"settings");V(this,"messageHistory");this.app=t,this.chatClient=this.initializeChatClient(e),this.settings=e,this.messageHistory=new Os(Rb)}extractAzureInstanceName(e){let t=e.trim(),r=t.match(/https:\/\/([^.]+)\.openai\.azure\.com/);if(r)return r[1];let a=t.match(/https:\/\/([^.]+)\.cognitiveservices\.azure\.com/);return a?a[1]:null}initializeChatClient(e){try{switch(e.messageHistory?this.messageHistory=new Os(Rb):this.messageHistory=new Os(0),e.provider){case"openai":return e.apiKey?new ua({modelName:e.model,temperature:0,apiKey:e.apiKey}):(new bt.Notice("\u26A0\uFE0F OpenAI API key is required. Please check your settings."),null);case"ollama":return new Fu({model:e.model});case"gemini":return new Hu({model:e.model,apiKey:e.apiKey});case"azure":if(!e.apiKey||!e.azureEndpoint)return new bt.Notice("\u26A0\uFE0F API key and Azure endpoint are required for Azure provider."),null;let t=this.extractAzureInstanceName(e.azureEndpoint);return t?new Du({azureOpenAIApiKey:e.apiKey,azureOpenAIApiInstanceName:t,azureOpenAIApiDeploymentName:e.model,azureOpenAIApiVersion:e.azureApiVersion||"2024-02-15-preview",temperature:0}):(new bt.Notice("\u26A0\uFE0F Invalid Azure endpoint format. Expected: https://your-resource.openai.azure.com"),null);case"custom":return!e.apiKey||!e.customURL?(new bt.Notice("\u26A0\uFE0F API key and custom base URL are required for custom providers."),null):new ua({modelName:e.model,temperature:0,openAIApiKey:e.apiKey,configuration:{baseURL:e.customURL.trim()}});default:return new bt.Notice(`\u26A0\uFE0F Unsupported provider: ${e.provider}`),null}}catch(t){return console.error("Error initializing chat client:",t),new bt.Notice(`\u274C Error initializing chat client: ${t.message}`),null}}async callApi(e,t){if(!this.chatClient)return new bt.Notice("\u26A0\uFE0F Chat client is not initialized. Please check your settings."),"\u26A0\uFE0F Chat client is not available.";let r=[new Zr(e),new pt(t)];try{let a=await this.chatClient.invoke(r);return typeof a=="string"?a:a.content.toString()}catch(a){return console.error("Error calling the chat model:",a),new bt.Notice(`\u274C Error calling the chat model: ${a.message}`),"\u26A0\uFE0F Failed to generate a response. Please try again later."}}async handleEditorUpdate(e,t){try{let r=await this.callApi(e,t);if(!r)return"\u26A0\uFE0F No response generated.";let a=this.app.workspace.getActiveViewOfType(bt.MarkdownView);if(!a)return new bt.Notice("\u26A0\uFE0F No active Markdown editor found."),"";let s=a.editor.cm;return s==null||s.dispatch({effects:Es.of({airesponse:r,prompt:t})}),r}catch(r){return console.error("Error processing request:",r),new bt.Notice(`\u274C Error processing request: ${r.message}`),"\u26A0\uFE0F Failed to process request."}}async callSelection(e,t){e=kb(e,this.settings.commandPrefix,this.settings.customCommands);let r=!1;t.trim().length===0&&(r=!0);let a=r?this.settings.cursorPrompt:this.settings.selectionPrompt,s="",i=r?"cursor":"selection";return this.settings.messageHistory&&this.messageHistory.enqueue({mode:i,userPrompt:e}),r?s=`
      **Task:** ${e}  
      **Output:**`:s=`
      **Task:** ${e}  
      **Input:**  
      ${t}

      **Output:**`,this.handleEditorUpdate(a,s)}updateSettings(e){this.settings=e;let t=this.initializeChatClient(e);t&&(this.chatClient=t)}getMessageHistory(){return this.messageHistory.getItems()}};var Ju=require("@codemirror/state"),_t=require("@codemirror/view"),Ku=wt(Nb());var Zu=class extends _t.WidgetType{constructor(t,r){super();this.content=t;this.type=r}toDOM(){let t=document.createElement("span");return t.className=`cm-change-widget cm-change-${this.type}`,t.textContent=this.content,t.setAttribute("aria-label",this.type==="added"?"Added content":"Removed content"),t.addEventListener("mousedown",r=>{r.preventDefault(),r.stopPropagation()}),t.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation()}),t}ignoreEvent(){return!0}};function rP(n){var e,t,r;try{let a=n.field(fa),s=n.field(mr),i=(e=a==null?void 0:a.airesponse)!=null?e:"",o=(t=s==null?void 0:s.text)!=null?t:"",u=new Ku.default,c=u.diff_main(o,i);u.diff_cleanupSemantic(c);let l=new Ju.RangeSetBuilder,d=(r=s==null?void 0:s.from)!=null?r:0;return c.forEach(([h,f])=>{let p=f.length;if(h===Ku.default.DIFF_INSERT){let m=new Zu(f,"added");l.add(d,d,_t.Decoration.widget({widget:m,side:1}))}else if(h===Ku.default.DIFF_DELETE){let m=new Zu(f,"removed");l.add(d,d+p,_t.Decoration.widget({widget:m,side:-1})),d+=p}else d+=p}),l.finish()}catch(a){return console.error("Error generating diff view:",a),_t.Decoration.none}}function nP(n,e){var t,r,a;try{let s=n.field(fa),i=n.field(mr),o=(t=s==null?void 0:s.airesponse)!=null?t:"",u=(r=i==null?void 0:i.from)!=null?r:0,c=(a=i==null?void 0:i.to)!=null?a:0;e.dispatch({changes:{from:u,to:c,insert:o}})}catch(s){console.error("Error applying diff changes:",s)}}var aP=Ju.StateField.define({create(){return _t.Decoration.none},update(n,e){return e.effects.some(r=>r.is(Es))?rP(e.state):e.effects.some(r=>r.is(Nt))?_t.Decoration.none:n},provide:n=>_t.EditorView.decorations.from(n)}),sP=_t.ViewPlugin.fromClass(class{update(n){for(let e of n.transactions)for(let t of e.effects)t.is(Ls)&&setTimeout(()=>{nP(n.state,n.view)},0)}}),iP=_t.ViewPlugin.fromClass(class{constructor(n){this.view=n;V(this,"onFocusOut",null);V(this,"onBlur",null);let e=t=>{var r;document.body.classList.contains("inlineai-widget-open")&&((r=t.stopImmediatePropagation)==null||r.call(t),t.stopPropagation())};this.onFocusOut=e,this.onBlur=e,this.view.dom.addEventListener("focusout",this.onFocusOut,!0),this.view.dom.addEventListener("blur",this.onBlur,!0),document.addEventListener("focusout",this.onFocusOut,!0),document.addEventListener("blur",this.onBlur,!0)}destroy(){try{this.onFocusOut&&(this.view.dom.removeEventListener("focusout",this.onFocusOut,!0),document.removeEventListener("focusout",this.onFocusOut,!0)),this.onBlur&&(this.view.dom.removeEventListener("blur",this.onBlur,!0),document.removeEventListener("blur",this.onBlur,!0))}catch(n){}}}),$b=[aP,sP,iP];var Wu=class extends Is.Plugin{constructor(){super(...arguments);V(this,"settings",Qu);V(this,"chatapi")}async onload(){await this.loadSettings(),this.chatapi=new Gu(this.settings,this.app),this.registerEditorExtension([sh(this.chatapi,this),fa,mr,th,$b]),this.addCommand({id:"show-cursor-tooltip",name:"Show cursor tooltip",callback:()=>{let t=this.app.workspace.getActiveViewOfType(Is.MarkdownView);if(t){let r=t.editor.cm,{from:a,to:s}=r.state.selection.main,i=[];if(a!==s){let o=r.state.doc.sliceString(a,s);i.push(Bi.of({from:a,to:s,text:o}))}else i.push(Bi.of({from:a,to:s,text:""}));i.push(tc.of(null)),r.dispatch({effects:i})}},hotkeys:[]}),this.addCommand({id:"accept-tooltip",name:"Accept tooltip suggestion",callback:()=>{let t=this.app.workspace.getActiveViewOfType(Is.MarkdownView);if(t){let r=t.editor.cm;r.state.field(fa,!1)&&(r.dispatch({effects:Ls.of(null)}),r.dispatch({effects:Nt.of(null)}))}}}),this.addCommand({id:"discard-tooltip",name:"Discard tooltip suggestion",callback:()=>{let t=this.app.workspace.getActiveViewOfType(Is.MarkdownView);if(t){let r=t.editor.cm;r.state.field(fa,!1)&&r.dispatch({effects:Nt.of(null)})}}}),this.addSettingTab(new zi(this.app,this))}onunload(){}async loadSettings(){this.settings=Object.assign({},Qu,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
/*! Bundled license information:

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)
*/

/* nosourcemap */